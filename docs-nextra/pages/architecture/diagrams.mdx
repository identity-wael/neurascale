import { Callout } from 'nextra/components'
import Mermaid from '../../components/Mermaid'

# Architecture Diagrams

<Callout>
  Visual representations of NeuraScale's architecture to help understand system design and data flow.
</Callout>

## Device Integration Architecture

<Mermaid>
{`graph TB
    subgraph "BCI Devices"
        OpenBCI[OpenBCI<br/>Cyton/Ganglion]
        Emotiv[Emotiv<br/>EPOC/Insight]
        Muse[Muse<br/>2/S]
        Clinical[Clinical Arrays<br/>Blackrock/Plexon]
    end

    subgraph "Connection Protocols"
        Serial[Serial/USB]
        BLE[Bluetooth LE]
        WiFi[WiFi/TCP]
        LSL[Lab Streaming Layer]
    end

    subgraph "Device Drivers"
        OpenBCIDriver[OpenBCI Driver]
        EmotivDriver[Emotiv Driver]
        MuseDriver[Muse Driver]
        LSLDriver[LSL Driver]
    end

    subgraph "Unified Interface"
        DeviceManager[Device Manager]
        StreamBuffer[Stream Buffer]
        QualityMonitor[Quality Monitor]
    end

    OpenBCI --> Serial
    Emotiv --> BLE
    Muse --> BLE
    Clinical --> LSL

    Serial --> OpenBCIDriver
    BLE --> EmotivDriver
    BLE --> MuseDriver
    LSL --> LSLDriver

    OpenBCIDriver --> DeviceManager
    EmotivDriver --> DeviceManager
    MuseDriver --> DeviceManager
    LSLDriver --> DeviceManager

    DeviceManager --> StreamBuffer
    DeviceManager --> QualityMonitor

    style OpenBCI fill:#4285f4
    style Emotiv fill:#34a853
    style Muse fill:#fbbc04
    style Clinical fill:#ea4335`}
</Mermaid>

## Neural Processing Pipeline

<Mermaid>
{`graph LR
    subgraph "Input Stage"
        Raw[Raw EEG Data<br/>250-30kHz]
    end

    subgraph "Preprocessing"
        Resample[Resampling<br/>Target: 500Hz]
        Filter[Filtering<br/>0.5-100Hz]
        Reference[Re-referencing<br/>CAR/Bipolar]
        Artifact[Artifact Removal<br/>ICA/Threshold]
    end

    subgraph "Feature Extraction"
        Time[Time Domain<br/>Mean/Var/RMS]
        Freq[Frequency Domain<br/>FFT/PSD]
        TimeFreq[Time-Frequency<br/>Wavelet/STFT]
        Connect[Connectivity<br/>Coherence/PLV]
    end

    subgraph "Machine Learning"
        Classify[Classification<br/>SVM/CNN]
        Decode[Decoding<br/>Kalman/RNN]
        Predict[Prediction<br/>LSTM/GRU]
    end

    subgraph "Output"
        Control[Control Signals]
        Feedback[User Feedback]
        Storage[Data Storage]
    end

    Raw --> Resample
    Resample --> Filter
    Filter --> Reference
    Reference --> Artifact

    Artifact --> Time
    Artifact --> Freq
    Artifact --> TimeFreq
    Artifact --> Connect

    Time --> Classify
    Freq --> Classify
    TimeFreq --> Decode
    Connect --> Predict

    Classify --> Control
    Decode --> Control
    Predict --> Feedback

    Control --> Storage
    Feedback --> Storage`}
</Mermaid>

## Kubernetes Deployment Architecture

<Mermaid>
{`graph TB
    subgraph "Internet"
        Users[Users]
        Devices[BCI Devices]
    end

    subgraph "Google Cloud Platform"
        subgraph "Global Load Balancer"
            GLB[Global LB<br/>SSL Termination]
        end

        subgraph "GKE Cluster - Primary Region"
            subgraph "Ingress"
                Nginx[NGINX Ingress<br/>Path Routing]
            end

            subgraph "Services"
                API[Neural API<br/>3 Replicas]
                WS[WebSocket Server<br/>5 Replicas]
                Worker[Workers<br/>10 Replicas]
            end

            subgraph "Data Layer"
                PG[PostgreSQL HA<br/>Primary]
                Redis[Redis Cluster<br/>3 Nodes]
                Kafka[Kafka Cluster<br/>3 Brokers]
            end

            subgraph "Monitoring"
                Prom[Prometheus]
                Graf[Grafana]
                Alert[AlertManager]
            end
        end

        subgraph "GKE Cluster - DR Region"
            PGDR[PostgreSQL<br/>Read Replica]
            APIDR[Neural API<br/>Standby]
        end

        subgraph "Managed Services"
            BQ[BigQuery<br/>Analytics]
            GCS[Cloud Storage<br/>Backups]
            KMS[Cloud KMS<br/>Encryption]
        end
    end

    Users --> GLB
    Devices --> GLB
    GLB --> Nginx

    Nginx --> API
    Nginx --> WS

    API --> PG
    API --> Redis
    WS --> Kafka
    Worker --> Kafka

    PG --> PGDR
    Worker --> BQ
    PG --> GCS

    Prom --> Graf
    Prom --> Alert

    style GLB fill:#4285f4
    style API fill:#34a853
    style WS fill:#fbbc04
    style PG fill:#ea4335`}
</Mermaid>

## Security Architecture

<Mermaid>
{`graph TB
    subgraph "External Access"
        User[User/Device]
        Attacker[Potential Threat]
    end

    subgraph "Edge Security"
        WAF[Web Application Firewall]
        DDoS[DDoS Protection]
        RateLimit[Rate Limiting]
    end

    subgraph "Authentication Layer"
        OAuth[OAuth 2.0]
        JWT[JWT Tokens]
        MFA[Multi-Factor Auth]
    end

    subgraph "Application Security"
        RBAC[Role-Based Access]
        Audit[Audit Logging]
        Secrets[Secret Manager]
    end

    subgraph "Data Security"
        TLS[TLS 1.3 in Transit]
        KMS[KMS Encryption at Rest]
        PII[PII Masking]
    end

    subgraph "Infrastructure Security"
        VPC[Private VPC]
        Firewall[Firewall Rules]
        SIEM[SIEM Integration]
    end

    User --> WAF
    Attacker --> WAF
    WAF --> DDoS
    DDoS --> RateLimit

    RateLimit --> OAuth
    OAuth --> JWT
    JWT --> MFA

    MFA --> RBAC
    RBAC --> Audit
    RBAC --> Secrets

    Secrets --> TLS
    TLS --> KMS
    KMS --> PII

    PII --> VPC
    VPC --> Firewall
    Firewall --> SIEM

    style Attacker fill:#ea4335
    style WAF fill:#4285f4
    style KMS fill:#34a853`}
</Mermaid>

## Data Storage Architecture

<Mermaid>
{`graph TB
    subgraph "Data Sources"
        Stream[Streaming Data]
        Batch[Batch Uploads]
        API[API Writes]
    end

    subgraph "Ingestion"
        Kafka[Kafka<br/>Event Stream]
        Queue[Cloud Tasks<br/>Batch Queue]
    end

    subgraph "Processing"
        Beam[Apache Beam<br/>Stream Processing]
        Functions[Cloud Functions<br/>Event Handlers]
    end

    subgraph "Storage Tiers"
        subgraph "Hot Storage"
            Redis[(Redis<br/>< 5 min)]
            Memcache[(Memcached<br/>Session)]
        end

        subgraph "Warm Storage"
            TimescaleDB[(TimescaleDB<br/>< 30 days)]
            PostgreSQL[(PostgreSQL<br/>Metadata)]
        end

        subgraph "Cold Storage"
            BigQuery[(BigQuery<br/>Analytics)]
            CloudStorage[(Cloud Storage<br/>Archive)]
        end
    end

    subgraph "Access Patterns"
        Realtime[Real-time API]
        Analytics[Analytics API]
        Export[Bulk Export]
    end

    Stream --> Kafka
    Batch --> Queue
    API --> PostgreSQL

    Kafka --> Beam
    Queue --> Functions

    Beam --> Redis
    Beam --> TimescaleDB
    Functions --> PostgreSQL

    Redis --> Realtime
    TimescaleDB --> Analytics

    TimescaleDB --> BigQuery
    PostgreSQL --> CloudStorage
    BigQuery --> Export

    style Kafka fill:#4285f4
    style TimescaleDB fill:#34a853
    style BigQuery fill:#fbbc04`}
</Mermaid>

## Machine Learning Architecture

<Mermaid>
{`graph LR
    subgraph "Training Pipeline"
        Data[Training Data]
        Preprocess[Preprocessing]
        Train[Model Training]
        Validate[Validation]
        Registry[Model Registry]
    end

    subgraph "Serving Infrastructure"
        Endpoint[Prediction Endpoint]
        Cache[Prediction Cache]
        Monitor[Performance Monitor]
    end

    subgraph "Model Types"
        Movement[Movement Decoder]
        Emotion[Emotion Classifier]
        Attention[Attention Monitor]
        Seizure[Seizure Detector]
    end

    subgraph "Deployment"
        AB[A/B Testing]
        Canary[Canary Deploy]
        Rollback[Auto Rollback]
    end

    Data --> Preprocess
    Preprocess --> Train
    Train --> Validate
    Validate --> Registry

    Registry --> Movement
    Registry --> Emotion
    Registry --> Attention
    Registry --> Seizure

    Movement --> Endpoint
    Emotion --> Endpoint
    Attention --> Endpoint
    Seizure --> Endpoint

    Endpoint --> Cache
    Endpoint --> Monitor

    Monitor --> AB
    AB --> Canary
    Canary --> Rollback

    style Train fill:#4285f4
    style Endpoint fill:#34a853
    style Monitor fill:#fbbc04`}
</Mermaid>

## Network Architecture

<Mermaid>
{`graph TB
    subgraph "External Network"
        Internet[Internet]
        CDN[Cloudflare CDN]
    end

    subgraph "GCP Network"
        subgraph "Edge"
            LB[Load Balancer<br/>Global Anycast]
            Armor[Cloud Armor<br/>DDoS Protection]
        end

        subgraph "VPC Network"
            subgraph "Public Subnet"
                NAT[Cloud NAT]
                Bastion[Bastion Host]
            end

            subgraph "Private Subnet A"
                GKE[GKE Nodes]
                CloudSQL[Cloud SQL]
            end

            subgraph "Private Subnet B"
                Redis[Redis Instances]
                Kafka[Kafka Brokers]
            end

            subgraph "Service Subnet"
                PrivateIP[Private Service IPs]
                Peering[VPC Peering]
            end
        end

        subgraph "Connectivity"
            VPN[Cloud VPN]
            Interconnect[Partner Interconnect]
        end
    end

    subgraph "On-Premise"
        Corporate[Corporate Network]
        DataCenter[Data Center]
    end

    Internet --> CDN
    CDN --> LB
    LB --> Armor
    Armor --> NAT

    NAT --> GKE
    Bastion --> GKE

    GKE --> CloudSQL
    GKE --> Redis
    GKE --> Kafka

    CloudSQL --> PrivateIP
    Redis --> PrivateIP

    VPN --> Corporate
    Interconnect --> DataCenter

    Corporate --> Peering
    DataCenter --> Peering

    style Internet fill:#4285f4
    style GKE fill:#34a853
    style CloudSQL fill:#fbbc04
    style Redis fill:#ea4335`}
</Mermaid>

## CI/CD Pipeline

<Mermaid>
{`graph LR
    subgraph "Development"
        Dev[Developer]
        Local[Local Testing]
    end

    subgraph "Source Control"
        GitHub[GitHub]
        PR[Pull Request]
        Branch[Feature Branch]
    end

    subgraph "CI Pipeline"
        Actions[GitHub Actions]
        Test[Unit Tests]
        Lint[Linting]
        Security[Security Scan]
        Build[Docker Build]
    end

    subgraph "Artifact Storage"
        Registry[Artifact Registry]
        Images[Container Images]
        Helm[Helm Charts]
    end

    subgraph "CD Pipeline"
        Deploy[Deployment]
        Staging[Staging Env]
        Prod[Production Env]
    end

    subgraph "Validation"
        E2E[E2E Tests]
        Smoke[Smoke Tests]
        Rollback[Rollback Ready]
    end

    Dev --> Local
    Local --> GitHub
    GitHub --> PR
    PR --> Branch

    Branch --> Actions
    Actions --> Test
    Actions --> Lint
    Actions --> Security
    Test --> Build

    Build --> Registry
    Registry --> Images
    Registry --> Helm

    Images --> Deploy
    Helm --> Deploy
    Deploy --> Staging

    Staging --> E2E
    E2E --> Smoke
    Smoke --> Prod
    Prod --> Rollback

    style GitHub fill:#4285f4
    style Actions fill:#34a853
    style Prod fill:#fbbc04`}
</Mermaid>

## Summary

These diagrams illustrate the key architectural components of NeuraScale:

1. **Device Integration**: How various BCI devices connect to the platform
2. **Processing Pipeline**: The signal processing workflow from raw data to insights
3. **Kubernetes Deployment**: Container orchestration and scaling strategy
4. **Security Architecture**: Multi-layered security approach
5. **Data Storage**: Tiered storage strategy for different access patterns
6. **Machine Learning**: ML model training and serving infrastructure
7. **Network Architecture**: Network topology and security zones
8. **CI/CD Pipeline**: Continuous integration and deployment workflow

Each component is designed for:
- **Scalability**: Handle growing workloads
- **Reliability**: High availability and fault tolerance
- **Security**: Defense in depth approach
- **Performance**: Optimized for real-time processing

## Next Steps

- Return to [Architecture Overview](/architecture/overview)
- Explore [System Components](/architecture/system-components) in detail
- Learn about [Data Flow](/architecture/data-flow) patterns
