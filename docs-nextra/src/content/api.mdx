import { Tabs, Callout } from 'nextra/components'

# NeuraScale API Documentation

## 🎉 Latest Update: Phase 12 - Complete API Implementation with Kong Gateway

**Version 2.0** | **[Interactive Docs](https://api.neurascale.com/api/docs)** | **[GraphQL Playground](https://api.neurascale.com/api/graphql)** | **[Kong Admin](http://localhost:8001)**

Phase 12 introduces enterprise-grade API infrastructure with comprehensive REST v2 and GraphQL APIs, Kong API Gateway, client SDKs, and real-time capabilities.

## Overview

The NeuraScale API provides comprehensive access to neural data processing, device management, and real-time brain-computer interface functionality. Built with FastAPI and Strawberry GraphQL, protected by Kong API Gateway, it offers enterprise-grade performance, security, and monitoring with both RESTful endpoints and GraphQL queries with WebSocket subscriptions.

## API Versions

### REST API v2

- **Base URL**: `https://api.neurascale.com/api/v2/`
- **Authentication**: Bearer JWT tokens
- **Content Type**: `application/json`
- **Rate Limiting**: 1000 requests/minute per API key
- **HATEOAS**: All responses include navigation links

### GraphQL API

- **Endpoint**: `https://api.neurascale.com/api/graphql`
- **WebSocket**: `wss://api.neurascale.com/api/graphql` (subscriptions)
- **Playground**: Available in development at `/api/graphql`
- **Introspection**: Enabled for development environments

### Kong API Gateway

- **Admin API**: `http://localhost:8001` (development)
- **Prometheus Metrics**: `http://localhost:9090`
- **Grafana Dashboard**: `http://localhost:3000`
- **Features**: Load balancing, circuit breakers, rate limiting, SSL termination
- **Performance**: Sub-10ms overhead, 10,000+ req/sec throughput
- **Monitoring**: Real-time metrics, health checks, automated failover

## Quick Start

### Authentication

All API endpoints require authentication using JWT Bearer tokens:

```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     https://api.neurascale.com/api/v2/devices
```

### REST API Example

```bash
# List all devices
curl -X GET \
  -H "Authorization: Bearer YOUR_TOKEN" \
  https://api.neurascale.com/api/v2/devices

# Create a new session
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"patientId": "pat_001", "deviceId": "dev_001"}' \
  https://api.neurascale.com/api/v2/sessions
```

### GraphQL Example

```bash
curl -X POST \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "query { devices { edges { node { id name type status } } } }"
  }' \
  https://api.neurascale.com/api/graphql
```

## Core Endpoints

### 🔌 Device Management
**REST**: `/api/v2/devices/`
**GraphQL**: `devices`, `device(id)`
Manage neural acquisition devices, calibration, and status monitoring

### 📊 Session Recording
**REST**: `/api/v2/sessions/`
**GraphQL**: `sessions`, `session(id)`
Control recording sessions, real-time data streaming

### 🧠 Neural Data Access
**REST**: `/api/v2/neural-data/`
**GraphQL**: `neuralData(sessionId)`
Retrieve and stream neural signal data with filtering

### 👤 Patient Management
**REST**: `/api/v2/patients/`
**GraphQL**: `patients`, `patient(id)`
Patient records and clinical data integration

### 🔬 Analysis Pipeline
**REST**: `/api/v2/analysis/`
**GraphQL**: `analyses`, `startAnalysis`
Signal processing and machine learning inference

### 🤖 ML Models
**REST**: `/api/v2/ml-models/`
**GraphQL**: `mlModels`, `predict`
Neural network models for BCI applications

## REST API v2 Reference

### Device Management

#### List Devices

```http
GET /api/v2/devices
```

**Query Parameters:**

- `status` (string): Filter by device status (ONLINE, OFFLINE, CALIBRATING)
- `type` (string): Filter by device type (EEG, EMG, ECoG)
- `page` (int): Page number for pagination (default: 1)
- `size` (int): Items per page (default: 20, max: 100)

**Response:**

```json
{
  "items": [
    {
      "id": "dev_001",
      "name": "OpenBCI Cyton",
      "type": "EEG",
      "status": "ONLINE",
      "serialNumber": "OBC-001",
      "firmwareVersion": "3.1.2",
      "lastSeen": "2024-01-15T10:30:00Z",
      "channelCount": 8,
      "samplingRate": 250,
      "_links": {
        "self": { "href": "/api/v2/devices/dev_001", "method": "GET" },
        "update": { "href": "/api/v2/devices/dev_001", "method": "PATCH" },
        "calibration": {
          "href": "/api/v2/devices/dev_001/calibration",
          "method": "POST"
        }
      }
    }
  ],
  "total": 150,
  "page": 1,
  "size": 20,
  "totalPages": 8,
  "_links": {
    "self": "/api/v2/devices?page=1&size=20",
    "next": "/api/v2/devices?page=2&size=20",
    "last": "/api/v2/devices?page=8&size=20"
  }
}
```

#### Create Device

```http
POST /api/v2/devices
```

**Request Body:**

```json
{
  "name": "New EEG Device",
  "type": "EEG",
  "serialNumber": "NEW-001",
  "firmwareVersion": "1.0.0",
  "channelCount": 32,
  "samplingRate": 256
}
```

**Response (201 Created):**

```json
{
  "id": "dev_new",
  "name": "New EEG Device",
  "type": "EEG",
  "status": "OFFLINE",
  "serialNumber": "NEW-001",
  "firmwareVersion": "1.0.0",
  "channelCount": 32,
  "samplingRate": 256,
  "createdAt": "2024-01-15T10:30:00Z",
  "_links": {
    "self": { "href": "/api/v2/devices/dev_new", "method": "GET" }
  }
}
```

### Session Recording

#### Create Session

```http
POST /api/v2/sessions
```

**Request Body:**

```json
{
  "patientId": "pat_001",
  "deviceId": "dev_001",
  "channelCount": 32,
  "samplingRate": 256,
  "metadata": {
    "protocol": "resting_state",
    "notes": "Baseline recording"
  }
}
```

#### Start Recording

```http
POST /api/v2/sessions/{sessionId}/start
```

**Response:**

```json
{
  "id": "ses_001",
  "patientId": "pat_001",
  "deviceId": "dev_001",
  "startTime": "2024-01-15T10:30:00Z",
  "status": "RECORDING",
  "channelCount": 32,
  "samplingRate": 256,
  "_links": {
    "stop": { "href": "/api/v2/sessions/ses_001/stop", "method": "POST" },
    "pause": { "href": "/api/v2/sessions/ses_001/pause", "method": "POST" }
  }
}
```

### Neural Data Access

#### Get Neural Data

```http
GET /api/v2/neural-data/sessions/{sessionId}
```

**Query Parameters:**

- `startTime` (float): Start time in seconds
- `endTime` (float): End time in seconds
- `channels` (string): Comma-separated channel indices (e.g., "0,1,2,3")
- `downsample` (int): Downsampling factor

**Response:**

```json
{
  "sessionId": "ses_001",
  "startTime": 0.0,
  "endTime": 60.0,
  "samplingRate": 256,
  "channelCount": 4,
  "data": [
    [1.2, 1.5, 1.8],  // Channel 0 samples
    [0.8, 0.9, 1.1],  // Channel 1 samples
    [2.1, 2.3, 2.5],  // Channel 2 samples
    [1.7, 1.9, 2.0]   // Channel 3 samples
  ],
  "timestamps": [0.0, 0.00390625, 0.0078125],
  "channels": [0, 1, 2, 3],
  "metadata": {
    "deviceType": "EEG",
    "units": "microvolts"
  }
}
```

## GraphQL API Reference

### Basic Query Example

```graphql
query GetDeviceDetails($deviceId: String!) {
  device(id: $deviceId) {
    id
    name
    type
    status
    sessions(pagination: { first: 5 }) {
      edges {
        node {
          id
          startTime
          status
          patient {
            id
            externalId
          }
        }
      }
    }
  }
}
```

### Mutation Example

```graphql
mutation CreateSession($input: CreateSessionInput!) {
  createSession(input: $input) {
    success
    message
    session {
      id
      startTime
      status
    }
  }
}
```

### Subscription Example

```graphql
subscription NeuralDataStream($sessionId: String!) {
  neuralDataStream(sessionId: $sessionId, channels: [0, 1, 2, 3]) {
    timestamp
    samplingRate
    data
    channels
  }
}
```

## Client SDKs

<Tabs items={['Python', 'TypeScript/JavaScript']}>
  <Tabs.Tab>
```python
import asyncio
from neurascale import NeuraScaleClient

async def main():
    client = NeuraScaleClient(api_key="your-api-key")

    # List devices
    devices = await client.list_devices()
    print(f"Found {devices.total} devices")

    # Create session
    session = await client.create_session({
        "patientId": "pat_001",
        "deviceId": devices.items[0].id,
        "channelCount": 32,
        "samplingRate": 256
    })

    # Start recording
    await client.start_session(session.id)

    # Get neural data
    data = await client.get_neural_data(
        session.id,
        channels=[0, 1, 2, 3],
        start_time=0,
        end_time=60
    )

    await client.close()

asyncio.run(main())
```
  </Tabs.Tab>
  <Tabs.Tab>
```typescript
import { NeuraScaleClient, StreamClient } from "@neurascale/sdk";

// REST API operations
const client = new NeuraScaleClient({
  apiKey: "your-api-key",
});

const devices = await client.listDevices();
const session = await client.createSession({
  patientId: "pat_001",
  deviceId: devices.items[0].id,
});

// Real-time streaming
const stream = new StreamClient({
  url: "wss://api.neurascale.com/ws/neural-data",
  token: "your-stream-token",
});

stream.on("data", (frame) => {
  console.log(`Received ${frame.data.length} channels`);
});

await stream.connect();
stream.subscribeToSession(session.id, [0, 1, 2, 3]);
```
  </Tabs.Tab>
</Tabs>

## Real-time Features

### WebSocket Streaming

```javascript
const ws = new WebSocket("wss://api.neurascale.com/ws/neural-data");

ws.onmessage = (event) => {
  const frame = JSON.parse(event.data);
  console.log(`Frame ${frame.timestamp}: ${frame.data.length} samples`);
};

// Subscribe to session data
ws.send(
  JSON.stringify({
    type: "subscribe",
    sessionId: "ses_001",
    channels: [0, 1, 2, 3],
  }),
);
```

### GraphQL Subscriptions (WebSocket)

```javascript
import { createClient } from "graphql-ws";

const client = createClient({
  url: "wss://api.neurascale.com/api/graphql",
  connectionParams: {
    Authorization: "Bearer your-token",
  },
});

client.subscribe(
  {
    query: `
    subscription {
      neuralDataStream(sessionId: "ses_001") {
        timestamp
        data
        channels
      }
    }
  `,
  },
  {
    next: (data) => console.log("Received data:", data),
    error: (err) => console.error("Error:", err),
  },
);
```

## Error Handling

### HTTP Status Codes

| Code | Description      | Action                        |
| ---- | ---------------- | ----------------------------- |
| 200  | Success          | Continue                      |
| 201  | Created          | Resource created successfully |
| 400  | Bad Request      | Check request format          |
| 401  | Unauthorized     | Verify authentication token   |
| 403  | Forbidden        | Check permissions             |
| 404  | Not Found        | Resource doesn't exist        |
| 422  | Validation Error | Fix request data              |
| 429  | Rate Limited     | Reduce request frequency      |
| 500  | Server Error     | Retry or contact support      |

### Error Response Format

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid request parameters",
    "details": [
      {
        "field": "channelCount",
        "message": "Must be between 1 and 256"
      }
    ]
  },
  "timestamp": "2024-01-15T10:30:00Z",
  "requestId": "req_1234567890"
}
```

## Rate Limiting

API requests are rate limited to ensure fair usage:

- **Default**: 1000 requests/minute per API key
- **Burst**: Up to 10 requests/second
- **Streaming**: 100 concurrent connections per account

Response headers include rate limit information:

```http
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 999
X-RateLimit-Reset: 1642248600
```

## Advanced Features

### Batch Operations

Execute multiple operations in a single request:

```json
POST /api/v2/devices/batch
{
  "operations": [
    {
      "operation": "update",
      "id": "dev_001",
      "data": {"status": "ONLINE"}
    },
    {
      "operation": "create",
      "data": {
        "name": "Batch Device",
        "type": "EMG",
        "serialNumber": "BATCH-001"
      }
    }
  ]
}
```

### Data Export

Export session data in various formats:

```http
POST /api/v2/sessions/{sessionId}/export
{
  "format": "EDF",
  "channels": [0, 1, 2, 3],
  "startTime": 0,
  "endTime": 3600
}
```

**Response:**

```json
{
  "exportId": "exp_12345",
  "status": "PROCESSING",
  "_links": {
    "status": "/api/v2/exports/exp_12345",
    "download": "/api/v2/exports/exp_12345/download"
  }
}
```

## SDK Installation

<Tabs items={['Python', 'JavaScript/TypeScript']}>
  <Tabs.Tab>
```bash
pip install neurascale
```
  </Tabs.Tab>
  <Tabs.Tab>
```bash
npm install @neurascale/sdk
# or
yarn add @neurascale/sdk
```
  </Tabs.Tab>
</Tabs>

## Interactive Documentation

- **Swagger UI**: [https://api.neurascale.com/api/docs](https://api.neurascale.com/api/docs)
- **ReDoc**: [https://api.neurascale.com/api/redoc](https://api.neurascale.com/api/redoc)
- **GraphQL Playground**: [https://api.neurascale.com/api/graphql](https://api.neurascale.com/api/graphql)

## Performance Metrics

### Response Times

| Endpoint Type  | P50  | P95   | P99   | Max   |
| -------------- | ---- | ----- | ----- | ----- |
| Device List    | 45ms | 120ms | 180ms | 250ms |
| Session Create | 60ms | 150ms | 220ms | 300ms |
| Neural Data    | 80ms | 200ms | 300ms | 400ms |
| GraphQL Query  | 50ms | 130ms | 200ms | 280ms |

### Throughput Capacity

| Metric                | Single Instance | Load Balanced |
| --------------------- | --------------- | ------------- |
| Requests/sec          | 1,000           | 10,000+       |
| Concurrent Users      | 500             | 5,000+        |
| WebSocket Connections | 100             | 1,000+        |
| Data Throughput       | 100 MB/s        | 1 GB/s        |

## Changelog

### v2.0.0 (2024-01-15) - Phase 12 Release

- ✨ Complete GraphQL API with subscriptions
- ✨ Enhanced REST API v2 with HATEOAS
- ✨ Python and TypeScript/JavaScript SDKs
- ✨ Real-time WebSocket streaming
- ✨ Comprehensive test coverage (100+ tests)
- ✨ Advanced error handling and validation
- ✨ Rate limiting and security enhancements

<Callout type="warning">
**v1.x.x (Legacy)**

🗑️ REST API v1 is deprecated and removal is planned for Q2 2024. See [Migration Guide](./migration-v1-to-v2.md) for upgrade path.
</Callout>

## Support

### Getting Help

- 📖 **Documentation**: [https://docs.neurascale.io/api](https://docs.neurascale.io/api)
- 💬 **Discord**: [https://discord.gg/neurascale](https://discord.gg/neurascale)
- 📧 **Email Support**: api-support@neurascale.io
- 🐛 **Bug Reports**: [https://github.com/identity-wael/neurascale/issues](https://github.com/identity-wael/neurascale/issues)

### API Status

- **Status Page**: [https://status.neurascale.io](https://status.neurascale.io)
- **Uptime**: 99.9% SLA
- **Monitoring**: Real-time API health metrics
