"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[418],{8328:function(e,t,r){r.a(e,async function(e,r){try{void 0===window.GPUShaderStage&&(window.GPUShaderStage={VERTEX:1,FRAGMENT:2,COMPUTE:4});let e=!1;if(void 0!==navigator.gpu){let t=await navigator.gpu.requestAdapter();null!==t&&(e=!0)}class i{static isAvailable(){return e}static getErrorMessage(){let e=document.createElement("div");return e.id="webgpumessage",e.style.fontFamily="monospace",e.style.fontSize="13px",e.style.fontWeight="normal",e.style.textAlign="center",e.style.background="#fff",e.style.color="#000",e.style.padding="1.5em",e.style.maxWidth="400px",e.style.margin="5em auto 0",e.innerHTML='Your browser does not support <a href="https://gpuweb.github.io/gpuweb/" style="color:blue">WebGPU</a> yet',e}}t.Z=i,r()}catch(e){r(e)}},1)},3200:function(e,t,r){let i,s,n;r.d(t,{wg:function(){return tL},mTA:function(){return lO},D21:function(){return sk},hul:function(){return re},_XU:function(){return nk},ipI:function(){return nW},Oie:function(){return nh},zYp:function(){return aN},Qwr:function(){return a_},Do7:function(){return te},$vw:function(){return sM},fpk:function(){return oS},ZEm:function(){return sY},Hut:function(){return C},KfF:function(){return sn},BnF:function(){return iF},WxF:function(){return B},WR:function(){return ox},YPW:function(){return io},o_W:function(){return E},hYO:function(){return ir},Fhw:function(){return a9},vhs:function(){return eD},sSb:function(){return s5}});let a={VERTEX:"vertex"},o={NONE:"none",FRAME:"frame",RENDER:"render",OBJECT:"object"},l=["setup","analyze","generate"],u=["fragment","vertex","compute"],d=["x","y","z","w"];var c=r(1901);function h(e){let t="{";for(let{property:r,childNode:i}of(!0===e.isNode&&(t+=e.id),p(e)))t+=","+r.slice(0,-4)+":"+i.getCacheKey();return t+"}"}function*p(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];for(let r in e){if(!0===r.startsWith("_"))continue;let i=e[r];if(!0===Array.isArray(i))for(let e=0;e<i.length;e++){let s=i[e];s&&(!0===s.isNode||t&&"function"==typeof s.toJSON)&&(yield{property:r,index:e,childNode:s})}else if(i&&!0===i.isNode)yield{property:r,childNode:i};else if("object"==typeof i)for(let e in i){let s=i[e];s&&(!0===s.isNode||t&&"function"==typeof s.toJSON)&&(yield{property:r,index:e,childNode:s})}}}function g(e){if(null==e)return null;let t=typeof e;if(!0===e.isNode)return"node";if("number"===t)return"float";if("boolean"===t)return"bool";if("string"===t)return"string";if("function"===t)return"shader";if(!0===e.isVector2)return"vec2";if(!0===e.isVector3)return"vec3";else if(!0===e.isVector4)return"vec4";else if(!0===e.isMatrix3)return"mat3";else if(!0===e.isMatrix4)return"mat4";else if(!0===e.isColor)return"color";else if(e instanceof ArrayBuffer)return"ArrayBuffer";return null}function m(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];let s=e?e.slice(-4):void 0;if(1===r.length&&("vec2"===s?r=[r[0],r[0]]:"vec3"===s?r=[r[0],r[0],r[0]]:"vec4"===s&&(r=[r[0],r[0],r[0],r[0]])),"color"===e)return new c.Color(...r);if("vec2"===s)return new c.Vector2(...r);if("vec3"===s)return new c.Vector3(...r);if("vec4"===s)return new c.Vector4(...r);if("mat3"===s)return new c.Matrix3(...r);if("mat4"===s)return new c.Matrix4(...r);if("bool"===e)return r[0]||!1;else if("float"===e||"int"===e||"uint"===e)return r[0]||0;else if("string"===e)return r[0]||"";else if("ArrayBuffer"===e)return T(r[0]);return null}function f(e){let t="",r=new Uint8Array(e);for(let e=0;e<r.length;e++)t+=String.fromCharCode(r[e]);return btoa(t)}function T(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0)).buffer}let y=new Map,x=0;class b extends c.EventDispatcher{get type(){return this.constructor.type}getSelf(){return this.self||this}updateReference(){return this}isGlobal(){return!1}*getChildren(){for(let{childNode:e}of p(this))yield e}dispose(){this.dispatchEvent({type:"dispose"})}traverse(e){for(let t of(e(this),this.getChildren()))t.traverse(e)}getCacheKey(){return h(this)}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getNodeType(e){let t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){let t=this.getHash(e);return e.getNodeFromHash(t)||this}setup(e){let t=e.getNodeProperties(this);for(let e of this.getChildren())t["_node"+e.id]=e;return null}construct(e){return console.warn("THREE.Node: construct() is deprecated. Use setup() instead."),this.setup(e)}analyze(e){let t=e.getDataFromNode(this);if(t.dependenciesCount=void 0===t.dependenciesCount?1:t.dependenciesCount+1,1===t.dependenciesCount)for(let t of Object.values(e.getNodeProperties(this)))t&&!0===t.isNode&&t.build(e)}generate(e,t){let{outputNode:r}=e.getNodeProperties(this);if(r&&!0===r.isNode)return r.build(e,t)}updateBefore(){console.warn("Abstract function.")}update(){console.warn("Abstract function.")}build(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this.getShared(e);if(this!==r)return r.build(e,t);e.addNode(this),e.addChain(this);let i=null,s=e.getBuildStage();if("setup"===s){let t=e.getNodeProperties(this);if(!0!==t.initialized||!1===e.context.tempRead){let r=e.stack.nodes.length;for(let i of(t.initialized=!0,t.outputNode=this.setup(e),null!==t.outputNode&&e.stack.nodes.length!==r&&(t.outputNode=e.stack),Object.values(t)))i&&!0===i.isNode&&i.build(e)}}else if("analyze"===s)this.analyze(e);else if("generate"===s){if(1===this.generate.length){let r=this.getNodeType(e),s=e.getDataFromNode(this);void 0===(i=s.snippet)&&(i=this.generate(e)||"",s.snippet=i),i=e.format(i,r,t)}else i=this.generate(e,t)||""}return e.removeChain(this),i}getSerializeChildren(){return p(this)}serialize(e){let t=this.getSerializeChildren(),r={};for(let{property:i,index:s,childNode:n}of t)void 0!==s?(void 0===r[i]&&(r[i]=Number.isInteger(s)?[]:{}),r[i][s]=n.toJSON(e.meta).uuid):r[i]=n.toJSON(e.meta).uuid;Object.keys(r).length>0&&(e.inputNodes=r)}deserialize(e){if(void 0!==e.inputNodes){let t=e.meta.nodes;for(let r in e.inputNodes)if(Array.isArray(e.inputNodes[r])){let i=[];for(let s of e.inputNodes[r])i.push(t[s]);this[r]=i}else if("object"==typeof e.inputNodes[r]){let i={};for(let s in e.inputNodes[r]){let n=e.inputNodes[r][s];i[s]=t[n]}this[r]=i}else{let i=e.inputNodes[r];this[r]=t[i]}}}toJSON(e){let{uuid:t,type:r}=this,i=void 0===e||"string"==typeof e;i&&(e={textures:{},images:{},nodes:{}});let s=e.nodes[t];function n(e){let t=[];for(let r in e){let i=e[r];delete i.metadata,t.push(i)}return t}if(void 0===s&&(s={uuid:t,type:r,meta:e,metadata:{version:4.6,type:"Node",generator:"Node.toJSON"}},!0!==i&&(e.nodes[s.uuid]=s),this.serialize(s),delete s.meta),i){let t=n(e.textures),r=n(e.images),i=n(e.nodes);t.length>0&&(s.textures=t),r.length>0&&(s.images=r),i.length>0&&(s.nodes=i)}return s}constructor(e=null){super(),this.nodeType=e,this.updateType=o.NONE,this.updateBeforeType=o.NONE,this.uuid=c.MathUtils.generateUUID(),this.isNode=!0,Object.defineProperty(this,"id",{value:x++})}}var S=b;function N(e,t){if("function"!=typeof t||!e)throw Error("Node class ".concat(e," is not a class"));if(y.has(e)){console.warn("Redefinition of node class ".concat(e));return}y.set(e,t),t.type=e}class _ extends S{getNodeType(){return null===this.nodeType?g(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=g(this.value),e.nodeType=this.nodeType,"ArrayBuffer"===e.valueType&&(e.value=f(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?m(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){console.warn("Abstract function.")}constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}}var v=_;N("InputNode",_);class A extends S{set needsUpdate(e){!0===e&&this.version++}constructor(e,t=!1){super("string"),this.name=e,this.version=0,this.shared=t,this.isUniformGroup=!0}}let R=e=>new A(e,!0),C=R("frame"),E=R("render"),B=new A("object");N("UniformGroupNode",A);class F extends S{getNodeType(e){return this.node.getNodeType(e)}generate(e){let t=this.node.build(e),r=this.indexNode.build(e,"uint");return"".concat(t,"[ ").concat(r," ]")}constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}}N("ArrayElementNode",F);class w extends S{getNodeType(e){let t=this.node.getNodeType(e),r=null;for(let i of this.convertTo.split("|"))(null===r||e.getTypeLength(t)===e.getTypeLength(i))&&(r=i);return r}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){let r=this.node,i=this.getNodeType(e),s=r.build(e,i);return e.format(s,i,t)}constructor(e,t){super(),this.node=e,this.convertTo=t}}N("ConvertNode",w);class M extends S{hasDependencies(e){return e.getDataFromNode(this).dependenciesCount>1}build(e,t){if("generate"===e.getBuildStage()){let r=e.getVectorType(this.getNodeType(e,t)),i=e.getDataFromNode(this);if(!1!==e.context.tempRead&&void 0!==i.propertyName)return e.format(i.propertyName,r,t);if(!1!==e.context.tempWrite&&"void"!==r&&"void"!==t&&this.hasDependencies(e)){let s=super.build(e,r),n=e.getVarFromNode(this,null,r),a=e.getPropertyName(n);return e.addLineFlowCode("".concat(a," = ").concat(s)),i.snippet=s,i.propertyName=a,e.format(i.propertyName,r,t)}}return super.build(e,t)}constructor(e){super(e),this.isTempNode=!0}}var D=M;N("TempNode",M);class I extends D{getNodeType(e){return null!==this.nodeType?e.getVectorType(this.nodeType):e.getTypeFromLength(this.nodes.reduce((t,r)=>t+e.getTypeLength(r.getNodeType(e)),0))}generate(e,t){let r=this.getNodeType(e),i=this.nodes,s=e.getPrimitiveType(r),n=[];for(let t of i){let r=t.build(e),i=e.getPrimitiveType(t.getNodeType(e));i!==s&&(r=e.format(r,i,s)),n.push(r)}let a="".concat(e.getType(r),"( ").concat(n.join(", ")," )");return e.format(a,r,t)}constructor(e=[],t=null){super(t),this.nodes=e}}N("JoinNode",I);let O=d.join("");class U extends S{getVectorLength(){let e=this.components.length;for(let t of this.components)e=Math.max(d.indexOf(t)+1,e);return e}getPrimitiveType(e){return e.getPrimitiveType(this.node.getNodeType(e))}getNodeType(e){return e.getTypeFromLength(this.components.length,this.getPrimitiveType(e))}generate(e,t){let r=this.node,i=e.getTypeLength(r.getNodeType(e)),s=null;if(i>1){let n=null;this.getVectorLength()>=i&&(n=e.getTypeFromLength(this.getVectorLength(),this.getPrimitiveType(e)));let a=r.build(e,n);s=this.components.length===i&&this.components===O.slice(0,this.components.length)?e.format(a,n,t):e.format("".concat(a,".").concat(this.components),this.getNodeType(e),t)}else s=r.build(e,t);return s}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}constructor(e,t="x"){super(),this.node=e,this.components=t,this.isSplitNode=!0}}N("SplitNode",U);class L extends D{getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){let{sourceNode:t,components:r,targetNode:i}=this,s=this.getNodeType(e),n=e.getTypeFromLength(r.length),a=i.build(e,n),o=t.build(e,s),l=e.getTypeLength(s),u=[];for(let e=0;e<l;e++){let t=d[e];t===r[0]?(u.push(a),e+=r.length-1):u.push(o+"."+t)}return"".concat(e.getType(s),"( ").concat(u.join(", ")," )")}constructor(e,t,r){super(),this.sourceNode=e,this.components=t,this.targetNode=r}}N("SetNode",L);class G extends v{generateConst(e){return e.generateConst(this.getNodeType(e),this.value)}generate(e,t){let r=this.getNodeType(e);return e.format(this.generateConst(e),r,t)}constructor(e,t=null){super(e,t),this.isConstNode=!0}}N("ConstNode",G);let V=null,P=new Map;function k(e,t){if(P.has(e)){console.warn("Redefinition of node element ".concat(e));return}if("function"!=typeof t)throw Error("Node element ".concat(e," is not a function"));P.set(e,t)}let z=e=>e.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),W={setup:(e,t)=>e(eh(t.shift()),...t),get(e,t,r){if("string"==typeof t&&void 0===e[t]){if(!0!==e.isStackNode&&"assign"===t)return function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return V.assign(r,...t),r};if(P.has(t)){let i=P.get(t);return e.isStackNode?function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return r.add(i(...t))}:function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return i(r,...t)}}if("self"===t)return e;if(t.endsWith("Assign")&&P.has(t.slice(0,t.length-6))){let i=P.get(t.slice(0,t.length-6));return e.isStackNode?function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return r.assign(t[0],i(...t))}:function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return r.assign(i(r,...t))}}else if(!0===/^[xyzwrgbastpq]{1,4}$/.test(t))return ec(new U(r,t=z(t)));else if(!0===/^set[XYZWRGBASTPQ]{1,4}$/.test(t))return t=(t=z(t.slice(3).toLowerCase())).split("").sort().join(""),r=>ec(new L(e,t,r));else if("width"===t||"height"===t||"depth"===t)return"width"===t?t="x":"height"===t?t="y":"depth"===t&&(t="z"),ec(new U(e,t));else if(!0===/^\d+$/.test(t))return ec(new F(r,new G(Number(t),"uint")))}return Reflect.get(e,t,r)},set:(e,t,r,i)=>"string"==typeof t&&void 0===e[t]&&(!0===/^[xyzwrgbastpq]{1,4}$/.test(t)||"width"===t||"height"===t||"depth"===t||!0===/^\d+$/.test(t))?(i[t].assign(r),!0):Reflect.set(e,t,r,i)},H=new WeakMap,q=new WeakMap,j=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=g(e);if("node"===r){let t=H.get(e);return void 0===t&&(t=new Proxy(e,W),H.set(e,t),H.set(t,t)),t}return null===t&&("float"===r||"boolean"===r)||r&&"shader"!==r&&"string"!==r?ec(ea(e,t)):"shader"===r?ef(e):e},X=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;for(let r in e)e[r]=ec(e[r],t);return e},Y=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=e.length;for(let i=0;i<r;i++)e[i]=ec(e[i],t);return e},Z=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=e=>ec(null!==i?Object.assign(e,i):e);return null===t?function(){for(var t=arguments.length,r=Array(t),i=0;i<t;i++)r[i]=arguments[i];return s(new e(...ep(r)))}:null!==r?(r=ec(r),function(){for(var i=arguments.length,n=Array(i),a=0;a<i;a++)n[a]=arguments[a];return s(new e(t,...ep(n),r))}):function(){for(var r=arguments.length,i=Array(r),n=0;n<r;n++)i[n]=arguments[n];return s(new e(t,...ep(i)))}},K=function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return ec(new e(...ep(r)))};class Q extends S{getNodeType(e){let{outputNode:t}=e.getNodeProperties(this);return t?t.getNodeType(e):super.getNodeType(e)}call(e){let{shaderNode:t,inputNodes:r}=this;if(t.layout){let i=q.get(e.constructor);void 0===i&&(i=new WeakMap,q.set(e.constructor,i));let s=i.get(t);return void 0===s&&(s=ec(e.buildFunctionNode(t)),i.set(t,s)),null!==e.currentFunctionNode&&e.currentFunctionNode.includes.push(s),ec(s.call(r))}let i=t.jsFunc;return ec(null!==r?i(r,e.stack,e):i(e.stack,e))}setup(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}generate(e,t){let{outputNode:r}=e.getNodeProperties(this);return null===r?this.call(e).build(e,t):super.generate(e,t)}constructor(e,t){super(),this.shaderNode=e,this.inputNodes=t}}class J extends S{get isArrayInput(){return/^\(\s+?\[/.test(this.jsFunc.toString())}setLayout(e){return this.layout=e,this}call(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return eh(e),ec(new Q(this,e))}setup(){return this.call()}constructor(e){super(),this.jsFunc=e,this.layout=null}}let $=[.5,1.5,1/3,1e-6,1e6,Math.PI,2*Math.PI,1/Math.PI,2/Math.PI,1/(2*Math.PI),Math.PI/2],ee=new Map;for(let e of[!1,!0])ee.set(e,new G(e));let et=new Map;for(let e of[0,1,2,3])et.set(e,new G(e,"uint"));let er=new Map([...et].map(e=>new G(e.value,"int")));for(let e of[-1,-2])er.set(e,new G(e,"int"));let ei=new Map([...er].map(e=>new G(e.value)));for(let e of $)ei.set(e,new G(e));for(let e of $)ei.set(-e,new G(-e));let es={bool:ee,uint:et,float:ei},en=new Map([...ee,...ei]),ea=(e,t)=>en.has(e)?en.get(e):!0===e.isNode?e:new G(e,t),eo=e=>{try{return e.getNodeType()}catch(e){return}},el=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return function(){for(var r=arguments.length,i=Array(r),s=0;s<r;s++)i[s]=arguments[s];if((0===i.length||!["bool","float","int","uint"].includes(e)&&i.every(e=>"object"!=typeof e))&&(i=[m(e,...i)]),1===i.length&&null!==t&&t.has(i[0]))return ec(t.get(i[0]));if(1===i.length){let t=ea(i[0],e);return eo(t)===e?ec(t):ec(new w(t,e))}return ec(new I(i.map(e=>ea(e)),e))}},eu=e=>null!=e?e.nodeType||e.convertTo||("string"==typeof e?e:null):null;function ed(e){return new Proxy(new J(e),W)}let ec=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return j(e,t)},eh=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new X(e,t)},ep=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new Y(e,t)},eg=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new Z(...t)},em=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new K(...t)},ef=e=>{let t=new ed(e),r=function(){let e;for(var r=arguments.length,i=Array(r),s=0;s<r;s++)i[s]=arguments[s];return eh(i),e=i[0]&&i[0].isNode?[...i]:i[0],t.call(e)};return r.shaderNode=t,r.setLayout=e=>(t.setLayout(e),r),r};N("ShaderNode",ed);let eT=e=>{V=e},ey=()=>V,ex=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return V.if(...t)};k("append",function(e){return V&&V.add(e),e});let eb=new el("color"),eS=new el("float",es.float),eN=new el("int",es.int),e_=new el("uint",es.uint),ev=new el("bool",es.bool),eA=new el("vec2"),eR=new el("ivec2"),eC=new el("uvec2"),eE=new el("bvec2"),eB=new el("vec3"),eF=new el("ivec3"),ew=new el("uvec3"),eM=new el("bvec3"),eD=new el("vec4"),eI=new el("ivec4"),eO=new el("uvec4"),eU=new el("bvec4"),eL=new el("mat3"),eG=new el("imat3"),eV=new el("umat3"),eP=new el("bmat3"),ek=new el("mat4"),ez=new el("imat4"),eW=new el("umat4"),eH=new el("bmat4");k("color",eb),k("float",eS),k("int",eN),k("uint",e_),k("bool",ev),k("vec2",eA),k("ivec2",eR),k("uvec2",eC),k("bvec2",eE),k("vec3",eB),k("ivec3",eF),k("uvec3",ew),k("bvec3",eM),k("vec4",eD),k("ivec4",eI),k("uvec4",eO),k("bvec4",eU),k("mat3",eL),k("imat3",eG),k("umat3",eV),k("bmat3",eP),k("mat4",ek),k("imat4",ez),k("umat4",eW),k("bmat4",eH),k("string",function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return ec(new G(e,"string"))}),k("arrayBuffer",e=>ec(new G(e,"ArrayBuffer"))),k("element",eg(F)),k("convert",(e,t)=>ec(new w(ec(e),t)));class eq extends v{setGroup(e){return this.groupNode=e,this}getGroup(){return this.groupNode}getUniformHash(e){return this.getHash(e)}generate(e,t){let r=this.getNodeType(e),i=this.getUniformHash(e),s=e.getNodeFromHash(i);void 0===s&&(e.setHashNode(this,i),s=this);let n=s.getInputType(e),a=e.getUniformFromNode(s,n,e.shaderStage,e.context.label),o=e.getPropertyName(a);return void 0!==e.context.label&&delete e.context.label,e.format(o,r,t)}constructor(e,t=null){super(e,t),this.isUniformNode=!0,this.groupNode=B}}var ej=eq;let eX=(e,t)=>{let r=eu(t||e);return ec(new eq(e&&!0===e.isNode?e.node&&e.node.value||e.value:e,r))};N("UniformNode",eq);class eY extends ej{getNodeType(e){return this.nodes[0].getNodeType(e)}constructor(e=[]){super(),this.isArrayUniformNode=!0,this.nodes=e}}N("ArrayUniformNode",eY);class eZ extends D{hasDependencies(){return!1}getNodeType(e,t){return"void"!==t?this.targetNode.getNodeType(e):"void"}generate(e,t){let r=this.targetNode,i=this.sourceNode,s=r.getNodeType(e),n=r.build(e),a=i.build(e,s),o="".concat(n," = ").concat(a);if("void"===t){e.addLineFlowCode(o);return}return"void"===i.getNodeType(e)?(e.addLineFlowCode(o),n):e.format(o,s,t)}constructor(e,t){super(),this.targetNode=e,this.sourceNode=t}}let eK=eg(eZ);N("AssignNode",eZ),k("assign",eK);class eQ extends S{isGlobal(){return!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){let{name:t,node:r}=this,i=this.getNodeType(e),s=e.getVaryingFromNode(this,t,i);s.needsInterpolation||(s.needsInterpolation="fragment"===e.shaderStage);let n=e.getPropertyName(s,a.VERTEX);return e.flowNodeFromShaderStage(a.VERTEX,r,i,n),e.getPropertyName(s)}constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0}}let eJ=eg(eQ);k("varying",eJ),N("VaryingNode",eQ);class e$ extends S{isGlobal(){return!0}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=super.getNodeType(e);if(null===t){let r=this.getAttributeName(e);if(e.hasGeometryAttribute(r)){let i=e.geometry.getAttribute(r);t=e.getTypeFromAttribute(i)}else t="float"}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){let t=this.getAttributeName(e),r=this.getNodeType(e);if(!0!==e.hasGeometryAttribute(t))return console.warn('AttributeNode: Attribute "'.concat(t,'" not found.')),e.generateConst(r);{let i=e.geometry.getAttribute(t),s=e.getTypeFromAttribute(i),n=e.getAttribute(t,s);return"vertex"===e.shaderStage?e.format(n.name,s,r):eJ(this).build(e,r)}}constructor(e,t=null){super(t),this._attributeName=e}}var e0=e$;let e1=(e,t)=>ec(new e$(e,t));N("AttributeNode",e$);class e2 extends S{getNodeType(e){return this.outputNode.getNodeType(e)}generate(e){let t=this.callNode.build(e,"void");return""!==t&&e.addLineFlowCode(t),this.outputNode.build(e)}constructor(e,t){super(),this.isBypassNode=!0,this.outputNode=e,this.callNode=t}}let e3=eg(e2);k("bypass",e3),N("BypassNode",e2);let e4=0;class e8{getNodeData(e){return this.nodesData.get(e)}setNodeData(e,t){this.nodesData.set(e,t)}constructor(){this.id=e4++,this.nodesData=new WeakMap}}class e5 extends S{getNodeType(e){return this.node.getNodeType(e)}build(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];let s=e.getCache(),n=this.cache||e.globalCache;e.setCache(n);let a=this.node.build(e,...r);return e.setCache(s),a}constructor(e,t=new e8){super(),this.isCacheNode=!0,this.node=e,this.cache=t}}let e6=eg(e5);k("cache",e6),k("globalCache",e=>e6(e,null)),N("CacheNode",e5);class e9 extends S{getNodeType(e){return this.node.getNodeType(e)}setup(e){let t=e.getContext();e.setContext({...e.context,...this.context});let r=this.node.build(e);return e.setContext(t),r}generate(e,t){let r=e.getContext();e.setContext({...e.context,...this.context});let i=this.node.build(e,t);return e.setContext(r),i}constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.context=t}}var e7=e9;let te=eg(e9),tt=(e,t)=>te(e,{label:t});k("context",te),k("label",tt),N("ContextNode",e9);class tr extends S{generate(e){let t;let r=this.getNodeType(e),i=this.scope;if(i===tr.VERTEX)t=e.getVertexIndex();else if(i===tr.INSTANCE)t=e.getInstanceIndex();else throw Error("THREE.IndexNode: Unknown scope: "+i);return"vertex"===e.shaderStage||"compute"===e.shaderStage?t:eJ(this).build(e,r)}constructor(e){super("uint"),this.scope=e,this.isInstanceIndexNode=!0}}tr.VERTEX="vertex",tr.INSTANCE="instance";let ti=em(tr,tr.VERTEX),ts=em(tr,tr.INSTANCE);N("IndexNode",tr);class tn{start(){}finish(){}direct(){}indirectDiffuse(){}indirectSpecular(){}ambientOcclusion(){}}var ta=tn;class to extends S{isGlobal(){return!0}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){let{node:t,name:r}=this,i=e.getVarFromNode(this,r,e.getVectorType(this.getNodeType(e))),s=e.getPropertyName(i),n=t.build(e,i.type);return e.addLineFlowCode("".concat(s," = ").concat(n)),s}constructor(e,t=null){super(),this.node=e,this.name=t,this.isVarNode=!0}}let tl=eg(to);k("temp",tl),k("toVar",function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return tl(...t).append()}),N("VarNode",to);class tu{constructor(e,t,r=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=r}}class td{get value(){return this.node.value}set value(e){this.node.value=e}get id(){return this.node.id}get groupNode(){return this.node.groupNode}constructor(e,t,r,i){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=r.getSelf(),this.needsUpdate=i}}class tc{constructor(e,t){this.isNodeVar=!0,this.name=e,this.type=t}}var th=tc;class tp extends th{constructor(e,t){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0}}class tg{constructor(e,t,r=""){this.name=e,this.type=t,this.code=r,Object.defineProperty(this,"isNodeCode",{value:!0})}}class tm{getNode(e){let t=this.nodes[e];return void 0===t&&void 0!==this.keywordsCallback[e]&&(t=this.keywordsCallback[e](e),this.nodes[e]=t),t}addKeyword(e,t){return this.keywords.push(e),this.keywordsCallback[e]=t,this}parse(e){let t=this.keywords,r=RegExp("\\b".concat(t.join("\\b|\\b"),"\\b"),"g"),i=e.match(r),s=[];if(null!==i)for(let e of i){let t=this.getNode(e);void 0!==t&&-1===s.indexOf(t)&&s.push(t)}return s}include(e,t){for(let r of this.parse(t))r.build(e)}constructor(){this.keywords=[],this.nodes=[],this.keywordsCallback={}}}class tf extends S{getHash(e){return this.name||super.getHash(e)}isGlobal(){return!0}generate(e){let t;return!0===this.varying?(t=e.getVaryingFromNode(this,this.name)).needsInterpolation=!0:t=e.getVarFromNode(this,this.name),e.getPropertyName(t)}constructor(e,t=null,r=!1){super(e),this.name=t,this.varying=r,this.isPropertyNode=!0}}var tT=tf;let ty=(e,t)=>ec(new tf(e,t)),tx=(e,t)=>ec(new tf(e,t,!0)),tb=em(tf,"vec4","DiffuseColor"),tS=em(tf,"float","Roughness"),tN=em(tf,"float","Metalness"),t_=em(tf,"float","Clearcoat"),tv=em(tf,"float","ClearcoatRoughness"),tA=em(tf,"vec3","Sheen"),tR=em(tf,"float","SheenRoughness"),tC=em(tf,"float","Iridescence"),tE=em(tf,"float","IridescenceIOR"),tB=em(tf,"float","IridescenceThickness"),tF=em(tf,"color","SpecularColor"),tw=em(tf,"float","Shininess"),tM=em(tf,"vec4","Output"),tD=em(tf,"float","dashSize"),tI=em(tf,"float","gapSize");em(tf,"float","pointWidth"),N("PropertyNode",tf);class tO extends tT{getHash(){return this.uuid}generate(){return this.name}constructor(e,t=null){super(e,t),this.isParameterNode=!0}}N("ParameterNode",tO);class tU extends S{setIncludes(e){return this.includes=e,this}getIncludes(){return this.includes}generate(e){for(let t of this.getIncludes(e))t.build(e);let t=e.getCodeFromNode(this,this.getNodeType(e));return t.code=this.code,t.code}serialize(e){super.serialize(e),e.code=this.code,e.language=this.language}deserialize(e){super.deserialize(e),this.code=e.code,this.language=e.language}constructor(e="",t=[],r=""){super("code"),this.isCodeNode=!0,this.code=e,this.language=r,this.includes=t}}var tL=tU;eg(tU),N("CodeNode",tU);class tG extends tL{getNodeType(e){return this.getNodeFunction(e).type}getInputs(e){return this.getNodeFunction(e).inputs}getNodeFunction(e){let t=e.getDataFromNode(this),r=t.nodeFunction;return void 0===r&&(r=e.parser.parseFunction(this.code),t.nodeFunction=r),r}generate(e,t){super.generate(e);let r=this.getNodeFunction(e),i=r.name,s=r.type,n=e.getCodeFromNode(this,s);""!==i&&(n.name=i);let a=e.getPropertyName(n),o=this.getNodeFunction(e).getCode(a),l=this.keywords,u=Object.keys(l);if(u.length>0)for(let t of u){let r=RegExp("\\b".concat(t,"\\b"),"g"),i=l[t].build(e,"property");o=o.replace(r,i)}return(n.code=o+"\n","property"===t)?a:e.format("".concat(a,"()"),s,t)}constructor(e="",t=[],r=""){super(e,t,r),this.keywords={}}}N("FunctionNode",tG);class tV extends e0{getAttributeName(){let e=this.index;return"uv"+(e>0?e:"")}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}constructor(e=0){super(null,"vec2"),this.isUVNode=!0,this.index=e}}let tP=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return ec(new tV(...t))};N("UVNode",tV);class tk extends S{generate(e,t){let r=this.textureNode.build(e,"property"),i=this.levelNode.build(e,"int");return e.format("".concat(e.getMethod("textureDimensions"),"( ").concat(r,", ").concat(i," )"),this.getNodeType(e),t)}constructor(e,t=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}}let tz=eg(tk);k("textureSize",tz),N("TextureSizeNode",tk);class tW extends D{getNodeType(e,t){let r=this.op,i=this.aNode,s=this.bNode,n=i.getNodeType(e),a=s.getNodeType(e);if("void"===n||"void"===a)return"void";if("%"===r)return n;if("&"===r||"|"===r||"^"===r||">>"===r||"<<"===r)return e.getIntegerType(n);if("=="===r||"&&"===r||"||"===r||"^^"===r)return"bool";if("<"===r||">"===r||"<="===r||">="===r){let r=t?e.getTypeLength(t):Math.max(e.getTypeLength(n),e.getTypeLength(a));return r>1?"bvec".concat(r):"bool"}return"float"===n&&e.isMatrix(a)?a:e.isMatrix(n)&&e.isVector(a)?e.getVectorFromMatrix(n):e.isVector(n)&&e.isMatrix(a)?e.getVectorFromMatrix(a):e.getTypeLength(a)>e.getTypeLength(n)?a:n}generate(e,t){let r=this.op,i=this.aNode,s=this.bNode,n=this.getNodeType(e,t),a=null,o=null;"void"!==n?(a=i.getNodeType(e),o=s.getNodeType(e),"<"===r||">"===r||"<="===r||">="===r||"=="===r?e.isVector(a)?o=a:a=o="float":">>"===r||"<<"===r?(a=n,o=e.changeComponentType(o,"uint")):e.isMatrix(a)&&e.isVector(o)?o=e.getVectorFromMatrix(a):a=e.isVector(a)&&e.isMatrix(o)?e.getVectorFromMatrix(o):o=n):a=o=n;let l=i.build(e,a),u=s.build(e,o),d=e.getTypeLength(t),c=e.getFunctionOperator(r);if("void"!==t){if("<"===r&&d>1)return e.format("".concat(e.getMethod("lessThan"),"( ").concat(l,", ").concat(u," )"),n,t);if("<="===r&&d>1)return e.format("".concat(e.getMethod("lessThanEqual"),"( ").concat(l,", ").concat(u," )"),n,t);if(">"===r&&d>1)return e.format("".concat(e.getMethod("greaterThan"),"( ").concat(l,", ").concat(u," )"),n,t);if(">="===r&&d>1)return e.format("".concat(e.getMethod("greaterThanEqual"),"( ").concat(l,", ").concat(u," )"),n,t);else if(c)return e.format("".concat(c,"( ").concat(l,", ").concat(u," )"),n,t);else return e.format("( ".concat(l," ").concat(r," ").concat(u," )"),n,t)}if("void"!==a)return c?e.format("".concat(c,"( ").concat(l,", ").concat(u," )"),n,t):e.format("".concat(l," ").concat(r," ").concat(u),n,t)}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}constructor(e,t,r,...i){if(super(),this.op=e,i.length>0){let t=r;for(let r=0;r<i.length;r++)t=new tW(e,t,i[r]);r=t}this.aNode=t,this.bNode=r}}let tH=eg(tW,"+"),tq=eg(tW,"-"),tj=eg(tW,"*"),tX=eg(tW,"/"),tY=eg(tW,"%"),tZ=eg(tW,"=="),tK=eg(tW,"!="),tQ=eg(tW,"<"),tJ=eg(tW,">"),t$=eg(tW,"<="),t0=eg(tW,">="),t1=eg(tW,"&&"),t2=eg(tW,"||"),t3=eg(tW,"^^"),t4=eg(tW,"&"),t8=eg(tW,"|"),t5=eg(tW,"^"),t6=eg(tW,"<<"),t9=eg(tW,">>");k("add",tH),k("sub",tq),k("mul",tj),k("div",tX),k("remainder",tY),k("equal",tZ),k("notEqual",tK),k("lessThan",tQ),k("greaterThan",tJ),k("lessThanEqual",t$),k("greaterThanEqual",t0),k("and",t1),k("or",t2),k("xor",t3),k("bitAnd",t4),k("bitOr",t8),k("bitXor",t5),k("shiftLeft",t6),k("shiftRight",t9),N("OperatorNode",tW);class t7 extends D{getInputType(e){let t=this.aNode.getNodeType(e),r=this.bNode?this.bNode.getNodeType(e):null,i=this.cNode?this.cNode.getNodeType(e):null,s=e.isMatrix(t)?0:e.getTypeLength(t),n=e.isMatrix(r)?0:e.getTypeLength(r),a=e.isMatrix(i)?0:e.getTypeLength(i);if(s>n&&s>a);else if(n>a)return r;else if(a>s)return i;return t}getNodeType(e){let t=this.method;return t===t7.LENGTH||t===t7.DISTANCE||t===t7.DOT?"float":t===t7.CROSS?"vec3":this.getInputType(e)}generate(e,t){let r=this.method,i=this.getNodeType(e),s=this.getInputType(e),n=this.aNode,a=this.bNode,o=this.cNode,l=!0===e.renderer.isWebGLRenderer;if(r===t7.TRANSFORM_DIRECTION){let r=n,i=a;return e.isMatrix(r.getNodeType(e))?i=eD(eB(i),0):r=eD(eB(r),0),rh(tj(r,i).xyz).build(e,t)}if(r===t7.NEGATE)return e.format("( - "+n.build(e,s)+" )",i,t);if(r===t7.ONE_MINUS)return tq(1,n).build(e,t);{if(r===t7.RECIPROCAL)return tX(1,n).build(e,t);if(r===t7.DIFFERENCE)return rb(tq(n,a)).build(e,t);let u=[];return r===t7.CROSS?u.push(n.build(e,i),a.build(e,i)):r===t7.STEP?u.push(n.build(e,1===e.getTypeLength(n.getNodeType(e))?"float":s),a.build(e,s)):l&&(r===t7.MIN||r===t7.MAX)||r===t7.MOD?u.push(n.build(e,s),a.build(e,1===e.getTypeLength(a.getNodeType(e))?"float":s)):r===t7.REFRACT?u.push(n.build(e,s),a.build(e,s),o.build(e,"float")):r===t7.MIX?u.push(n.build(e,s),a.build(e,s),o.build(e,1===e.getTypeLength(o.getNodeType(e))?"float":s)):(u.push(n.build(e,s)),null!==a&&u.push(a.build(e,s)),null!==o&&u.push(o.build(e,s))),e.format("".concat(e.getMethod(r),"( ").concat(u.join(", ")," )"),i,t)}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}constructor(e,t,r=null,i=null){super(),this.method=e,this.aNode=t,this.bNode=r,this.cNode=i}}t7.RADIANS="radians",t7.DEGREES="degrees",t7.EXP="exp",t7.EXP2="exp2",t7.LOG="log",t7.LOG2="log2",t7.SQRT="sqrt",t7.INVERSE_SQRT="inversesqrt",t7.FLOOR="floor",t7.CEIL="ceil",t7.NORMALIZE="normalize",t7.FRACT="fract",t7.SIN="sin",t7.COS="cos",t7.TAN="tan",t7.ASIN="asin",t7.ACOS="acos",t7.ATAN="atan",t7.ABS="abs",t7.SIGN="sign",t7.LENGTH="length",t7.NEGATE="negate",t7.ONE_MINUS="oneMinus",t7.DFDX="dFdx",t7.DFDY="dFdy",t7.ROUND="round",t7.RECIPROCAL="reciprocal",t7.TRUNC="trunc",t7.FWIDTH="fwidth",t7.BITCAST="bitcast",t7.ATAN2="atan2",t7.MIN="min",t7.MAX="max",t7.MOD="mod",t7.STEP="step",t7.REFLECT="reflect",t7.DISTANCE="distance",t7.DIFFERENCE="difference",t7.DOT="dot",t7.CROSS="cross",t7.POW="pow",t7.TRANSFORM_DIRECTION="transformDirection",t7.MIX="mix",t7.CLAMP="clamp",t7.REFRACT="refract",t7.SMOOTHSTEP="smoothstep",t7.FACEFORWARD="faceforward";var re=t7;let rt=eS(1e-6);eS(1e6);let rr=eg(t7,t7.RADIANS),ri=eg(t7,t7.DEGREES),rs=eg(t7,t7.EXP),rn=eg(t7,t7.EXP2),ra=eg(t7,t7.LOG),ro=eg(t7,t7.LOG2),rl=eg(t7,t7.SQRT),ru=eg(t7,t7.INVERSE_SQRT),rd=eg(t7,t7.FLOOR),rc=eg(t7,t7.CEIL),rh=eg(t7,t7.NORMALIZE),rp=eg(t7,t7.FRACT),rg=eg(t7,t7.SIN),rm=eg(t7,t7.COS),rf=eg(t7,t7.TAN),rT=eg(t7,t7.ASIN),ry=eg(t7,t7.ACOS),rx=eg(t7,t7.ATAN),rb=eg(t7,t7.ABS),rS=eg(t7,t7.SIGN),rN=eg(t7,t7.LENGTH),r_=eg(t7,t7.NEGATE),rv=eg(t7,t7.ONE_MINUS),rA=eg(t7,t7.DFDX),rR=eg(t7,t7.DFDY),rC=eg(t7,t7.ROUND),rE=eg(t7,t7.RECIPROCAL),rB=eg(t7,t7.TRUNC),rF=eg(t7,t7.FWIDTH);eg(t7,t7.BITCAST);let rw=eg(t7,t7.ATAN2),rM=eg(t7,t7.MIN),rD=eg(t7,t7.MAX),rI=eg(t7,t7.MOD),rO=eg(t7,t7.STEP),rU=eg(t7,t7.REFLECT),rL=eg(t7,t7.DISTANCE),rG=eg(t7,t7.DIFFERENCE),rV=eg(t7,t7.DOT),rP=eg(t7,t7.CROSS),rk=eg(t7,t7.POW),rz=eg(t7,t7.POW,2),rW=eg(t7,t7.POW,3),rH=eg(t7,t7.POW,4),rq=eg(t7,t7.TRANSFORM_DIRECTION),rj=eg(t7,t7.MIX),rX=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return ec(new t7(t7.CLAMP,ec(e),ec(t),ec(r)))},rY=eg(t7,t7.REFRACT),rZ=eg(t7,t7.SMOOTHSTEP),rK=eg(t7,t7.FACEFORWARD);k("radians",rr),k("degrees",ri),k("exp",rs),k("exp2",rn),k("log",ra),k("log2",ro),k("sqrt",rl),k("inverseSqrt",ru),k("floor",rd),k("ceil",rc),k("normalize",rh),k("fract",rp),k("sin",rg),k("cos",rm),k("tan",rf),k("asin",rT),k("acos",ry),k("atan",rx),k("abs",rb),k("sign",rS),k("length",rN),k("negate",r_),k("oneMinus",rv),k("dFdx",rA),k("dFdy",rR),k("round",rC),k("reciprocal",rE),k("trunc",rB),k("fwidth",rF),k("atan2",rw),k("min",rM),k("max",rD),k("mod",rI),k("step",rO),k("reflect",rU),k("distance",rL),k("dot",rV),k("cross",rP),k("pow",rk),k("pow2",rz),k("pow3",rW),k("pow4",rH),k("transformDirection",rq),k("mix",(e,t,r)=>rj(t,r,e)),k("clamp",rX),k("refract",rY),k("smoothstep",(e,t,r)=>rZ(t,r,e)),k("faceForward",rK),k("difference",rG),k("saturate",e=>rX(e)),N("MathNode",t7);let rQ=ef(e=>{let{value:t}=e,{rgb:r}=t;return eD(rj(r.mul(.9478672986).add(.0521327014).pow(2.4),r.mul(.0773993808),r.lessThanEqual(.04045)),t.a)}),rJ=ef(e=>{let{value:t}=e,{rgb:r}=t;return eD(rj(r.pow(.41666).mul(1.055).sub(.055),r.mul(12.92),r.lessThanEqual(.0031308)),t.a)}),r$=e=>{let t=null;return e===c.LinearSRGBColorSpace?t="Linear":e===c.SRGBColorSpace&&(t="sRGB"),t},r0=(e,t)=>r$(e)+"To"+r$(t);class r1 extends D{setup(){let{method:e,node:t}=this;return e===r1.LINEAR_TO_LINEAR?t:r2[e]({value:t})}constructor(e,t){super("vec4"),this.method=e,this.node=t}}r1.LINEAR_TO_LINEAR="LinearToLinear",r1.LINEAR_TO_sRGB="LinearTosRGB",r1.sRGB_TO_LINEAR="sRGBToLinear";let r2={[r1.LINEAR_TO_sRGB]:rJ,[r1.sRGB_TO_LINEAR]:rQ},r3=(e,t)=>ec(new r1(r0(t,c.LinearSRGBColorSpace),ec(e))),r4=eg(r1,r1.LINEAR_TO_sRGB),r8=eg(r1,r1.sRGB_TO_LINEAR);k("linearTosRGB",r4),k("sRGBToLinear",r8),k("linearToColorSpace",(e,t)=>ec(new r1(r0(c.LinearSRGBColorSpace,t),ec(e)))),k("colorSpaceToLinear",r3),N("ColorSpaceNode",r1);class r5 extends S{generate(e,t){let r=this.getNodeType(e),i=this.snippet;if("void"!==r)return e.format("( ".concat(i," )"),r,t);e.addLineFlowCode(i)}constructor(e="",t="void"){super(t),this.snippet=e}}let r6=eg(r5);N("ExpressionNode",r5);class r9 extends ej{get texture(){return this.textureNode.value}update(){let e=this.texture,t=e.images,r=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(r&&void 0!==r.width){let{width:e,height:t}=r;this.value=Math.log2(Math.max(e,t))}}constructor(e){super(0),this.textureNode=e,this.updateType=o.FRAME}}let r7=eg(r9);N("MaxMipLevelNode",r9);class ie extends ej{getUniformHash(){return this.value.uuid}getNodeType(){return!0===this.value.isDepthTexture?"float":"vec4"}getInputType(){return"texture"}getDefaultUV(){return tP(this.value.channel)}updateReference(){return this.value}getTransformedUV(e){return eX(this.value.matrix).mul(eB(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this.updateType=e?o.FRAME:o.NONE,this}setupUV(e,t){let r=this.value;return e.isFlipY()&&(!0===r.isRenderTargetTexture||!0===r.isFramebufferTexture||!0===r.isDepthTexture)&&(t=t.setY(t.y.oneMinus())),t}setup(e){let t=e.getNodeProperties(this),r=this.uvNode;(null===r||!0===e.context.forceUVContext)&&e.context.getUV&&(r=e.context.getUV(this)),r||(r=this.getDefaultUV()),!0===this.updateMatrix&&(r=this.getTransformedUV(r)),r=this.setupUV(e,r);let i=this.levelNode;null===i&&e.context.getTextureLevel&&(i=e.context.getTextureLevel(this)),null!==i&&void 0!==e.context.getTextureLevelAlgorithm&&(i=e.context.getTextureLevelAlgorithm(this,i)),t.uvNode=r,t.levelNode=i,t.compareNode=this.compareNode,t.depthNode=this.depthNode}generateUV(e,t){return t.build(e,!0===this.sampler?"vec2":"ivec2")}generateSnippet(e,t,r,i,s,n){let a=this.value;return i?e.generateTextureLevel(a,t,r,i,s):n?e.generateTextureCompare(a,t,r,n,s):!1===this.sampler?e.generateTextureLoad(a,t,r,s):e.generateTexture(a,t,r,s)}generate(e,t){let r=e.getNodeProperties(this),i=this.value;if(!i||!0!==i.isTexture)throw Error("TextureNode: Need a three.js texture.");let s=super.generate(e,"property");if("sampler"===t)return s+"_sampler";if(e.isReference(t))return s;{let n=e.getDataFromNode(this),a=n.propertyName;if(void 0===a){let{uvNode:t,levelNode:i,compareNode:o,depthNode:l}=r,u=this.generateUV(e,t),d=i?i.build(e,"float"):null,c=l?l.build(e,"int"):null,h=o?o.build(e,"float"):null,p=e.getVarFromNode(this);a=e.getPropertyName(p);let g=this.generateSnippet(e,s,u,d,c,h);e.addLineFlowCode("".concat(a," = ").concat(g)),!1!==e.context.tempWrite&&(n.snippet=g,n.propertyName=a)}let o=a,l=this.getNodeType(e);return e.needsColorSpaceToLinear(i)&&(o=r3(r6(o,l),i.colorSpace).setup(e).build(e,l)),e.format(o,l,t)}}setSampler(e){return this.sampler=e,this}getSampler(){return this.sampler}uv(e){let t=this.clone();return t.uvNode=e,ec(t)}blur(e){let t=this.clone();return t.levelNode=e.mul(r7(t)),ec(t)}level(e){let t=this.clone();return t.levelNode=e,t}size(e){return tz(this,e)}compare(e){let t=this.clone();return t.compareNode=ec(e),ec(t)}depth(e){let t=this.clone();return t.depthNode=ec(e),ec(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value]}update(){let e=this.value;!0===e.matrixAutoUpdate&&e.updateMatrix()}clone(){let e=new this.constructor(this.value,this.uvNode,this.levelNode);return e.sampler=this.sampler,e}constructor(e,t=null,r=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=r,this.compareNode=null,this.depthNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=o.NONE,this.setUpdateMatrix(null===t)}}var it=ie;let ir=eg(ie),ii=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return ir(...t).setSampler(!1)};k("texture",ir),N("TextureNode",ie);class is extends S{updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setIndex(e){return this.index=e,this}getIndex(){return this.index}setNodeType(e){let t=null;t="texture"===e?ir(null):eX(e),this.node=t}getNodeType(e){return this.node.getNodeType(e)}update(){let e=this.reference[this.property];null!==this.index&&(e=e[this.index]),this.node.value=e}setup(){return this.node}constructor(e,t,r=null){super(),this.property=e,this.index=null,this.uniformType=t,this.object=r,this.reference=null,this.node=null,this.updateType=o.OBJECT,this.setNodeType(t)}}var ia=is;let io=(e,t,r)=>ec(new is(e,t,r)),il=(e,t,r,i)=>ec(new is(e,r,i).setIndex(t));N("ReferenceNode",is);class iu extends ia{updateReference(e){return this.reference=null!==this.material?this.material:e.material,this.reference}setup(e){let t=null!==this.material?this.material:e.material;return this.node.value=t[this.property],super.setup(e)}constructor(e,t,r=null){super(e,t,r),this.material=r}}let id=(e,t,r)=>ec(new iu(e,t,r));N("MaterialReferenceNode",iu);class ic extends S{getNodeType(){let e=this.scope;return e===ic.WORLD_MATRIX||e===ic.VIEW_MATRIX?"mat4":e===ic.NORMAL_MATRIX?"mat3":e===ic.POSITION||e===ic.VIEW_POSITION||e===ic.DIRECTION||e===ic.SCALE?"vec3":void 0}update(e){let t=this.object3d,r=this._uniformNode,i=this.scope;if(i===ic.VIEW_MATRIX)r.value=t.modelViewMatrix;else if(i===ic.NORMAL_MATRIX)r.value=t.normalMatrix;else if(i===ic.WORLD_MATRIX)r.value=t.matrixWorld;else if(i===ic.POSITION)r.value=r.value||new c.Vector3,r.value.setFromMatrixPosition(t.matrixWorld);else if(i===ic.SCALE)r.value=r.value||new c.Vector3,r.value.setFromMatrixScale(t.matrixWorld);else if(i===ic.DIRECTION)r.value=r.value||new c.Vector3,t.getWorldDirection(r.value);else if(i===ic.VIEW_POSITION){let i=e.camera;r.value=r.value||new c.Vector3,r.value.setFromMatrixPosition(t.matrixWorld),r.value.applyMatrix4(i.matrixWorldInverse)}}generate(e){let t=this.scope;return t===ic.WORLD_MATRIX||t===ic.VIEW_MATRIX?this._uniformNode.nodeType="mat4":t===ic.NORMAL_MATRIX?this._uniformNode.nodeType="mat3":(t===ic.POSITION||t===ic.VIEW_POSITION||t===ic.DIRECTION||t===ic.SCALE)&&(this._uniformNode.nodeType="vec3"),this._uniformNode.build(e)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}constructor(e=ic.VIEW_MATRIX,t=null){super(),this.scope=e,this.object3d=t,this.updateType=o.OBJECT,this._uniformNode=new ej(null)}}ic.VIEW_MATRIX="viewMatrix",ic.NORMAL_MATRIX="normalMatrix",ic.WORLD_MATRIX="worldMatrix",ic.POSITION="position",ic.SCALE="scale",ic.VIEW_POSITION="viewPosition",ic.DIRECTION="direction";var ih=ic;eg(ic,ic.DIRECTION),eg(ic,ic.VIEW_MATRIX),eg(ic,ic.NORMAL_MATRIX),eg(ic,ic.WORLD_MATRIX);let ip=eg(ic,ic.POSITION);eg(ic,ic.SCALE);let ig=eg(ic,ic.VIEW_POSITION);N("Object3DNode",ic);class im extends ih{getNodeType(e){let t=this.scope;return t===im.PROJECTION_MATRIX?"mat4":t===im.NEAR||t===im.FAR||t===im.LOG_DEPTH?"float":super.getNodeType(e)}update(e){let t=e.camera,r=this._uniformNode,i=this.scope;i===im.VIEW_MATRIX?r.value=t.matrixWorldInverse:i===im.PROJECTION_MATRIX?r.value=t.projectionMatrix:i===im.NEAR?r.value=t.near:i===im.FAR?r.value=t.far:i===im.LOG_DEPTH?r.value=2/(Math.log(t.far+1)/Math.LN2):(this.object3d=t,super.update(e))}generate(e){let t=this.scope;return t===im.PROJECTION_MATRIX?this._uniformNode.nodeType="mat4":(t===im.NEAR||t===im.FAR||t===im.LOG_DEPTH)&&(this._uniformNode.nodeType="float"),super.generate(e)}constructor(e=im.POSITION){super(e),this.updateType=o.RENDER}}im.PROJECTION_MATRIX="projectionMatrix",im.NEAR="near",im.FAR="far",im.LOG_DEPTH="logDepth";let iT=tt(em(im,im.PROJECTION_MATRIX),"projectionMatrix"),iy=em(im,im.NEAR),ix=em(im,im.FAR),ib=em(im,im.LOG_DEPTH),iS=em(im,im.VIEW_MATRIX);em(im,im.NORMAL_MATRIX),em(im,im.WORLD_MATRIX),em(im,im.POSITION),N("CameraNode",im);class iN extends ih{update(e){this.object3d=e.object,super.update(e)}constructor(e=iN.VIEW_MATRIX){super(e)}}em(iN,iN.DIRECTION);let i_=em(iN,iN.VIEW_MATRIX).label("modelViewMatrix").temp("ModelViewMatrix"),iv=em(iN,iN.NORMAL_MATRIX),iA=em(iN,iN.WORLD_MATRIX);em(iN,iN.POSITION),em(iN,iN.SCALE),em(iN,iN.VIEW_POSITION),N("ModelNode",iN);class iR extends S{isGlobal(){return!0}getHash(){return"normal-".concat(this.scope)}generate(e){let t=this.scope,r=null;return t===iR.GEOMETRY?r=e1("normal","vec3"):t===iR.LOCAL?r=eJ(iC):t===iR.VIEW?r=rh(eJ(iv.mul(iE))):t===iR.WORLD&&(r=rh(eJ(iB.transformDirection(iS)))),r.build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}constructor(e=iR.LOCAL){super("vec3"),this.scope=e}}iR.GEOMETRY="geometry",iR.LOCAL="local",iR.VIEW="view",iR.WORLD="world";let iC=em(iR,iR.GEOMETRY),iE=em(iR,iR.LOCAL).temp("Normal"),iB=em(iR,iR.VIEW),iF=em(iR,iR.WORLD),iw=ty("vec3","TransformedNormalView"),iM=iw.transformDirection(iS).normalize(),iD=ty("vec3","TransformedClearcoatNormalView");N("NormalNode",iR);let iI=new Map;class iO extends S{getCache(e,t){let r=iI.get(e);return void 0===r&&(r=id(e,t),iI.set(e,r)),r}getFloat(e){return this.getCache(e,"float")}getColor(e){return this.getCache(e,"color")}getTexture(e){return this.getCache("map"===e?"map":e+"Map","texture")}setup(e){let t=e.context.material,r=this.scope,i=null;if(r===iO.COLOR){let e=this.getColor(r);i=t.map&&!0===t.map.isTexture?e.mul(this.getTexture("map")):e}else if(r===iO.OPACITY){let e=this.getFloat(r);i=t.alphaMap&&!0===t.alphaMap.isTexture?e.mul(this.getTexture("alpha")):e}else if(r===iO.SPECULAR_STRENGTH)i=t.specularMap&&!0===t.specularMap.isTexture?this.getTexture(r).r:eS(1);else if(r===iO.ROUGHNESS){let e=this.getFloat(r);i=t.roughnessMap&&!0===t.roughnessMap.isTexture?e.mul(this.getTexture(r).g):e}else if(r===iO.METALNESS){let e=this.getFloat(r);i=t.metalnessMap&&!0===t.metalnessMap.isTexture?e.mul(this.getTexture(r).b):e}else if(r===iO.EMISSIVE){let e=this.getColor(r);i=t.emissiveMap&&!0===t.emissiveMap.isTexture?e.mul(this.getTexture(r)):e}else if(r===iO.NORMAL)i=t.normalMap?this.getTexture("normal").normalMap(this.getCache("normalScale","vec2")):t.bumpMap?this.getTexture("bump").r.bumpMap(this.getFloat("bumpScale")):iB;else if(r===iO.CLEARCOAT){let e=this.getFloat(r);i=t.clearcoatMap&&!0===t.clearcoatMap.isTexture?e.mul(this.getTexture(r).r):e}else if(r===iO.CLEARCOAT_ROUGHNESS){let e=this.getFloat(r);i=t.clearcoatRoughnessMap&&!0===t.clearcoatRoughnessMap.isTexture?e.mul(this.getTexture(r).r):e}else if(r===iO.CLEARCOAT_NORMAL)i=t.clearcoatNormalMap?this.getTexture(r).normalMap(this.getCache(r+"Scale","vec2")):iB;else if(r===iO.SHEEN){let e=this.getColor("sheenColor").mul(this.getFloat("sheen"));i=t.sheenColorMap&&!0===t.sheenColorMap.isTexture?e.mul(this.getTexture("sheenColor").rgb):e}else if(r===iO.SHEEN_ROUGHNESS){let e=this.getFloat(r);i=(i=t.sheenRoughnessMap&&!0===t.sheenRoughnessMap.isTexture?e.mul(this.getTexture(r).a):e).clamp(.07,1)}else if(r===iO.IRIDESCENCE_THICKNESS){let e=io(1,"float",t.iridescenceThicknessRange);if(t.iridescenceThicknessMap){let s=io(0,"float",t.iridescenceThicknessRange);i=e.sub(s).mul(this.getTexture(r).g).add(s)}else i=e}else{let t=this.getNodeType(e);i=this.getCache(r,t)}return i}constructor(e){super(),this.scope=e}}iO.ALPHA_TEST="alphaTest",iO.COLOR="color",iO.OPACITY="opacity",iO.SHININESS="shininess",iO.SPECULAR_COLOR="specular",iO.SPECULAR_STRENGTH="specularStrength",iO.REFLECTIVITY="reflectivity",iO.ROUGHNESS="roughness",iO.METALNESS="metalness",iO.NORMAL="normal",iO.CLEARCOAT="clearcoat",iO.CLEARCOAT_ROUGHNESS="clearcoatRoughness",iO.CLEARCOAT_NORMAL="clearcoatNormal",iO.EMISSIVE="emissive",iO.ROTATION="rotation",iO.SHEEN="sheen",iO.SHEEN_ROUGHNESS="sheenRoughness",iO.IRIDESCENCE="iridescence",iO.IRIDESCENCE_IOR="iridescenceIOR",iO.IRIDESCENCE_THICKNESS="iridescenceThickness",iO.LINE_SCALE="scale",iO.LINE_DASH_SIZE="dashSize",iO.LINE_GAP_SIZE="gapSize",iO.LINE_WIDTH="linewidth",iO.LINE_DASH_OFFSET="dashOffset",iO.POINT_WIDTH="pointWidth";let iU=em(iO,iO.ALPHA_TEST),iL=em(iO,iO.COLOR),iG=em(iO,iO.SHININESS),iV=em(iO,iO.EMISSIVE),iP=em(iO,iO.OPACITY),ik=em(iO,iO.SPECULAR_COLOR),iz=em(iO,iO.SPECULAR_STRENGTH);em(iO,iO.REFLECTIVITY);let iW=em(iO,iO.ROUGHNESS),iH=em(iO,iO.METALNESS),iq=em(iO,iO.NORMAL),ij=em(iO,iO.CLEARCOAT),iX=em(iO,iO.CLEARCOAT_ROUGHNESS),iY=em(iO,iO.CLEARCOAT_NORMAL),iZ=em(iO,iO.ROTATION),iK=em(iO,iO.SHEEN),iQ=em(iO,iO.SHEEN_ROUGHNESS),iJ=em(iO,iO.IRIDESCENCE),i$=em(iO,iO.IRIDESCENCE_IOR),i0=em(iO,iO.IRIDESCENCE_THICKNESS),i1=em(iO,iO.LINE_SCALE),i2=em(iO,iO.LINE_DASH_SIZE),i3=em(iO,iO.LINE_GAP_SIZE),i4=em(iO,iO.LINE_WIDTH),i8=em(iO,iO.LINE_DASH_OFFSET),i5=em(iO,iO.POINT_WIDTH);N("MaterialNode",iO);class i6 extends S{isGlobal(){return!0}getHash(){return"position-".concat(this.scope)}generate(e){let t=this.scope,r=null;return t===i6.GEOMETRY?r=e1("position","vec3"):t===i6.LOCAL?r=eJ(i9):t===i6.WORLD?r=eJ(iA.mul(i7)):t===i6.VIEW?r=eJ(i_.mul(i7)):t===i6.VIEW_DIRECTION?r=rh(eJ(sr.negate())):t===i6.WORLD_DIRECTION&&(r=rh(eJ(i7.transformDirection(iA)))),r.build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}constructor(e=i6.LOCAL){super("vec3"),this.scope=e}}i6.GEOMETRY="geometry",i6.LOCAL="local",i6.WORLD="world",i6.WORLD_DIRECTION="worldDirection",i6.VIEW="view",i6.VIEW_DIRECTION="viewDirection";let i9=em(i6,i6.GEOMETRY),i7=em(i6,i6.LOCAL).temp("Position"),se=em(i6,i6.WORLD),st=em(i6,i6.WORLD_DIRECTION),sr=em(i6,i6.VIEW),si=em(i6,i6.VIEW_DIRECTION);N("PositionNode",i6);class ss extends D{setup(e){if("fragment"===e.shaderStage)return eJ(e.context.mvp);let t=this.positionNode||i7;return iT.mul(i_).mul(t)}constructor(e=null){super("vec4"),this.positionNode=e}}let sn=eg(ss);N("ModelViewProjectionNode",ss);class sa extends v{getNodeType(e){return null===this.bufferType&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(null!==this.attribute)return;let t=this.getNodeType(e),r=this.value,i=e.getTypeLength(t),s=this.bufferStride||i,n=this.bufferOffset,a=!0===r.isInterleavedBuffer?r:new c.InterleavedBuffer(r,s),o=new c.InterleavedBufferAttribute(a,i,n);a.setUsage(this.usage),this.attribute=o,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){let t=this.getNodeType(e),r=e.getBufferAttributeFromNode(this,t),i=e.getPropertyName(r);return"vertex"===e.shaderStage?i:eJ(this).build(e,t)}getInputType(){return"bufferAttribute"}setUsage(e){return this.usage=e,this}setInstanced(e){return this.instanced=e,this}constructor(e,t=null,r=0,i=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=r,this.bufferOffset=i,this.usage=c.StaticDrawUsage,this.instanced=!1,this.attribute=null,e&&!0===e.isBufferAttribute&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}}let so=(e,t,r,i)=>ec(new sa(e,t,r,i)),sl=(e,t,r,i)=>so(e,t,r,i).setUsage(c.DynamicDrawUsage),su=(e,t,r,i)=>so(e,t,r,i).setInstanced(!0),sd=(e,t,r,i)=>sl(e,t,r,i).setInstanced(!0);k("toAttribute",e=>so(e.value)),N("BufferAttributeNode",sa);class sc extends S{setup(){let e=this.instanceMatrixNode;if(null===e){let t=this.instanceMesh.instanceMatrix,r=new c.InstancedInterleavedBuffer(t.array,16,1),i=t.usage===c.DynamicDrawUsage?sd:su;e=ek(...[i(r,"vec4",16,0),i(r,"vec4",16,4),i(r,"vec4",16,8),i(r,"vec4",16,12)]),this.instanceMatrixNode=e}let t=e.mul(i7).xyz,r=eL(e[0].xyz,e[1].xyz,e[2].xyz),i=iE.div(eB(r[0].dot(r[0]),r[1].dot(r[1]),r[2].dot(r[2]))),s=r.mul(i).xyz;i7.assign(t),iE.assign(s)}constructor(e){super("void"),this.instanceMesh=e,this.instanceMatrixNode=null}}let sh=eg(sc);N("InstanceNode",sc);class sp extends ej{getInputType(){return"buffer"}constructor(e,t,r=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=r}}var sg=sp;let sm=(e,t,r)=>ec(new sp(e,t,r));N("BufferNode",sp);class sf extends S{getHash(){return"tangent-".concat(this.scope)}getNodeType(){return this.scope===sf.GEOMETRY?"vec4":"vec3"}generate(e){let t=this.scope,r=null;return t===sf.GEOMETRY?r=e1("tangent","vec4"):t===sf.LOCAL?r=eJ(sT.xyz):t===sf.VIEW?r=rh(eJ(i_.mul(sy).xyz)):t===sf.WORLD&&(r=rh(eJ(sx.transformDirection(iS)))),r.build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}constructor(e=sf.LOCAL){super(),this.scope=e}}sf.GEOMETRY="geometry",sf.LOCAL="local",sf.VIEW="view",sf.WORLD="world";let sT=em(sf,sf.GEOMETRY),sy=em(sf,sf.LOCAL),sx=em(sf,sf.VIEW),sb=em(sf,sf.WORLD),sS=tl(sx,"TransformedTangentView");rh(sS.transformDirection(iS)),N("TangentNode",sf);class sN extends S{setup(e){let{skinIndexNode:t,skinWeightNode:r,bindMatrixNode:i,bindMatrixInverseNode:s,boneMatricesNode:n}=this,a=n.element(t.x),o=n.element(t.y),l=n.element(t.z),u=n.element(t.w),d=i.mul(i7),c=tH(a.mul(r.x).mul(d),o.mul(r.y).mul(d),l.mul(r.z).mul(d),u.mul(r.w).mul(d)),h=s.mul(c).xyz,p=tH(r.x.mul(a),r.y.mul(o),r.z.mul(l),r.w.mul(u)),g=(p=s.mul(p).mul(i)).transformDirection(iE).xyz;i7.assign(h),iE.assign(g),e.hasGeometryAttribute("tangent")&&sy.assign(g)}generate(e,t){if("void"!==t)return i7.build(e,t)}update(){this.skinnedMesh.skeleton.update()}constructor(e){super("void"),this.skinnedMesh=e,this.updateType=o.OBJECT,this.skinIndexNode=e1("skinIndex","uvec4"),this.skinWeightNode=e1("skinWeight","vec4"),this.bindMatrixNode=eX(e.bindMatrix,"mat4"),this.bindMatrixInverseNode=eX(e.bindMatrixInverse,"mat4"),this.boneMatricesNode=sm(e.skeleton.boneMatrices,"mat4",e.skeleton.bones.length)}}let s_=eg(sN);N("SkinningNode",sN);let sv=new WeakMap,sA=new c.Vector4,sR=ef(e=>{let{bufferMap:t,influence:r,stride:i,width:s,depth:n,offset:a}=e,o=eN(ti).mul(i).add(a),l=o.div(s);return ii(t,eR(o.sub(l.mul(s)),l)).depth(n).mul(r)});class sC extends S{setup(e){let{geometry:t}=e,r=void 0!==t.morphAttributes.position,i=void 0!==t.morphAttributes.normal,s=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,n=void 0!==s?s.length:0,{texture:a,stride:o,size:l}=function(e){let t=void 0!==e.morphAttributes.position,r=void 0!==e.morphAttributes.normal,i=void 0!==e.morphAttributes.color,s=e.morphAttributes.position||e.morphAttributes.normal||e.morphAttributes.color,n=void 0!==s?s.length:0,a=sv.get(e);if(void 0===a||a.count!==n){void 0!==a&&a.texture.dispose();let s=e.morphAttributes.position||[],o=e.morphAttributes.normal||[],l=e.morphAttributes.color||[],u=0;!0===t&&(u=1),!0===r&&(u=2),!0===i&&(u=3);let d=e.attributes.position.count*u,h=1;d>4096&&(h=Math.ceil(d/4096),d=4096);let p=new Float32Array(d*h*4*n),g=new c.DataArrayTexture(p,d,h,n);g.type=c.FloatType,g.needsUpdate=!0;let m=4*u;for(let e=0;e<n;e++){let n=s[e],a=o[e],u=l[e],c=d*h*4*e;for(let e=0;e<n.count;e++){let s=e*m;!0===t&&(sA.fromBufferAttribute(n,e),p[c+s+0]=sA.x,p[c+s+1]=sA.y,p[c+s+2]=sA.z,p[c+s+3]=0),!0===r&&(sA.fromBufferAttribute(a,e),p[c+s+4]=sA.x,p[c+s+5]=sA.y,p[c+s+6]=sA.z,p[c+s+7]=0),!0===i&&(sA.fromBufferAttribute(u,e),p[c+s+8]=sA.x,p[c+s+9]=sA.y,p[c+s+10]=sA.z,p[c+s+11]=4===u.itemSize?sA.w:1)}}a={count:n,texture:g,stride:u,size:new c.Vector2(d,h)},sv.set(e,a),e.addEventListener("dispose",function t(){g.dispose(),sv.delete(e),e.removeEventListener("dispose",t)})}return a}(t);!0===r&&i7.mulAssign(this.morphBaseInfluence),!0===i&&iE.mulAssign(this.morphBaseInfluence);let u=eN(l.width);for(let e=0;e<n;e++){let t=il("morphTargetInfluences",e,"float"),s=eN(e);!0===r&&i7.addAssign(sR({bufferMap:a,influence:t,stride:o,width:u,depth:s,offset:eN(0)})),!0===i&&iE.addAssign(sR({bufferMap:a,influence:t,stride:o,width:u,depth:s,offset:eN(1)}))}}update(){let e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce((e,t)=>e+t,0)}constructor(e){super("void"),this.mesh=e,this.morphBaseInfluence=eX(1),this.updateType=o.OBJECT}}let sE=eg(sC);N("MorphNode",sC);class sB extends S{getHash(){return"reflectVector"}setup(){return si.negate().reflect(iw).transformDirection(iS)}constructor(){super("vec3")}}let sF=em(sB);N("ReflectVectorNode",sB);class sw extends it{getInputType(){return"cubeTexture"}getDefaultUV(){return sF}setUpdateMatrix(){}setupUV(e,t){return eB(t.x.negate(),t.yz)}generateUV(e,t){return t.build(e,"vec3")}constructor(e,t=null,r=null){super(e,t,r),this.isCubeTextureNode=!0}}let sM=eg(sw);k("cubeTexture",sM),N("CubeTextureNode",sw);class sD extends S{generate(){console.warn("Abstract function.")}constructor(){super("vec3")}}var sI=sD;N("LightingNode",sD);let sO=null;class sU extends sI{getCacheKey(){return super.getCacheKey()+"-"+this.light.id+"-"+(this.light.castShadow?"1":"0")}getHash(){return this.light.uuid}setupShadow(e){let t=this.shadowNode;if(null===t){var r,i;null===sO&&(sO=e.createNodeMaterial("MeshBasicNodeMaterial"));let s=this.light.shadow,n=e.getRenderTarget(s.mapSize.width,s.mapSize.height),a=new c.DepthTexture;a.minFilter=c.NearestFilter,a.magFilter=c.NearestFilter,a.image.width=s.mapSize.width,a.image.height=s.mapSize.height,a.compareFunction=c.LessCompare,n.depthTexture=a,s.camera.updateProjectionMatrix();let l=io("bias","float",s),u=io("normalBias","float",s),d=eX(s.matrix).mul(se.add(iF.mul(u))),h=(d=d.xyz.div(d.w)).x.greaterThanEqual(0).and(d.x.lessThanEqual(1)).and(d.y.greaterThanEqual(0)).and(d.y.lessThanEqual(1)).and(d.z.lessThanEqual(1)),p=d.z.add(l);e.renderer.coordinateSystem===c.WebGPUCoordinateSystem&&(p=p.mul(2).sub(1)),r=(d=eB(d.x,d.y.oneMinus(),p)).xy,i=d.z,t=ir(a,r).compare(i),this.rtt=n,this.colorNode=this.colorNode.mul(h.mix(1,t)),this.shadowNode=t,this.updateBeforeType=o.RENDER}}setup(e){this.light.castShadow?this.setupShadow(e):null!==this.shadowNode&&this.disposeShadow()}updateShadow(e){let{rtt:t,light:r}=this,{renderer:i,scene:s}=e,n=s.overrideMaterial;s.overrideMaterial=sO,t.setSize(r.shadow.mapSize.width,r.shadow.mapSize.height),r.shadow.updateMatrices(r);let a=i.getRenderTarget(),o=i.getRenderObjectFunction();i.setRenderObjectFunction(function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),s=1;s<t;s++)r[s-1]=arguments[s];!0===e.castShadow&&i.renderObject(e,...r)}),i.setRenderTarget(t),i.render(s,r.shadow.camera),i.setRenderTarget(a),i.setRenderObjectFunction(o),s.overrideMaterial=n}disposeShadow(){this.rtt.dispose(),this.shadowNode=null,this.rtt=null,this.colorNode=this._defaultColorNode}updateBefore(e){let{light:t}=this;t.castShadow&&this.updateShadow(e)}update(){let{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}constructor(e=null){super(),this.updateType=o.FRAME,this.light=e,this.rtt=null,this.shadowNode=null,this.color=new c.Color,this._defaultColorNode=eX(this.color),this.colorNode=this._defaultColorNode,this.isAnalyticLightNode=!0}}var sL=sU;N("AnalyticLightNode",sU);let sG=new WeakMap,sV=e=>e.sort((e,t)=>e.id-t.id);class sP extends S{get hasLight(){return this.lightNodes.length>0}getHash(){if(null===this._hash){let e=[];for(let t of this.lightNodes)e.push(t.getHash());this._hash="lights-"+e.join(",")}return this._hash}setup(e){let t=e.context,r=t.lightingModel,i=this.outgoingLightNode;if(r){let{lightNodes:s,totalDiffuseNode:n,totalSpecularNode:a}=this;t.outgoingLight=i;let o=e.addStack();for(let i of(r.start(t,o,e),s))i.build(e);r.indirectDiffuse(t,o,e),r.indirectSpecular(t,o,e),r.ambientOcclusion(t,o,e);let{backdrop:l,backdropAlpha:u}=t,{directDiffuse:d,directSpecular:c,indirectDiffuse:h,indirectSpecular:p}=t.reflectedLight,g=d.add(h);null!==l&&(g=eB(null!==u?u.mix(g,l):l)),n.assign(g),a.assign(c.add(p)),i.assign(n.add(a)),r.finish(t,o,e),i=i.bypass(e.removeStack())}return i}_getLightNodeById(e){for(let t of this.lightNodes)if(t.isAnalyticLightNode&&t.light.id===e)return t;return null}fromLights(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=[];for(let r of e=sV(e)){let e=this._getLightNodeById(r.id);if(null===e){let t=r.constructor;e=ec(new(sG.has(t)?sG.get(t):sL)(r))}t.push(e)}return this.lightNodes=t,this._hash=null,this}constructor(e=[]){super("vec3"),this.totalDiffuseNode=eB().temp("totalDiffuse"),this.totalSpecularNode=eB().temp("totalSpecular"),this.outgoingLightNode=eB().temp("outgoingLight"),this.lightNodes=e,this._hash=null}}var sk=sP;let sz=eg(sP);function sW(e,t){if(sG.has(e)){console.warn("Redefinition of light node ".concat(t.type));return}if("function"!=typeof e)throw Error("Light ".concat(e.name," is not a class"));if("function"!=typeof t||!t.type)throw Error("Light node ".concat(t.type," is not a class"));sG.set(e,t)}class sH extends sI{setup(e){let t=this.aoNode.x.sub(1).mul(1).add(1);e.context.ambientOcclusion.mulAssign(t)}constructor(e=null){super(),this.aoNode=e}}N("AONode",sH);class sq extends e7{getContext(){let{backdropNode:e,backdropAlphaNode:t}=this,r=eB().temp("directDiffuse"),i=eB().temp("directSpecular"),s=eB().temp("indirectDiffuse"),n=eB().temp("indirectSpecular");return{radiance:eB().temp("radiance"),irradiance:eB().temp("irradiance"),iblIrradiance:eB().temp("iblIrradiance"),ambientOcclusion:eS(1).temp("ambientOcclusion"),reflectedLight:{directDiffuse:r,directSpecular:i,indirectDiffuse:s,indirectSpecular:n},backdrop:e,backdropAlpha:t}}setup(e){return this.context=this._context||(this._context=this.getContext()),this.context.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}constructor(e,t=null,r=null,i=null){super(e),this.lightingModel=t,this.backdropNode=r,this.backdropAlphaNode=i,this._context=null}}let sj=eg(sq);k("lightingContext",sj),N("LightingContextNode",sq);class sX extends D{setup(){let e=this.dirNode;return eA(e.z.atan2(e.x).mul(1/(2*Math.PI)).add(.5),e.y.negate().clamp(-1,1).asin().mul(1/Math.PI).add(.5))}constructor(e=st){super("vec2"),this.dirNode=e}}let sY=eg(sX);N("EquirectUVNode",sX);class sZ extends S{setup(){let{textureNode:e,roughnessNode:t}=this,r=r7(e),i=t.mul(t).mul(Math.PI).div(t.add(1));return r.add(i.log2()).clamp(0,r)}constructor(e,t=null){super("float"),this.textureNode=e,this.roughnessNode=t}}let sK=eg(sZ);N("SpecularMIPLevelNode",sZ);let sQ=new WeakMap;class sJ extends sI{setup(e){let t=this.envNode;if(t.isTextureNode&&!0!==t.value.isCubeTexture){let r=sQ.get(t.value);if(void 0===r){let i=t.value,s=e.renderer;r=sM(e.getCubeRenderTarget(512).fromEquirectangularTexture(s,i).texture),sQ.set(t.value,r)}t=r}let r=io("envMapIntensity","float",e.material),i=te(t,s$(tS,iw)).mul(r),s=te(t,s0(iM)).mul(Math.PI).mul(r),n=e6(i);e.context.radiance.addAssign(n),e.context.iblIrradiance.addAssign(s);let a=e.context.lightingModel.clearcoatRadiance;if(a){let e=e6(te(t,s$(tv,iD)).mul(r));a.addAssign(e)}}constructor(e=null){super(),this.envNode=e}}let s$=(e,t)=>{let r=null,i=null;return{getUV:s=>{let n=null;return null===r&&(r=si.negate().reflect(t),r=(r=e.mul(e).mix(r,t).normalize()).transformDirection(iS)),s.isCubeTextureNode?n=r:s.isTextureNode&&(null===i&&(i=sY(r)),n=i),n},getTextureLevel:()=>e,getTextureLevelAlgorithm:(e,t)=>sK(e,t)}},s0=e=>{let t=null;return{getUV:r=>{let i=null;return r.isCubeTextureNode?i=e:r.isTextureNode&&(null===t&&(t=eA((t=sY(e)).x,t.y.oneMinus())),i=t),i},getTextureLevel:e=>r7(e)}};N("EnvironmentNode",sJ);class s1 extends S{getNodeType(){return this.scope===s1.VIEWPORT?"vec4":"vec2"}getUpdateType(){let e=o.NONE;return(this.scope===s1.RESOLUTION||this.scope===s1.VIEWPORT)&&(e=o.FRAME),this.updateType=e,e}update(e){let{renderer:t}=e;this.scope===s1.VIEWPORT?t.getViewport(s):t.getDrawingBufferSize(i)}setup(){let e=this.scope;if(e===s1.COORDINATE)return;let t=null;if(e===s1.RESOLUTION)t=eX(i||(i=new c.Vector2));else if(e===s1.VIEWPORT)t=eX(s||(s=new c.Vector4));else{let r=(t=s2.div(s3)).x,i=t.y;/bottom/i.test(e)&&(i=i.oneMinus()),/right/i.test(e)&&(r=r.oneMinus()),t=eA(r,i)}return t}generate(e){if(this.scope===s1.COORDINATE){let t=e.getFragCoord();if(e.isFlipY()){let r=e.getNodeProperties(s3).outputNode.build(e);t="".concat(e.getType("vec2"),"( ").concat(t,".x, ").concat(r,".y - ").concat(t,".y )")}return t}return super.generate(e)}constructor(e){super(),this.scope=e,this.isViewportNode=!0}}s1.COORDINATE="coordinate",s1.RESOLUTION="resolution",s1.VIEWPORT="viewport",s1.TOP_LEFT="topLeft",s1.BOTTOM_LEFT="bottomLeft",s1.TOP_RIGHT="topRight",s1.BOTTOM_RIGHT="bottomRight";let s2=em(s1,s1.COORDINATE),s3=em(s1,s1.RESOLUTION),s4=em(s1,s1.VIEWPORT),s8=em(s1,s1.TOP_LEFT),s5=em(s1,s1.BOTTOM_LEFT);em(s1,s1.TOP_RIGHT),em(s1,s1.BOTTOM_RIGHT),N("ViewportNode",s1);let s6=new c.Vector2;class s9 extends it{updateBefore(e){let t=e.renderer;t.getDrawingBufferSize(s6);let r=this.value;(r.image.width!==s6.width||r.image.height!==s6.height)&&(r.image.width=s6.width,r.image.height=s6.height,r.needsUpdate=!0);let i=r.generateMipmaps;r.generateMipmaps=this.generateMipmaps,t.copyFramebufferToTexture(r),r.generateMipmaps=i}clone(){return new this.constructor(this.uvNode,this.levelNode,this.value)}constructor(e=s8,t=null,r=null){null===r&&((r=new c.FramebufferTexture).minFilter=c.LinearMipmapLinearFilter),super(r,e,t),this.generateMipmaps=!1,this.isOutputTextureNode=!0,this.updateBeforeType=o.FRAME}}var s7=s9;let ne=eg(s9),nt=eg(s9,null,null,{generateMipmaps:!0});k("viewportTexture",ne),k("viewportMipTexture",nt),N("ViewportTextureNode",s9);let nr=null;class ni extends s7{constructor(e=s8,t=null){null===nr&&((nr=new c.DepthTexture).minFilter=c.NearestMipmapNearestFilter,nr.type=c.UnsignedIntType,nr.format=c.DepthFormat),super(e,t,nr)}}let ns=eg(ni);k("viewportDepthTexture",ns),N("ViewportDepthTextureNode",ni);class nn extends S{generate(e){let{scope:t}=this;return t===nn.DEPTH_PIXEL?e.getFragDepth():super.generate(e)}setup(){let{scope:e}=this,t=null;return e===nn.DEPTH?t=na(sr.z,iy,ix):e===nn.DEPTH_TEXTURE?t=na(no(this.valueNode||ns(),iy,ix),iy,ix):e===nn.DEPTH_PIXEL&&null!==this.valueNode&&(t=nl().assign(this.valueNode)),t}constructor(e,t=null){super("float"),this.scope=e,this.valueNode=t,this.isViewportDepthNode=!0}}let na=(e,t,r)=>e.add(t).div(t.sub(r)),no=(e,t,r)=>t.mul(r).div(r.sub(t).mul(e).sub(r));nn.DEPTH="depth",nn.DEPTH_TEXTURE="depthTexture",nn.DEPTH_PIXEL="depthPixel";let nl=eg(nn,nn.DEPTH_PIXEL);em(nn,nn.DEPTH),eg(nn,nn.DEPTH_TEXTURE);let nu=em(nn,nn.DEPTH_PIXEL);nu.assign=e=>nl(e),N("ViewportDepthNode",nn);let nd=new Map;class nc extends c.ShaderMaterial{customProgramCacheKey(){return this.type+h(this)}build(e){this.setup(e)}setup(e){let t;if(e.addStack(),e.stack.outputNode=this.vertexNode||this.setupPosition(e),e.addFlow("vertex",e.removeStack()),e.addStack(),null===this.fragmentNode){!0===this.depthWrite&&this.setupDepth(e),!0===this.normals&&this.setupNormal(e),this.setupDiffuseColor(e),this.setupVariants(e);let r=this.setupLighting(e);t=this.setupOutput(e,eD(r,tb.a)),tM.assign(t),null!==this.outputNode&&(t=this.outputNode)}else t=this.setupOutput(e,this.fragmentNode);e.stack.outputNode=t,e.addFlow("fragment",e.removeStack())}setupDepth(e){let{renderer:t}=e,r=this.depthNode;null===r&&!0===t.logarithmicDepthBuffer&&(r=sn().w.add(1).log2().mul(ib).mul(.5)),null!==r&&nu.assign(r).append()}setupPosition(e){let{object:t}=e,r=t.geometry;e.addStack(),(r.morphAttributes.position||r.morphAttributes.normal||r.morphAttributes.color)&&sE(t).append(),!0===t.isSkinnedMesh&&s_(t).append(),t.instanceMatrix&&!0===t.instanceMatrix.isInstancedBufferAttribute&&!0===e.isAvailable("instance")&&sh(t).append(),null!==this.positionNode&&i7.assign(this.positionNode);let i=sn();return e.context.vertex=e.removeStack(),e.context.mvp=i,i}setupDiffuseColor(e){let{geometry:t}=e,r=this.colorNode?eD(this.colorNode):iL;!0===this.vertexColors&&t.hasAttribute("color")&&(r=eD(r.xyz.mul(e1("color","vec3")),r.a)),tb.assign(r);let i=this.opacityNode?eS(this.opacityNode):iP;if(tb.a.assign(tb.a.mul(i)),null!==this.alphaTestNode||this.alphaTest>0){let e=null!==this.alphaTestNode?eS(this.alphaTestNode):iU;tb.a.lessThanEqual(e).discard()}}setupVariants(){}setupNormal(){if(!0===this.flatShading){let e=sr.dFdx().cross(sr.dFdy()).normalize();iw.assign(e)}else{let e=this.normalNode?eB(this.normalNode):iq;iw.assign(e)}}getEnvNode(e){let t=null;return this.envNode?t=this.envNode:this.envMap?t=this.envMap.isCubeTexture?sM(this.envMap):ir(this.envMap):e.environmentNode&&(t=e.environmentNode),t}setupLights(e){let t=this.getEnvNode(e),r=[];t&&r.push(new sJ(t)),e.material.aoMap&&r.push(new sH(ir(e.material.aoMap)));let i=this.lightsNode||e.lightsNode;return r.length>0&&(i=sz([...i.lightNodes,...r])),i}setupLightingModel(){}setupLighting(e){let{material:t}=e,{backdropNode:r,backdropAlphaNode:i,emissiveNode:s}=this,n=!0===this.lights||null!==this.lightsNode?this.setupLights(e):null,a=tb.rgb;return n&&!1!==n.hasLight?a=sj(n,this.setupLightingModel(e),r,i):null!==r&&(a=eB(null!==i?rj(a,r,i):r)),(s&&!0===s.isNode||t.emissive&&!0===t.emissive.isColor)&&(a=a.add(eB(s||iV))),a}setupOutput(e,t){let r=e.renderer,i=e.toneMappingNode;if(!0===this.toneMapped&&i&&(t=eD(i.context({color:t.rgb}),t.a)),!0===this.fog){let r=e.fogNode;r&&(t=eD(r.mixAssign(t.rgb),t.a))}if(!0===this.colorSpaced){let e=r.currentColorSpace;e!==c.LinearSRGBColorSpace&&e!==c.NoColorSpace&&(t=t.linearToColorSpace(e))}return t}setDefaultValues(e){for(let t in e){let r=e[t];void 0===this[t]&&(this[t]=r,r&&r.clone&&(this[t]=r.clone()))}Object.assign(this.defines,e.defines);let t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(let e in t)void 0===Object.getOwnPropertyDescriptor(this.constructor.prototype,e)&&void 0!==t[e].get&&Object.defineProperty(this.constructor.prototype,e,t[e])}toJSON(e){let t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{},nodes:{}});let r=c.Material.prototype.toJSON.call(this,e),i=p(this);for(let{property:t,childNode:s}of(r.inputNodes={},i))r.inputNodes[t]=s.toJSON(e).uuid;function s(e){let t=[];for(let r in e){let i=e[r];delete i.metadata,t.push(i)}return t}if(t){let t=s(e.textures),i=s(e.images),n=s(e.nodes);t.length>0&&(r.textures=t),i.length>0&&(r.images=i),n.length>0&&(r.nodes=n)}return r}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.positionNode=e.positionNode,this.depthNode=e.depthNode,this.outputNode=e.outputNode,this.fragmentNode=e.fragmentNode,this.vertexNode=e.vertexNode,super.copy(e)}static fromMaterial(e){if(!0===e.isNodeMaterial)return e;let t=ng(e.type.replace("Material","NodeMaterial"));if(void 0===t)throw Error('NodeMaterial: Material "'.concat(e.type,'" is not compatible.'));for(let r in e)t[r]=e[r];return t}constructor(){super(),this.isNodeMaterial=!0,this.type=this.constructor.type,this.forceSinglePass=!1,this.fog=!0,this.lights=!0,this.normals=!0,this.colorSpaced=!0,this.lightsNode=null,this.envNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.positionNode=null,this.depthNode=null,this.outputNode=null,this.fragmentNode=null,this.vertexNode=null}}var nh=nc;function np(e,t){if("function"!=typeof t||!e)throw Error("Node material ".concat(e," is not a class"));if(nd.has(e)){console.warn("Redefinition of node material ".concat(e));return}nd.set(e,t),t.type=e}function ng(e){let t=nd.get(e);if(void 0!==t)return new t}np("NodeMaterial",nc);class nm{setValue(e){this.value=e}getValue(){return this.value}constructor(e,t=null){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}}class nf extends nm{constructor(e,t=0){super(e,t),this.isFloatUniform=!0,this.boundary=4,this.itemSize=1}}class nT extends nm{constructor(e,t=new c.Vector2){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}}class ny extends nm{constructor(e,t=new c.Vector3){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}}class nx extends nm{constructor(e,t=new c.Vector4){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}}class nb extends nm{constructor(e,t=new c.Color){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}}class nS extends nm{constructor(e,t=new c.Matrix3){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}}class nN extends nm{constructor(e,t=new c.Matrix4){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}}class n_ extends nf{getValue(){return this.nodeUniform.value}constructor(e){super(e.name,e.value),this.nodeUniform=e}}class nv extends nT{getValue(){return this.nodeUniform.value}constructor(e){super(e.name,e.value),this.nodeUniform=e}}class nA extends ny{getValue(){return this.nodeUniform.value}constructor(e){super(e.name,e.value),this.nodeUniform=e}}class nR extends nx{getValue(){return this.nodeUniform.value}constructor(e){super(e.name,e.value),this.nodeUniform=e}}class nC extends nb{getValue(){return this.nodeUniform.value}constructor(e){super(e.name,e.value),this.nodeUniform=e}}class nE extends nS{getValue(){return this.nodeUniform.value}constructor(e){super(e.name,e.value),this.nodeUniform=e}}class nB extends nN{getValue(){return this.nodeUniform.value}constructor(e){super(e.name,e.value),this.nodeUniform=e}}class nF extends S{getNodeType(e){let t=this.ifNode.getNodeType(e);if(null!==this.elseNode){let r=this.elseNode.getNodeType(e);if(e.getTypeLength(r)>e.getTypeLength(t))return r}return t}generate(e){let t=this.getNodeType(e),r={tempWrite:!1},{ifNode:i,elseNode:s}=this,n="void"!==i.getNodeType(e)||s&&"void"!==s.getNodeType(e),a=n?ty(t).build(e):"",o=te(this.condNode).build(e,"bool");e.addFlowCode("\n".concat(e.tab,"if ( ").concat(o," ) {\n\n")).addFlowTab();let l=te(this.ifNode,r).build(e,t);if(l=n?a+" = "+l+";":l,e.removeFlowTab().addFlowCode(e.tab+"	"+l+"\n\n"+e.tab+"}"),null!==s){e.addFlowCode(" else {\n\n").addFlowTab();let i=te(s,r).build(e,t);i=a?a+" = "+i+";":i,e.removeFlowTab().addFlowCode(e.tab+"	"+i+"\n\n"+e.tab+"}\n\n")}else e.addFlowCode("\n\n");return a}constructor(e,t,r=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=r}}var nw=nF;let nM=eg(nF);k("cond",nM),N("CondNode",nF);class nD extends S{getNodeType(e){return this.outputNode?this.outputNode.getNodeType(e):"void"}add(e){return this.nodes.push(e),this}if(e,t){let r=new ed(t);return this._currentCond=nM(e,r),this.add(this._currentCond)}elseif(e,t){let r=nM(e,new ed(t));return this._currentCond.elseNode=r,this._currentCond=r,this}else(e){return this._currentCond.elseNode=new ed(e),this}build(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];let s=ey();for(let t of(eT(this),this.nodes))t.build(e,"void");return eT(s),this.outputNode?this.outputNode.build(e,...r):super.build(e,...r)}constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this.isStackNode=!0}}let nI=eg(nD);N("StackNode",nD);class nO extends c.WebGLCubeRenderTarget{fromEquirectangularTexture(e,t){let r=t.minFilter,i=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;let s=new c.BoxGeometry(5,5,5),n=sY(st),a=ng("MeshBasicNodeMaterial");a.colorNode=ir(t,n,0),a.side=c.BackSide,a.blending=c.NoBlending;let o=new c.Mesh(s,a),l=new c.Scene;return l.add(o),t.minFilter===c.LinearMipmapLinearFilter&&(t.minFilter=c.LinearFilter),new c.CubeCamera(1,10,this).update(e,l),t.minFilter=r,t.currentGenerateMipmaps=i,o.geometry.dispose(),o.material.dispose(),this}constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}}let nU=new(r(1291)).Z,nL=new Map([[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),nG=new Map([[Int8Array,"int"],[Int16Array,"int"],[Int32Array,"int"],[Uint8Array,"uint"],[Uint16Array,"uint"],[Uint32Array,"uint"],[Float32Array,"float"]]),nV=e=>(e=Number(e))+(e%1?"":".0");class nP{getRenderTarget(e,t,r){return new c.RenderTarget(e,t,r)}getCubeRenderTarget(e,t){return new nO(e,t)}includes(e){return this.nodes.includes(e)}_getSharedBindings(e){let t=[];for(let r of e)if(!0===r.shared){let e=r.getNodes(),i=nU.get(e);void 0===i&&(nU.set(e,r),i=r),t.push(i)}else t.push(r);return t}getBindings(){let e=this.bindingsArray;if(null===e){let t=this.bindings;this.bindingsArray=e=this._getSharedBindings(null!==this.material?[...t.vertex,...t.fragment]:t.compute)}return e}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){!1===this.nodes.includes(e)&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}buildUpdateNodes(){for(let e of this.nodes){let t=e.getUpdateType(),r=e.getUpdateBeforeType();t!==o.NONE&&this.updateNodes.push(e.getSelf()),r!==o.NONE&&this.updateBeforeNodes.push(e)}}get currentNode(){return this.chaining[this.chaining.length-1]}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw Error("NodeBuilder: Invalid node chaining!")}getMethod(e){return e}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}setCache(e){this.cache=e}getCache(){return this.cache}isAvailable(){return!1}getVertexIndex(){console.warn("Abstract function.")}getInstanceIndex(){console.warn("Abstract function.")}getFrontFacing(){console.warn("Abstract function.")}getFragCoord(){console.warn("Abstract function.")}isFlipY(){return!1}generateTexture(){console.warn("Abstract function.")}generateTextureLod(){console.warn("Abstract function.")}generateConst(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(null===t&&("float"===e||"int"===e||"uint"===e?t=0:"bool"===e?t=!1:"color"===e?t=new c.Color:"vec2"===e?t=new c.Vector2:"vec3"===e?t=new c.Vector3:"vec4"===e&&(t=new c.Vector4)),"float"===e)return nV(t);if("int"===e)return"".concat(Math.round(t));if("uint"===e)return t>=0?"".concat(Math.round(t),"u"):"0u";if("bool"===e)return t?"true":"false";if("color"===e)return"".concat(this.getType("vec3"),"( ").concat(nV(t.r),", ").concat(nV(t.g),", ").concat(nV(t.b)," )");let r=this.getTypeLength(e),i=this.getComponentType(e),s=e=>this.generateConst(i,e);if(2===r)return"".concat(this.getType(e),"( ").concat(s(t.x),", ").concat(s(t.y)," )");if(3===r)return"".concat(this.getType(e),"( ").concat(s(t.x),", ").concat(s(t.y),", ").concat(s(t.z)," )");if(4===r)return"".concat(this.getType(e),"( ").concat(s(t.x),", ").concat(s(t.y),", ").concat(s(t.z),", ").concat(s(t.w)," )");if(r>4&&t&&(t.isMatrix3||t.isMatrix4))return"".concat(this.getType(e),"( ").concat(t.elements.map(s).join(", ")," )");if(r>4)return"".concat(this.getType(e),"()");throw Error("NodeBuilder: Type '".concat(e,"' not found in generate constant attempt."))}getType(e){return"color"===e?"vec3":e}generateMethod(e){return e}hasGeometryAttribute(e){return this.geometry&&void 0!==this.geometry.getAttribute(e)}getAttribute(e,t){let r=this.attributes;for(let t of r)if(t.name===e)return t;let i=new tu(e,t);return r.push(i),i}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return"void"===e||"property"===e||"sampler"===e||"texture"===e||"cubeTexture"===e}needsColorSpaceToLinear(){return!1}getTextureEncodingFromMap(e){return console.warn("THREE.NodeBuilder: Method .getTextureEncodingFromMap replaced by .getTextureColorSpaceFromMap in r152+."),this.getTextureColorSpaceFromMap(e)===c.SRGBColorSpace?c.sRGBEncoding:c.LinearEncoding}getTextureColorSpaceFromMap(e){return e&&e.isTexture?e.colorSpace:e&&e.isWebGLRenderTarget?e.texture.colorSpace:c.NoColorSpace}getComponentType(e){if("float"===(e=this.getVectorType(e))||"bool"===e||"int"===e||"uint"===e)return e;let t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return null===t?null:"b"===t[1]?"bool":"i"===t[1]?"int":"u"===t[1]?"uint":"float"}getVectorType(e){return"color"===e?"vec3":"texture"===e?"vec4":e}getTypeFromLength(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"float";if(1===e)return t;let r=nL.get(e);return("float"===t?"":t[0])+r}getTypeFromArray(e){return nG.get(e.constructor)}getTypeFromAttribute(e){let t,r=e;e.isInterleavedBufferAttribute&&(r=e.data);let i=r.array,s=e.itemSize,n=e.normalized;return e instanceof c.Float16BufferAttribute||!0===n||(t=this.getTypeFromArray(i)),this.getTypeFromLength(s,t)}getTypeLength(e){let t=this.getVectorType(e),r=/vec([2-4])/.exec(t);return null!==r?Number(r[1]):"float"===t||"bool"===t||"int"===t||"uint"===t?1:!0===/mat3/.test(e)?9:!0===/mat4/.test(e)?16:0}getVectorFromMatrix(e){return e.replace("mat","vec")}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){let t=this.getComponentType(e);return"int"===t||"uint"===t?e:this.changeComponentType(e,"int")}addStack(){return this.stack=nI(this.stack),this.stacks.push(ey()||this.stack),eT(this.stack),this.stack}removeStack(){let e=this.stack;return this.stack=e.parent,eT(this.stacks.pop()),e}getDataFromNode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.shaderStage,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=(r=null===r?e.isGlobal(this)?this.globalCache:this.cache:r).getNodeData(e);return void 0===i&&(i={},r.setNodeData(e,i)),void 0===i[t]&&(i[t]={}),i[t]}getNodeProperties(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"any",r=this.getDataFromNode(e,t);return r.properties||(r.properties={outputNode:null})}getBufferAttributeFromNode(e,t){let r=this.getDataFromNode(e),i=r.bufferAttribute;return void 0===i&&(i=new tu("nodeAttribute"+this.uniforms.index++,t,e),this.bufferAttributes.push(i),r.bufferAttribute=i),i}getStructTypeFromNode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.shaderStage,r=this.getDataFromNode(e,t);if(void 0===r.structType){let i=this.structs.index++;e.name="StructType".concat(i),this.structs[t].push(e),r.structType=e}return e}getUniformFromNode(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.shaderStage,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=this.getDataFromNode(e,r,this.globalCache),n=s.uniform;if(void 0===n){let a=this.uniforms.index++;n=new td(i||"nodeUniform"+a,t,e),this.uniforms[r].push(n),s.uniform=n}return n}getVarFromNode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.getNodeType(this),i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.shaderStage,s=this.getDataFromNode(e,i),n=s.variable;if(void 0===n){let e=this.vars[i]||(this.vars[i]=[]);null===t&&(t="nodeVar"+e.length),n=new th(t,r),e.push(n),s.variable=n}return n}getVaryingFromNode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.getNodeType(this),i=this.getDataFromNode(e,"any"),s=i.varying;if(void 0===s){let e=this.varyings,n=e.length;null===t&&(t="nodeVarying"+n),s=new tp(t,r),e.push(s),i.varying=s}return s}getCodeFromNode(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.shaderStage,i=this.getDataFromNode(e),s=i.code;if(void 0===s){let e=this.codes[r]||(this.codes[r]=[]);s=new tg("nodeCode"+e.length,t),e.push(s),i.code=s}return s}addLineFlowCode(e){return""===e||(e=this.tab+e,/;\s*$/.test(e)||(e+=";\n"),this.flow.code+=e),this}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+="	",this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){let t=e.getNodeType(this),r=this.flowChildNode(e,t);return this.flowsData.set(e,r),r}buildFunctionNode(e){let t=new tG,r=this.currentFunctionNode;return this.currentFunctionNode=t,t.code=this.buildFunctionCode(e),this.currentFunctionNode=r,t}flowShaderNode(e){let t;let r=e.layout;if(e.isArrayInput)for(let e of(t=[],r.inputs))t.push(new tO(e.type,e.name));else for(let e of(t={},r.inputs))t[e.name]=new tO(e.type,e.name);e.layout=null;let i=e.call(t),s=this.flowStagesNode(i,r.type);return e.layout=r,s}flowStagesNode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this.flow,i=this.vars,s=this.buildStage,n={code:""};for(let r of(this.flow=n,this.vars={},l))this.setBuildStage(r),n.result=e.build(this,t);return n.vars=this.getVars(this.shaderStage),this.flow=r,this.vars=i,this.setBuildStage(s),n}getFunctionOperator(){return null}flowChildNode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=this.flow,i={code:""};return this.flow=i,i.result=e.build(this,t),this.flow=r,i}flowNodeFromShaderStage(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=this.shaderStage;this.setShaderStage(e);let n=this.flowChildNode(t,r);return null!==i&&(n.code+="".concat(this.tab+i," = ").concat(n.result,";\n")),this.flowCode[e]=this.flowCode[e]+n.code,this.setShaderStage(s),n}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){console.warn("Abstract function.")}getVaryings(){console.warn("Abstract function.")}getVar(e,t){return"".concat(this.getType(e)," ").concat(t)}getVars(e){let t="",r=this.vars[e];if(void 0!==r)for(let e of r)t+="".concat(this.getVar(e.type,e.name),"; ");return t}getUniforms(){console.warn("Abstract function.")}getCodes(e){let t=this.codes[e],r="";if(void 0!==t)for(let e of t)r+=e.code+"\n";return r}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){console.warn("Abstract function.")}build(){for(let e of l)for(let t of(this.setBuildStage(e),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage("vertex",this.context.vertex),u))for(let r of(this.setShaderStage(t),this.flowNodes[t]))"generate"===e?this.flowNode(r):r.build(this);return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if("float"===t)return new n_(e);if("vec2"===t)return new nv(e);if("vec3"===t)return new nA(e);if("vec4"===t)return new nR(e);if("color"===t)return new nC(e);if("mat3"===t)return new nE(e);if("mat4"===t)return new nB(e);throw Error('Uniform "'.concat(t,'" not declared.'))}createNodeMaterial(e){return ng(e)}getPrimitiveType(e){return"i"===e[0]?"int":"u"===e[0]?"uint":"float"}format(e,t,r){if(t=this.getVectorType(t),r=this.getVectorType(r),t===r||null===r||this.isReference(r))return e;let i=this.getTypeLength(t),s=this.getTypeLength(r);return i>4||s>4||0===s?e:i===s?"".concat(this.getType(r),"( ").concat(e," )"):i>s?this.format("".concat(e,".").concat("xyz".slice(0,s)),this.getTypeFromLength(s,this.getComponentType(t)),r):4===s&&i>1?"".concat(this.getType(r),"( ").concat(this.format(e,t,"vec3"),", 1.0 )"):2===i?"".concat(this.getType(r),"( ").concat(this.format(e,t,"vec2"),", 0.0 )"):(1===i&&s>1&&t[0]!==r[0]&&(e="".concat(this.getType(this.getPrimitiveType(r)),"( ").concat(e," )")),"".concat(this.getType(r),"( ").concat(e," )"))}getSignature(){return"// Three.js r".concat(c.REVISION," - NodeMaterial System\n")}constructor(e,t,r,i=null,s=null){this.object=e,this.material=s||e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=r,this.scene=i,this.nodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.hashNodes={},this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.toneMappingNode=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:"",fragment:"",compute:[]},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:[],fragment:[],compute:[]},this.bindingsOffset={vertex:0,fragment:0,compute:0},this.bindingsArray=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.flow={code:""},this.chaining=[],this.stack=nI(),this.stacks=[],this.tab="	",this.currentFunctionNode=null,this.context={keywords:new tm,material:this.material},this.cache=new e8,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null}}var nk=nP;class nz{_getMaps(e,t){let r=e.get(t);return void 0===r&&(r={renderMap:new WeakMap,frameMap:new WeakMap},e.set(t,r)),r}updateBeforeNode(e){let t=e.getUpdateBeforeType(),r=e.updateReference(this);if(t===o.FRAME){let{frameMap:t}=this._getMaps(this.updateBeforeMap,r);t.get(e)!==this.frameId&&(t.set(e,this.frameId),e.updateBefore(this))}else if(t===o.RENDER){let{renderMap:t}=this._getMaps(this.updateBeforeMap,r);t.get(e)!==this.renderId&&(t.set(e,this.renderId),e.updateBefore(this))}else t===o.OBJECT&&e.updateBefore(this)}updateNode(e){let t=e.getUpdateType(),r=e.updateReference(this);if(t===o.FRAME){let{frameMap:t}=this._getMaps(this.updateMap,r);t.get(e)!==this.frameId&&(t.set(e,this.frameId),e.update(this))}else if(t===o.RENDER){let{renderMap:t}=this._getMaps(this.updateMap,r);t.get(e)!==this.renderId&&(t.set(e,this.renderId),e.update(this))}else t===o.OBJECT&&e.update(this)}update(){this.frameId++,void 0===this.lastTime&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.startTime=null,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}}var nW=nz,nH=r(134);class nq extends S{getMemberTypes(){return this.types}constructor(e){super(),this.types=e,this.isStructTypeNode=!0}}N("StructTypeNode",nq);class nj extends S{setup(e){super.setup(e);let t=this.members,r=[];for(let i=0;i<t.length;i++)r.push(t[i].getNodeType(e));this.nodeType=e.getStructTypeFromNode(new nq(r)).name}generate(e,t){let r=e.getVarFromNode(this);r.isOutputStructVar=!0;let i=e.getPropertyName(r),s=this.members,n=""!==i?i+".":"";for(let r=0;r<s.length;r++){let i=s[r].build(e,t);e.addLineFlowCode("".concat(n,"m").concat(r," = ").concat(i))}return i}constructor(...e){super(),this.isOutputStructNode=!0,this.members=e}}eg(nj),N("OutputStructNode",nj);class nX extends S{setup(){let e=this.seedNode.uint().mul(747796405).add(2891336453),t=e.shiftRight(e.shiftRight(28).add(4)).bitXor(e).mul(277803737);return t.shiftRight(22).bitXor(t).float().mul(1/4294967296)}constructor(e){super(),this.seedNode=e}}k("hash",eg(nX)),N("HashNode",nX);class nY extends nw{constructor(e){super(e,n=n||r6("discard"))}}let nZ=eg(nY);k("discard",e=>nZ(e).append()),N("DiscardNode",nY);class nK extends S{getNodeType(){return this.functionNodes[0].shaderNode.layout.type}setup(e){let t=this.parametersNodes,r=this._candidateFnCall;if(null===r){let i=null,s=-1;for(let r of this.functionNodes){let n=r.shaderNode.layout;if(null===n)throw Error("FunctionOverloadingNode: FunctionNode must be a layout.");let a=n.inputs;if(t.length===a.length){let n=0;for(let r=0;r<t.length;r++){let i=t[r],s=a[r];i.getNodeType(e)===s.type?n++:n=0}n>s&&(i=r,s=n)}}this._candidateFnCall=r=i(...t)}return r}constructor(e=[],...t){super(),this.functionNodes=e,this.parametersNodes=t,this._candidateFnCall=null}}let nQ=eg(nK),nJ=e=>function(){for(var t=arguments.length,r=Array(t),i=0;i<t;i++)r[i]=arguments[i];return nQ(e,...r)};N("FunctionOverloadingNode",nK);class n$ extends S{getVarName(e){return String.fromCharCode("i".charCodeAt()+e)}getProperties(e){let t=e.getNodeProperties(this);if(void 0!==t.stackNode)return t;let r={};for(let e=0,t=this.params.length-1;e<t;e++){let t=this.params[e],i=!0!==t.isNode&&t.name||this.getVarName(e),s=!0!==t.isNode&&t.type||"int";r[i]=r6(i,s)}return t.returnsNode=this.params[this.params.length-1](r,e.addStack(),e),t.stackNode=e.removeStack(),t}getNodeType(e){let{returnsNode:t}=this.getProperties(e);return t?t.getNodeType(e):"void"}setup(e){this.getProperties(e)}generate(e){let t=this.getProperties(e),r=this.params,i=t.stackNode;for(let t=0,i=r.length-1;t<i;t++){let i=r[t],s=null,n=null,a=null,o=null,l=null,u=null;i.isNode?(o="int",a=this.getVarName(t),s="0",n=i.build(e,o),l="<"):(o=i.type||"int",a=i.name||this.getVarName(t),s=i.start,n=i.end,l=i.condition,u=i.update,"number"==typeof s?s=s.toString():s&&s.isNode&&(s=s.build(e,o)),"number"==typeof n?n=n.toString():n&&n.isNode&&(n=n.build(e,o)),void 0!==s&&void 0===n?(s+=" - 1",n="0",l=">="):void 0!==n&&void 0===s&&(s="0",l="<"),void 0===l&&(l=Number(s)>Number(n)?">=":"<"));let d={start:s,end:n},c=d.start,h=d.end,p="",g="",m="";u||(u="int"===o?l.includes("<")?"++":"--":l.includes("<")?"+= 1":"-= 1"),p+=e.getVar(o,a)+" = "+c,g+=a+" "+l+" "+h,m+=a+" "+u;let f="for ( ".concat(p,"; ").concat(g,"; ").concat(m," )");e.addFlowCode((0===t?"\n":"")+e.tab+f+" {\n\n").addFlowTab()}let s=te(i,{tempWrite:!1}).build(e,"void"),n=t.returnsNode?t.returnsNode.build(e):"";e.removeFlowTab().addFlowCode("\n"+e.tab+s);for(let t=0,r=this.params.length-1;t<r;t++)e.addFlowCode((0===t?"":e.tab)+"}\n\n").removeFlowTab();return e.addFlowTab(),n}constructor(e=[]){super(),this.params=e}}let n0=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return ec(new n$(ep(t,"int"))).append()};k("loop",function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return e3(e,n0(...r))}),N("LoopNode",n$);class n1 extends D{setup(){let e=eB(si.z,0,si.x.negate()).normalize(),t=si.cross(e);return eA(e.dot(iw),t.dot(iw)).mul(.495).add(.5)}constructor(){super("vec2")}}em(n1),N("MatcapUVNode",n1);class n2 extends ej{update(e){let t=this.scope,r=this.scale;t===n2.LOCAL?this.value+=e.deltaTime*r:t===n2.DELTA?this.value=e.deltaTime*r:t===n2.FRAME?this.value=e.frameId:this.value=e.time*r}serialize(e){super.serialize(e),e.scope=this.scope,e.scale=this.scale}deserialize(e){super.deserialize(e),this.scope=e.scope,this.scale=e.scale}constructor(e=n2.LOCAL,t=1,r=0){super(r),this.scope=e,this.scale=t,this.updateType=o.FRAME}}n2.LOCAL="local",n2.GLOBAL="global",n2.DELTA="delta",n2.FRAME="frame";let n3=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return ec(new n2(n2.LOCAL,e,t))};em(n2,n2.FRAME).uint(),N("TimerNode",n2);class n4 extends S{getNodeType(e){return this.timeNode.getNodeType(e)}setup(){let e=this.method,t=ec(this.timeNode),r=null;return e===n4.SINE?r=t.add(.75).mul(2*Math.PI).sin().mul(.5).add(.5):e===n4.SQUARE?r=t.fract().round():e===n4.TRIANGLE?r=t.add(.5).fract().mul(2).sub(1).abs():e===n4.SAWTOOTH&&(r=t.fract()),r}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}constructor(e=n4.SINE,t=n3()){super(),this.method=e,this.timeNode=t}}n4.SINE="sine",n4.SQUARE="square",n4.TRIANGLE="triangle",n4.SAWTOOTH="sawtooth",eg(n4,n4.SINE),eg(n4,n4.SQUARE),eg(n4,n4.TRIANGLE),eg(n4,n4.SAWTOOTH),N("OscNode",n4);class n8 extends D{getNodeType(e){return this.node.getNodeType(e)}setup(){let{scope:e,node:t}=this,r=null;return e===n8.DIRECTION_TO_COLOR?r=t.mul(.5).add(.5):e===n8.COLOR_TO_DIRECTION&&(r=t.mul(2).sub(1)),r}constructor(e,t){super(),this.scope=e,this.node=t}}n8.DIRECTION_TO_COLOR="directionToColor",n8.COLOR_TO_DIRECTION="colorToDirection";let n5=eg(n8,n8.DIRECTION_TO_COLOR),n6=eg(n8,n8.COLOR_TO_DIRECTION);k("directionToColor",n5),k("colorToDirection",n6),N("PackingNode",n8);class n9 extends S{setup(){let{node:e,inLowNode:t,inHighNode:r,outLowNode:i,outHighNode:s,doClamp:n}=this,a=e.sub(t).div(r.sub(t));return!0===n&&(a=a.clamp()),a.mul(s.sub(i)).add(i)}constructor(e,t,r,i=eS(0),s=eS(1)){super(),this.node=e,this.inLowNode=t,this.inHighNode=r,this.outLowNode=i,this.outHighNode=s,this.doClamp=!0}}let n7=eg(n9,null,null,{doClamp:!1}),ae=eg(n9);k("remap",n7),k("remapClamp",ae),N("RemapNode",n9);class at extends D{setup(){let{uvNode:e,rotationNode:t,centerNode:r}=this,i=t.cos(),s=t.sin(),n=e.sub(r);return eA(eA(i,s).dot(n),eA(s.negate(),i).dot(n)).add(r)}constructor(e,t,r=eA(.5)){super("vec2"),this.uvNode=e,this.rotationNode=t,this.centerNode=r}}k("rotateUV",eg(at)),N("RotateUVNode",at);class ar extends S{setup(){let{frameNode:e,uvNode:t,countNode:r}=this,{width:i,height:s}=r,n=e.mod(i.mul(s)).floor(),a=n.mod(i),o=s.sub(n.add(1).div(i).ceil()),l=r.reciprocal(),u=eA(a,o);return t.add(u).mul(l)}constructor(e,t=tP(),r=eS(0)){super("vec2"),this.countNode=e,this.uvNode=t,this.frameNode=r}}eg(ar),N("SpriteSheetUVNode",ar);class ai extends S{setup(){let{textureXNode:e,textureYNode:t,textureZNode:r,scaleNode:i,positionNode:s,normalNode:n}=this,a=n.abs().normalize();a=a.div(a.dot(eB(1)));let o=s.yz.mul(i),l=s.zx.mul(i),u=s.xy.mul(i),d=e.value,c=null!==t?t.value:d,h=null!==r?r.value:d;return tH(ir(d,o).mul(a.x),ir(c,l).mul(a.y),ir(h,u).mul(a.z))}constructor(e,t=null,r=null,i=eS(1),s=i7,n=iE){super("vec4"),this.textureXNode=e,this.textureYNode=t,this.textureZNode=r,this.scaleNode=i,this.positionNode=s,this.normalNode=n}}let as=eg(ai);k("triplanarTexture",function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return as(...t)}),N("TriplanarTexturesNode",ai);class an extends S{getHash(){return"bitangent-".concat(this.scope)}generate(e){let t;let r=this.scope;return r===an.GEOMETRY?t=iC.cross(sT):r===an.LOCAL?t=iE.cross(sy):r===an.VIEW?t=iB.cross(sx):r===an.WORLD&&(t=iF.cross(sb)),rh(eJ(t.mul(sT.w).xyz)).build(e,this.getNodeType(e))}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}constructor(e=an.LOCAL){super("vec3"),this.scope=e}}an.GEOMETRY="geometry",an.LOCAL="local",an.VIEW="view",an.WORLD="world",em(an,an.GEOMETRY),em(an,an.LOCAL);let aa=em(an,an.VIEW);em(an,an.WORLD);let ao=rh(iw.cross(sS).mul(sT.w));rh(ao.transformDirection(iS)),N("BitangentNode",an);let al=1/6,au=e=>tj(al,tj(e,tj(e,e.negate().add(3)).sub(3)).add(1)),ad=e=>tj(al,tj(e,tj(e,tj(3,e).sub(6))).add(4)),ac=e=>tj(al,tj(e,tj(e,tj(-3,e).add(3)).add(3)).add(1)),ah=e=>tj(al,rk(e,3)),ap=e=>au(e).add(ad(e)),ag=e=>ac(e).add(ah(e)),am=e=>tH(-1,ad(e).div(au(e).add(ad(e)))),af=e=>tH(1,ah(e).div(ac(e).add(ah(e)))),aT=(e,t,r)=>{let i=tj(e.uvNode,t.zw).add(.5),s=rd(i),n=rp(i),a=ap(n.x),o=ag(n.x),l=am(n.x),u=af(n.x),d=am(n.y),c=af(n.y),h=eA(s.x.add(l),s.y.add(d)).sub(.5).mul(t.xy),p=eA(s.x.add(u),s.y.add(d)).sub(.5).mul(t.xy),g=eA(s.x.add(l),s.y.add(c)).sub(.5).mul(t.xy),m=eA(s.x.add(u),s.y.add(c)).sub(.5).mul(t.xy),f=ap(n.y).mul(tH(a.mul(e.uv(h).level(r)),o.mul(e.uv(p).level(r)))),T=ag(n.y).mul(tH(a.mul(e.uv(g).level(r)),o.mul(e.uv(m).level(r))));return f.add(T)},ay=(e,t)=>{let r=eA(e.size(eN(t))),i=eA(e.size(eN(t.add(1)))),s=tX(1,r),n=tX(1,i),a=aT(e,eD(s,r),rd(t)),o=aT(e,eD(n,i),rc(t));return rp(t).mix(a,o)};class ax extends D{setup(){return ay(this.textureNode,this.blurNode)}constructor(e,t=eS(3)){super("vec4"),this.textureNode=e,this.blurNode=t}}k("bicubic",eg(ax)),N("TextureBicubicNode",ax);class ab extends S{generate(){return"vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y )"}constructor(){super("vec2"),this.isPointUVNode=!0}}em(ab),N("PointUVNode",ab);class aS extends S{setup(e){let t;let r=this.scope,i=null!==this.scene?this.scene:e.scene;return r===aS.BACKGROUND_BLURRINESS?t=io("backgroundBlurriness","float",i):r===aS.BACKGROUND_INTENSITY?t=io("backgroundIntensity","float",i):console.error("THREE.SceneNode: Unknown scope:",r),t}constructor(e=aS.BACKGROUND_BLURRINESS,t=null){super(),this.scope=e,this.scene=t}}aS.BACKGROUND_BLURRINESS="backgroundBlurriness",aS.BACKGROUND_INTENSITY="backgroundIntensity";let aN=em(aS,aS.BACKGROUND_BLURRINESS),a_=em(aS,aS.BACKGROUND_INTENSITY);N("SceneNode",aS);class av extends sg{getInputType(){return"storageBuffer"}constructor(e,t,r=0){super(e,t,r),this.isStorageBufferNode=!0}}N("StorageBufferNode",av);class aA extends it{getNodeType(){return"void"}constructor(e,t,r=null){super(e,t),this.storeNode=r,this.isStoreTextureNode=!0}}eg(aA),N("TextureStoreNode",aA);class aR extends ia{update(e){this.reference=null!==this.userData?this.userData:e.object.userData,super.update(e)}constructor(e,t,r=null){super(e,t,r),this.userData=r}}N("UserDataNode",aR);let aC=ef(e=>{let{base:t,blend:r}=e,i=e=>r[e].lessThan(rt).cond(r[e],t[e].oneMinus().div(r[e]).oneMinus().max(0));return eB(i("x"),i("y"),i("z"))}),aE=ef(e=>{let{base:t,blend:r}=e,i=e=>r[e].equal(1).cond(r[e],t[e].div(r[e].oneMinus()).max(0));return eB(i("x"),i("y"),i("z"))}),aB=ef(e=>{let{base:t,blend:r}=e,i=e=>t[e].oneMinus().mul(r[e].oneMinus()).oneMinus();return eB(i("x"),i("y"),i("z"))}),aF=ef(e=>{let{base:t,blend:r}=e,i=e=>t[e].lessThan(.5).cond(t[e].mul(r[e],2),t[e].oneMinus().mul(r[e].oneMinus()).oneMinus());return eB(i("x"),i("y"),i("z"))});class aw extends D{setup(){let{blendMode:e,baseNode:t,blendNode:r}=this,i={base:t,blend:r},s=null;return e===aw.BURN?s=aC(i):e===aw.DODGE?s=aE(i):e===aw.SCREEN?s=aB(i):e===aw.OVERLAY&&(s=aF(i)),s}constructor(e,t,r){super(),this.blendMode=e,this.baseNode=t,this.blendNode=r}}aw.BURN="burn",aw.DODGE="dodge",aw.SCREEN="screen",aw.OVERLAY="overlay";let aM=eg(aw,aw.BURN),aD=eg(aw,aw.DODGE),aI=eg(aw,aw.OVERLAY),aO=eg(aw,aw.SCREEN);k("burn",aM),k("dodge",aD),k("overlay",aI),k("screen",aO),N("BlendModeNode",aw);class aU extends S{generate(e){return e.getFrontFacing()}constructor(){super("bool"),this.isFrontFacingNode=!0}}let aL=eS(em(aU)).mul(2).sub(1);N("FrontFacingNode",aU);let aG=ef(e=>{let{textureNode:t,bumpScale:r}=e,i=t;if(!0!==i.isTextureNode&&i.traverse(e=>{!0===e.isTextureNode&&(i=e)}),!0!==i.isTextureNode)throw Error("THREE.TSL: dHdxy_fwd() requires a TextureNode.");let s=eS(t),n=i.uvNode||tP(),a=e=>t.cache().context({getUV:()=>e,forceUVContext:!0});return eA(eS(a(n.add(n.dFdx()))).sub(s),eS(a(n.add(n.dFdy()))).sub(s)).mul(r)}),aV=ef(e=>{let{surf_pos:t,surf_norm:r,dHdxy:i}=e,s=t.dFdx().normalize(),n=t.dFdy().normalize().cross(r),a=r.cross(s),o=s.dot(n).mul(aL),l=o.sign().mul(i.x.mul(n).add(i.y.mul(a)));return o.abs().mul(r).sub(l).normalize()});class aP extends D{setup(){let e=null!==this.scaleNode?this.scaleNode:1;return aV({surf_pos:sr,surf_norm:iB,dHdxy:aG({textureNode:this.textureNode,bumpScale:e})})}constructor(e,t=null){super("vec3"),this.textureNode=e,this.scaleNode=t}}k("bumpMap",eg(aP)),N("BumpMapNode",aP);let ak=ef(e=>{let{color:t,adjustment:r}=e;return r.mix(aZ(t.rgb),t.rgb)}),az=ef(e=>{let{color:t,adjustment:r}=e,i=tH(t.r,t.g,t.b).div(3),s=t.r.max(t.g.max(t.b)),n=s.sub(i).mul(r).mul(-3);return rj(t.rgb,s,n)}),aW=ef(e=>{let{color:t,adjustment:r}=e,i=eB(.57735,.57735,.57735),s=r.cos();return eB(t.rgb.mul(s).add(i.cross(t.rgb).mul(r.sin()).add(i.mul(rV(i,t.rgb).mul(s.oneMinus())))))});class aH extends D{setup(){let{method:e,colorNode:t,adjustmentNode:r}=this,i={color:t,adjustment:r},s=null;return e===aH.SATURATION?s=ak(i):e===aH.VIBRANCE?s=az(i):e===aH.HUE?s=aW(i):console.error("".concat(this.type,': Method "').concat(this.method,'" not supported!')),s}constructor(e,t,r=eS(1)){super("vec3"),this.method=e,this.colorNode=t,this.adjustmentNode=r}}aH.SATURATION="saturation",aH.VIBRANCE="vibrance",aH.HUE="hue";let aq=eg(aH,aH.SATURATION),aj=eg(aH,aH.VIBRANCE),aX=eg(aH,aH.HUE),aY=eB(.2125,.7154,.0721),aZ=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:aY;return rV(e,t)};k("saturation",aq),k("vibrance",aj),k("hue",aX),N("ColorAdjustmentNode",aH);let aK=ef(e=>{let{eye_pos:t,surf_norm:r,mapN:i,uv:s}=e,n=t.dFdx(),a=t.dFdy(),o=s.dFdx(),l=s.dFdy(),u=a.cross(r),d=r.cross(n),c=u.mul(o.x).add(d.mul(l.x)),h=u.mul(o.y).add(d.mul(l.y)),p=c.dot(c).max(h.dot(h)),g=aL.mul(p.inverseSqrt());return tH(c.mul(i.x,g),h.mul(i.y,g),r.mul(i.z)).normalize()});class aQ extends D{setup(e){let{normalMapType:t,scaleNode:r}=this,i=this.node.mul(2).sub(1);null!==r&&(i=eB(i.xy.mul(r),i.z));let s=null;return t===c.ObjectSpaceNormalMap?s=iv.mul(i).normalize():t===c.TangentSpaceNormalMap&&(s=!0===e.hasGeometryAttribute("tangent")?a$.mul(i).normalize():aK({eye_pos:sr,surf_norm:iB,mapN:i,uv:tP()})),s}constructor(e,t=null){super("vec3"),this.node=e,this.scaleNode=t,this.normalMapType=c.TangentSpaceNormalMap}}let aJ=eg(aQ),a$=eL(sx,aa,iB);k("normalMap",aJ),N("NormalMapNode",aQ);class a0 extends D{setup(){let{sourceNode:e,stepsNode:t}=this;return e.mul(t).floor().div(t)}constructor(e,t){super(),this.sourceNode=e,this.stepsNode=t}}k("posterize",eg(a0)),N("PosterizeNode",a0);let a1=ef(e=>{let{color:t,exposure:r}=e;return t.mul(r).clamp()}),a2=ef(e=>{let{color:t,exposure:r}=e;return(t=t.mul(r)).div(t.add(1)).clamp()}),a3=ef(e=>{let{color:t,exposure:r}=e,i=(t=(t=t.mul(r)).sub(.004).max(0)).mul(t.mul(6.2).add(.5)),s=t.mul(t.mul(6.2).add(1.7)).add(.06);return i.div(s).pow(2.2)}),a4=ef(e=>{let{color:t}=e,r=t.mul(t.add(.0245786)).sub(90537e-9),i=t.mul(t.add(.432951).mul(.983729)).add(.238081);return r.div(i)}),a8=ef(e=>{let{color:t,exposure:r}=e,i=eL(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),s=eL(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return t=t.mul(r).div(.6),t=a4({color:t=i.mul(t)}),(t=s.mul(t)).clamp()}),a5={[c.LinearToneMapping]:a1,[c.ReinhardToneMapping]:a2,[c.CineonToneMapping]:a3,[c.ACESFilmicToneMapping]:a8};class a6 extends D{getCacheKey(){let e=super.getCacheKey();return"{toneMapping:"+this.toneMapping+",nodes:"+e+"}"}setup(e){let t=this.colorNode||e.context.color,r=this.toneMapping;if(r===c.NoToneMapping)return t;let i={exposure:this.exposureNode,color:t},s=a5[r],n=null;return s?n=s(i):(console.error("ToneMappingNode: Unsupported Tone Mapping configuration.",r),n=t),n}constructor(e=c.NoToneMapping,t=eS(1),r=null){super("vec3"),this.toneMapping=e,this.exposureNode=t,this.colorNode=r}}let a9=(e,t,r)=>ec(new a6(e,ec(t),ec(r)));N("ToneMappingNode",a6);let a7=null;class oe extends s7{constructor(e=s8,t=null){null===a7&&(a7=new c.FramebufferTexture),super(e,t,a7)}}k("viewportSharedTexture",eg(oe)),N("ViewportSharedTextureNode",oe);let ot=new c.OrthographicCamera(-1,1,1,-1,0,1);class or extends c.BufferGeometry{constructor(e=!1){super(),this.setAttribute("position",new c.Float32BufferAttribute([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new c.Float32BufferAttribute(!1===e?[0,-1,0,1,2,1]:[0,2,0,0,2,0],2))}}let oi=new or;class os{dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,ot)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}constructor(e=null){this._mesh=new c.Mesh(oi,e)}}let on=new os;class oa extends D{setSize(e,t){e=Math.max(Math.round(e*this.resolution.x),1),t=Math.max(Math.round(t*this.resolution.y),1),this._invSize.value.set(1/e,1/t),this._horizontalRT.setSize(e,t),this._verticalRT.setSize(e,t)}updateBefore(e){let{renderer:t}=e,r=this.textureNode,i=r.value,s=t.getRenderTarget(),n=r.value;on.material=this._material,this.setSize(i.image.width,i.image.height),t.setRenderTarget(this._horizontalRT),this._passDirection.value.set(1,0),on.render(t),r.value=this._horizontalRT.texture,t.setRenderTarget(this._verticalRT),this._passDirection.value.set(0,1),on.render(t),t.setRenderTarget(s),r.value=n}setup(e){let t=this.textureNode;if(!0!==t.isTextureNode)return console.error("GaussianBlurNode requires a TextureNode."),eD();let r=t.uvNode||tP(),i=e=>t.cache().context({getUV:()=>e,forceUVContext:!0}),s=ef(()=>{let e=3+2*this.sigma,t=this._getCoefficients(e),s=this._invSize,n=eA(this.directionNode).mul(this._passDirection),a=eS(t[0]).toVar(),o=eB(i(r).mul(a)).toVar();for(let l=1;l<e;l++){let e=eS(l),u=eS(t[l]),d=eA(n.mul(s.mul(e))).toVar(),c=eB(i(r.add(d))),h=eB(i(r.sub(d)));o.addAssign(c.add(h).mul(u)),a.addAssign(tj(2,u))}return eD(o.div(a),1)});return(this._material||(this._material=e.createNodeMaterial("MeshBasicNodeMaterial"))).fragmentNode=s(),e.getNodeProperties(this).textureNode=t,ir(this._verticalRT.texture)}_getCoefficients(e){let t=[];for(let r=0;r<e;r++)t.push(.39894*Math.exp(-.5*r*r/(e*e))/e);return t}constructor(e,t=2){super(e),this.textureNode=e,this.sigma=t,this.directionNode=eA(1),this._invSize=eX(new c.Vector2),this._passDirection=eX(new c.Vector2),this._horizontalRT=new c.RenderTarget,this._verticalRT=new c.RenderTarget,this.updateBeforeType=o.RENDER,this.resolution=new c.Vector2(1,1)}}k("gaussianBlur",(e,t)=>ec(new oa(ec(e),t)));class oo extends it{setup(e){return this.passNode.build(e),super.setup(e)}clone(){return new this.constructor(this.passNode,this.value)}constructor(e,t){super(t),this.passNode=e,this.setUpdateMatrix(!1)}}class ol extends D{isGlobal(){return!0}getTextureNode(){return this._textureNode}getTextureDepthNode(){return this._depthTextureNode}getDepthNode(){if(null===this._depthNode){let e=this._cameraNear,t=this._cameraFar;this._depthNode=na(no(this._depthTextureNode,e,t),e,t)}return this._depthNode}setup(){return this.scope===ol.COLOR?this.getTextureNode():this.getDepthNode()}updateBefore(e){let{renderer:t}=e,{scene:r,camera:i}=this;this._pixelRatio=t.getPixelRatio();let s=t.getSize(new c.Vector2);this.setSize(s.width,s.height);let n=t.toneMapping,a=t.toneMappingNode,o=t.getRenderTarget();this._cameraNear.value=i.near,this._cameraFar.value=i.far,t.toneMapping=c.NoToneMapping,t.toneMappingNode=null,t.setRenderTarget(this.renderTarget),t.render(r,i),t.toneMapping=n,t.toneMappingNode=a,t.setRenderTarget(o)}setSize(e,t){this._width=e,this._height=t;let r=this._width*this._pixelRatio,i=this._height*this._pixelRatio;this.renderTarget.setSize(r,i)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}constructor(e,t,r){super("vec4"),this.scope=e,this.scene=t,this.camera=r,this._pixelRatio=1,this._width=1,this._height=1;let i=new c.DepthTexture;i.isRenderTargetTexture=!0,i.type=c.FloatType,i.name="PostProcessingDepth";let s=new c.RenderTarget(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:c.HalfFloatType});s.texture.name="PostProcessing",s.depthTexture=i,this.renderTarget=s,this.updateBeforeType=o.FRAME,this._textureNode=ec(new oo(this,s.texture)),this._depthTextureNode=ec(new oo(this,i)),this._depthNode=null,this._cameraNear=eX(0),this._cameraFar=eX(0),this.isPassNode=!0}}ol.COLOR="color",ol.DEPTH="depth",N("PassNode",ol);class ou extends D{setParameters(e){return this.parameters=e,this}getParameters(){return this.parameters}getNodeType(e){return this.functionNode.getNodeType(e)}generate(e){let t=[],r=this.functionNode,i=r.getInputs(e),s=this.parameters;if(Array.isArray(s))for(let r=0;r<s.length;r++){let n=i[r],a=s[r];t.push(a.build(e,n.type))}else for(let r of i){let i=s[r.name];if(void 0!==i)t.push(i.build(e,r.type));else throw Error("FunctionCallNode: Input '".concat(r.name,"' not found in FunctionNode."))}let n=r.build(e,"property");return"".concat(n,"( ").concat(t.join(", ")," )")}constructor(e=null,t={}){super(),this.functionNode=e,this.parameters=t}}k("call",function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return r=r.length>1||r[0]&&!0===r[0].isNode?ep(r):eh(r[0]),ec(new ou(ec(e),r))}),N("FunctionCallNode",ou);class od extends S{get isScriptableOutputNode(){return null!==this.outputType}set value(e){this._value!==e&&(this._cache&&"URL"===this.inputType&&this.value.value instanceof ArrayBuffer&&(URL.revokeObjectURL(this._cache),this._cache=null),this._value=e,this.events.dispatchEvent({type:"change"}),this.refresh())}get value(){return this._value}refresh(){this.events.dispatchEvent({type:"refresh"})}getValue(){let e=this.value;if(e&&null===this._cache&&"URL"===this.inputType&&e.value instanceof ArrayBuffer)this._cache=URL.createObjectURL(new Blob([e.value]));else if(e&&null!==e.value&&void 0!==e.value&&(("URL"===this.inputType||"String"===this.inputType)&&"string"==typeof e.value||"Number"===this.inputType&&"number"==typeof e.value||"Vector2"===this.inputType&&e.value.isVector2||"Vector3"===this.inputType&&e.value.isVector3||"Vector4"===this.inputType&&e.value.isVector4||"Color"===this.inputType&&e.value.isColor||"Matrix3"===this.inputType&&e.value.isMatrix3||"Matrix4"===this.inputType&&e.value.isMatrix4))return e.value;return this._cache||e}getNodeType(e){return this.value&&this.value.isNode?this.value.getNodeType(e):"float"}setup(){return this.value&&this.value.isNode?this.value:eS()}serialize(e){super.serialize(e),null!==this.value?"ArrayBuffer"===this.inputType?e.value=f(this.value):e.value=this.value?this.value.toJSON(e.meta).uuid:null:e.value=null,e.inputType=this.inputType,e.outputType=this.outputType}deserialize(e){super.deserialize(e);let t=null;null!==e.value&&(t="ArrayBuffer"===e.inputType?T(e.value):"Texture"===e.inputType?e.meta.textures[e.value]:e.meta.nodes[e.value]||null),this.value=t,this.inputType=e.inputType,this.outputType=e.outputType}constructor(e=null){super(),this._value=e,this._cache=null,this.inputType=null,this.outpuType=null,this.events=new c.EventDispatcher,this.isScriptableValueNode=!0}}let oc=eg(od);k("scriptableValue",oc),N("ScriptableValueNode",od);class oh extends Map{get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;for(var r=arguments.length,i=Array(r>2?r-2:0),s=2;s<r;s++)i[s-2]=arguments[s];if(this.has(e))return super.get(e);if(null!==t){let r=t(...i);return this.set(e,r),r}}}class op{get parameters(){return this.scriptableNode.parameters}get layout(){return this.scriptableNode.getLayout()}getInputLayout(e){return this.scriptableNode.getInputLayout(e)}get(e){let t=this.parameters[e];return t?t.getValue():null}constructor(e){this.scriptableNode=e}}let og=new oh;class om extends S{get source(){return this.codeNode?this.codeNode.code:""}setLocal(e,t){return this._local.set(e,t)}getLocal(e){return this._local.get(e)}onRefresh(){this._refresh()}getInputLayout(e){for(let t of this.getLayout())if(t.inputType&&(t.id===e||t.name===e))return t}getOutputLayout(e){for(let t of this.getLayout())if(t.outputType&&(t.id===e||t.name===e))return t}setOutput(e,t){let r=this._outputs;return void 0===r[e]?r[e]=oc(t):r[e].value=t,this}getOutput(e){return this._outputs[e]}getParameter(e){return this.parameters[e]}setParameter(e,t){let r=this.parameters;return t&&t.isScriptableNode?(this.deleteParameter(e),r[e]=t,r[e].getDefaultOutput().events.addEventListener("refresh",this.onRefresh)):t&&t.isScriptableValueNode?(this.deleteParameter(e),r[e]=t,r[e].events.addEventListener("refresh",this.onRefresh)):void 0===r[e]?(r[e]=oc(t),r[e].events.addEventListener("refresh",this.onRefresh)):r[e].value=t,this}getValue(){return this.getDefaultOutput().getValue()}deleteParameter(e){let t=this.parameters[e];return t&&(t.isScriptableNode&&(t=t.getDefaultOutput()),t.events.removeEventListener("refresh",this.onRefresh)),this}clearParameters(){for(let e of Object.keys(this.parameters))this.deleteParameter(e);return this.needsUpdate=!0,this}call(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];let s=this.getObject()[e];if("function"==typeof s)return s(...r)}async callAsync(e){for(var t=arguments.length,r=Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];let s=this.getObject()[e];if("function"==typeof s)return"AsyncFunction"===s.constructor.name?await s(...r):s(...r)}getNodeType(e){return this.getDefaultOutputNode().getNodeType(e)}refresh(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null!==e?this.getOutput(e).refresh():this._refresh()}getObject(){if(this.needsUpdate&&this.dispose(),null!==this._object)return this._object;let e=new op(this),t=og.get("THREE"),r=og.get("TSL"),i=this.getMethod(this.codeNode),s=[e,this._local,og,()=>this.refresh(),(e,t)=>this.setOutput(e,t),t,r];this._object=i(...s);let n=this._object.layout;if(n&&(!1===n.cache&&this._local.clear(),this._output.outputType=n.outputType||null,Array.isArray(n.elements)))for(let e of n.elements){let t=e.id||e.name;e.inputType&&(void 0===this.getParameter(t)&&this.setParameter(t,null),this.getParameter(t).inputType=e.inputType),e.outputType&&(void 0===this.getOutput(t)&&this.setOutput(t,null),this.getOutput(t).outputType=e.outputType)}return this._object}deserialize(e){for(let t in super.deserialize(e),this.parameters){let e=this.parameters[t];e.isScriptableNode&&(e=e.getDefaultOutput()),e.events.addEventListener("refresh",this.onRefresh)}}getLayout(){return this.getObject().layout}getDefaultOutputNode(){let e=this.getDefaultOutput().value;return e&&e.isNode?e:eS()}getDefaultOutput(){return this._exec()._output}getMethod(){if(this.needsUpdate&&this.dispose(),null!==this._method)return this._method;let e="layout, init, main, dispose",t="var "+e+"; var output = {};\n"+this.codeNode.code+"\nreturn { ...output, "+e+" };";return this._method=Function(...["parameters","local","global","refresh","setOutput","THREE","TSL"],t),this._method}dispose(){null!==this._method&&(this._object&&"function"==typeof this._object.dispose&&this._object.dispose(),this._method=null,this._object=null,this._source=null,this._value=null,this._needsOutputUpdate=!0,this._output.value=null,this._outputs={})}setup(){return this.getDefaultOutputNode()}set needsUpdate(e){!0===e&&this.dispose()}get needsUpdate(){return this.source!==this._source}_exec(){return null===this.codeNode||(!0===this._needsOutputUpdate&&(this._value=this.call("main"),this._needsOutputUpdate=!1),this._output.value=this._value),this}_refresh(){this.needsUpdate=!0,this._exec(),this._output.refresh()}constructor(e=null,t={}){super(),this.codeNode=e,this.parameters=t,this._local=new oh,this._output=oc(),this._outputs={},this._source=this.source,this._method=null,this._object=null,this._value=null,this._needsOutputUpdate=!0,this.onRefresh=this.onRefresh.bind(this),this.isScriptableNode=!0}}k("scriptable",eg(om)),N("ScriptableNode",om);class of extends S{mixAssign(e){return this.mix(e,this.colorNode)}setup(){return this.factorNode}constructor(e,t){super("float"),this.isFogNode=!0,this.colorNode=e,this.factorNode=t}}var oT=of;k("fog",eg(of)),N("FogNode",of);class oy extends oT{setup(){return rZ(this.nearNode,this.farNode,sr.z.negate())}constructor(e,t,r){super(e),this.isFogRangeNode=!0,this.nearNode=t,this.farNode=r}}let ox=eg(oy);k("rangeFog",ox),N("FogRangeNode",oy);class ob extends oT{setup(){let e=sr.z.negate(),t=this.densityNode;return t.mul(t,e,e).negate().exp().oneMinus()}constructor(e,t){super(e),this.isFogExp2Node=!0,this.densityNode=t}}let oS=eg(ob);k("densityFog",oS),N("FogExp2Node",ob);let oN=null,o_=null;class ov extends S{getVectorLength(e){let t=e.getTypeLength(g(this.minNode.value)),r=e.getTypeLength(g(this.maxNode.value));return t>r?t:r}getNodeType(e){return!0===e.object.isInstancedMesh?e.getTypeFromLength(this.getVectorLength(e)):"float"}setup(e){let t=e.object,r=null;if(!0===t.isInstancedMesh){let i=this.minNode.value,s=this.maxNode.value,n=e.getTypeLength(g(i)),a=e.getTypeLength(g(s));oN=oN||new c.Vector4,o_=o_||new c.Vector4,oN.setScalar(0),o_.setScalar(0),1===n?oN.setScalar(i):i.isColor?oN.set(i.r,i.g,i.b):oN.set(i.x,i.y,i.z||0,i.w||0),1===a?o_.setScalar(s):s.isColor?o_.set(s.r,s.g,s.b):o_.set(s.x,s.y,s.z||0,s.w||0);let o=4*t.count,l=new Float32Array(o);for(let e=0;e<o;e++){let t=e%4,r=oN.getComponent(t),i=o_.getComponent(t);l[e]=c.MathUtils.lerp(r,i,Math.random())}let u=this.getNodeType(e);r=sm(l,"vec4",t.count).element(ts).convert(u)}else r=eS(0);return r}constructor(e=eS(),t=eS()){super(),this.minNode=e,this.maxNode=t}}eg(ov),N("RangeNode",ov);class oA extends S{dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}updateDispatchCount(){let{count:e,workgroupSize:t}=this,r=t[0];for(let e=1;e<t.length;e++)r*=t[e];this.dispatchCount=Math.ceil(e/r)}onInit(){}updateBefore(e){let{renderer:t}=e;t.compute(this)}generate(e){let{shaderStage:t}=e;if("compute"===t){let t=this.computeNode.build(e,"void");""!==t&&e.addLineFlowCode(t)}}constructor(e,t,r=[64]){super("void"),this.isComputeNode=!0,this.computeNode=e,this.count=t,this.workgroupSize=r,this.dispatchCount=0,this.version=1,this.updateBeforeType=o.OBJECT,this.updateDispatchCount()}}k("compute",(e,t,r)=>ec(new oA(ec(e),t,r))),N("ComputeNode",oA);class oR extends S{setup(){let{scope:e,light:t}=this,r=null;return e===oR.TARGET_DIRECTION&&(r=iS.transformDirection(ip(t).sub(ip(t.target)))),r}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}constructor(e=oR.TARGET_DIRECTION,t=null){super(),this.scope=e,this.light=t}}oR.TARGET_DIRECTION="targetDirection";let oC=eg(oR,oR.TARGET_DIRECTION);N("LightNode",oR);let oE=ef(e=>{let{lightDistance:t,cutoffDistance:r,decayExponent:i}=e,s=t.pow(i).max(.01).reciprocal();return r.greaterThan(0).cond(s.mul(t.div(r).pow4().oneMinus().clamp().pow2()),s)});class oB extends sL{update(e){let{light:t}=this;super.update(e),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}setup(e){let{colorNode:t,cutoffDistanceNode:r,decayExponentNode:i,light:s}=this,n=e.context.lightingModel,a=ig(s).sub(sr),o=a.normalize(),l=oE({lightDistance:a.length(),cutoffDistance:r,decayExponent:i}),u=t.mul(l),d=e.context.reflectedLight;n.direct({lightDirection:o,lightColor:u,reflectedLight:d},e.stack,e)}constructor(e=null){super(e),this.cutoffDistanceNode=eX(0),this.decayExponentNode=eX(0)}}N("PointLightNode",oB),sW(c.PointLight,oB);class oF extends sL{setup(e){super.setup(e);let t=e.context.lightingModel,r=this.colorNode,i=oC(this.light),s=e.context.reflectedLight;t.direct({lightDirection:i,lightColor:r,reflectedLight:s},e.stack,e)}constructor(e=null){super(e)}}N("DirectionalLightNode",oF),sW(c.DirectionalLight,oF);class ow extends sL{update(e){super.update(e);let{light:t}=this;this.coneCosNode.value=Math.cos(t.angle),this.penumbraCosNode.value=Math.cos(t.angle*(1-t.penumbra)),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}getSpotAttenuation(e){let{coneCosNode:t,penumbraCosNode:r}=this;return rZ(t,r,e)}setup(e){super.setup(e);let t=e.context.lightingModel,{colorNode:r,cutoffDistanceNode:i,decayExponentNode:s,light:n}=this,a=ig(n).sub(sr),o=a.normalize(),l=o.dot(oC(n)),u=this.getSpotAttenuation(l),d=oE({lightDistance:a.length(),cutoffDistance:i,decayExponent:s}),c=r.mul(u).mul(d),h=e.context.reflectedLight;t.direct({lightDirection:o,lightColor:c,reflectedLight:h},e.stack,e)}constructor(e=null){super(e),this.coneCosNode=eX(0),this.penumbraCosNode=eX(0),this.cutoffDistanceNode=eX(0),this.decayExponentNode=eX(0)}}var oM=ow;N("SpotLightNode",ow),sW(c.SpotLight,ow);class oD extends c.SpotLight{copy(e,t){return super.copy(e,t),this.iesMap=e.iesMap,this}constructor(e,t,r,i,s,n){super(e,t,r,i,s,n),this.iesMap=null}}class oI extends oM{getSpotAttenuation(e){let t=this.light.iesMap;return t&&!0===t.isTexture?ir(t,eA(e.acos().mul(1/Math.PI),0),0).r:super.getSpotAttenuation(e)}}N("IESSpotLightNode",oI),sW(oD,oI);class oO extends sL{setup(e){let{context:t}=e;t.irradiance.addAssign(this.colorNode)}constructor(e=null){super(e)}}N("AmbientLightNode",oO),sW(c.AmbientLight,oO);class oU extends sL{update(e){let{light:t}=this;super.update(e),this.lightPositionNode.object3d=t,this.groundColorNode.value.copy(t.groundColor).multiplyScalar(t.intensity)}setup(e){let{colorNode:t,groundColorNode:r,lightDirectionNode:i}=this,s=rj(r,t,iB.dot(i).mul(.5).add(.5));e.context.irradiance.addAssign(s)}constructor(e=null){super(e),this.lightPositionNode=ip(e),this.lightDirectionNode=this.lightPositionNode.normalize(),this.groundColorNode=eX(new c.Color)}}N("HemisphereLightNode",oU),sW(c.HemisphereLight,oU);let oL=ef(e=>{let t=e.uv.mul(2),r=t.x.floor(),i=t.y.floor();return r.add(i).mod(2).sign()});class oG extends D{setup(){return oL({uv:this.uvNode})}constructor(e=tP()){super("float"),this.uvNode=e}}k("checker",eg(oG)),N("CheckerNode",oG);let oV=new c.PointsMaterial;class oP extends nh{setupShaders(){let e=this.alphaToCoverage,t=this.useColor;this.vertexNode=ef(()=>{eJ(eA(),"vUv").assign(tP());let e=e1("instancePosition"),t=ty("vec4","mvPos");t.assign(i_.mul(eD(e,1)));let r=s4.z.div(s4.w),i=iT.mul(t),s=ty("vec2","offset");return s.assign(i9.xy),s.assign(s.mul(i5)),s.assign(s.div(s4.z)),s.y.assign(s.y.mul(r)),s.assign(s.mul(i.w)),i.assign(i.add(eD(s,0,0))),i})(),this.fragmentNode=ef(()=>{let r=eJ(eA(),"vUv"),i=ty("float","alpha");i.assign(1);let s=r.x,n=r.y,a=s.mul(s).add(n.mul(n));if(e){let e=ty("float","dlen");e.assign(a.fwidth()),i.assign(rZ(e.oneMinus(),e.add(1),a).oneMinus())}else a.greaterThan(1).discard();return eD(this.pointColorNode?this.pointColorNode:t?e1("instanceColor").mul(iL):iL,i)})(),this.needsUpdate=!0}get alphaToCoverage(){return this.useAlphaToCoverage}set alphaToCoverage(e){this.useAlphaToCoverage!==e&&(this.useAlphaToCoverage=e,this.setupShaders())}constructor(e={}){super(),this.normals=!1,this.lights=!1,this.useAlphaToCoverage=!0,this.useColor=e.vertexColors,this.pointWidth=1,this.pointColorNode=null,this.setDefaultValues(oV),this.setupShaders(),this.setValues(e)}}np("InstancedPointsNodeMaterial",oP);let ok=new c.LineBasicMaterial;class oz extends nh{constructor(e){super(),this.isLineBasicNodeMaterial=!0,this.lights=!1,this.normals=!1,this.setDefaultValues(ok),this.setValues(e)}}np("LineBasicNodeMaterial",oz);let oW=new c.LineDashedMaterial;class oH extends nh{setupVariants(){let e=this.offsetNode,t=this.dashScaleNode?eS(this.dashScaleNode):i1,r=this.dashSizeNode?eS(this.dashSizeNode):i2,i=this.dashSizeNode?eS(this.dashGapNode):i3;tD.assign(r),tI.assign(i);let s=eJ(e1("lineDistance").mul(t));(e?s.add(e):s).mod(tD.add(tI)).greaterThan(tD).discard()}constructor(e){super(),this.isLineDashedNodeMaterial=!0,this.lights=!1,this.normals=!1,this.setDefaultValues(oW),this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}}np("LineDashedNodeMaterial",oH);let oq=new c.LineDashedMaterial;class oj extends nh{setupShaders(){let e=this.alphaToCoverage,t=this.useColor,r=this.dashed,i=this.worldUnits,s=ef(e=>{let{start:t,end:r}=e,i=iT.element(2).element(2),s=iT.element(3).element(2).mul(-.5).div(i).sub(t.z).div(r.z.sub(t.z));return eD(rj(t.xyz,r.xyz,s),r.w)});this.vertexNode=ef(()=>{tx("vec2","vUv").assign(tP());let e=e1("instanceStart"),t=e1("instanceEnd"),n=ty("vec4","start"),a=ty("vec4","end");n.assign(i_.mul(eD(e,1))),a.assign(i_.mul(eD(t,1))),i&&(tx("vec3","worldStart").assign(n.xyz),tx("vec3","worldEnd").assign(a.xyz));let o=s4.z.div(s4.w);ex(iT.element(2).element(3).equal(-1),()=>{ex(n.z.lessThan(0).and(a.z.greaterThan(0)),()=>{a.assign(s({start:n,end:a}))}).elseif(a.z.lessThan(0).and(n.z.greaterThanEqual(0)),()=>{n.assign(s({start:a,end:n}))})});let l=iT.mul(n),u=iT.mul(a),d=l.xyz.div(l.w),c=u.xyz.div(u.w),h=c.xy.sub(d.xy).temp();h.x.assign(h.x.mul(o)),h.assign(h.normalize());let p=tl(eD());if(i){let e=a.xyz.sub(n.xyz).normalize(),t=i9.y.lessThan(.5).cond(n.xyz.cross(e).normalize(),a.xyz.cross(e).normalize());t.assign(i9.x.lessThan(0).cond(t.negate(),t));let i=e.dot(eB(0,0,1));r||(n.assign(n.sub(eD(e.mul(i4).mul(.5),0))),a.assign(a.add(eD(e.mul(i4).mul(.5),0))),t.assign(t.sub(eB(h.mul(i),0))),t.z.assign(t.z.add(.5))),ex(i9.y.greaterThan(1).or(i9.y.lessThan(0)),()=>{t.assign(t.add(eB(h.mul(2).mul(i),0)))}),t.assign(t.mul(i4).mul(.5));let s=tx("vec4","worldPos");s.assign(i9.y.lessThan(.5).cond(n,a)),s.assign(s.add(eD(t,0))),p.assign(iT.mul(s));let o=tl(eB());o.assign(i9.y.lessThan(.5).cond(d,c)),p.z.assign(o.z.mul(p.w))}else{let e=ty("vec2","offset");e.assign(eA(h.y,h.x.negate())),h.x.assign(h.x.div(o)),e.x.assign(e.x.div(o)),e.assign(i9.x.lessThan(0).cond(e.negate(),e)),ex(i9.y.lessThan(0),()=>{e.assign(e.sub(h))}).elseif(i9.y.greaterThan(1),()=>{e.assign(e.add(h))}),e.assign(e.mul(i4)),e.assign(e.div(s4.w)),p.assign(i9.y.lessThan(.5).cond(l,u)),e.assign(e.mul(p.w)),p.assign(p.add(eD(e,0,0)))}return p})();let n=ef(e=>{let{p1:t,p2:r,p3:i,p4:s}=e,n=t.sub(i),a=s.sub(i),o=r.sub(t),l=n.dot(a),u=a.dot(o),d=n.dot(o),c=a.dot(a),h=o.dot(o).mul(c).sub(u.mul(u)),p=l.mul(u).sub(d.mul(c)).div(h).clamp(),g=l.add(u.mul(p)).div(c).clamp();return eA(p,g)});this.fragmentNode=ef(()=>{let s;let a=tx("vec2","vUv");if(r){let e=this.offsetNode?eS(this.offsetNodeNode):i8,t=this.dashScaleNode?eS(this.dashScaleNode):i1,r=this.dashSizeNode?eS(this.dashSizeNode):i2,i=this.dashSizeNode?eS(this.dashGapNode):i3;tD.assign(r),tI.assign(i);let s=e1("instanceDistanceStart"),n=e1("instanceDistanceEnd"),o=eJ(i9.y.lessThan(.5).cond(t.mul(s),i1.mul(n)).add(i8)),l=e?o.add(e):o;a.y.lessThan(-1).or(a.y.greaterThan(1)).discard(),l.mod(tD.add(tI)).greaterThan(tD).discard()}let o=ty("float","alpha");if(o.assign(1),i){let t=tx("vec3","worldStart"),i=tx("vec3","worldEnd"),s=tx("vec4","worldPos").xyz.normalize().mul(1e5),a=i.sub(t),l=n({p1:t,p2:i,p3:eB(0,0,0),p4:s}),u=t.add(a.mul(l.x)),d=s.mul(l.y),c=u.sub(d).length().div(i4);if(!r){if(e){let e=c.fwidth();o.assign(rZ(e.negate().add(.5),e.add(.5),c).oneMinus())}else c.greaterThan(.5).discard()}}else if(e){let e=a.x,t=a.y.greaterThan(0).cond(a.y.sub(1),a.y.add(1)),r=e.mul(e).add(t.mul(t)),i=ty("float","dlen");i.assign(r.fwidth()),ex(a.y.abs().greaterThan(1),()=>{o.assign(rZ(i.oneMinus(),i.add(1),r).oneMinus())})}else ex(a.y.abs().greaterThan(1),()=>{let e=a.x,t=a.y.greaterThan(0).cond(a.y.sub(1),a.y.add(1));e.mul(e).add(t.mul(t)).greaterThan(1).discard()});if(this.lineColorNode)s=this.lineColorNode;else if(t){let e=e1("instanceColorStart"),t=e1("instanceColorEnd");s=i9.y.lessThan(.5).cond(e,t).mul(iL)}else s=iL;return eD(s,o)})(),this.needsUpdate=!0}get worldUnits(){return this.useWorldUnits}set worldUnits(e){this.useWorldUnits!==e&&(this.useWorldUnits=e,this.setupShaders())}get dashed(){return this.useDash}set dashed(e){this.useDash!==e&&(this.useDash=e,this.setupShaders())}get alphaToCoverage(){return this.useAlphaToCoverage}set alphaToCoverage(e){this.useAlphaToCoverage!==e&&(this.useAlphaToCoverage=e,this.setupShaders())}constructor(e={}){super(),this.normals=!1,this.lights=!1,this.setDefaultValues(oq),this.useAlphaToCoverage=!0,this.useColor=e.vertexColors,this.useDash=e.dashed,this.useWorldUnits=!1,this.dashOffset=0,this.lineWidth=1,this.lineColorNode=null,this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setupShaders(),this.setValues(e)}}np("Line2NodeMaterial",oj);let oX=new c.MeshNormalMaterial;class oY extends nh{setupDiffuseColor(){let e=this.opacityNode?eS(this.opacityNode):iP;tb.assign(eD(n5(iw),e))}constructor(e){super(),this.isMeshNormalNodeMaterial=!0,this.colorSpaced=!1,this.setDefaultValues(oX),this.setValues(e)}}np("MeshNormalNodeMaterial",oY);let oZ=new c.MeshBasicMaterial;class oK extends nh{constructor(e){super(),this.isMeshBasicNodeMaterial=!0,this.lights=!1,this.setDefaultValues(oZ),this.setValues(e)}}np("MeshBasicNodeMaterial",oK);let oQ=ef(e=>{let{f0:t,f90:r,dotVH:i}=e,s=i.mul(-5.55473).sub(6.98316).mul(i).exp2();return t.mul(s.oneMinus()).add(r.mul(s))}),oJ=ef(e=>e.diffuseColor.mul(1/Math.PI)),o$=()=>eS(.25),o0=ef(e=>{let{dotNH:t}=e;return tw.mul(.5/Math.PI).add(1).mul(t.pow(tw))}),o1=ef(e=>{let{lightDirection:t}=e,r=t.add(si).normalize(),i=iw.dot(r).clamp(),s=oQ({f0:tF,f90:1,dotVH:si.dot(r).clamp()}),n=o$(),a=o0({dotNH:i});return s.mul(n).mul(a)});class o2 extends ta{direct(e){let{lightDirection:t,lightColor:r,reflectedLight:i}=e,s=iw.dot(t).clamp().mul(r);i.directDiffuse.addAssign(s.mul(oJ({diffuseColor:tb.rgb}))),!0===this.specular&&i.directSpecular.addAssign(s.mul(o1({lightDirection:t})).mul(iz))}indirectDiffuse(e){let{irradiance:t,reflectedLight:r}=e;r.indirectDiffuse.addAssign(t.mul(oJ({diffuseColor:tb})))}constructor(e=!0){super(),this.specular=e}}let o3=new c.MeshLambertMaterial;class o4 extends nh{setupLightingModel(){return new o2(!1)}constructor(e){super(),this.isMeshLambertNodeMaterial=!0,this.lights=!0,this.setDefaultValues(o3),this.setValues(e)}}np("MeshLambertNodeMaterial",o4);let o8=new c.MeshPhongMaterial;class o5 extends nh{setupLightingModel(){return new o2}setupVariants(){let e=(this.shininessNode?eS(this.shininessNode):iG).max(1e-4);tw.assign(e);let t=this.specularNode||ik;tF.assign(t)}copy(e){return this.shininessNode=e.shininessNode,this.specularNode=e.specularNode,super.copy(e)}constructor(e){super(),this.isMeshPhongNodeMaterial=!0,this.lights=!0,this.shininessNode=null,this.specularNode=null,this.setDefaultValues(o8),this.setValues(e)}}np("MeshPhongNodeMaterial",o5);let o6=ef(()=>{let e=iC.dFdx().abs().max(iC.dFdy().abs());return e.x.max(e.y).max(e.z)}),o9=ef(e=>{let{roughness:t}=e,r=o6(),i=t.max(.0525);return(i=i.add(r)).min(1)}),o7=ef(e=>{let{alpha:t,dotNL:r,dotNV:i}=e,s=t.pow2(),n=r.mul(s.add(s.oneMinus().mul(i.pow2())).sqrt()),a=i.mul(s.add(s.oneMinus().mul(r.pow2())).sqrt());return tX(.5,n.add(a).max(rt))}).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),le=ef(e=>{let{alpha:t,dotNH:r}=e,i=t.pow2(),s=r.pow2().mul(i.oneMinus()).oneMinus();return i.div(s.pow2()).mul(1/Math.PI)}).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),lt=ef(e=>{let{lightDirection:t,f0:r,f90:i,roughness:s,iridescenceFresnel:n}=e,a=e.normalView||iw,o=s.pow2(),l=t.add(si).normalize(),u=a.dot(t).clamp(),d=a.dot(si).clamp(),c=a.dot(l).clamp(),h=oQ({f0:r,f90:i,dotVH:si.dot(l).clamp()});n&&(h=tC.mix(h,n));let p=o7({alpha:o,dotNL:u,dotNV:d}),g=le({alpha:o,dotNH:c});return h.mul(p).mul(g)}),lr=ef(e=>{let{roughness:t,dotNV:r}=e,i=eD(-1,-.0275,-.572,.022),s=eD(1,.0425,1.04,-.04),n=t.mul(i).add(s),a=n.x.mul(n.x).min(r.mul(-9.28).exp2()).mul(n.x).add(n.y);return eA(-1.04,1.04).mul(a).add(n.zw)}).setLayout({name:"DFGApprox",type:"vec2",inputs:[{name:"roughness",type:"float"},{name:"dotNV",type:"vec3"}]}),li=ef(e=>{let{dotNV:t,specularColor:r,specularF90:i,roughness:s}=e,n=lr({dotNV:t,roughness:s});return r.mul(n.x).add(i.mul(n.y))}),ls=ef(e=>{let{f:t,f90:r,dotVH:i}=e,s=i.oneMinus().saturate(),n=s.mul(s),a=s.mul(n,n).clamp(0,.9999);return t.sub(eB(r).mul(a)).div(a.oneMinus())}).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),ln=ef(e=>{let{roughness:t,dotNH:r}=e,i=t.pow2(),s=eS(1).div(i),n=r.pow2().oneMinus().max(.0078125);return eS(2).add(s).mul(n.pow(s.mul(.5))).div(2*Math.PI)}).setLayout({name:"D_Charlie",type:"float",inputs:[{name:"roughness",type:"float"},{name:"dotNH",type:"float"}]}),la=ef(e=>{let{dotNV:t,dotNL:r}=e;return eS(1).div(eS(4).mul(r.add(t).sub(r.mul(t))))}).setLayout({name:"V_Neubelt",type:"float",inputs:[{name:"dotNV",type:"float"},{name:"dotNL",type:"float"}]}),lo=ef(e=>{let{lightDirection:t}=e,r=t.add(si).normalize(),i=iw.dot(t).clamp(),s=iw.dot(si).clamp(),n=ln({roughness:tR,dotNH:iw.dot(r).clamp()}),a=la({dotNV:s,dotNL:i});return tA.mul(n).mul(a)}),ll=eL(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),lu=e=>{let t=e.sqrt();return eB(1).add(t).div(eB(1).sub(t))},ld=(e,t)=>e.sub(t).div(e.add(t)).pow2(),lc=(e,t)=>{let r=e.mul(2*Math.PI*1e-9),i=eB(54856e-17,44201e-17,52481e-17),s=eB(1681e3,1795300,2208400),n=eB(43278e5,93046e5,66121e5),a=eS(9747e-17*Math.sqrt(2*Math.PI*45282e5)).mul(r.mul(2239900).add(t.x).cos()).mul(r.pow2().mul(-45282e5).exp()),o=i.mul(n.mul(2*Math.PI).sqrt()).mul(s.mul(r).add(t).cos()).mul(r.pow2().negate().mul(n).exp());return o=eB(o.x.add(a),o.y,o.z).div(10685e-11),ll.mul(o)},lh=ef(e=>{let{outsideIOR:t,eta2:r,cosTheta1:i,thinFilmThickness:s,baseF0:n}=e,a=rj(t,r,rZ(0,.03,s)),o=t.div(a).pow2().mul(eS(1).sub(i.pow2())),l=eS(1).sub(o).sqrt(),u=oQ({f0:ld(a,t),f90:1,dotVH:i}),d=u.oneMinus(),c=a.lessThan(t).cond(Math.PI,0),h=eS(Math.PI).sub(c),p=lu(n.clamp(0,.9999)),g=oQ({f0:ld(p,a.vec3()),f90:1,dotVH:l}),m=eB(p.x.lessThan(a).cond(Math.PI,0),p.y.lessThan(a).cond(Math.PI,0),p.z.lessThan(a).cond(Math.PI,0)),f=a.mul(s,l,2),T=eB(h).add(m),y=u.mul(g).clamp(1e-5,.9999),x=y.sqrt(),b=d.pow2().mul(g).div(eB(1).sub(y)),S=u.add(b),N=b.sub(d);for(let e=1;e<=2;++e){N=N.mul(x);let t=lc(eS(e).mul(f),eS(e).mul(T)).mul(2);S=S.add(N.mul(t))}return S.max(eB(0))}).setLayout({name:"evalIridescence",type:"vec3",inputs:[{name:"outsideIOR",type:"float"},{name:"eta2",type:"float"},{name:"cosTheta1",type:"float"},{name:"thinFilmThickness",type:"float"},{name:"baseF0",type:"vec3"}]}),lp=ef(e=>{let{normal:t,viewDir:r,roughness:i}=e,s=t.dot(r).saturate(),n=i.pow2(),a=nM(i.lessThan(.25),eS(-339.2).mul(n).add(eS(161.4).mul(i)).sub(25.9),eS(-8.48).mul(n).add(eS(14.3).mul(i)).sub(9.95)),o=nM(i.lessThan(.25),eS(44).mul(n).sub(eS(23.7).mul(i)).add(3.26),eS(1.97).mul(n).sub(eS(3.27).mul(i)).add(.72));return nM(i.lessThan(.25),0,eS(.1).mul(i).sub(.025)).add(a.mul(s).add(o).exp()).mul(1/Math.PI).saturate()}),lg=eB(.04),lm=eB(1);class lf extends ta{start(){if(!0===this.clearcoat&&(this.clearcoatRadiance=eB().temp("clearcoatRadiance"),this.clearcoatSpecularDirect=eB().temp("clearcoatSpecularDirect"),this.clearcoatSpecularIndirect=eB().temp("clearcoatSpecularIndirect")),!0===this.sheen&&(this.sheenSpecularDirect=eB().temp("sheenSpecularDirect"),this.sheenSpecularIndirect=eB().temp("sheenSpecularIndirect")),!0===this.iridescence){let e=iw.dot(si).clamp();this.iridescenceFresnel=lh({outsideIOR:eS(1),eta2:tE,cosTheta1:e,thinFilmThickness:tB,baseF0:tF}),this.iridescenceF0=ls({f:this.iridescenceFresnel,f90:1,dotVH:e})}}computeMultiscattering(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:eS(1),i=lr({roughness:tS,dotNV:iw.dot(si).clamp()}),s=(this.iridescenceF0?tC.mix(tF,this.iridescenceF0):tF).mul(i.x).add(r.mul(i.y)),n=i.x.add(i.y).oneMinus(),a=tF.add(tF.oneMinus().mul(.047619)),o=s.mul(a).div(n.mul(a).oneMinus());e.addAssign(s),t.addAssign(o.mul(n))}direct(e){let{lightDirection:t,lightColor:r,reflectedLight:i}=e,s=iw.dot(t).clamp().mul(r);if(!0===this.sheen&&this.sheenSpecularDirect.addAssign(s.mul(lo({lightDirection:t}))),!0===this.clearcoat){let e=iD.dot(t).clamp().mul(r);this.clearcoatSpecularDirect.addAssign(e.mul(lt({lightDirection:t,f0:lg,f90:lm,roughness:tv,normalView:iD})))}i.directDiffuse.addAssign(s.mul(oJ({diffuseColor:tb.rgb}))),i.directSpecular.addAssign(s.mul(lt({lightDirection:t,f0:tF,f90:1,roughness:tS,iridescence:this.iridescence,iridescenceFresnel:this.iridescenceFresnel})))}indirectDiffuse(e){let{irradiance:t,reflectedLight:r}=e;r.indirectDiffuse.addAssign(t.mul(oJ({diffuseColor:tb})))}indirectSpecular(e){let{radiance:t,iblIrradiance:r,reflectedLight:i}=e;if(!0===this.sheen&&this.sheenSpecularIndirect.addAssign(r.mul(tA,lp({normal:iw,viewDir:si,roughness:tR}))),!0===this.clearcoat){let e=li({dotNV:iD.dot(si).clamp(),specularColor:lg,specularF90:lm,roughness:tv});this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(e))}let s=eB().temp("singleScattering"),n=eB().temp("multiScattering"),a=r.mul(1/Math.PI);this.computeMultiscattering(s,n);let o=s.add(n),l=tb.mul(o.r.max(o.g).max(o.b).oneMinus());i.indirectSpecular.addAssign(t.mul(s)),i.indirectSpecular.addAssign(n.mul(a)),i.indirectDiffuse.addAssign(l.mul(a))}ambientOcclusion(e){let{ambientOcclusion:t,reflectedLight:r}=e,i=iw.dot(si).clamp().add(t),s=tS.mul(-16).oneMinus().negate().exp2(),n=t.sub(i.pow(s).oneMinus()).clamp();!0===this.clearcoat&&this.clearcoatSpecularIndirect.mulAssign(t),!0===this.sheen&&this.sheenSpecularIndirect.mulAssign(t),r.indirectDiffuse.mulAssign(t),r.indirectSpecular.mulAssign(n)}finish(e){let{outgoingLight:t}=e;if(!0===this.clearcoat){let e=oQ({dotVH:iD.dot(si).clamp(),f0:lg,f90:lm}),r=t.mul(t_.mul(e).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(t_));t.assign(r)}if(!0===this.sheen){let e=tA.r.max(tA.g).max(tA.b).mul(.157).oneMinus(),r=t.mul(e).add(this.sheenSpecularDirect,this.sheenSpecularIndirect);t.assign(r)}}constructor(e=!1,t=!1,r=!1){super(),this.clearcoat=e,this.sheen=t,this.iridescence=r,this.clearcoatRadiance=null,this.clearcoatSpecularDirect=null,this.clearcoatSpecularIndirect=null,this.sheenSpecularDirect=null,this.sheenSpecularIndirect=null,this.iridescenceFresnel=null,this.iridescenceF0=null}}let lT=new c.MeshStandardMaterial;class ly extends nh{setupLightingModel(){return new lf}setupVariants(){let e=this.metalnessNode?eS(this.metalnessNode):iH;tN.assign(e);let t=this.roughnessNode?eS(this.roughnessNode):iW;t=o9({roughness:t}),tS.assign(t);let r=rj(eB(.04),tb.rgb,e);tF.assign(r),tb.assign(eD(tb.rgb.mul(e.oneMinus()),tb.a))}copy(e){return this.emissiveNode=e.emissiveNode,this.metalnessNode=e.metalnessNode,this.roughnessNode=e.roughnessNode,super.copy(e)}constructor(e){super(),this.isMeshStandardNodeMaterial=!0,this.emissiveNode=null,this.metalnessNode=null,this.roughnessNode=null,this.setDefaultValues(lT),this.setValues(e)}}var lx=ly;np("MeshStandardNodeMaterial",ly);let lb=new c.MeshPhysicalMaterial;class lS extends lx{get useClearcoat(){return this.clearcoat>0||null!==this.clearcoatNode}get useIridescence(){return this.iridescence>0||null!==this.iridescenceNode}get useSheen(){return this.sheen>0||null!==this.sheenNode}setupLightingModel(){return new lf(this.useClearcoat,this.useSheen,this.useIridescence)}setupVariants(e){if(super.setupVariants(e),this.useClearcoat){let e=this.clearcoatNode?eS(this.clearcoatNode):ij,t=this.clearcoatRoughnessNode?eS(this.clearcoatRoughnessNode):iX;t_.assign(e),tv.assign(t)}if(this.useSheen){let e=this.sheenNode?eB(this.sheenNode):iK,t=this.sheenRoughnessNode?eS(this.sheenRoughnessNode):iQ;tA.assign(e),tR.assign(t)}if(this.useIridescence){let e=this.iridescenceNode?eS(this.iridescenceNode):iJ,t=this.iridescenceIORNode?eS(this.iridescenceIORNode):i$,r=this.iridescenceThicknessNode?eS(this.iridescenceThicknessNode):i0;tC.assign(e),tE.assign(t),tB.assign(r)}}setupNormal(e){super.setupNormal(e);let t=this.clearcoatNormalNode?eB(this.clearcoatNormalNode):iY;iD.assign(t)}copy(e){return this.clearcoatNode=e.clearcoatNode,this.clearcoatRoughnessNode=e.clearcoatRoughnessNode,this.clearcoatNormalNode=e.clearcoatNormalNode,this.sheenNode=e.sheenNode,this.sheenRoughnessNode=e.sheenRoughnessNode,this.iridescenceNode=e.iridescenceNode,this.iridescenceIORNode=e.iridescenceIORNode,this.iridescenceThicknessNode=e.iridescenceThicknessNode,this.specularIntensityNode=e.specularIntensityNode,this.specularColorNode=e.specularColorNode,this.transmissionNode=e.transmissionNode,this.thicknessNode=e.thicknessNode,this.attenuationDistanceNode=e.attenuationDistanceNode,this.attenuationColorNode=e.attenuationColorNode,super.copy(e)}constructor(e){super(),this.isMeshPhysicalNodeMaterial=!0,this.clearcoatNode=null,this.clearcoatRoughnessNode=null,this.clearcoatNormalNode=null,this.sheenNode=null,this.sheenRoughnessNode=null,this.iridescenceNode=null,this.iridescenceIORNode=null,this.iridescenceThicknessNode=null,this.specularIntensityNode=null,this.specularColorNode=null,this.transmissionNode=null,this.thicknessNode=null,this.attenuationDistanceNode=null,this.attenuationColorNode=null,this.setDefaultValues(lb),this.setValues(e)}}np("MeshPhysicalNodeMaterial",lS);let lN=new c.PointsMaterial;class l_ extends nh{copy(e){return this.sizeNode=e.sizeNode,super.copy(e)}constructor(e){super(),this.isPointsNodeMaterial=!0,this.lights=!1,this.normals=!1,this.transparent=!0,this.sizeNode=null,this.setDefaultValues(lN),this.setValues(e)}}np("PointsNodeMaterial",l_);let lv=new c.SpriteMaterial;class lA extends nh{setupPosition(e){let{object:t,context:r}=e,{positionNode:i,rotationNode:s,scaleNode:n}=this,a=i_.mul(eB(i||0)),o=eA(iA[0].xyz.length(),iA[1].xyz.length());null!==n&&(o=o.mul(n));let l=i7.xy;t.center&&!0===t.center.isVector2&&(l=l.sub(eX(t.center).sub(.5))),l=l.mul(o);let u=eS(s||iZ),d=u.cos(),c=u.sin(),h=eA(eA(d,c.negate()).dot(l),eA(c,d).dot(l));a=eD(a.xy.add(h),a.zw);let p=iT.mul(a);return r.vertex=i7,p}copy(e){return this.positionNode=e.positionNode,this.rotationNode=e.rotationNode,this.scaleNode=e.scaleNode,super.copy(e)}constructor(e){super(),this.isSpriteNodeMaterial=!0,this.lights=!1,this.normals=!1,this.positionNode=null,this.rotationNode=null,this.scaleNode=null,this.setDefaultValues(lv),this.setValues(e)}}np("SpriteNodeMaterial",lA);let lR=c.MaterialLoader.createMaterialFromType;c.MaterialLoader.createMaterialFromType=function(e){let t=ng(e);return void 0!==t?t:lR.call(this,e)};var lC=r(3858),lE=r(1812);let lB=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,lF=/[a-z_0-9]+/ig,lw="#pragma main",lM=e=>{let t=(e=e.trim()).indexOf(lw),r=-1!==t?e.slice(t+lw.length):e,i=r.match(lB);if(null!==i&&5===i.length){let s=i[4],n=[],a=null;for(;null!==(a=lF.exec(s));)n.push(a);let o=[],l=0;for(;l<n.length;){let e="const"===n[l][0];!0===e&&l++;let t=n[l][0];"in"===t||"out"===t||"inout"===t?l++:t="";let r=n[l++][0],i=Number.parseInt(n[l][0]);!1===Number.isNaN(i)?l++:i=null;let s=n[l++][0];o.push(new nH.Z(r,s,i,t,e))}let u=r.substring(i[0].length),d=void 0!==i[3]?i[3]:"";return{type:i[2],inputs:o,name:d,presicion:void 0!==i[1]?i[1]:"",inputsCode:s,blockCode:u,headerCode:-1!==t?e.slice(0,t):""}}throw Error("FunctionNode: Function is not a GLSL code.")};class lD extends lE.Z{getCode(){let e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.name,r=this.blockCode;if(""!==r){let{type:i,inputsCode:s,headerCode:n,presicion:a}=this,o="".concat(i," ").concat(t," ( ").concat(s.trim()," )");""!==a&&(o="".concat(a," ").concat(o)),e=n+o+r}else e="";return e}constructor(e){let{type:t,inputs:r,name:i,presicion:s,inputsCode:n,blockCode:a,headerCode:o}=lM(e);super(t,r,i,s),this.inputsCode=n,this.blockCode=a,this.headerCode=o}}class lI extends lC.Z{parseFunction(e){return new lD(e)}}var lO=lI;let lU=ef(e=>{let[t,r,i]=e,s=eS(i).toVar(),n=eS(r).toVar();return nM(ev(t).toVar(),n,s)}),lL=ef(e=>{let[t,r]=e,i=ev(r).toVar(),s=eS(t).toVar();return nM(i,s.negate(),s)}),lG=ef(e=>{let[t]=e;return eN(rd(eS(t).toVar()))}),lV=ef(e=>{let[t,r]=e,i=eS(t).toVar();return r.assign(lG(i)),i.sub(eS(r))}),lP=ef(e=>{let[t,r,i,s,n,a]=e,o=eS(a).toVar(),l=eS(n).toVar(),u=eS(s).toVar(),d=eS(i).toVar(),c=eS(r).toVar(),h=eS(t).toVar(),p=eS(tq(1,l)).toVar();return tq(1,o).mul(h.mul(p).add(c.mul(l))).add(o.mul(d.mul(p).add(u.mul(l))))}),lk=ef(e=>{let[t,r,i,s,n,a]=e,o=eS(a).toVar(),l=eS(n).toVar(),u=eB(s).toVar(),d=eB(i).toVar(),c=eB(r).toVar(),h=eB(t).toVar(),p=eS(tq(1,l)).toVar();return tq(1,o).mul(h.mul(p).add(c.mul(l))).add(o.mul(d.mul(p).add(u.mul(l))))}),lz=nJ([lP,lk]),lW=ef(e=>{let[t,r,i,s,n,a,o,l,u,d,c]=e,h=eS(c).toVar(),p=eS(d).toVar(),g=eS(u).toVar(),m=eS(l).toVar(),f=eS(o).toVar(),T=eS(a).toVar(),y=eS(n).toVar(),x=eS(s).toVar(),b=eS(i).toVar(),S=eS(r).toVar(),N=eS(t).toVar(),_=eS(tq(1,g)).toVar(),v=eS(tq(1,p)).toVar();return eS(tq(1,h)).toVar().mul(v.mul(N.mul(_).add(S.mul(g))).add(p.mul(b.mul(_).add(x.mul(g))))).add(h.mul(v.mul(y.mul(_).add(T.mul(g))).add(p.mul(f.mul(_).add(m.mul(g))))))}),lH=ef(e=>{let[t,r,i,s,n,a,o,l,u,d,c]=e,h=eS(c).toVar(),p=eS(d).toVar(),g=eS(u).toVar(),m=eB(l).toVar(),f=eB(o).toVar(),T=eB(a).toVar(),y=eB(n).toVar(),x=eB(s).toVar(),b=eB(i).toVar(),S=eB(r).toVar(),N=eB(t).toVar(),_=eS(tq(1,g)).toVar(),v=eS(tq(1,p)).toVar();return eS(tq(1,h)).toVar().mul(v.mul(N.mul(_).add(S.mul(g))).add(p.mul(b.mul(_).add(x.mul(g))))).add(h.mul(v.mul(y.mul(_).add(T.mul(g))).add(p.mul(f.mul(_).add(m.mul(g))))))}),lq=nJ([lW,lH]),lj=ef(e=>{let[t,r,i]=e,s=eS(i).toVar(),n=eS(r).toVar(),a=e_(t).toVar(),o=e_(a.bitAnd(e_(7))).toVar(),l=eS(lU(o.lessThan(e_(4)),n,s)).toVar(),u=eS(tj(2,lU(o.lessThan(e_(4)),s,n))).toVar();return lL(l,ev(o.bitAnd(e_(1)))).add(lL(u,ev(o.bitAnd(e_(2)))))}),lX=ef(e=>{let[t,r,i,s]=e,n=eS(s).toVar(),a=eS(i).toVar(),o=eS(r).toVar(),l=e_(t).toVar(),u=e_(l.bitAnd(e_(15))).toVar(),d=eS(lU(u.lessThan(e_(8)),o,a)).toVar(),c=eS(lU(u.lessThan(e_(4)),a,lU(u.equal(e_(12)).or(u.equal(e_(14))),o,n))).toVar();return lL(d,ev(u.bitAnd(e_(1)))).add(lL(c,ev(u.bitAnd(e_(2)))))}),lY=nJ([lj,lX]),lZ=ef(e=>{let[t,r,i]=e,s=eS(i).toVar(),n=eS(r).toVar(),a=ew(t).toVar();return eB(lY(a.x,n,s),lY(a.y,n,s),lY(a.z,n,s))}),lK=ef(e=>{let[t,r,i,s]=e,n=eS(s).toVar(),a=eS(i).toVar(),o=eS(r).toVar(),l=ew(t).toVar();return eB(lY(l.x,o,a,n),lY(l.y,o,a,n),lY(l.z,o,a,n))}),lQ=nJ([lZ,lK]),lJ=ef(e=>{let[t]=e;return tj(.6616,eS(t).toVar())}),l$=ef(e=>{let[t]=e;return tj(.982,eS(t).toVar())}),l0=ef(e=>{let[t]=e;return tj(.6616,eB(t).toVar())}),l1=nJ([lJ,l0]),l2=ef(e=>{let[t]=e;return tj(.982,eB(t).toVar())}),l3=nJ([l$,l2]),l4=ef(e=>{let[t,r]=e,i=eN(r).toVar(),s=e_(t).toVar();return s.shiftLeft(i).bitOr(s.shiftRight(eN(32).sub(i)))}),l8=ef(e=>{let[t,r,i]=e;t.subAssign(i),t.bitXorAssign(l4(i,eN(4))),i.addAssign(r),r.subAssign(t),r.bitXorAssign(l4(t,eN(6))),t.addAssign(i),i.subAssign(r),i.bitXorAssign(l4(r,eN(8))),r.addAssign(t),t.subAssign(i),t.bitXorAssign(l4(i,eN(16))),i.addAssign(r),r.subAssign(t),r.bitXorAssign(l4(t,eN(19))),t.addAssign(i),i.subAssign(r),i.bitXorAssign(l4(r,eN(4))),r.addAssign(t)}),l5=ef(e=>{let[t,r,i]=e,s=e_(i).toVar(),n=e_(r).toVar(),a=e_(t).toVar();return s.bitXorAssign(n),s.subAssign(l4(n,eN(14))),a.bitXorAssign(s),a.subAssign(l4(s,eN(11))),n.bitXorAssign(a),n.subAssign(l4(a,eN(25))),s.bitXorAssign(n),s.subAssign(l4(n,eN(16))),a.bitXorAssign(s),a.subAssign(l4(s,eN(4))),n.bitXorAssign(a),n.subAssign(l4(a,eN(14))),s.bitXorAssign(n),s.subAssign(l4(n,eN(24))),s}),l6=ef(e=>{let[t]=e;return eS(e_(t).toVar()).div(eS(e_(eN(4294967295))))}),l9=ef(e=>{let[t]=e,r=eS(t).toVar();return r.mul(r.mul(r.mul(r.mul(r.mul(6).sub(15)).add(10))))}),l7=ef(e=>{let[t]=e,r=eN(t).toVar(),i=e_(e_(1)).toVar(),s=e_(e_(eN(3735928559)).add(i.shiftLeft(e_(2)).add(e_(13)))).toVar();return l5(s.add(e_(r)),s,s)}),ue=ef(e=>{let[t,r]=e,i=eN(r).toVar(),s=eN(t).toVar(),n=e_(e_(2)).toVar(),a=e_().toVar(),o=e_().toVar(),l=e_().toVar();return a.assign(o.assign(l.assign(e_(eN(3735928559)).add(n.shiftLeft(e_(2)).add(e_(13)))))),a.addAssign(e_(s)),o.addAssign(e_(i)),l5(a,o,l)}),ut=ef(e=>{let[t,r,i]=e,s=eN(i).toVar(),n=eN(r).toVar(),a=eN(t).toVar(),o=e_(e_(3)).toVar(),l=e_().toVar(),u=e_().toVar(),d=e_().toVar();return l.assign(u.assign(d.assign(e_(eN(3735928559)).add(o.shiftLeft(e_(2)).add(e_(13)))))),l.addAssign(e_(a)),u.addAssign(e_(n)),d.addAssign(e_(s)),l5(l,u,d)}),ur=ef(e=>{let[t,r,i,s]=e,n=eN(s).toVar(),a=eN(i).toVar(),o=eN(r).toVar(),l=eN(t).toVar(),u=e_(e_(4)).toVar(),d=e_().toVar(),c=e_().toVar(),h=e_().toVar();return d.assign(c.assign(h.assign(e_(eN(3735928559)).add(u.shiftLeft(e_(2)).add(e_(13)))))),d.addAssign(e_(l)),c.addAssign(e_(o)),h.addAssign(e_(a)),l8(d,c,h),d.addAssign(e_(n)),l5(d,c,h)}),ui=ef(e=>{let[t,r,i,s,n]=e,a=eN(n).toVar(),o=eN(s).toVar(),l=eN(i).toVar(),u=eN(r).toVar(),d=eN(t).toVar(),c=e_(e_(5)).toVar(),h=e_().toVar(),p=e_().toVar(),g=e_().toVar();return h.assign(p.assign(g.assign(e_(eN(3735928559)).add(c.shiftLeft(e_(2)).add(e_(13)))))),h.addAssign(e_(d)),p.addAssign(e_(u)),g.addAssign(e_(l)),l8(h,p,g),h.addAssign(e_(o)),p.addAssign(e_(a)),l5(h,p,g)}),us=nJ([l7,ue,ut,ur,ui]),un=ef(e=>{let[t,r]=e,i=eN(r).toVar(),s=e_(us(eN(t).toVar(),i)).toVar(),n=ew().toVar();return n.x.assign(s.bitAnd(eN(255))),n.y.assign(s.shiftRight(eN(8)).bitAnd(eN(255))),n.z.assign(s.shiftRight(eN(16)).bitAnd(eN(255))),n}),ua=ef(e=>{let[t,r,i]=e,s=eN(i).toVar(),n=eN(r).toVar(),a=e_(us(eN(t).toVar(),n,s)).toVar(),o=ew().toVar();return o.x.assign(a.bitAnd(eN(255))),o.y.assign(a.shiftRight(eN(8)).bitAnd(eN(255))),o.z.assign(a.shiftRight(eN(16)).bitAnd(eN(255))),o}),uo=nJ([un,ua]),ul=ef(e=>{let[t]=e,r=eA(t).toVar(),i=eN().toVar(),s=eN().toVar(),n=eS(lV(r.x,i)).toVar(),a=eS(lV(r.y,s)).toVar(),o=eS(l9(n)).toVar(),l=eS(l9(a)).toVar();return l1(eS(lz(lY(us(i,s),n,a),lY(us(i.add(eN(1)),s),n.sub(1),a),lY(us(i,s.add(eN(1))),n,a.sub(1)),lY(us(i.add(eN(1)),s.add(eN(1))),n.sub(1),a.sub(1)),o,l)).toVar())}),uu=ef(e=>{let[t]=e,r=eB(t).toVar(),i=eN().toVar(),s=eN().toVar(),n=eN().toVar(),a=eS(lV(r.x,i)).toVar(),o=eS(lV(r.y,s)).toVar(),l=eS(lV(r.z,n)).toVar(),u=eS(l9(a)).toVar(),d=eS(l9(o)).toVar(),c=eS(l9(l)).toVar();return l3(eS(lq(lY(us(i,s,n),a,o,l),lY(us(i.add(eN(1)),s,n),a.sub(1),o,l),lY(us(i,s.add(eN(1)),n),a,o.sub(1),l),lY(us(i.add(eN(1)),s.add(eN(1)),n),a.sub(1),o.sub(1),l),lY(us(i,s,n.add(eN(1))),a,o,l.sub(1)),lY(us(i.add(eN(1)),s,n.add(eN(1))),a.sub(1),o,l.sub(1)),lY(us(i,s.add(eN(1)),n.add(eN(1))),a,o.sub(1),l.sub(1)),lY(us(i.add(eN(1)),s.add(eN(1)),n.add(eN(1))),a.sub(1),o.sub(1),l.sub(1)),u,d,c)).toVar())}),ud=nJ([ul,uu]),uc=ef(e=>{let[t]=e,r=eA(t).toVar(),i=eN().toVar(),s=eN().toVar(),n=eS(lV(r.x,i)).toVar(),a=eS(lV(r.y,s)).toVar(),o=eS(l9(n)).toVar(),l=eS(l9(a)).toVar();return l1(eB(lz(lQ(uo(i,s),n,a),lQ(uo(i.add(eN(1)),s),n.sub(1),a),lQ(uo(i,s.add(eN(1))),n,a.sub(1)),lQ(uo(i.add(eN(1)),s.add(eN(1))),n.sub(1),a.sub(1)),o,l)).toVar())}),uh=ef(e=>{let[t]=e,r=eB(t).toVar(),i=eN().toVar(),s=eN().toVar(),n=eN().toVar(),a=eS(lV(r.x,i)).toVar(),o=eS(lV(r.y,s)).toVar(),l=eS(lV(r.z,n)).toVar(),u=eS(l9(a)).toVar(),d=eS(l9(o)).toVar(),c=eS(l9(l)).toVar();return l3(eB(lq(lQ(uo(i,s,n),a,o,l),lQ(uo(i.add(eN(1)),s,n),a.sub(1),o,l),lQ(uo(i,s.add(eN(1)),n),a,o.sub(1),l),lQ(uo(i.add(eN(1)),s.add(eN(1)),n),a.sub(1),o.sub(1),l),lQ(uo(i,s,n.add(eN(1))),a,o,l.sub(1)),lQ(uo(i.add(eN(1)),s,n.add(eN(1))),a.sub(1),o,l.sub(1)),lQ(uo(i,s.add(eN(1)),n.add(eN(1))),a,o.sub(1),l.sub(1)),lQ(uo(i.add(eN(1)),s.add(eN(1)),n.add(eN(1))),a.sub(1),o.sub(1),l.sub(1)),u,d,c)).toVar())}),up=nJ([uc,uh]),ug=ef(e=>{let[t]=e;return l6(us(eN(lG(eS(t).toVar())).toVar()))}),um=ef(e=>{let[t]=e,r=eA(t).toVar();return l6(us(eN(lG(r.x)).toVar(),eN(lG(r.y)).toVar()))}),uf=ef(e=>{let[t]=e,r=eB(t).toVar();return l6(us(eN(lG(r.x)).toVar(),eN(lG(r.y)).toVar(),eN(lG(r.z)).toVar()))}),uT=ef(e=>{let[t]=e,r=eD(t).toVar(),i=eN(lG(r.x)).toVar();return l6(us(i,eN(lG(r.y)).toVar(),eN(lG(r.z)).toVar(),eN(lG(r.w)).toVar()))});nJ([ug,um,uf,uT]);let uy=ef(e=>{let[t]=e,r=eN(lG(eS(t).toVar())).toVar();return eB(l6(us(r,eN(0))),l6(us(r,eN(1))),l6(us(r,eN(2))))}),ux=ef(e=>{let[t]=e,r=eA(t).toVar(),i=eN(lG(r.x)).toVar(),s=eN(lG(r.y)).toVar();return eB(l6(us(i,s,eN(0))),l6(us(i,s,eN(1))),l6(us(i,s,eN(2))))}),ub=ef(e=>{let[t]=e,r=eB(t).toVar(),i=eN(lG(r.x)).toVar(),s=eN(lG(r.y)).toVar(),n=eN(lG(r.z)).toVar();return eB(l6(us(i,s,n,eN(0))),l6(us(i,s,n,eN(1))),l6(us(i,s,n,eN(2))))}),uS=ef(e=>{let[t]=e,r=eD(t).toVar(),i=eN(lG(r.x)).toVar(),s=eN(lG(r.y)).toVar(),n=eN(lG(r.z)).toVar(),a=eN(lG(r.w)).toVar();return eB(l6(us(i,s,n,a,eN(0))),l6(us(i,s,n,a,eN(1))),l6(us(i,s,n,a,eN(2))))}),uN=nJ([uy,ux,ub,uS]),u_=ef(e=>{let[t,r,i,s]=e,n=eS(s).toVar(),a=eS(i).toVar(),o=eN(r).toVar(),l=eB(t).toVar(),u=eS(0).toVar(),d=eS(1).toVar();return n0({start:eN(0),end:o},e=>{let{i:t}=e;u.addAssign(d.mul(ud(l))),d.mulAssign(n),l.mulAssign(a)}),u}),uv=ef(e=>{let[t,r,i,s]=e,n=eS(s).toVar(),a=eS(i).toVar(),o=eN(r).toVar(),l=eB(t).toVar(),u=eB(0).toVar(),d=eS(1).toVar();return n0({start:eN(0),end:o},e=>{let{i:t}=e;u.addAssign(d.mul(up(l))),d.mulAssign(n),l.mulAssign(a)}),u}),uA=ef(e=>{let[t,r,i,s]=e,n=eS(s).toVar(),a=eS(i).toVar(),o=eN(r).toVar(),l=eB(t).toVar();return eA(u_(l,o,a,n),u_(l.add(eB(eN(19),eN(193),eN(17))),o,a,n))}),uR=ef(e=>{let[t,r,i,s]=e,n=eS(s).toVar(),a=eS(i).toVar(),o=eN(r).toVar(),l=eB(t).toVar();return eD(eB(uv(l,o,a,n)).toVar(),eS(u_(l.add(eB(eN(19),eN(193),eN(17))),o,a,n)).toVar())}),uC=ef(e=>{let[t,r,i,s,n,a,o]=e,l=eN(o).toVar(),u=eS(a).toVar(),d=eN(n).toVar(),c=eN(s).toVar(),h=eN(i).toVar(),p=eN(r).toVar(),g=eA(t).toVar(),m=eB(uN(eA(p.add(c),h.add(d)))).toVar(),f=eA(m.x,m.y).toVar();f.subAssign(.5),f.mulAssign(u),f.addAssign(.5);let T=eA(eA(eS(p),eS(h)).add(f)).toVar(),y=eA(T.sub(g)).toVar();return ex(l.equal(eN(2)),()=>rb(y.x).add(rb(y.y))),ex(l.equal(eN(3)),()=>rD(rb(y.x),rb(y.y))),rV(y,y)}),uE=ef(e=>{let[t,r,i,s,n,a,o,l,u]=e,d=eN(u).toVar(),c=eS(l).toVar(),h=eN(o).toVar(),p=eN(a).toVar(),g=eN(n).toVar(),m=eN(s).toVar(),f=eN(i).toVar(),T=eN(r).toVar(),y=eB(t).toVar(),x=eB(uN(eB(T.add(g),f.add(p),m.add(h)))).toVar();x.subAssign(.5),x.mulAssign(c),x.addAssign(.5);let b=eB(eB(eS(T),eS(f),eS(m)).add(x)).toVar(),S=eB(b.sub(y)).toVar();return ex(d.equal(eN(2)),()=>rb(S.x).add(rb(S.y).add(rb(S.z)))),ex(d.equal(eN(3)),()=>rD(rD(rb(S.x),rb(S.y)),rb(S.z))),rV(S,S)}),uB=nJ([uC,uE]),uF=ef(e=>{let[t,r,i]=e,s=eN(i).toVar(),n=eS(r).toVar(),a=eA(t).toVar(),o=eN().toVar(),l=eN().toVar(),u=eA(lV(a.x,o),lV(a.y,l)).toVar(),d=eS(1e6).toVar();return n0({start:-1,end:eN(1),name:"x",condition:"<="},e=>{let{x:t}=e;n0({start:-1,end:eN(1),name:"y",condition:"<="},e=>{let{y:r}=e,i=eS(uB(u,t,r,o,l,n,s)).toVar();d.assign(rM(d,i))})}),ex(s.equal(eN(0)),()=>{d.assign(rl(d))}),d}),uw=ef(e=>{let[t,r,i]=e,s=eN(i).toVar(),n=eS(r).toVar(),a=eA(t).toVar(),o=eN().toVar(),l=eN().toVar(),u=eA(lV(a.x,o),lV(a.y,l)).toVar(),d=eA(1e6,1e6).toVar();return n0({start:-1,end:eN(1),name:"x",condition:"<="},e=>{let{x:t}=e;n0({start:-1,end:eN(1),name:"y",condition:"<="},e=>{let{y:r}=e,i=eS(uB(u,t,r,o,l,n,s)).toVar();ex(i.lessThan(d.x),()=>{d.y.assign(d.x),d.x.assign(i)}).elseif(i.lessThan(d.y),()=>{d.y.assign(i)})})}),ex(s.equal(eN(0)),()=>{d.assign(rl(d))}),d}),uM=ef(e=>{let[t,r,i]=e,s=eN(i).toVar(),n=eS(r).toVar(),a=eA(t).toVar(),o=eN().toVar(),l=eN().toVar(),u=eA(lV(a.x,o),lV(a.y,l)).toVar(),d=eB(1e6,1e6,1e6).toVar();return n0({start:-1,end:eN(1),name:"x",condition:"<="},e=>{let{x:t}=e;n0({start:-1,end:eN(1),name:"y",condition:"<="},e=>{let{y:r}=e,i=eS(uB(u,t,r,o,l,n,s)).toVar();ex(i.lessThan(d.x),()=>{d.z.assign(d.y),d.y.assign(d.x),d.x.assign(i)}).elseif(i.lessThan(d.y),()=>{d.z.assign(d.y),d.y.assign(i)}).elseif(i.lessThan(d.z),()=>{d.z.assign(i)})})}),ex(s.equal(eN(0)),()=>{d.assign(rl(d))}),d}),uD=ef(e=>{let[t,r,i]=e,s=eN(i).toVar(),n=eS(r).toVar(),a=eB(t).toVar(),o=eN().toVar(),l=eN().toVar(),u=eN().toVar(),d=eB(lV(a.x,o),lV(a.y,l),lV(a.z,u)).toVar(),c=eS(1e6).toVar();return n0({start:-1,end:eN(1),name:"x",condition:"<="},e=>{let{x:t}=e;n0({start:-1,end:eN(1),name:"y",condition:"<="},e=>{let{y:r}=e;n0({start:-1,end:eN(1),name:"z",condition:"<="},e=>{let{z:i}=e,a=eS(uB(d,t,r,i,o,l,u,n,s)).toVar();c.assign(rM(c,a))})})}),ex(s.equal(eN(0)),()=>{c.assign(rl(c))}),c});nJ([uF,uD]);let uI=ef(e=>{let[t,r,i]=e,s=eN(i).toVar(),n=eS(r).toVar(),a=eB(t).toVar(),o=eN().toVar(),l=eN().toVar(),u=eN().toVar(),d=eB(lV(a.x,o),lV(a.y,l),lV(a.z,u)).toVar(),c=eA(1e6,1e6).toVar();return n0({start:-1,end:eN(1),name:"x",condition:"<="},e=>{let{x:t}=e;n0({start:-1,end:eN(1),name:"y",condition:"<="},e=>{let{y:r}=e;n0({start:-1,end:eN(1),name:"z",condition:"<="},e=>{let{z:i}=e,a=eS(uB(d,t,r,i,o,l,u,n,s)).toVar();ex(a.lessThan(c.x),()=>{c.y.assign(c.x),c.x.assign(a)}).elseif(a.lessThan(c.y),()=>{c.y.assign(a)})})})}),ex(s.equal(eN(0)),()=>{c.assign(rl(c))}),c});nJ([uw,uI]);let uO=ef(e=>{let[t,r,i]=e,s=eN(i).toVar(),n=eS(r).toVar(),a=eB(t).toVar(),o=eN().toVar(),l=eN().toVar(),u=eN().toVar(),d=eB(lV(a.x,o),lV(a.y,l),lV(a.z,u)).toVar(),c=eB(1e6,1e6,1e6).toVar();return n0({start:-1,end:eN(1),name:"x",condition:"<="},e=>{let{x:t}=e;n0({start:-1,end:eN(1),name:"y",condition:"<="},e=>{let{y:r}=e;n0({start:-1,end:eN(1),name:"z",condition:"<="},e=>{let{z:i}=e,a=eS(uB(d,t,r,i,o,l,u,n,s)).toVar();ex(a.lessThan(c.x),()=>{c.z.assign(c.y),c.y.assign(c.x),c.x.assign(a)}).elseif(a.lessThan(c.y),()=>{c.z.assign(c.y),c.y.assign(a)}).elseif(a.lessThan(c.z),()=>{c.z.assign(a)})})})}),ex(s.equal(eN(0)),()=>{c.assign(rl(c))}),c});nJ([uM,uO]),lU.setLayout({name:"mx_select",type:"float",inputs:[{name:"b",type:"bool"},{name:"t",type:"float"},{name:"f",type:"float"}]}),lL.setLayout({name:"mx_negate_if",type:"float",inputs:[{name:"val",type:"float"},{name:"b",type:"bool"}]}),lG.setLayout({name:"mx_floor",type:"int",inputs:[{name:"x",type:"float"}]}),lP.setLayout({name:"mx_bilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"}]}),lk.setLayout({name:"mx_bilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"}]}),lW.setLayout({name:"mx_trilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"v4",type:"float"},{name:"v5",type:"float"},{name:"v6",type:"float"},{name:"v7",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]}),lH.setLayout({name:"mx_trilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"v4",type:"vec3"},{name:"v5",type:"vec3"},{name:"v6",type:"vec3"},{name:"v7",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]}),lj.setLayout({name:"mx_gradient_float_0",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"}]}),lX.setLayout({name:"mx_gradient_float_1",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),lZ.setLayout({name:"mx_gradient_vec3_0",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"}]}),lK.setLayout({name:"mx_gradient_vec3_1",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),lJ.setLayout({name:"mx_gradient_scale2d_0",type:"float",inputs:[{name:"v",type:"float"}]}),l$.setLayout({name:"mx_gradient_scale3d_0",type:"float",inputs:[{name:"v",type:"float"}]}),l0.setLayout({name:"mx_gradient_scale2d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]}),l2.setLayout({name:"mx_gradient_scale3d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]}),l4.setLayout({name:"mx_rotl32",type:"uint",inputs:[{name:"x",type:"uint"},{name:"k",type:"int"}]}),l5.setLayout({name:"mx_bjfinal",type:"uint",inputs:[{name:"a",type:"uint"},{name:"b",type:"uint"},{name:"c",type:"uint"}]}),l6.setLayout({name:"mx_bits_to_01",type:"float",inputs:[{name:"bits",type:"uint"}]}),l9.setLayout({name:"mx_fade",type:"float",inputs:[{name:"t",type:"float"}]}),l7.setLayout({name:"mx_hash_int_0",type:"uint",inputs:[{name:"x",type:"int"}]}),ue.setLayout({name:"mx_hash_int_1",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),ut.setLayout({name:"mx_hash_int_2",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]}),ur.setLayout({name:"mx_hash_int_3",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"}]}),ui.setLayout({name:"mx_hash_int_4",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"},{name:"yy",type:"int"}]}),un.setLayout({name:"mx_hash_vec3_0",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),ua.setLayout({name:"mx_hash_vec3_1",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]}),ul.setLayout({name:"mx_perlin_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"}]}),uu.setLayout({name:"mx_perlin_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"}]}),uc.setLayout({name:"mx_perlin_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),uh.setLayout({name:"mx_perlin_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),ug.setLayout({name:"mx_cell_noise_float_0",type:"float",inputs:[{name:"p",type:"float"}]}),um.setLayout({name:"mx_cell_noise_float_1",type:"float",inputs:[{name:"p",type:"vec2"}]}),uf.setLayout({name:"mx_cell_noise_float_2",type:"float",inputs:[{name:"p",type:"vec3"}]}),uT.setLayout({name:"mx_cell_noise_float_3",type:"float",inputs:[{name:"p",type:"vec4"}]}),uy.setLayout({name:"mx_cell_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"float"}]}),ux.setLayout({name:"mx_cell_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),ub.setLayout({name:"mx_cell_noise_vec3_2",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),uS.setLayout({name:"mx_cell_noise_vec3_3",type:"vec3",inputs:[{name:"p",type:"vec4"}]}),u_.setLayout({name:"mx_fractal_noise_float",type:"float",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),uv.setLayout({name:"mx_fractal_noise_vec3",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),uA.setLayout({name:"mx_fractal_noise_vec2",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),uR.setLayout({name:"mx_fractal_noise_vec4",type:"vec4",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),uC.setLayout({name:"mx_worley_distance_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),uE.setLayout({name:"mx_worley_distance_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"zoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),uF.setLayout({name:"mx_worley_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),uw.setLayout({name:"mx_worley_noise_vec2_0",type:"vec2",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),uM.setLayout({name:"mx_worley_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),uD.setLayout({name:"mx_worley_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),uI.setLayout({name:"mx_worley_noise_vec2_1",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),uO.setLayout({name:"mx_worley_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]});let uU=ef(e=>{let[t]=e,r=eB(t).toVar(),i=eS(r.x).toVar(),s=eS(r.y).toVar(),n=eS(r.z).toVar();ex(s.lessThan(1e-4),()=>eB(n,n,n)).else(()=>{i.assign(tj(6,i.sub(rd(i))));let e=eN(rB(i)).toVar(),t=eS(i.sub(eS(e))).toVar(),r=eS(n.mul(tq(1,s))).toVar(),a=eS(n.mul(tq(1,s.mul(t)))).toVar(),o=eS(n.mul(tq(1,s.mul(tq(1,t))))).toVar();return ex(e.equal(eN(0)),()=>eB(n,o,r)).elseif(e.equal(eN(1)),()=>eB(a,n,r)).elseif(e.equal(eN(2)),()=>eB(r,n,o)).elseif(e.equal(eN(3)),()=>eB(r,a,n)).elseif(e.equal(eN(4)),()=>eB(o,r,n)),eB(n,r,a)})}),uL=ef(e=>{let[t]=e,r=eB(t).toVar(),i=eS(r.x).toVar(),s=eS(r.y).toVar(),n=eS(r.z).toVar(),a=eS(rM(i,rM(s,n))).toVar(),o=eS(rD(i,rD(s,n))).toVar(),l=eS(o.sub(a)).toVar(),u=eS().toVar(),d=eS().toVar(),c=eS().toVar();return c.assign(o),ex(o.greaterThan(0),()=>{d.assign(l.div(o))}).else(()=>{d.assign(0)}),ex(d.lessThanEqual(0),()=>{u.assign(0)}).else(()=>{ex(i.greaterThanEqual(o),()=>{u.assign(s.sub(n).div(l))}).elseif(s.greaterThanEqual(o),()=>{u.assign(tH(2,n.sub(i).div(l)))}).else(()=>{u.assign(tH(4,i.sub(s).div(l)))}),u.mulAssign(1/6),ex(u.lessThan(0),()=>{u.addAssign(1)})}),eB(u,d,c)});uU.setLayout({name:"mx_hsvtorgb",type:"vec3",inputs:[{name:"hsv",type:"vec3"}]}),uL.setLayout({name:"mx_rgbtohsv",type:"vec3",inputs:[{name:"c",type:"vec3"}]}),ef(e=>{let[t]=e,r=eB(t).toVar(),i=eM(tJ(r,eB(.04045))).toVar();return rj(eB(r.div(12.92)).toVar(),eB(rk(rD(r.add(eB(.055)),eB(0)).div(1.055),eB(2.4))).toVar(),i)}).setLayout({name:"mx_srgb_texture_to_lin_rec709",type:"vec3",inputs:[{name:"color",type:"vec3"}]})},1812:function(e,t){class r{getCode(){console.warn("Abstract function.")}constructor(e,t,r="",i=""){this.type=e,this.inputs=t,this.name=r,this.presicion=i}}r.isNodeFunction=!0,t.Z=r},134:function(e,t){class r{constructor(e,t,r=null,i="",s=!1){this.type=e,this.name=t,this.count=r,this.qualifier=i,this.isConst=s}}r.isNodeFunctionInput=!0,t.Z=r},3858:function(e,t){class r{parseFunction(){console.warn("Abstract function.")}}t.Z=r},3475:function(e,t,r){var i=r(9396),s=r(1901);let n=null,a=null,o=null;class l{async init(e){this.renderer=e}begin(e){}finish(e){}draw(e,t){}createProgram(e){}destroyProgram(e){}createBindings(e){}updateBindings(e){}createRenderPipeline(e){}createComputePipeline(e,t){}destroyPipeline(e){}needsRenderUpdate(e){}getRenderCacheKey(e){}createNodeBuilder(e){}createSampler(e){}createDefaultTexture(e){}createTexture(e){}copyTextureToBuffer(e,t,r,i,s){}createAttribute(e){}createIndexAttribute(e){}updateAttribute(e){}destroyAttribute(e){}updateSize(){}hasFeature(e){}getInstanceCount(e){let{object:t,geometry:r}=e;return r.isInstancedBufferGeometry?r.instanceCount:t.isInstancedMesh?t.count:1}getDrawingBufferSize(){return n=n||new s.Vector2,this.renderer.getDrawingBufferSize(n)}getScissor(){return a=a||new s.Vector4,this.renderer.getScissor(a)}getClearColor(){let e=this.renderer;return o=o||new i.Z,e.getClearColor(o),o.getRGB(o,this.renderer.currentColorSpace),o}getDomElement(){let e=this.domElement;return null===e&&("setAttribute"in(e=void 0!==this.parameters.canvas?this.parameters.canvas:(0,s.createCanvasElement)())&&e.setAttribute("data-engine","three.js r".concat(s.REVISION," webgpu")),this.domElement=e),e}set(e,t){this.data.set(e,t)}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}delete(e){this.data.delete(e)}constructor(e={}){this.parameters=Object.assign({},e),this.data=new WeakMap,this.renderer=null,this.domElement=null}}t.Z=l},2578:function(e,t){class r{setVisibility(e){this.visibility|=e}clone(){return Object.assign(new this.constructor,this)}constructor(e=""){this.name=e,this.visibility=0}}t.Z=r},4324:function(e,t,r){var i=r(2578),s=r(5584);class n extends i.Z{get byteLength(){return(0,s.tg)(this._buffer.byteLength)}get buffer(){return this._buffer}update(){return!0}constructor(e,t=null){super(e),this.isBuffer=!0,this.bytesPerElement=Float32Array.BYTES_PER_ELEMENT,this._buffer=t}}t.Z=n},5584:function(e,t,r){r.d(t,{VL:function(){return n},bW:function(){return a},tg:function(){return s}});var i=r(3245);function s(e){return e+(i.BU-e%i.BU)%i.BU}function n(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;return s(a(t)*e)}function a(e){return e+(4-e%4)%4}},1291:function(e,t,r){r.d(t,{Z:function(){return i}});class i{get(e){if(!Array.isArray(e))return super.get(e);{let t=this.weakMap;for(let r=0;r<e.length;r++)if(void 0===(t=t.get(e[r])))return;return t.get(e[e.length-1])}}set(e,t){if(!Array.isArray(e))return super.set(e,t);{let r=this.weakMap;for(let t=0;t<e.length;t++){let i=e[t];!1===r.has(i)&&r.set(i,new WeakMap),r=r.get(i)}return r.set(e[e.length-1],t)}}delete(e){if(!Array.isArray(e))return super.delete(e);{let t=this.weakMap;for(let r=0;r<e.length;r++)if(void 0===(t=t.get(e[r])))return!1;return t.delete(e[e.length-1])}}dispose(){this.weakMap.clear()}constructor(){this.weakMap=new WeakMap}}},9396:function(e,t,r){var i=r(1901);class s extends i.Color{set(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return this.a=i,super.set(e,t,r)}copy(e){return void 0!==e.a&&(this.a=e.a),super.copy(e)}clone(){return new this.constructor(this.r,this.g,this.b,this.a)}constructor(e,t,r,i=1){super(e,t,r),this.a=i}}t.Z=s},3245:function(e,t,r){r.d(t,{$i:function(){return n},BU:function(){return s},GC:function(){return i},Xh:function(){return a}});let i={VERTEX:1,INDEX:2,STORAGE:4},s=16,n=211,a=212},4010:function(e,t,r){r.d(t,{Z:function(){return X}});class i{_init(){let e=(t,r)=>{this.requestId=self.requestAnimationFrame(e),this.nodes.nodeFrame.update(),this.info.frame=this.nodes.nodeFrame.frameId,null!==this.animationLoop&&this.animationLoop(t,r)};e()}dispose(){self.cancelAnimationFrame(this.requestId)}setAnimationLoop(e){this.animationLoop=e}constructor(e,t){this.nodes=e,this.info=t,this.animationLoop=null,this.requestId=null,this._init()}}var s=r(1291);let n=0;class a{getNodeBuilderState(){return this._nodeBuilderState||(this._nodeBuilderState=this._nodes.getForRender(this))}getBindings(){return this._bindings||(this._bindings=this.getNodeBuilderState().createBindings())}getIndex(){return this._geometries.getIndex(this)}getChainArray(){return[this.object,this.material,this.context,this.lightsNode]}getAttributes(){if(null!==this.attributes)return this.attributes;let e=this.getNodeBuilderState().nodeAttributes,t=this.geometry,r=[],i=new Set;for(let s of e){let e=s.node&&s.node.attribute?s.node.attribute:t.getAttribute(s.name);r.push(e);let n=e.isInterleavedBufferAttribute?e.data:e;i.add(n)}return this.attributes=r,this.vertexBuffers=Array.from(i.values()),r}getVertexBuffers(){return null===this.vertexBuffers&&this.getAttributes(),this.vertexBuffers}getMaterialCacheKey(){let{object:e,material:t}=this,r=t.customProgramCacheKey();for(let e in t){if(/^(is[A-Z])|^(visible|version|uuid|name|opacity|userData)$/.test(e))continue;let i=t[e];if(null!==i){let e=typeof i;"number"===e?i=0!==i?"1":"0":"object"===e&&(i="{}")}r+=i+","}return e.skeleton&&(r+=e.skeleton.uuid+","),e.morphTargetInfluences&&(r+=e.morphTargetInfluences.length+","),r}get needsUpdate(){return this.initialNodesCacheKey!==this.getNodesCacheKey()}getNodesCacheKey(){return this._nodes.getCacheKey(this.scene,this.lightsNode)}getCacheKey(){return this.getMaterialCacheKey()+","+this.getNodesCacheKey()}dispose(){this.material.removeEventListener("dispose",this.onMaterialDispose),this.onDispose()}constructor(e,t,r,i,s,a,o,l,u){this._nodes=e,this._geometries=t,this.id=n++,this.renderer=r,this.object=i,this.material=s,this.scene=a,this.camera=o,this.lightsNode=l,this.context=u,this.geometry=i.geometry,this.version=s.version,this.attributes=null,this.pipeline=null,this.vertexBuffers=null,this.initialNodesCacheKey=this.getNodesCacheKey(),this.initialCacheKey=this.getCacheKey(),this._nodeBuilderState=null,this._bindings=null,this.onDispose=null,this.isRenderObject=!0,this.onMaterialDispose=()=>{this.dispose()},this.material.addEventListener("dispose",this.onMaterialDispose)}}class o{get(e,t,r,i,s,n,a){let o=this.getChainMap(a),l=[e,t,n,s],u=o.get(l);return void 0===u?(u=this.createRenderObject(this.nodes,this.geometries,this.renderer,e,t,r,i,s,n,a),o.set(l,u)):(u.version!==t.version||u.needsUpdate)&&(u.initialCacheKey!==u.getCacheKey()?(u.dispose(),u=this.get(e,t,r,i,s,n,a)):u.version=t.version),u}getChainMap(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";return this.chainMaps[e]||(this.chainMaps[e]=new s.Z)}dispose(){this.chainMaps={}}createRenderObject(e,t,r,i,s,n,o,l,u,d){let c=this.getChainMap(d),h=new a(e,t,r,i,s,n,o,l,u);return h.onDispose=()=>{this.pipelines.delete(h),this.bindings.delete(h),this.nodes.delete(h),c.delete(h.getChainArray())},h}constructor(e,t,r,i,s,n){this.renderer=e,this.nodes=t,this.geometries=r,this.pipelines=i,this.bindings=s,this.info=n,this.chainMaps={}}}class l{get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}delete(e){let t;return this.data.has(e)&&(t=this.data.get(e),this.data.delete(e)),t}has(e){return this.data.has(e)}dispose(){this.data.clear()}constructor(){this.data=new WeakMap}}var u=l,d=r(3245),c=r(1901);class h extends u{delete(e){void 0!==super.delete(e)&&this.backend.destroyAttribute(e)}update(e,t){let r=this.get(e);if(void 0===r.version)t===d.GC.VERTEX?this.backend.createAttribute(e):t===d.GC.INDEX?this.backend.createIndexAttribute(e):t===d.GC.STORAGE&&this.backend.createStorageAttribute(e),r.version=this._getBufferAttribute(e).version;else{let t=this._getBufferAttribute(e);(r.version<t.version||t.usage===c.DynamicDrawUsage)&&(this.backend.updateAttribute(e),r.version=t.version)}}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}constructor(e){super(),this.backend=e}}function p(e){return null!==e.index?e.index.version:e.attributes.position.version}function g(e){let t=[],r=e.index,i=e.attributes.position;if(null!==r){let e=r.array;for(let r=0,i=e.length;r<i;r+=3){let i=e[r+0],s=e[r+1],n=e[r+2];t.push(i,s,s,n,n,i)}}else{let e=i.array;for(let r=0,i=e.length/3-1;r<i;r+=3){let e=r+0,i=r+1,s=r+2;t.push(e,i,i,s,s,e)}}let s=new(!function(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}(t)?c.Uint16BufferAttribute:c.Uint32BufferAttribute)(t,1);return s.version=p(e),s}class m extends u{has(e){let t=e.geometry;return super.has(t)&&!0===this.get(t).initialized}updateForRender(e){!1===this.has(e)&&this.initGeometry(e),this.updateAttributes(e)}initGeometry(e){let t=e.geometry;this.get(t).initialized=!0,this.info.memory.geometries++;let r=()=>{this.info.memory.geometries--;let i=t.index,s=e.getAttributes();for(let e of(null!==i&&this.attributes.delete(i),s))this.attributes.delete(e);let n=this.wireframes.get(t);void 0!==n&&this.attributes.delete(n),t.removeEventListener("dispose",r)};t.addEventListener("dispose",r)}updateAttributes(e){for(let t of e.getAttributes())this.updateAttribute(t,d.GC.VERTEX);let t=this.getIndex(e);null!==t&&this.updateAttribute(t,d.GC.INDEX)}updateAttribute(e,t){let r=this.info.render.calls;this.attributeCall.get(e)!==r&&(this.attributes.update(e,t),this.attributeCall.set(e,r))}getIndex(e){let{geometry:t,material:r}=e,i=t.index;if(!0===r.wireframe){let e=this.wireframes,r=e.get(t);void 0===r?(r=g(t),e.set(t,r)):r.version!==p(t)&&(this.attributes.delete(r),r=g(t),e.set(t,r)),i=r}return i}constructor(e,t){super(),this.attributes=e,this.info=t,this.wireframes=new WeakMap,this.attributeCall=new WeakMap}}class f{update(e,t,r){this.render.drawCalls++,e.isMesh||e.isSprite?this.render.triangles+=t/3*r:e.isPoints?this.render.points+=r*t:e.isLineSegments?this.render.lines+=t/2*r:e.isLine?this.render.lines+=r*(t-1):console.error("THREE.WebGPUInfo: Unknown object type.")}reset(){this.render.drawCalls=0,this.render.triangles=0,this.render.points=0,this.render.lines=0}dispose(){this.reset(),this.calls=0,this.render.calls=0,this.compute.calls=0,this.memory.geometries=0,this.memory.textures=0}constructor(){this.autoReset=!0,this.frame=0,this.calls=0,this.render={calls:0,drawCalls:0,triangles:0,points:0,lines:0},this.compute={calls:0},this.memory={geometries:0,textures:0}}}class T{constructor(e){this.cacheKey=e,this.usedTimes=0}}var y=T;class x extends y{constructor(e,t,r){super(e),this.vertexProgram=t,this.fragmentProgram=r}}class b extends y{constructor(e,t){super(e),this.computeProgram=t,this.isComputePipeline=!0}}let S=0;class N{constructor(e,t){this.id=S++,this.code=e,this.stage=t,this.usedTimes=0}}class _ extends u{getForCompute(e,t){let{backend:r}=this,i=this.get(e);if(this._needsComputeUpdate(e)){let s=i.pipeline;s&&(s.usedTimes--,s.computeProgram.usedTimes--);let n=this.nodes.getForCompute(e),a=this.programs.compute.get(n.computeShader);void 0===a&&(s&&0===s.computeProgram.usedTimes&&this._releaseProgram(s.computeProgram),a=new N(n.computeShader,"compute"),this.programs.compute.set(n.computeShader,a),r.createProgram(a));let o=this._getComputeCacheKey(e,a),l=this.caches.get(o);void 0===l&&(s&&0===s.usedTimes&&this._releasePipeline(e),l=this._getComputePipeline(e,a,o,t)),l.usedTimes++,a.usedTimes++,i.version=e.version,i.pipeline=l}return i.pipeline}getForRender(e){let{backend:t}=this,r=this.get(e);if(this._needsRenderUpdate(e)){let i=r.pipeline;i&&(i.usedTimes--,i.vertexProgram.usedTimes--,i.fragmentProgram.usedTimes--);let s=e.getNodeBuilderState(),n=this.programs.vertex.get(s.vertexShader);void 0===n&&(i&&0===i.vertexProgram.usedTimes&&this._releaseProgram(i.vertexProgram),n=new N(s.vertexShader,"vertex"),this.programs.vertex.set(s.vertexShader,n),t.createProgram(n));let a=this.programs.fragment.get(s.fragmentShader);void 0===a&&(i&&0===i.fragmentProgram.usedTimes&&this._releaseProgram(i.fragmentProgram),a=new N(s.fragmentShader,"fragment"),this.programs.fragment.set(s.fragmentShader,a),t.createProgram(a));let o=this._getRenderCacheKey(e,n,a),l=this.caches.get(o);void 0===l?(i&&0===i.usedTimes&&this._releasePipeline(i),l=this._getRenderPipeline(e,n,a,o)):e.pipeline=l,l.usedTimes++,n.usedTimes++,a.usedTimes++,r.pipeline=l}return r.pipeline}delete(e){let t=this.get(e).pipeline;t&&(t.usedTimes--,0===t.usedTimes&&this._releasePipeline(t),t.isComputePipeline?(t.computeProgram.usedTimes--,0===t.computeProgram.usedTimes&&this._releaseProgram(t.computeProgram)):(t.fragmentProgram.usedTimes--,t.vertexProgram.usedTimes--,0===t.vertexProgram.usedTimes&&this._releaseProgram(t.vertexProgram),0===t.fragmentProgram.usedTimes&&this._releaseProgram(t.fragmentProgram))),super.delete(e)}dispose(){super.dispose(),this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}updateForRender(e){this.getForRender(e)}_getComputePipeline(e,t,r,i){r=r||this._getComputeCacheKey(e,t);let s=this.caches.get(r);return void 0===s&&(s=new b(r,t),this.caches.set(r,s),this.backend.createComputePipeline(s,i)),s}_getRenderPipeline(e,t,r,i){i=i||this._getRenderCacheKey(e,t,r);let s=this.caches.get(i);return void 0===s&&(s=new x(i,t,r),this.caches.set(i,s),e.pipeline=s,this.backend.createRenderPipeline(e)),s}_getComputeCacheKey(e,t){return e.id+","+t.id}_getRenderCacheKey(e,t,r){return t.id+","+r.id+","+this.backend.getRenderCacheKey(e)}_releasePipeline(e){this.caches.delete(e.cacheKey)}_releaseProgram(e){let t=e.code,r=e.stage;this.programs[r].delete(t)}_needsComputeUpdate(e){let t=this.get(e);return void 0===t.pipeline||t.version!==e.version}_needsRenderUpdate(e){return void 0===this.get(e).pipeline||this.backend.needsRenderUpdate(e)}constructor(e,t){super(),this.backend=e,this.nodes=t,this.bindings=null,this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}}class v extends u{getForRender(e){let t=e.getBindings(),r=this.get(e);return r.bindings!==t&&(r.bindings=t,this._init(t),this.backend.createBindings(t)),r.bindings}getForCompute(e){let t=this.get(e);if(void 0===t.bindings){let r=this.nodes.getForCompute(e).bindings.compute;t.bindings=r,this._init(r),this.backend.createBindings(r)}return t.bindings}updateForCompute(e){this._update(e,this.getForCompute(e))}updateForRender(e){this._update(e,this.getForRender(e))}_init(e){for(let t of e)if(t.isSampledTexture)this.textures.updateTexture(t.texture);else if(t.isStorageBuffer){let e=t.attribute;this.attributes.update(e,d.GC.STORAGE)}}_update(e,t){let{backend:r}=this,i=!1;for(let e of t)if(!e.isNodeUniformsGroup||this.nodes.updateGroup(e)){if(e.isUniformBuffer)e.update()&&r.updateBinding(e);else if(e.isSampledTexture){let t=e.texture;if(e.needsBindingsUpdate&&(i=!0),e.update()&&this.textures.updateTexture(e.texture),!0===t.isStorageTexture){let r=this.get(t);!0===e.store?r.needsMipmap=!0:!0===t.generateMipmaps&&this.textures.needsMipmaps(t)&&!0===r.needsMipmap&&(this.backend.generateMipmaps(t),r.needsMipmap=!1)}}}if(!0===i){let r=this.pipelines.getForRender(e);this.backend.updateBindings(t,r)}}constructor(e,t,r,i,s,n){super(),this.backend=e,this.textures=r,this.pipelines=s,this.attributes=i,this.nodes=t,this.info=n,this.pipelines.bindings=this}}var A=r(3200);function R(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function C(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}class E{begin(){return this.renderItemsIndex=0,this.opaque.length=0,this.transparent.length=0,this.lightsArray.length=0,this.occlusionQueryCount=0,this}getNextRenderItem(e,t,r,i,s,n){let a=this.renderItems[this.renderItemsIndex];return void 0===a?(a={id:e.id,object:e,geometry:t,material:r,groupOrder:i,renderOrder:e.renderOrder,z:s,group:n},this.renderItems[this.renderItemsIndex]=a):(a.id=e.id,a.object=e,a.geometry=t,a.material=r,a.groupOrder=i,a.renderOrder=e.renderOrder,a.z=s,a.group=n),this.renderItemsIndex++,a}push(e,t,r,i,s,n){let a=this.getNextRenderItem(e,t,r,i,s,n);!0===e.occlusionTest&&this.occlusionQueryCount++,(!0===r.transparent?this.transparent:this.opaque).push(a)}unshift(e,t,r,i,s,n){let a=this.getNextRenderItem(e,t,r,i,s,n);(!0===r.transparent?this.transparent:this.opaque).unshift(a)}pushLight(e){this.lightsArray.push(e)}getLightsNode(){return this.lightsNode.fromLights(this.lightsArray)}sort(e,t){this.opaque.length>1&&this.opaque.sort(e||R),this.transparent.length>1&&this.transparent.sort(t||C)}finish(){this.lightsNode.fromLights(this.lightsArray);for(let e=this.renderItemsIndex,t=this.renderItems.length;e<t;e++){let t=this.renderItems[e];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.groupOrder=null,t.renderOrder=null,t.z=null,t.group=null}}constructor(){this.renderItems=[],this.renderItemsIndex=0,this.opaque=[],this.transparent=[],this.lightsNode=new A.D21([]),this.lightsArray=[],this.occlusionQueryCount=0}}class B{get(e,t){let r=this.lists,i=[e,t],s=r.get(i);return void 0===s&&(s=new E,r.set(i,s)),s}dispose(){this.lists=new s.Z}constructor(){this.lists=new s.Z}}let F=0;class w{constructor(){this.id=F++,this.color=!0,this.clearColor=!0,this.clearColorValue={r:0,g:0,b:0,a:1},this.depth=!0,this.clearDepth=!0,this.clearDepthValue=1,this.stencil=!0,this.clearStencil=!0,this.clearStencilValue=1,this.viewport=!1,this.viewportValue=new c.Vector4,this.scissor=!1,this.scissorValue=new c.Vector4,this.textures=null,this.depthTexture=null,this.activeCubeFace=0,this.sampleCount=1,this.width=0,this.height=0}}class M{get(e,t){let r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=[e,t];if(null===i)r="default";else{let e,t;i.isWebGLMultipleRenderTargets?(e=i.texture[0].format,t=i.texture.length):(e=i.texture.format,t=1),r="".concat(t,":").concat(e,":").concat(i.samples,":").concat(i.depthBuffer,":").concat(i.stencilBuffer)}let n=this.getChainMap(r),a=n.get(s);return void 0===a&&(a=new w,n.set(s,a)),null!==i&&(a.sampleCount=0===i.samples?1:i.samples),a}getChainMap(e){return this.chainMaps[e]||(this.chainMaps[e]=new s.Z)}dispose(){this.chainMaps={}}constructor(){this.chainMaps={}}}let D=new c.Vector3;class I extends u{updateRenderTarget(e){let t,r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,s=this.get(e),n=0===e.samples?1:e.samples,a=s.depthTextureMips||(s.depthTextureMips={});e.isWebGLMultipleRenderTargets?(r=e.texture,t=e.texture[0]):(r=[e.texture],t=e.texture);let o=this.getSize(t),l=o.width>>i,u=o.height>>i,d=e.depthTexture||a[i],h=!1;void 0===d&&((d=new c.DepthTexture).format=c.DepthStencilFormat,d.type=c.UnsignedInt248Type,d.image.width=l,d.image.height=u,a[i]=d),(s.width!==o.width||o.height!==s.height)&&(h=!0,d.needsUpdate=!0,d.image.width=l,d.image.height=u),s.width=o.width,s.height=o.height,s.textures=r,s.depthTexture=d,s.depth=e.depthBuffer,s.stencil=e.stencilBuffer,s.sampleCount!==n&&(h=!0,d.needsUpdate=!0,s.sampleCount=n);let p={sampleCount:n};for(let e=0;e<r.length;e++){let t=r[e];h&&(t.needsUpdate=!0),this.updateTexture(t,p)}if(this.updateTexture(d,p),!0!==s.initialized){s.initialized=!0;let i=()=>{if(e.removeEventListener("dispose",i),void 0!==r)for(let e=0;e<r.length;e++)this._destroyTexture(r[e]);else this._destroyTexture(t);this._destroyTexture(d)};e.addEventListener("dispose",i)}}updateTexture(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.get(e);if(!0===r.initialized&&r.version===e.version)return;let i=e.isRenderTargetTexture||e.isDepthTexture||e.isFramebufferTexture,s=this.backend;i&&!0===r.initialized&&(s.destroySampler(e),s.destroyTexture(e));let{width:n,height:a,depth:o}=this.getSize(e);if(t.width=n,t.height=a,t.depth=o,t.needsMipmaps=this.needsMipmaps(e),t.levels=t.needsMipmaps?this.getMipLevels(e,n,a):1,i||!0===e.isStorageTexture)s.createSampler(e),s.createTexture(e,t);else if(!0!==r.initialized&&s.createSampler(e),e.version>0){let i=e.image;if(void 0===i)console.warn("THREE.Renderer: Texture marked for update but image is undefined.");else if(!1===i.complete)console.warn("THREE.Renderer: Texture marked for update but image is incomplete.");else{if(e.images){let r=[];for(let t of e.images)r.push(t);t.images=r}else t.image=i;(void 0===r.isDefaultTexture||!0===r.isDefaultTexture)&&(s.createTexture(e,t),r.isDefaultTexture=!1),s.updateTexture(e,t),t.needsMipmaps&&0===e.mipmaps.length&&s.generateMipmaps(e)}}else s.createDefaultTexture(e),r.isDefaultTexture=!0;if(!0!==r.initialized){r.initialized=!0,this.info.memory.textures++;let t=()=>{e.removeEventListener("dispose",t),this._destroyTexture(e),this.info.memory.textures--};e.addEventListener("dispose",t)}r.version=e.version}getSize(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:D,r=e.images?e.images[0]:e.image;return r?(void 0!==r.image&&(r=r.image),t.width=r.width,t.height=r.height,t.depth=e.isCubeTexture?6:r.depth||1):t.width=t.height=t.depth=1,t}getMipLevels(e,t,r){return e.isCompressedTexture?e.mipmaps.length:Math.floor(Math.log2(Math.max(t,r)))+1}needsMipmaps(e){return!!this.isEnvironmentTexture(e)||!0===e.isCompressedTexture||e.minFilter!==c.NearestFilter&&e.minFilter!==c.LinearFilter}isEnvironmentTexture(e){let t=e.mapping;return t===c.EquirectangularReflectionMapping||t===c.EquirectangularRefractionMapping||t===c.CubeReflectionMapping||t===c.CubeRefractionMapping}_destroyTexture(e){this.backend.destroySampler(e),this.backend.destroyTexture(e),this.delete(e)}constructor(e,t){super(),this.backend=e,this.info=t}}var O=r(9396);let U=new O.Z;class L extends u{update(e,t,r){let i=this.renderer,s=this.nodes.getBackgroundNode(e)||e.background,n=!1;if(null===s)i._clearColor.getRGB(U,this.renderer.currentColorSpace),U.a=i._clearColor.a;else if(!0===s.isColor)s.getRGB(U,this.renderer.currentColorSpace),U.a=1,n=!0;else if(!0===s.isNode){let r=this.get(e);U.copy(i._clearColor);let n=r.backgroundMesh;if(void 0===n){let e=(0,A.Do7)((0,A.vhs)(s),{getUV:()=>A.BnF,getTextureLevel:()=>A.zYp}).mul(A.Qwr),t=(0,A.KfF)();t=t.setZ(t.w);let i=new A.Oie;i.side=c.BackSide,i.depthTest=!1,i.depthWrite=!1,i.fog=!1,i.vertexNode=t,i.fragmentNode=e,r.backgroundMeshNode=e,r.backgroundMesh=n=new c.Mesh(new c.SphereGeometry(1,32,32),i),n.frustumCulled=!1,n.onBeforeRender=function(e,t,r){this.matrixWorld.copyPosition(r.matrixWorld)}}let a=s.getCacheKey();r.backgroundCacheKey!==a&&(r.backgroundMeshNode.node=(0,A.vhs)(s),n.material.needsUpdate=!0,r.backgroundCacheKey=a),t.unshift(n,n.geometry,n.material,0,0,null)}else console.error("THREE.Renderer: Unsupported background configuration.",s);if(!0===i.autoClear||!0===n){U.multiplyScalar(U.a);let e=r.clearColorValue;e.r=U.r,e.g=U.g,e.b=U.b,e.a=U.a,r.depthClearValue=i._clearDepth,r.stencilClearValue=i._clearStencil,r.clearColor=!0===i.autoClearColor,r.clearDepth=!0===i.autoClearDepth,r.clearStencil=!0===i.autoClearStencil}else r.clearColor=!1,r.clearDepth=!1,r.clearStencil=!1}constructor(e,t){super(),this.renderer=e,this.nodes=t}}class G{createBindings(){let e=[];for(let t of this.bindings){let r=t;!0!==t.shared&&(r=t.clone()),e.push(r)}return e}constructor(e,t,r,i,s,n,a){this.vertexShader=e,this.fragmentShader=t,this.computeShader=r,this.nodeAttributes=i,this.bindings=s,this.updateNodes=n,this.updateBeforeNodes=a,this.usedTimes=0}}class V extends u{updateGroup(e){let t=e.groupNode,r=t.name;if(r===A.WxF.name)return!0;if(r===A.o_W.name){let t=this.get(e),r=this.nodeFrame.renderId;return t.renderId!==r&&(t.renderId=r,!0)}if(r===A.Hut.name){let t=this.get(e),r=this.nodeFrame.frameId;return t.frameId!==r&&(t.frameId=r,!0)}let i=[t,e],s=this.groupsData.get(i);return void 0===s&&this.groupsData.set(i,s={}),s.version!==t.version&&(s.version=t.version,!0)}getForRenderCacheKey(e){return e.initialCacheKey}getForRender(e){let t=this.get(e),r=t.nodeBuilderState;if(void 0===r){let{nodeBuilderCache:i}=this,s=this.getForRenderCacheKey(e);if(void 0===(r=i.get(s))){let t=this.backend.createNodeBuilder(e.object,this.renderer,e.scene);t.material=e.material,t.context.material=e.material,t.lightsNode=e.lightsNode,t.environmentNode=this.getEnvironmentNode(e.scene),t.fogNode=this.getFogNode(e.scene),t.toneMappingNode=this.getToneMappingNode(),t.build(),r=this._createNodeBuilderState(t),i.set(s,r)}r.usedTimes++,t.nodeBuilderState=r}return r}delete(e){if(e.isRenderObject){let t=this.get(e).nodeBuilderState;t.usedTimes--,0===t.usedTimes&&this.nodeBuilderCache.delete(this.getForRenderCacheKey(e))}return super.delete(e)}getForCompute(e){let t=this.get(e),r=t.nodeBuilderState;if(void 0===r){let i=this.backend.createNodeBuilder(e,this.renderer);i.build(),r=this._createNodeBuilderState(i),t.nodeBuilderState=i}return r}_createNodeBuilderState(e){return new G(e.vertexShader,e.fragmentShader,e.computeShader,e.getAttributesArray(),e.getBindings(),e.updateNodes,e.updateBeforeNodes)}getEnvironmentNode(e){return e.environmentNode||this.get(e).environmentNode||null}getBackgroundNode(e){return e.backgroundNode||this.get(e).backgroundNode||null}getFogNode(e){return e.fogNode||this.get(e).fogNode||null}getToneMappingNode(){return!1===this.isToneMappingState?null:this.renderer.toneMappingNode||this.get(this.renderer).toneMappingNode||null}getCacheKey(e,t){let r=[e,t],i=this.renderer.info.calls,s=this.callHashCache.get(r);if(void 0===s||s.callId!==i){let n=this.getEnvironmentNode(e),a=this.getFogNode(e),o=this.getToneMappingNode(),l=[];t&&l.push(t.getCacheKey()),n&&l.push(n.getCacheKey()),a&&l.push(a.getCacheKey()),o&&l.push(o.getCacheKey()),s={callId:i,cacheKey:l.join(",")},this.callHashCache.set(r,s)}return s.cacheKey}updateScene(e){this.updateEnvironment(e),this.updateFog(e),this.updateBackground(e),this.updateToneMapping()}get isToneMappingState(){let e=this.renderer.getRenderTarget();return!e||!e.isCubeRenderTarget}updateToneMapping(){let e=this.renderer,t=this.get(e),r=e.toneMapping;if(this.isToneMappingState&&r!==c.NoToneMapping){if(t.toneMapping!==r){let i=t.rendererToneMappingNode||(0,A.Fhw)(r,(0,A.YPW)("toneMappingExposure","float",e));i.toneMapping=r,t.rendererToneMappingNode=i,t.toneMappingNode=i,t.toneMapping=r}}else delete t.toneMappingNode,delete t.toneMapping}updateBackground(e){let t=this.get(e),r=e.background;if(r){if(t.background!==r){let e=null;if(!0===r.isCubeTexture)e=(0,A.$vw)(r,A.BnF);else if(!0===r.isTexture){let t=null;t=r.mapping===c.EquirectangularReflectionMapping||r.mapping===c.EquirectangularRefractionMapping?(0,A.ZEm)():A.sSb,e=(0,A.hYO)(r,t).setUpdateMatrix(!0)}else!0!==r.isColor&&console.error("WebGPUNodes: Unsupported background configuration.",r);t.backgroundNode=e,t.background=r}}else t.backgroundNode&&(delete t.backgroundNode,delete t.background)}updateFog(e){let t=this.get(e),r=e.fog;if(r){if(t.fog!==r){let e=null;r.isFogExp2?e=(0,A.fpk)((0,A.YPW)("color","color",r),(0,A.YPW)("density","float",r)):r.isFog?e=(0,A.WR)((0,A.YPW)("color","color",r),(0,A.YPW)("near","float",r),(0,A.YPW)("far","float",r)):console.error("WebGPUNodes: Unsupported fog configuration.",r),t.fogNode=e,t.fog=r}}else delete t.fogNode,delete t.fog}updateEnvironment(e){let t=this.get(e),r=e.environment;if(r){if(t.environment!==r){let e=null;!0===r.isCubeTexture?e=(0,A.$vw)(r):!0===r.isTexture?e=(0,A.hYO)(r):console.error("Nodes: Unsupported environment configuration.",r),t.environmentNode=e,t.environment=r}}else t.environmentNode&&(delete t.environmentNode,delete t.environment)}getNodeFrame(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.renderer,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,n=this.nodeFrame;return n.renderer=e,n.scene=t,n.object=r,n.camera=i,n.material=s,n}getNodeFrameForRender(e){return this.getNodeFrame(e.renderer,e.scene,e.object,e.camera,e.material)}updateBefore(e){let t=this.getNodeFrameForRender(e);for(let r of e.getNodeBuilderState().updateBeforeNodes)t.updateBeforeNode(r)}updateForCompute(e){let t=this.getNodeFrame();for(let r of this.getForCompute(e).updateNodes)t.updateNode(r)}updateForRender(e){let t=this.getNodeFrameForRender(e);for(let r of e.getNodeBuilderState().updateNodes)t.updateNode(r)}dispose(){super.dispose(),this.nodeFrame=new A.ipI,this.nodeBuilderCache=new Map}constructor(e,t){super(),this.renderer=e,this.backend=t,this.nodeFrame=new A.ipI,this.nodeBuilderCache=new Map,this.callHashCache=new s.Z,this.groupsData=new s.Z}}let P=new c.Scene,k=new c.Vector2,z=new c.Vector4,W=new c.Frustum,H=new c.Matrix4,q=new c.Vector3;class j{async init(){if(this._initialized)throw Error("Renderer: Backend has already been initialized.");return null!==this._initPromise||(this._initPromise=new Promise(async(e,t)=>{let r=this.backend;try{await r.init(this)}catch(e){t(e);return}this._nodes=new V(this,r),this._animation=new i(this._nodes,this.info),this._attributes=new h(r),this._background=new L(this,this._nodes),this._geometries=new m(this._attributes,this.info),this._textures=new I(r,this.info),this._pipelines=new _(r,this._nodes),this._bindings=new v(r,this._nodes,this._textures,this._attributes,this._pipelines,this.info),this._objects=new o(this,this._nodes,this._geometries,this._pipelines,this._bindings,this.info),this._renderLists=new B,this._renderContexts=new M,this._initialized=!0,e()})),this._initPromise}get coordinateSystem(){return this.backend.coordinateSystem}async compile(){console.warn("THREE.Renderer: .compile() is not implemented yet.")}async render(e,t){!1===this._initialized&&await this.init();let r=this._nodes.nodeFrame,i=r.renderId,s=this._currentRenderContext,n=this._currentRenderObjectFunction,a=!0===e.isScene?e:P,o=this._renderTarget,l=this._renderContexts.get(e,t,o),u=this._activeCubeFace,d=this._activeMipmapLevel;this._currentRenderContext=l,this._currentRenderObjectFunction=this._renderObjectFunction||this.renderObject,this.info.calls++,this.info.render.calls++,r.renderId=this.info.calls;let c=this.coordinateSystem;t.coordinateSystem!==c&&(t.coordinateSystem=c,t.updateProjectionMatrix()),!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===this.info.autoReset&&this.info.reset();let h=this._viewport,p=this._scissor,g=this._pixelRatio;null!==o&&(h=o.viewport,p=o.scissor,g=1),this.getDrawingBufferSize(k),z.set(0,0,k.width,k.height);let m=void 0===h.minDepth?0:h.minDepth,f=void 0===h.maxDepth?1:h.maxDepth;l.viewportValue.copy(h).multiplyScalar(g).floor(),l.viewportValue.width>>=d,l.viewportValue.height>>=d,l.viewportValue.minDepth=m,l.viewportValue.maxDepth=f,l.viewport=!1===l.viewportValue.equals(z),l.scissorValue.copy(p).multiplyScalar(g).floor(),l.scissor=this._scissorTest&&!1===l.scissorValue.equals(z),l.scissorValue.width>>=d,l.scissorValue.height>>=d,l.depth=this.depth,l.stencil=this.stencil,a.onBeforeRender(this,e,t,o),H.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),W.setFromProjectionMatrix(H,c);let T=this._renderLists.get(e,t);if(T.begin(),this._projectObject(e,t,0,T),T.finish(),!0===this.sortObjects&&T.sort(this._opaqueSort,this._transparentSort),null!==o){this._textures.updateRenderTarget(o,d);let e=this._textures.get(o);l.textures=e.textures,l.depthTexture=e.depthTexture,l.width=e.width,l.height=e.height,l.renderTarget=o}else l.textures=null,l.depthTexture=null,l.width=this.domElement.width,l.height=this.domElement.height;l.width>>=d,l.height>>=d,l.activeCubeFace=u,l.activeMipmapLevel=d,l.occlusionQueryCount=T.occlusionQueryCount,this._nodes.updateScene(a),this._background.update(a,T,l),this.backend.beginRender(l);let y=T.opaque,x=T.transparent,b=T.lightsNode;y.length>0&&this._renderObjects(y,t,a,b),x.length>0&&this._renderObjects(x,t,a,b),this.backend.finishRender(l),r.renderId=i,this._currentRenderContext=s,this._currentRenderObjectFunction=n,a.onAfterRender(this,e,t,o)}getMaxAnisotropy(){return this.backend.getMaxAnisotropy()}getActiveCubeFace(){return this._activeCubeFace}getActiveMipmapLevel(){return this._activeMipmapLevel}async setAnimationLoop(e){!1===this._initialized&&await this.init(),this._animation.setAnimationLoop(e)}getArrayBuffer(e){return console.warn("THREE.Renderer: getArrayBuffer() is deprecated. Use getArrayBufferAsync() instead."),this.getArrayBufferAsync(e)}async getArrayBufferAsync(e){return await this.backend.getArrayBufferAsync(e)}getContext(){return this._context}getPixelRatio(){return this._pixelRatio}getDrawingBufferSize(e){return e.set(this._width*this._pixelRatio,this._height*this._pixelRatio).floor()}getSize(e){return e.set(this._width,this._height)}setPixelRatio(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this._pixelRatio=e,this.setSize(this._width,this._height,!1)}setDrawingBufferSize(e,t,r){this._width=e,this._height=t,this._pixelRatio=r,this.domElement.width=Math.floor(e*r),this.domElement.height=Math.floor(t*r),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize()}setSize(e,t){let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2];this._width=e,this._height=t,this.domElement.width=Math.floor(e*this._pixelRatio),this.domElement.height=Math.floor(t*this._pixelRatio),!0===r&&(this.domElement.style.width=e+"px",this.domElement.style.height=t+"px"),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize()}setOpaqueSort(e){this._opaqueSort=e}setTransparentSort(e){this._transparentSort=e}getScissor(e){let t=this._scissor;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e}setScissor(e,t,r,i){let s=this._scissor;e.isVector4?s.copy(e):s.set(e,t,r,i)}getScissorTest(){return this._scissorTest}setScissorTest(e){this._scissorTest=e}getViewport(e){return e.copy(this._viewport)}setViewport(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,a=this._viewport;e.isVector4?a.copy(e):a.set(e,t,r,i),a.minDepth=s,a.maxDepth=n}getClearColor(e){return e.copy(this._clearColor)}setClearColor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;this._clearColor.set(e),this._clearColor.a=t}getClearAlpha(){return this._clearColor.a}setClearAlpha(e){this._clearColor.a=e}getClearDepth(){return this._clearDepth}setClearDepth(e){this._clearDepth=e}getClearStencil(){return this._clearStencil}setClearStencil(e){this._clearStencil=e}isOccluded(e){let t=this._currentRenderContext;return t&&this.backend.isOccluded(t,e)}clear(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0],t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],i=null,s=this._renderTarget;null!==s&&(this._textures.updateRenderTarget(s),i=this._textures.get(s)),this.backend.clear(e,t,r,i)}clearColor(){this.clear(!0,!1,!1)}clearDepth(){this.clear(!1,!0,!1)}clearStencil(){this.clear(!1,!1,!0)}get currentColorSpace(){let e=this._renderTarget;if(null!==e){let t=e.texture;return(Array.isArray(t)?t[0]:t).colorSpace}return this.outputColorSpace}dispose(){this.info.dispose(),this._animation.dispose(),this._objects.dispose(),this._properties.dispose(),this._pipelines.dispose(),this._nodes.dispose(),this._bindings.dispose(),this._renderLists.dispose(),this._renderContexts.dispose(),this._textures.dispose(),this.setRenderTarget(null),this.setAnimationLoop(null)}setRenderTarget(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._renderTarget=e,this._activeCubeFace=t,this._activeMipmapLevel=r}getRenderTarget(){return this._renderTarget}setRenderObjectFunction(e){this._renderObjectFunction=e}getRenderObjectFunction(){return this._renderObjectFunction}async compute(e){!1===this._initialized&&await this.init();let t=this._nodes.nodeFrame,r=t.renderId;this.info.calls++,this.info.compute.calls++,t.renderId=this.info.calls;let i=this.backend,s=this._pipelines,n=this._bindings,a=this._nodes,o=Array.isArray(e)?e:[e];if(void 0===o[0]||!0!==o[0].isComputeNode)throw Error("THREE.Renderer: .compute() expects a ComputeNode.");for(let t of(i.beginCompute(e),o)){if(!1===s.has(t)){let e=()=>{t.removeEventListener("dispose",e),s.delete(t),n.delete(t),a.delete(t)};t.addEventListener("dispose",e),t.onInit({renderer:this})}a.updateForCompute(t),n.updateForCompute(t);let r=n.getForCompute(t),o=s.getForCompute(t,r);i.compute(e,t,r,o)}i.finishCompute(e),t.renderId=r}hasFeature(e){return this.backend.hasFeature(e)}copyFramebufferToTexture(e){let t=this._currentRenderContext;this._textures.updateTexture(e),this.backend.copyFramebufferToTexture(e,t)}readRenderTargetPixelsAsync(e,t,r,i,s){return this.backend.copyTextureToBuffer(e.texture,t,r,i,s)}_projectObject(e,t,r,i){if(!1===e.visible)return;if(e.layers.test(t.layers)){if(e.isGroup)r=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)i.pushLight(e);else if(e.isSprite){if(!e.frustumCulled||W.intersectsSprite(e)){!0===this.sortObjects&&q.setFromMatrixPosition(e.matrixWorld).applyMatrix4(H);let t=e.geometry,s=e.material;s.visible&&i.push(e,t,s,r,q.z,null)}}else if(e.isLineLoop)console.error("THREE.Renderer: Objects of type THREE.LineLoop are not supported. Please use THREE.Line or THREE.LineSegments.");else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||W.intersectsObject(e))){let t=e.geometry,s=e.material;if(!0===this.sortObjects&&(null===t.boundingSphere&&t.computeBoundingSphere(),q.copy(t.boundingSphere.center).applyMatrix4(e.matrixWorld).applyMatrix4(H)),Array.isArray(s)){let n=t.groups;for(let a=0,o=n.length;a<o;a++){let o=n[a],l=s[o.materialIndex];l&&l.visible&&i.push(e,t,l,r,q.z,o)}}else s.visible&&i.push(e,t,s,r,q.z,null)}}let s=e.children;for(let e=0,n=s.length;e<n;e++)this._projectObject(s[e],t,r,i)}_renderObjects(e,t,r,i){for(let s=0,n=e.length;s<n;s++){let{object:n,geometry:a,material:o,group:l}=e[s];if(t.isArrayCamera){let e=t.cameras;for(let t=0,s=e.length;t<s;t++){let s=e[t];if(n.layers.test(s.layers)){let e=s.viewport,t=void 0===e.minDepth?0:e.minDepth,u=void 0===e.maxDepth?1:e.maxDepth,d=this._currentRenderContext.viewportValue;d.copy(e).multiplyScalar(this._pixelRatio).floor(),d.minDepth=t,d.maxDepth=u,this.backend.updateViewport(this._currentRenderContext),this._currentRenderObjectFunction(n,r,s,a,o,l,i)}}}else this._currentRenderObjectFunction(n,r,t,a,o,l,i)}}renderObject(e,t,r,i,s,n,a){let o;if(e.onBeforeRender(this,t,r,i,s,n),s.onBeforeRender(this,t,r,i,s,n),null!==t.overrideMaterial){let e=t.overrideMaterial;s.positionNode&&s.positionNode.isNode&&(o=e.positionNode,e.positionNode=s.positionNode),s=e}!0===s.transparent&&s.side===c.DoubleSide&&!1===s.forceSinglePass?(s.side=c.BackSide,this._renderObjectDirect(e,s,t,r,a,"backSide"),s.side=c.FrontSide,this._renderObjectDirect(e,s,t,r,a),s.side=c.DoubleSide):this._renderObjectDirect(e,s,t,r,a),void 0!==o&&(t.overrideMaterial.positionNode=o),e.onAfterRender(this,t,r,i,s,n)}_renderObjectDirect(e,t,r,i,s,n){let a=this._objects.get(e,t,r,i,s,this._currentRenderContext,n);this._nodes.updateBefore(a),e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),this._nodes.updateForRender(a),this._geometries.updateForRender(a),this._bindings.updateForRender(a),this._pipelines.updateForRender(a),this.backend.draw(a,this.info)}constructor(e,t={}){this.isRenderer=!0;let{logarithmicDepthBuffer:r=!1}=t;this.domElement=e.getDomElement(),this.backend=e,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.logarithmicDepthBuffer=r,this.outputColorSpace=c.SRGBColorSpace,this.toneMapping=c.NoToneMapping,this.toneMappingExposure=1,this.sortObjects=!0,this.depth=!0,this.stencil=!0,this.info=new f,this._pixelRatio=1,this._width=this.domElement.width,this._height=this.domElement.height,this._viewport=new c.Vector4(0,0,this._width,this._height),this._scissor=new c.Vector4(0,0,this._width,this._height),this._scissorTest=!1,this._properties=null,this._attributes=null,this._geometries=null,this._nodes=null,this._animation=null,this._bindings=null,this._objects=null,this._pipelines=null,this._renderLists=null,this._renderContexts=null,this._textures=null,this._background=null,this._currentRenderContext=null,this._opaqueSort=null,this._transparentSort=null,this._clearColor=new O.Z(0),this._clearDepth=1,this._clearStencil=0,this._renderTarget=null,this._activeCubeFace=0,this._activeMipmapLevel=0,this._renderObjectFunction=null,this._currentRenderObjectFunction=null,this._initialized=!1,this._initPromise=null,this.shadowMap={enabled:!1,type:null},this.xr={enabled:!1}}}var X=j},6183:function(e,t,r){var i=r(4324);class s extends i.Z{constructor(e,t=null){super(e,t),this.isUniformBuffer=!0}}t.Z=s},178:function(e,t,r){r.d(t,{j:function(){return o},m:function(){return a}});var i=r(2578);let s=0;class n extends i.Z{get needsBindingsUpdate(){let{texture:e,version:t}=this;return!!e.isVideoTexture||t!==e.version}update(){let{texture:e,version:t}=this;return t!==e.version&&(this.version=e.version,!0)}constructor(e,t){super(e),this.id=s++,this.texture=t,this.version=t?t.version:0,this.store=!1,this.isSampledTexture=!0}}class a extends n{get needsBindingsUpdate(){return this.textureNode.value!==this.texture||super.needsBindingsUpdate}update(){let{textureNode:e}=this;return this.texture!==e.value?(this.texture=e.value,!0):super.update()}constructor(e,t){super(e,t?t.value:null),this.textureNode=t}}class o extends a{constructor(e,t){super(e,t),this.isSampledCubeTexture=!0}}},9567:function(e,t,r){r.d(t,{Z:function(){return u}});var i=r(6183),s=r(3245);class n extends i.Z{addUniform(e){return this.uniforms.push(e),this}removeUniform(e){let t=this.uniforms.indexOf(e);return -1!==t&&this.uniforms.splice(t,1),this}get buffer(){let e=this._buffer;if(null===e){let t=this.byteLength;e=new Float32Array(new ArrayBuffer(t)),this._buffer=e}return e}get byteLength(){let e=0;for(let t=0,r=this.uniforms.length;t<r;t++){let r=this.uniforms[t],i=e%s.BU,n=s.BU-i;0!==i&&n-r.boundary<0?e+=s.BU-i:i%r.boundary!=0&&(e+=i%r.boundary),r.offset=e/this.bytesPerElement,e+=r.itemSize*this.bytesPerElement}return Math.ceil(e/s.BU)*s.BU}update(){let e=!1;for(let t of this.uniforms)!0===this.updateByType(t)&&(e=!0);return e}updateByType(e){return e.isFloatUniform?this.updateNumber(e):e.isVector2Uniform?this.updateVector2(e):e.isVector3Uniform?this.updateVector3(e):e.isVector4Uniform?this.updateVector4(e):e.isColorUniform?this.updateColor(e):e.isMatrix3Uniform?this.updateMatrix3(e):e.isMatrix4Uniform?this.updateMatrix4(e):void console.error("THREE.WebGPUUniformsGroup: Unsupported uniform type.",e)}updateNumber(e){let t=!1,r=this.buffer,i=e.getValue(),s=e.offset;return r[s]!==i&&(r[s]=i,t=!0),t}updateVector2(e){let t=!1,r=this.buffer,i=e.getValue(),s=e.offset;return(r[s+0]!==i.x||r[s+1]!==i.y)&&(r[s+0]=i.x,r[s+1]=i.y,t=!0),t}updateVector3(e){let t=!1,r=this.buffer,i=e.getValue(),s=e.offset;return(r[s+0]!==i.x||r[s+1]!==i.y||r[s+2]!==i.z)&&(r[s+0]=i.x,r[s+1]=i.y,r[s+2]=i.z,t=!0),t}updateVector4(e){let t=!1,r=this.buffer,i=e.getValue(),s=e.offset;return(r[s+0]!==i.x||r[s+1]!==i.y||r[s+2]!==i.z||r[s+4]!==i.w)&&(r[s+0]=i.x,r[s+1]=i.y,r[s+2]=i.z,r[s+3]=i.w,t=!0),t}updateColor(e){let t=!1,r=this.buffer,i=e.getValue(),s=e.offset;return(r[s+0]!==i.r||r[s+1]!==i.g||r[s+2]!==i.b)&&(r[s+0]=i.r,r[s+1]=i.g,r[s+2]=i.b,t=!0),t}updateMatrix3(e){let t=!1,r=this.buffer,i=e.getValue().elements,s=e.offset;return(r[s+0]!==i[0]||r[s+1]!==i[1]||r[s+2]!==i[2]||r[s+4]!==i[3]||r[s+5]!==i[4]||r[s+6]!==i[5]||r[s+8]!==i[6]||r[s+9]!==i[7]||r[s+10]!==i[8])&&(r[s+0]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+4]=i[3],r[s+5]=i[4],r[s+6]=i[5],r[s+8]=i[6],r[s+9]=i[7],r[s+10]=i[8],t=!0),t}updateMatrix4(e){let t=!1,r=this.buffer,i=e.getValue().elements,s=e.offset;return!1===function(e,t,r){for(let i=0,s=t.length;i<s;i++)if(e[r+i]!==t[i])return!1;return!0}(r,i,s)&&(r.set(i,s),t=!0),t}constructor(e){super(e),this.isUniformsGroup=!0,this.uniforms=[]}}var a=n;let o=0;class l extends a{get shared(){return this.groupNode.shared}getNodes(){let e=[];for(let t of this.uniforms){let r=t.nodeUniform.node;if(!r)throw Error("NodeUniformsGroup: Uniform has no node.");e.push(r)}return e}constructor(e,t){super(e),this.id=o++,this.groupNode=t,this.isNodeUniformsGroup=!0}}var u=l},4358:function(e,t,r){r.d(t,{Z:function(){return E}});var i=r(1901),s=r(3200),n=r(6183),a=r(9567),o=r(178);let l={[s.hul.ATAN2]:"atan",textureDimensions:"textureSize"},u={low:"lowp",medium:"mediump",high:"highp"},d={instance:!0},c="\nprecision highp float;\nprecision highp int;\nprecision mediump sampler2DArray;\nprecision lowp sampler2DShadow;\n";class h extends s._XU{getMethod(e){return l[e]||e}getPropertyName(e,t){return e.isOutputStructVar?"":super.getPropertyName(e,t)}buildFunctionCode(e){let t=e.layout,r=this.flowShaderNode(e),i=[];for(let e of t.inputs)i.push(this.getType(e.type)+" "+e.name);return"".concat(this.getType(t.type)," ").concat(t.name,"( ").concat(i.join(", ")," ) {\n\n	").concat(r.vars,"\n\n").concat(r.code,"\n	return ").concat(r.result,";\n\n}")}generateTextureLoad(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"0";return i?"texelFetch( ".concat(t,", ivec3( ").concat(r,", ").concat(i," ), ").concat(s," )"):"texelFetch( ".concat(t,", ").concat(r,", ").concat(s," )")}generateTexture(e,t,r,i){return e.isTextureCube?"textureCube( ".concat(t,", ").concat(r," )"):e.isDepthTexture?"texture( ".concat(t,", ").concat(r," ).x"):(i&&(r="vec3( ".concat(r,", ").concat(i," )")),"texture( ".concat(t,", ").concat(r," )"))}generateTextureLevel(e,t,r,i){return"textureLod( ".concat(t,", ").concat(r,", ").concat(i," )")}generateTextureCompare(e,t,r,i,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.shaderStage;if("fragment"===n)return"texture( ".concat(t,", vec3( ").concat(r,", ").concat(i," ) )");console.error("WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ".concat(n," shader."))}getVars(e){let t=[],r=this.vars[e];if(void 0!==r)for(let e of r)e.isOutputStructVar||t.push("".concat(this.getVar(e.type,e.name),";"));return t.join("\n	")}getUniforms(e){let t=this.uniforms[e],r=[],i={};for(let e of t){let t=null,s=!1;if("texture"===e.type){let r=e.node.value;t=r.compareFunction?"sampler2DShadow ".concat(e.name,";"):!0===r.isDataArrayTexture?"sampler2DArray ".concat(e.name,";"):"sampler2D ".concat(e.name,";")}else if("cubeTexture"===e.type)t="samplerCube ".concat(e.name,";");else if("buffer"===e.type){let r=e.node,i=this.getType(r.bufferType),s=r.bufferCount,n=s>0?s:"";t="".concat(r.name," {\n	").concat(i," ").concat(e.name,"[").concat(n,"];\n};\n")}else{let r=this.getVectorType(e.type);t="".concat(r," ").concat(e.name,";"),s=!0}let n=e.node.precision;if(null!==n&&(t=u[n]+" "+t),s){t="	"+t;let r=e.groupNode.name;(i[r]||(i[r]=[])).push(t)}else t="uniform "+t,r.push(t)}let s="";for(let t in i){let r=i[t];s+=this._getGLSLUniformStruct(e+"_"+t,r.join("\n"))+"\n"}return s+r.join("\n")}getTypeFromAttribute(e){let t=super.getTypeFromAttribute(e);if(/^[iu]/.test(t)&&e.gpuType!==i.IntType){let r=e;e.isInterleavedBufferAttribute&&(r=e.data);let i=r.array;!1==(i instanceof Uint32Array||i instanceof Int32Array)&&(t=t.slice(1))}return t}getAttributes(e){let t="";if("vertex"===e){let e=this.getAttributesArray(),r=0;for(let i of e)t+="layout( location = ".concat(r++," ) in ").concat(i.type," ").concat(i.name,";\n")}return t}getStructMembers(e){let t=[],r=e.getMemberTypes();for(let e=0;e<r.length;e++){let i=r[e];t.push("layout( location = ".concat(e," ) out ").concat(i," m").concat(e,";"))}return t.join("\n")}getStructs(e){let t=[],r=this.structs[e];if(0===r.length)return"layout( location = 0 ) out vec4 fragColor;\n";for(let e=0,i=r.length;e<i;e++){let i=r[e],s="\n";s+=this.getStructMembers(i)+"\n",t.push(s)}return t.join("\n\n")}getVaryings(e){let t="",r=this.varyings;if("vertex"===e)for(let e of r){let r=e.type,i="int"===r||"uint"===r?"flat ":"";t+="".concat(i).concat(e.needsInterpolation?"out":"/*out*/"," ").concat(r," ").concat(e.name,";\n")}else if("fragment"===e){for(let e of r)if(e.needsInterpolation){let r=e.type,i="int"===r||"uint"===r?"flat ":"";t+="".concat(i,"in ").concat(r," ").concat(e.name,";\n")}}return t}getVertexIndex(){return"uint( gl_VertexID )"}getInstanceIndex(){return"uint( gl_InstanceID )"}getFrontFacing(){return"gl_FrontFacing"}getFragCoord(){return"gl_FragCoord"}getFragDepth(){return"gl_FragDepth"}isAvailable(e){return!0===d[e]}isFlipY(){return!0}_getGLSLUniformStruct(e,t){return"\nlayout( std140 ) uniform ".concat(e," {\n").concat(t,"\n};")}_getGLSLVertexCode(e){return"#version 300 es\n\n".concat(this.getSignature(),"\n\n// precision\n").concat(c,"\n\n// uniforms\n").concat(e.uniforms,"\n\n// varyings\n").concat(e.varyings,"\n\n// attributes\n").concat(e.attributes,"\n\n// codes\n").concat(e.codes,"\n\nvoid main() {\n\n	// vars\n	").concat(e.vars,"\n\n	// flow\n	").concat(e.flow,"\n\n	gl_PointSize = 1.0;\n\n}\n")}_getGLSLFragmentCode(e){return"#version 300 es\n\n".concat(this.getSignature(),"\n\n// precision\n").concat(c,"\n\n// uniforms\n").concat(e.uniforms,"\n\n// varyings\n").concat(e.varyings,"\n\n// codes\n").concat(e.codes,"\n\n").concat(e.structs,"\n\nvoid main() {\n\n	// vars\n	").concat(e.vars,"\n\n	// flow\n	").concat(e.flow,"\n\n}\n")}buildCode(){let e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};for(let t in e){let r="// code\n\n";r+=this.flowCode[t];let i=this.flowNodes[t],s=i[i.length-1];for(let e of i){let i=this.getFlowData(e),n=e.name;n&&(r.length>0&&(r+="\n"),r+="	// flow -> ".concat(n,"\n	")),r+="".concat(i.code,"\n	"),e!==s||"compute"===t||(r+="// result\n	","vertex"===t?r+="gl_Position = "+"".concat(i.result,";"):"fragment"!==t||e.outputNode.isOutputStructNode||(r+="fragColor = "+"".concat(i.result,";")))}let n=e[t];n.uniforms=this.getUniforms(t),n.attributes=this.getAttributes(t),n.varyings=this.getVaryings(t),n.vars=this.getVars(t),n.structs=this.getStructs(t),n.codes=this.getCodes(t),n.flow=r}null!==this.material?(this.vertexShader=this._getGLSLVertexCode(e.vertex),this.fragmentShader=this._getGLSLFragmentCode(e.fragment)):console.warn("GLSLNodeBuilder: compute shaders are not supported.")}getUniformFromNode(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=super.getUniformFromNode(e,t,r,i),l=this.getDataFromNode(e,r,this.globalCache),u=l.uniformGPU;if(void 0===u){if("texture"===t)u=new o.m(s.name,s.node),this.bindings[r].push(u);else if("cubeTexture"===t)u=new o.j(s.name,s.node),this.bindings[r].push(u);else if("buffer"===t){e.name="NodeBuffer_".concat(e.id);let t=new n.Z(e.name,e.value);s.name="buffer".concat(e.id),this.bindings[r].push(t),u=t}else{let i=e.groupNode,n=i.name,o=this.uniformGroups[r]||(this.uniformGroups[r]={}),l=o[n];void 0===l&&(l=new a.Z(r+"_"+n,i),o[n]=l,this.bindings[r].push(l)),u=this.getNodeUniform(s,t),l.addUniform(u)}l.uniformGPU=u}return s}build(){let{object:e,material:t}=this;return null!==t?s.Oie.fromMaterial(t).build(this):this.addFlow("compute",e),super.build()}constructor(e,t,r=null){super(e,t,new s.mTA,r),this.uniformGroups={}}}var p=r(3475);class g{createAttribute(e,t){let r;let s=this.backend,{gl:n}=s,a=e.array,o=e.usage||n.STATIC_DRAW,l=e.isInterleavedBufferAttribute?e.data:e,u=s.get(l),d=u.bufferGPU;if(void 0===d&&(d=n.createBuffer(),n.bindBuffer(t,d),n.bufferData(t,a,o),n.bindBuffer(t,null),u.bufferGPU=d,u.bufferType=t,u.version=l.version),a instanceof Float32Array)r=n.FLOAT;else if(a instanceof Uint16Array)r=e.isFloat16BufferAttribute?n.HALF_FLOAT:n.UNSIGNED_SHORT;else if(a instanceof Int16Array)r=n.SHORT;else if(a instanceof Uint32Array)r=n.UNSIGNED_INT;else if(a instanceof Int32Array)r=n.INT;else if(a instanceof Int8Array)r=n.BYTE;else if(a instanceof Uint8Array)r=n.UNSIGNED_BYTE;else if(a instanceof Uint8ClampedArray)r=n.UNSIGNED_BYTE;else throw Error("THREE.WebGLBackend: Unsupported buffer data format: "+a);s.set(e,{bufferGPU:d,type:r,bytesPerElement:a.BYTES_PER_ELEMENT,version:e.version,isInteger:r===n.INT||r===n.UNSIGNED_INT||e.gpuType===i.IntType})}updateAttribute(e){let t=this.backend,{gl:r}=t,i=e.array,s=e.isInterleavedBufferAttribute?e.data:e,n=t.get(s),a=n.bufferType,o=e.isInterleavedBufferAttribute?e.data.updateRanges:e.updateRanges;if(r.bindBuffer(a,n.bufferGPU),0===o.length)r.bufferSubData(a,0,i);else{for(let e=0,t=o.length;e<t;e++){let t=o[e];r.bufferSubData(a,t.start*i.BYTES_PER_ELEMENT,i,t.start,t.count)}s.clearUpdateRanges()}r.bindBuffer(a,null),n.version=s.version}async getArrayBufferAsync(e){let t=this.backend,{gl:r}=t,i=e.isInterleavedBufferAttribute?e.data:e,{bufferGPU:s}=t.get(i),n=e.array,a=n.byteLength;r.bindBuffer(r.COPY_READ_BUFFER,s);let o=r.createBuffer();r.bindBuffer(r.COPY_WRITE_BUFFER,o),r.bufferData(r.COPY_WRITE_BUFFER,a,r.STREAM_READ),r.copyBufferSubData(r.COPY_READ_BUFFER,r.COPY_WRITE_BUFFER,0,0,a),await t.utils._clientWaitAsync();let l=new e.array.constructor(n.length);return r.getBufferSubData(r.COPY_WRITE_BUFFER,0,l),r.deleteBuffer(o),l.buffer}constructor(e){this.backend=e}}let m=!1,f,T;class y{_init(e){f={[i.AddEquation]:e.FUNC_ADD,[i.SubtractEquation]:e.FUNC_SUBTRACT,[i.ReverseSubtractEquation]:e.FUNC_REVERSE_SUBTRACT},T={[i.ZeroFactor]:e.ZERO,[i.OneFactor]:e.ONE,[i.SrcColorFactor]:e.SRC_COLOR,[i.SrcAlphaFactor]:e.SRC_ALPHA,[i.SrcAlphaSaturateFactor]:e.SRC_ALPHA_SATURATE,[i.DstColorFactor]:e.DST_COLOR,[i.DstAlphaFactor]:e.DST_ALPHA,[i.OneMinusSrcColorFactor]:e.ONE_MINUS_SRC_COLOR,[i.OneMinusSrcAlphaFactor]:e.ONE_MINUS_SRC_ALPHA,[i.OneMinusDstColorFactor]:e.ONE_MINUS_DST_COLOR,[i.OneMinusDstAlphaFactor]:e.ONE_MINUS_DST_ALPHA}}enable(e){let{enabled:t}=this;!0!==t[e]&&(this.gl.enable(e),t[e]=!0)}disable(e){let{enabled:t}=this;!1!==t[e]&&(this.gl.disable(e),t[e]=!1)}setFlipSided(e){if(this.currentFlipSided!==e){let{gl:t}=this;e?t.frontFace(t.CW):t.frontFace(t.CCW),this.currentFlipSided=e}}setCullFace(e){let{gl:t}=this;e!==i.CullFaceNone?(this.enable(t.CULL_FACE),e!==this.currentCullFace&&(e===i.CullFaceBack?t.cullFace(t.BACK):e===i.CullFaceFront?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):this.disable(t.CULL_FACE),this.currentCullFace=e}setBlending(e,t,r,s,n,a,o,l){let{gl:u}=this;if(e===i.NoBlending){!0===this.currentBlendingEnabled&&(this.disable(u.BLEND),this.currentBlendingEnabled=!1);return}if(!1===this.currentBlendingEnabled&&(this.enable(u.BLEND),this.currentBlendingEnabled=!0),e!==i.CustomBlending){if(e!==this.currentBlending||l!==this.currentPremultipledAlpha){if((this.currentBlendEquation!==i.AddEquation||this.currentBlendEquationAlpha!==i.AddEquation)&&(u.blendEquation(u.FUNC_ADD),this.currentBlendEquation=i.AddEquation,this.currentBlendEquationAlpha=i.AddEquation),l)switch(e){case i.NormalBlending:u.blendFuncSeparate(u.ONE,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA);break;case i.AdditiveBlending:u.blendFunc(u.ONE,u.ONE);break;case i.SubtractiveBlending:u.blendFuncSeparate(u.ZERO,u.ONE_MINUS_SRC_COLOR,u.ZERO,u.ONE);break;case i.MultiplyBlending:u.blendFuncSeparate(u.ZERO,u.SRC_COLOR,u.ZERO,u.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case i.NormalBlending:u.blendFuncSeparate(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA);break;case i.AdditiveBlending:u.blendFunc(u.SRC_ALPHA,u.ONE);break;case i.SubtractiveBlending:u.blendFuncSeparate(u.ZERO,u.ONE_MINUS_SRC_COLOR,u.ZERO,u.ONE);break;case i.MultiplyBlending:u.blendFunc(u.ZERO,u.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentBlending=e,this.currentPremultipledAlpha=l}return}n=n||t,a=a||r,o=o||s,(t!==this.currentBlendEquation||n!==this.currentBlendEquationAlpha)&&(u.blendEquationSeparate(f[t],f[n]),this.currentBlendEquation=t,this.currentBlendEquationAlpha=n),(r!==this.currentBlendSrc||s!==this.currentBlendDst||a!==this.currentBlendSrcAlpha||o!==this.currentBlendDstAlpha)&&(u.blendFuncSeparate(T[r],T[s],T[a],T[o]),this.currentBlendSrc=r,this.currentBlendDst=s,this.currentBlendSrcAlpha=a,this.currentBlendDstAlpha=o),this.currentBlending=e,this.currentPremultipledAlpha=!1}setColorMask(e){this.currentColorMask!==e&&(this.gl.colorMask(e,e,e,e),this.currentColorMask=e)}setDepthTest(e){let{gl:t}=this;e?this.enable(t.DEPTH_TEST):this.disable(t.DEPTH_TEST)}setDepthMask(e){this.currentDepthMask!==e&&(this.gl.depthMask(e),this.currentDepthMask=e)}setDepthFunc(e){if(this.currentDepthFunc!==e){let{gl:t}=this;switch(e){case i.NeverDepth:t.depthFunc(t.NEVER);break;case i.AlwaysDepth:t.depthFunc(t.ALWAYS);break;case i.LessDepth:t.depthFunc(t.LESS);break;case i.LessEqualDepth:t.depthFunc(t.LEQUAL);break;case i.EqualDepth:t.depthFunc(t.EQUAL);break;case i.GreaterEqualDepth:t.depthFunc(t.GEQUAL);break;case i.GreaterDepth:t.depthFunc(t.GREATER);break;case i.NotEqualDepth:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}this.currentDepthFunc=e}}setStencilTest(e){let{gl:t}=this;e?this.enable(t.STENCIL_TEST):this.disable(t.STENCIL_TEST)}setStencilMask(e){this.currentStencilMask!==e&&(this.gl.stencilMask(e),this.currentStencilMask=e)}setStencilFunc(e,t,r){(this.currentStencilFunc!==e||this.currentStencilRef!==t||this.currentStencilFuncMask!==r)&&(this.gl.stencilFunc(e,t,r),this.currentStencilFunc=e,this.currentStencilRef=t,this.currentStencilFuncMask=r)}setStencilOp(e,t,r){(this.currentStencilFail!==e||this.currentStencilZFail!==t||this.currentStencilZPass!==r)&&(this.gl.stencilOp(e,t,r),this.currentStencilFail=e,this.currentStencilZFail=t,this.currentStencilZPass=r)}setMaterial(e,t){let{gl:r}=this;e.side===i.DoubleSide?this.disable(r.CULL_FACE):this.enable(r.CULL_FACE);let s=e.side===i.BackSide;t&&(s=!s),this.setFlipSided(s),e.blending===i.NormalBlending&&!1===e.transparent?this.setBlending(i.NoBlending):this.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),this.setDepthFunc(e.depthFunc),this.setDepthTest(e.depthTest),this.setDepthMask(e.depthWrite),this.setColorMask(e.colorWrite);let n=e.stencilWrite;this.setStencilTest(n),n&&(this.setStencilMask(e.stencilWriteMask),this.setStencilFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),this.setStencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),this.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage?this.enable(r.SAMPLE_ALPHA_TO_COVERAGE):this.disable(r.SAMPLE_ALPHA_TO_COVERAGE)}setPolygonOffset(e,t,r){let{gl:i}=this;e?(this.enable(i.POLYGON_OFFSET_FILL),(this.currentPolygonOffsetFactor!==t||this.currentPolygonOffsetUnits!==r)&&(i.polygonOffset(t,r),this.currentPolygonOffsetFactor=t,this.currentPolygonOffsetUnits=r)):this.disable(i.POLYGON_OFFSET_FILL)}useProgram(e){return this.currentProgram!==e&&(this.gl.useProgram(e),this.currentProgram=e,!0)}constructor(e){this.backend=e,this.gl=this.backend.gl,this.enabled={},this.currentFlipSided=null,this.currentCullFace=null,this.currentProgram=null,this.currentBlendingEnabled=!1,this.currentBlending=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipledAlpha=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentColorMask=null,this.currentDepthFunc=null,this.currentDepthMask=null,this.currentStencilFunc=null,this.currentStencilRef=null,this.currentStencilFuncMask=null,this.currentStencilFail=null,this.currentStencilZFail=null,this.currentStencilZPass=null,this.currentStencilMask=null,!1===m&&(this._init(this.gl),m=!0)}}class x{convert(e){let t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i.NoColorSpace,{gl:s,extensions:n}=this;if(e===i.UnsignedByteType)return s.UNSIGNED_BYTE;if(e===i.UnsignedShort4444Type)return s.UNSIGNED_SHORT_4_4_4_4;if(e===i.UnsignedShort5551Type)return s.UNSIGNED_SHORT_5_5_5_1;if(e===i.ByteType)return s.BYTE;if(e===i.ShortType)return s.SHORT;if(e===i.UnsignedShortType)return s.UNSIGNED_SHORT;if(e===i.IntType)return s.INT;if(e===i.UnsignedIntType)return s.UNSIGNED_INT;if(e===i.FloatType)return s.FLOAT;if(e===i.HalfFloatType)return s.HALF_FLOAT;if(e===i.AlphaFormat)return s.ALPHA;if(e===i.RGBAFormat)return s.RGBA;if(e===i.LuminanceFormat)return s.LUMINANCE;if(e===i.LuminanceAlphaFormat)return s.LUMINANCE_ALPHA;if(e===i.DepthFormat)return s.DEPTH_COMPONENT;if(e===i.DepthStencilFormat)return s.DEPTH_STENCIL;if(e===i.RedFormat)return s.RED;if(e===i.RedIntegerFormat)return s.RED_INTEGER;if(e===i.RGFormat)return s.RG;if(e===i.RGIntegerFormat)return s.RG_INTEGER;if(e===i.RGBAIntegerFormat)return s.RGBA_INTEGER;if(e===i.RGB_S3TC_DXT1_Format||e===i.RGBA_S3TC_DXT1_Format||e===i.RGBA_S3TC_DXT3_Format||e===i.RGBA_S3TC_DXT5_Format){if(r===i.SRGBColorSpace){if(null===(t=n.get("WEBGL_compressed_texture_s3tc_srgb")))return null;if(e===i.RGB_S3TC_DXT1_Format)return t.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(e===i.RGBA_S3TC_DXT1_Format)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(e===i.RGBA_S3TC_DXT3_Format)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(e===i.RGBA_S3TC_DXT5_Format)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(null===(t=n.get("WEBGL_compressed_texture_s3tc")))return null;if(e===i.RGB_S3TC_DXT1_Format)return t.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===i.RGBA_S3TC_DXT1_Format)return t.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===i.RGBA_S3TC_DXT3_Format)return t.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===i.RGBA_S3TC_DXT5_Format)return t.COMPRESSED_RGBA_S3TC_DXT5_EXT}}if(e===i.RGB_PVRTC_4BPPV1_Format||e===i.RGB_PVRTC_2BPPV1_Format||e===i.RGBA_PVRTC_4BPPV1_Format||e===i.RGBA_PVRTC_2BPPV1_Format){if(null===(t=n.get("WEBGL_compressed_texture_pvrtc")))return null;if(e===i.RGB_PVRTC_4BPPV1_Format)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===i.RGB_PVRTC_2BPPV1_Format)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===i.RGBA_PVRTC_4BPPV1_Format)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===i.RGBA_PVRTC_2BPPV1_Format)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===i.RGB_ETC1_Format)return null!==(t=n.get("WEBGL_compressed_texture_etc1"))?t.COMPRESSED_RGB_ETC1_WEBGL:null;if(e===i.RGB_ETC2_Format||e===i.RGBA_ETC2_EAC_Format){if(null===(t=n.get("WEBGL_compressed_texture_etc")))return null;if(e===i.RGB_ETC2_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ETC2:t.COMPRESSED_RGB8_ETC2;if(e===i.RGBA_ETC2_EAC_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t.COMPRESSED_RGBA8_ETC2_EAC}if(e===i.RGBA_ASTC_4x4_Format||e===i.RGBA_ASTC_5x4_Format||e===i.RGBA_ASTC_5x5_Format||e===i.RGBA_ASTC_6x5_Format||e===i.RGBA_ASTC_6x6_Format||e===i.RGBA_ASTC_8x5_Format||e===i.RGBA_ASTC_8x6_Format||e===i.RGBA_ASTC_8x8_Format||e===i.RGBA_ASTC_10x5_Format||e===i.RGBA_ASTC_10x6_Format||e===i.RGBA_ASTC_10x8_Format||e===i.RGBA_ASTC_10x10_Format||e===i.RGBA_ASTC_12x10_Format||e===i.RGBA_ASTC_12x12_Format){if(null===(t=n.get("WEBGL_compressed_texture_astc")))return null;if(e===i.RGBA_ASTC_4x4_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:t.COMPRESSED_RGBA_ASTC_4x4_KHR;if(e===i.RGBA_ASTC_5x4_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:t.COMPRESSED_RGBA_ASTC_5x4_KHR;if(e===i.RGBA_ASTC_5x5_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:t.COMPRESSED_RGBA_ASTC_5x5_KHR;if(e===i.RGBA_ASTC_6x5_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:t.COMPRESSED_RGBA_ASTC_6x5_KHR;if(e===i.RGBA_ASTC_6x6_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:t.COMPRESSED_RGBA_ASTC_6x6_KHR;if(e===i.RGBA_ASTC_8x5_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:t.COMPRESSED_RGBA_ASTC_8x5_KHR;if(e===i.RGBA_ASTC_8x6_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:t.COMPRESSED_RGBA_ASTC_8x6_KHR;if(e===i.RGBA_ASTC_8x8_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:t.COMPRESSED_RGBA_ASTC_8x8_KHR;if(e===i.RGBA_ASTC_10x5_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:t.COMPRESSED_RGBA_ASTC_10x5_KHR;if(e===i.RGBA_ASTC_10x6_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:t.COMPRESSED_RGBA_ASTC_10x6_KHR;if(e===i.RGBA_ASTC_10x8_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:t.COMPRESSED_RGBA_ASTC_10x8_KHR;if(e===i.RGBA_ASTC_10x10_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:t.COMPRESSED_RGBA_ASTC_10x10_KHR;if(e===i.RGBA_ASTC_12x10_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:t.COMPRESSED_RGBA_ASTC_12x10_KHR;if(e===i.RGBA_ASTC_12x12_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:t.COMPRESSED_RGBA_ASTC_12x12_KHR}if(e===i.RGBA_BPTC_Format){if(null===(t=n.get("EXT_texture_compression_bptc")))return null;if(e===i.RGBA_BPTC_Format)return r===i.SRGBColorSpace?t.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:t.COMPRESSED_RGBA_BPTC_UNORM_EXT}if(e===i.RED_RGTC1_Format||e===i.SIGNED_RED_RGTC1_Format||e===i.RED_GREEN_RGTC2_Format||e===i.SIGNED_RED_GREEN_RGTC2_Format){if(null===(t=n.get("EXT_texture_compression_rgtc")))return null;if(e===i.RGBA_BPTC_Format)return t.COMPRESSED_RED_RGTC1_EXT;if(e===i.SIGNED_RED_RGTC1_Format)return t.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(e===i.RED_GREEN_RGTC2_Format)return t.COMPRESSED_RED_GREEN_RGTC2_EXT;if(e===i.SIGNED_RED_GREEN_RGTC2_Format)return t.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return e===i.UnsignedInt248Type?s.UNSIGNED_INT_24_8:void 0!==s[e]?s[e]:null}_clientWaitAsync(){let{gl:e}=this,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),new Promise((r,i)=>{!function s(){let n=e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0);if(n===e.WAIT_FAILED){e.deleteSync(t),i();return}if(n===e.TIMEOUT_EXPIRED){requestAnimationFrame(s);return}e.deleteSync(t),r()}()})}constructor(e){this.backend=e,this.gl=this.backend.gl,this.extensions=e.extensions}}let b=!1,S,N,_;class v{_init(e){S={[i.RepeatWrapping]:e.REPEAT,[i.ClampToEdgeWrapping]:e.CLAMP_TO_EDGE,[i.MirroredRepeatWrapping]:e.MIRRORED_REPEAT},N={[i.NearestFilter]:e.NEAREST,[i.NearestMipmapNearestFilter]:e.NEAREST_MIPMAP_NEAREST,[i.NearestMipmapLinearFilter]:e.NEAREST_MIPMAP_LINEAR,[i.LinearFilter]:e.LINEAR,[i.LinearMipmapNearestFilter]:e.LINEAR_MIPMAP_NEAREST,[i.LinearMipmapLinearFilter]:e.LINEAR_MIPMAP_LINEAR},_={[i.NeverCompare]:e.NEVER,[i.AlwaysCompare]:e.ALWAYS,[i.LessCompare]:e.LESS,[i.LessEqualCompare]:e.LEQUAL,[i.EqualCompare]:e.EQUAL,[i.GreaterEqualCompare]:e.GEQUAL,[i.GreaterCompare]:e.GREATER,[i.NotEqualCompare]:e.NOTEQUAL}}filterFallback(e){let{gl:t}=this;return e===i.NearestFilter||e===i.NearestMipmapNearestFilter||e===i.NearestMipmapLinearFilter?t.NEAREST:t.LINEAR}getGLTextureType(e){let{gl:t}=this;return!0===e.isCubeTexture?t.TEXTURE_CUBE_MAP:!0===e.isDataArrayTexture?t.TEXTURE_2D_ARRAY:t.TEXTURE_2D}getInternalFormat(e,t,r,s){let n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],{gl:a,extensions:o}=this;if(null!==e){if(void 0!==a[e])return a[e];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+e+"'")}let l=t;return t===a.RED&&(r===a.FLOAT&&(l=a.R32F),r===a.HALF_FLOAT&&(l=a.R16F),r===a.UNSIGNED_BYTE&&(l=a.R8)),t===a.RED_INTEGER&&(r===a.UNSIGNED_BYTE&&(l=a.R8UI),r===a.UNSIGNED_SHORT&&(l=a.R16UI),r===a.UNSIGNED_INT&&(l=a.R32UI),r===a.BYTE&&(l=a.R8I),r===a.SHORT&&(l=a.R16I),r===a.INT&&(l=a.R32I)),t===a.RG&&(r===a.FLOAT&&(l=a.RG32F),r===a.HALF_FLOAT&&(l=a.RG16F),r===a.UNSIGNED_BYTE&&(l=a.RG8)),t===a.RGBA&&(r===a.FLOAT&&(l=a.RGBA32F),r===a.HALF_FLOAT&&(l=a.RGBA16F),r===a.UNSIGNED_BYTE&&(l=s===i.SRGBColorSpace&&!1===n?a.SRGB8_ALPHA8:a.RGBA8),r===a.UNSIGNED_SHORT_4_4_4_4&&(l=a.RGBA4),r===a.UNSIGNED_SHORT_5_5_5_1&&(l=a.RGB5_A1)),t===a.DEPTH_COMPONENT&&(r===a.UNSIGNED_INT&&(l=a.DEPTH24_STENCIL8),r===a.FLOAT&&(l=a.DEPTH_COMPONENT32F)),t===a.DEPTH_STENCIL&&r===a.UNSIGNED_INT_24_8&&(l=a.DEPTH24_STENCIL8),(l===a.R16F||l===a.R32F||l===a.RG16F||l===a.RG32F||l===a.RGBA16F||l===a.RGBA32F)&&o.get("EXT_color_buffer_float"),l}setTextureParameters(e,t){let{gl:r,extensions:s}=this;if(r.texParameteri(e,r.TEXTURE_WRAP_S,S[t.wrapS]),r.texParameteri(e,r.TEXTURE_WRAP_T,S[t.wrapT]),(e===r.TEXTURE_3D||e===r.TEXTURE_2D_ARRAY)&&r.texParameteri(e,r.TEXTURE_WRAP_R,S[t.wrapR]),r.texParameteri(e,r.TEXTURE_MAG_FILTER,N[t.magFilter]),r.texParameteri(e,r.TEXTURE_MIN_FILTER,N[t.minFilter]),t.compareFunction&&(r.texParameteri(e,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE),r.texParameteri(e,r.TEXTURE_COMPARE_FUNC,_[t.compareFunction])),!0===s.has("EXT_texture_filter_anisotropic")){if(t.magFilter===i.NearestFilter||t.minFilter!==i.NearestMipmapLinearFilter&&t.minFilter!==i.LinearMipmapLinearFilter||t.type===i.FloatType&&!1===s.has("OES_texture_float_linear"))return;t.anisotropy}}async copyTextureToBuffer(e,t,r,i,s){let{backend:n,gl:a}=this,{textureGPU:o,glFormat:l,glType:u}=this.backend.get(e),d=a.createFramebuffer();a.bindFramebuffer(a.READ_FRAMEBUFFER,d),a.framebufferTexture2D(a.READ_FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,o,0);let c=this._getTypedArrayType(u),h=this._getBytesPerTexel(l),p=i*s,g=p*h,m=a.createBuffer();a.bindBuffer(a.PIXEL_PACK_BUFFER,m),a.bufferData(a.PIXEL_PACK_BUFFER,g,a.STREAM_READ),a.readPixels(t,r,i,s,l,u,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),await n.utils._clientWaitAsync();let f=new c(p);return a.bindBuffer(a.PIXEL_PACK_BUFFER,m),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,f),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.deleteFramebuffer(d),f}_getTypedArrayType(e){let{gl:t}=this;return e===t.UNSIGNED_BYTE?Uint8Array:e===t.UNSIGNED_SHORT_4_4_4_4||e===t.UNSIGNED_SHORT_5_5_5_1||e===t.UNSIGNED_SHORT_5_6_5||e===t.UNSIGNED_SHORT?Uint16Array:e===t.UNSIGNED_INT?Uint32Array:e===t.UNSIGNED_FLOAT?Float32Array:void 0}_getBytesPerTexel(e){let{gl:t}=this;return e===t.RGBA?4:e===t.RGB?3:e===t.ALPHA?1:void 0}constructor(e){this.backend=e,this.gl=e.gl,this.extensions=e.extensions,!1===b&&(this._init(this.gl),b=!0)}}class A{get(e){let t=this.extensions[e];return void 0===t&&(t=this.gl.getExtension(e)),t}has(e){return this.availableExtensions.includes(e)}constructor(e){this.backend=e,this.gl=this.backend.gl,this.availableExtensions=this.gl.getSupportedExtensions(),this.extensions={}}}class R{getMaxAnisotropy(){if(null!==this.maxAnisotropy)return this.maxAnisotropy;let e=this.backend.gl,t=this.backend.extensions;if(!0===t.has("EXT_texture_filter_anisotropic")){let r=t.get("EXT_texture_filter_anisotropic");this.maxAnisotropy=e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else this.maxAnisotropy=0;return this.maxAnisotropy}constructor(e){this.backend=e,this.maxAnisotropy=null}}class C extends p.Z{async init(e){await super.init(e);let t=this.parameters,r=void 0!==t.context?t.context:e.domElement.getContext("webgl2");this.gl=r,this.extensions=new A(this),this.capabilities=new R(this),this.attributeUtils=new g(this),this.textureUtils=new v(this),this.state=new y(this),this.utils=new x(this),this.defaultTextures={},this.extensions.get("EXT_color_buffer_float"),this._currentContext=null}get coordinateSystem(){return i.WebGLCoordinateSystem}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}beginRender(e){let{gl:t}=this,r=this.get(e);r.previousContext=this._currentContext,this._currentContext=e,this._setFramebuffer(e),this.clear(e.clearColor,e.clearDepth,e.clearStencil,e),e.viewport?this.updateViewport(e):t.viewport(0,0,t.drawingBufferWidth,t.drawingBufferHeight);let i=e.occlusionQueryCount;i>0&&(r.currentOcclusionQueries=r.occlusionQueries,r.currentOcclusionQueryObjects=r.occlusionQueryObjects,r.lastOcclusionObject=null,r.occlusionQueries=Array(i),r.occlusionQueryObjects=Array(i),r.occlusionQueryIndex=0)}finishRender(e){let t=this.get(e).previousContext;if(this._currentContext=t,null!==t){if(this._setFramebuffer(t),t.viewport)this.updateViewport(t);else{let e=this.gl;e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight)}}let r=e.occlusionQueryCount;if(r>0){if(r>this.get(e).occlusionQueryIndex){let{gl:e}=this;e.endQuery(e.ANY_SAMPLES_PASSED)}this.resolveOccludedAsync(e)}}resolveOccludedAsync(e){let t=this.get(e),{currentOcclusionQueries:r,currentOcclusionQueryObjects:i}=t;if(r&&i){let e=new WeakSet,{gl:s}=this;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueries=null;let n=()=>{let a=0;for(let t=0;t<r.length;t++){let n=r[t];null!==n&&s.getQueryParameter(n,s.QUERY_RESULT_AVAILABLE)&&(s.getQueryParameter(n,s.QUERY_RESULT)>0&&e.add(i[t]),r[t]=null,s.deleteQuery(n),a++)}a<r.length?requestAnimationFrame(n):t.occluded=e};n()}}isOccluded(e,t){let r=this.get(e);return r.occluded&&r.occluded.has(t)}updateViewport(e){let t=this.gl,{x:r,y:i,width:s,height:n}=e.viewportValue;t.viewport(r,i,s,n)}clear(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,{gl:s}=this;null===i&&(i={textures:null,clearColorValue:this.getClearColor()});let n=0;if(e&&(n|=s.COLOR_BUFFER_BIT),t&&(n|=s.DEPTH_BUFFER_BIT),r&&(n|=s.STENCIL_BUFFER_BIT),0!==n){let a=i.clearColorValue;if(t&&this.state.setDepthMask(!0),null===i.textures)s.clearColor(a.r,a.g,a.b,a.a),s.clear(n);else{if(e)for(let e=0;e<i.textures.length;e++)s.clearBufferfv(s.COLOR,e,[a.r,a.g,a.b,a.a]);t&&r?s.clearBufferfi(s.DEPTH_STENCIL,0,1,0):t?s.clearBufferfv(s.DEPTH,0,[1]):r&&s.clearBufferiv(s.STENCIL,0,[0])}}}beginCompute(){console.warn("Abstract class.")}compute(){console.warn("Abstract class.")}finishCompute(){console.warn("Abstract class.")}draw(e,t){let r;let{pipeline:i,material:s,context:n}=e,{programGPU:a,vaoGPU:o}=this.get(i),{gl:l,state:u}=this,d=this.get(n);for(let t of e.getBindings()){let e=this.get(t),r=e.index;t.isUniformsGroup||t.isUniformBuffer?l.bindBufferBase(l.UNIFORM_BUFFER,r,e.bufferGPU):t.isSampledTexture&&(l.activeTexture(l.TEXTURE0+r),l.bindTexture(e.glTextureType,e.textureGPU))}u.setMaterial(s),l.useProgram(a),l.bindVertexArray(o);let c=e.getIndex(),h=e.object,p=e.geometry,g=p.drawRange,m=g.start,f=d.lastOcclusionObject;if(f!==h&&void 0!==f){if(null!==f&&!0===f.occlusionTest&&(l.endQuery(l.ANY_SAMPLES_PASSED),d.occlusionQueryIndex++),!0===h.occlusionTest){let e=l.createQuery();l.beginQuery(l.ANY_SAMPLES_PASSED,e),d.occlusionQueries[d.occlusionQueryIndex]=e,d.occlusionQueryObjects[d.occlusionQueryIndex]=h}d.lastOcclusionObject=h}r=h.isPoints?l.POINTS:h.isLineSegments?l.LINES:h.isLine?l.LINE_STRIP:h.isLineLoop?l.LINE_LOOP:l.TRIANGLES;let T=this.getInstanceCount(e);if(null!==c){let e=this.get(c),i=g.count!==1/0?g.count:c.count;T>1?l.drawElementsInstanced(r,c.count,e.type,m,T):l.drawElements(r,c.count,e.type,m),t.update(h,i,1)}else{let e=p.attributes.position,i=g.count!==1/0?g.count:e.count;T>1?l.drawArraysInstanced(r,0,i,T):l.drawArrays(r,0,i),t.update(h,i,1)}l.bindVertexArray(null)}needsRenderUpdate(e){return!1}getRenderCacheKey(e){return e.id}createSampler(){}createDefaultTexture(e){let{gl:t,textureUtils:r,defaultTextures:i}=this,s=r.getGLTextureType(e),n=i[s];void 0===n&&(n=t.createTexture(),t.bindTexture(s,n),t.texParameteri(s,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(s,t.TEXTURE_MAG_FILTER,t.NEAREST),i[s]=n),this.set(e,{textureGPU:n,glTextureType:s,isDefault:!0})}createTexture(e,t){let{gl:r,utils:i,textureUtils:s}=this,{levels:n,width:a,height:o,depth:l}=t,u=i.convert(e.format,e.colorSpace),d=i.convert(e.type),c=s.getInternalFormat(e.internalFormat,u,d,e.colorSpace,e.isVideoTexture),h=r.createTexture(),p=s.getGLTextureType(e);r.bindTexture(p,h),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,e.flipY),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha),r.pixelStorei(r.UNPACK_ALIGNMENT,e.unpackAlignment),r.pixelStorei(r.UNPACK_COLORSPACE_CONVERSION_WEBGL,r.NONE),s.setTextureParameters(p,e),r.bindTexture(p,h),e.isDataArrayTexture?r.texStorage3D(r.TEXTURE_2D_ARRAY,n,c,a,o,l):e.isVideoTexture||r.texStorage2D(p,n,c,a,o),this.set(e,{textureGPU:h,glTextureType:p,glFormat:u,glType:d,glInternalFormat:c})}updateTexture(e,t){let{gl:r}=this,{width:i,height:s}=t,{textureGPU:n,glTextureType:a,glFormat:o,glType:l,glInternalFormat:u}=this.get(e),d=e=>e.isDataTexture?e.image.data:e instanceof ImageBitmap||e instanceof OffscreenCanvas||e instanceof HTMLImageElement||e instanceof HTMLCanvasElement?e:e.data;if(r.bindTexture(a,n),e.isCubeTexture){let e=t.images;for(let t=0;t<6;t++){let n=d(e[t]);r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,i,s,o,l,n)}}else if(e.isDataArrayTexture){let e=t.image;r.texSubImage3D(r.TEXTURE_2D_ARRAY,0,0,0,0,e.width,e.height,e.depth,o,l,e.data)}else if(e.isVideoTexture)e.update(),r.texImage2D(a,0,u,o,l,t.image);else{let e=d(t.image);r.texSubImage2D(a,0,0,0,i,s,o,l,e)}}generateMipmaps(e){let{gl:t}=this,{textureGPU:r,glTextureType:i}=this.get(e);t.bindTexture(i,r),t.generateMipmap(i)}destroyTexture(e){let{gl:t}=this,{textureGPU:r}=this.get(e);t.deleteTexture(r),this.delete(e)}destroySampler(){}copyTextureToBuffer(e,t,r,i,s){return this.textureUtils.copyTextureToBuffer(e,t,r,i,s)}createNodeBuilder(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new h(e,t,r)}createProgram(e){let t=this.gl,{stage:r,code:i}=e,s="vertex"===r?t.createShader(t.VERTEX_SHADER):t.createShader(t.FRAGMENT_SHADER);t.shaderSource(s,i),t.compileShader(s),this.set(e,{shaderGPU:s})}destroyProgram(){console.warn("Abstract class.")}createRenderPipeline(e){let t=this.gl,r=e.pipeline,{fragmentProgram:i,vertexProgram:s}=r,n=t.createProgram(),a=this.get(i).shaderGPU,o=this.get(s).shaderGPU;for(let r of(t.attachShader(n,a),t.attachShader(n,o),t.linkProgram(n),!1===t.getProgramParameter(n,t.LINK_STATUS)&&(console.error("THREE.WebGLBackend:",t.getProgramInfoLog(n)),console.error("THREE.WebGLBackend:",t.getShaderInfoLog(a)),console.error("THREE.WebGLBackend:",t.getShaderInfoLog(o))),t.useProgram(n),e.getBindings())){let e=this.get(r).index;if(r.isUniformsGroup||r.isUniformBuffer){let i=t.getUniformBlockIndex(n,r.name);t.uniformBlockBinding(n,i,e)}else if(r.isSampledTexture){let i=t.getUniformLocation(n,r.name);t.uniform1i(i,e)}}let l=t.createVertexArray(),u=e.getIndex(),d=e.getAttributes();if(t.bindVertexArray(l),null!==u){let e=this.get(u);t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.bufferGPU)}for(let e=0;e<d.length;e++){let r,i;let s=d[e],n=this.get(s);t.bindBuffer(t.ARRAY_BUFFER,n.bufferGPU),t.enableVertexAttribArray(e),!0===s.isInterleavedBufferAttribute?(r=s.data.stride*n.bytesPerElement,i=s.offset*n.bytesPerElement):(r=0,i=0),n.isInteger?t.vertexAttribIPointer(e,s.itemSize,n.type,r,i):t.vertexAttribPointer(e,s.itemSize,n.type,s.normalized,r,i),s.isInstancedBufferAttribute&&!s.isInterleavedBufferAttribute?t.vertexAttribDivisor(e,s.meshPerAttribute):s.isInterleavedBufferAttribute&&s.data.isInstancedInterleavedBuffer&&t.vertexAttribDivisor(e,s.data.meshPerAttribute)}t.bindVertexArray(null),this.set(r,{programGPU:n,vaoGPU:l})}createComputePipeline(){console.warn("Abstract class.")}createBindings(e){this.updateBindings(e)}updateBindings(e){let{gl:t}=this,r=0,i=0;for(let s of e)if(s.isUniformsGroup||s.isUniformBuffer){let e=t.createBuffer(),i=s.buffer;t.bindBuffer(t.UNIFORM_BUFFER,e),t.bufferData(t.UNIFORM_BUFFER,i,t.DYNAMIC_DRAW),t.bindBufferBase(t.UNIFORM_BUFFER,r,e),this.set(s,{index:r++,bufferGPU:e})}else if(s.isSampledTexture){let{textureGPU:e,glTextureType:t}=this.get(s.texture);this.set(s,{index:i++,textureGPU:e,glTextureType:t})}}updateBinding(e){let t=this.gl;if(e.isUniformsGroup||e.isUniformBuffer){let r=this.get(e).bufferGPU,i=e.buffer;t.bindBuffer(t.UNIFORM_BUFFER,r),t.bufferData(t.UNIFORM_BUFFER,i,t.DYNAMIC_DRAW)}}createIndexAttribute(e){let t=this.gl;this.attributeUtils.createAttribute(e,t.ELEMENT_ARRAY_BUFFER)}createAttribute(e){let t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}createStorageAttribute(){console.warn("Abstract class.")}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(){console.warn("Abstract class.")}updateSize(){}hasFeature(){return!0}getMaxAnisotropy(){return this.capabilities.getMaxAnisotropy()}copyFramebufferToTexture(e,t){let{gl:r}=this,{textureGPU:i}=this.get(e),s=e.image.width,n=e.image.height;if(r.bindFramebuffer(r.READ_FRAMEBUFFER,null),e.isDepthTexture){let e=r.createFramebuffer();r.bindFramebuffer(r.DRAW_FRAMEBUFFER,e),r.framebufferTexture2D(r.DRAW_FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,i,0),r.blitFramebuffer(0,0,s,n,0,0,s,n,r.DEPTH_BUFFER_BIT,r.NEAREST),r.deleteFramebuffer(e)}else r.bindTexture(r.TEXTURE_2D,i),r.copyTexSubImage2D(r.TEXTURE_2D,0,0,0,0,0,s,n),r.bindTexture(r.TEXTURE_2D,null);e.generateMipmaps&&this.generateMipmaps(e),this._setFramebuffer(t)}_setFramebuffer(e){let{gl:t}=this;if(null!==e.textures){let r=this.get(e.renderTarget),i=r.framebuffer;if(void 0===i){i=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,i);let s=e.textures,n=[];for(let e=0;e<s.length;e++){let r=s[e],{textureGPU:i}=this.get(r),a=t.COLOR_ATTACHMENT0+e;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,i,0),n.push(a)}if(t.drawBuffers(n),null!==e.depthTexture){let{textureGPU:r}=this.get(e.depthTexture);t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,r,0)}r.framebuffer=i}else t.bindFramebuffer(t.FRAMEBUFFER,i)}else t.bindFramebuffer(t.FRAMEBUFFER,null)}constructor(e={}){super(e),this.isWebGLBackend=!0}}var E=C},6505:function(e,t,r){r.a(e,async function(e,i){try{var s=r(8667),n=r(8898),a=r(3475),o=r(1901),l=r(9456),u=r(3784),d=r(7540),c=r(1172),h=r(6241);let e=null;void 0!==navigator.gpu&&(e=await navigator.gpu.requestAdapter());class p extends a.Z{async init(e){await super.init(e);let t=this.parameters,r={powerPreference:t.powerPreference},i=await navigator.gpu.requestAdapter(r);if(null===i)throw Error("WebGPUBackend: Unable to create WebGPU adapter.");let n=Object.values(s.qO),a=[];for(let e of n)i.features.has(e)&&a.push(e);let o={requiredFeatures:a,requiredLimits:t.requiredLimits},l=await i.requestDevice(o),u=void 0!==t.context?t.context:e.domElement.getContext("webgpu");this.adapter=i,this.device=l,this.context=u,this.context.configure({device:this.device,format:s.DI.BGRA8Unorm,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:"premultiplied"}),this.updateSize()}get coordinateSystem(){return o.WebGPUCoordinateSystem}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}beginRender(e){let t;let r=this.get(e),i=this.device,n=e.occlusionQueryCount;n>0&&(r.currentOcclusionQuerySet&&r.currentOcclusionQuerySet.destroy(),r.currentOcclusionQueryBuffer&&r.currentOcclusionQueryBuffer.destroy(),r.currentOcclusionQuerySet=r.occlusionQuerySet,r.currentOcclusionQueryBuffer=r.occlusionQueryBuffer,r.currentOcclusionQueryObjects=r.occlusionQueryObjects,t=i.createQuerySet({type:"occlusion",count:n}),r.occlusionQuerySet=t,r.occlusionQueryIndex=0,r.occlusionQueryObjects=Array(n),r.lastOcclusionObject=null);let a={colorAttachments:[{view:null}],depthStencilAttachment:{view:null},occlusionQuerySet:t},l=a.colorAttachments[0],u=a.depthStencilAttachment,d=this.parameters.antialias;if(null!==e.textures){let t=e.textures;a.colorAttachments=[];let r=a.colorAttachments;for(let i=0;i<t.length;i++){let n,a;let o=this.get(t[i]),l=o.texture.createView({baseMipLevel:e.activeMipmapLevel,mipLevelCount:1,baseArrayLayer:e.activeCubeFace,dimension:s.ID.TwoD});void 0!==o.msaaTexture?(n=o.msaaTexture.createView(),a=l):(n=l,a=void 0),r.push({view:n,resolveTarget:a,loadOp:s.Tw.Load,storeOp:s.Zb.Store})}let i=this.get(e.depthTexture);u.view=i.texture.createView(),e.stencil&&e.depthTexture.format===o.DepthFormat&&(e.stencil=!1)}else!0===d?(l.view=this.colorBuffer.createView(),l.resolveTarget=this.context.getCurrentTexture().createView()):(l.view=this.context.getCurrentTexture().createView(),l.resolveTarget=void 0),u.view=this.textureUtils.getDepthBuffer(e.depth,e.stencil).createView();if(null!==e.textures){let t=a.colorAttachments;for(let r=0;r<t.length;r++){let i=t[r];e.clearColor?(i.clearValue=e.clearColorValue,i.loadOp=s.Tw.Clear):i.loadOp=s.Tw.Load,i.storeOp=s.Zb.Store}}else e.clearColor?(l.clearValue=e.clearColorValue,l.loadOp=s.Tw.Clear):l.loadOp=s.Tw.Load,l.storeOp=s.Zb.Store;e.depth&&(e.clearDepth?(u.depthClearValue=e.clearDepthValue,u.depthLoadOp=s.Tw.Clear):u.depthLoadOp=s.Tw.Load,u.depthStoreOp=s.Zb.Store),e.stencil&&(e.clearStencil?(u.stencilClearValue=e.clearStencilValue,u.stencilLoadOp=s.Tw.Clear):u.stencilLoadOp=s.Tw.Load,u.stencilStoreOp=s.Zb.Store);let c=i.createCommandEncoder({label:"renderContext_"+e.id}),h=c.beginRenderPass(a);if(r.descriptor=a,r.encoder=c,r.currentPass=h,r.currentSets={attributes:{}},e.viewport&&this.updateViewport(e),e.scissor){let{x:t,y:r,width:i,height:s}=e.scissorValue;h.setScissorRect(t,e.height-s-r,i,s)}}finishRender(e){let t=this.get(e),r=e.occlusionQueryCount;if(r>t.occlusionQueryIndex&&t.currentPass.endOcclusionQuery(),t.currentPass.end(),r>0){let i=8*r,s=this.occludedResolveCache.get(i);void 0===s&&(s=this.device.createBuffer({size:i,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.occludedResolveCache.set(i,s));let n=this.device.createBuffer({size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});t.encoder.resolveQuerySet(t.occlusionQuerySet,0,r,s,0),t.encoder.copyBufferToBuffer(s,0,n,0,i),t.occlusionQueryBuffer=n,this.resolveOccludedAsync(e)}if(this.device.queue.submit([t.encoder.finish()]),null!==e.textures){let t=e.textures;for(let e=0;e<t.length;e++){let r=t[e];!0===r.generateMipmaps&&this.textureUtils.generateMipmaps(r)}}}isOccluded(e,t){let r=this.get(e);return r.occluded&&r.occluded.has(t)}async resolveOccludedAsync(e){let t=this.get(e),{currentOcclusionQueryBuffer:r,currentOcclusionQueryObjects:i}=t;if(r&&i){let e=new WeakSet;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueryBuffer=null,await r.mapAsync(GPUMapMode.READ);let s=r.getMappedRange(),n=new BigUint64Array(s);for(let t=0;t<i.length;t++)0n!==n[t]&&e.add(i[t]);r.destroy(),t.occluded=e}}updateViewport(e){let{currentPass:t}=this.get(e),{x:r,y:i,width:s,height:n,minDepth:a,maxDepth:o}=e.viewportValue;t.setViewport(r,e.height-n-i,s,n,a,o)}clear(e,t,r){let i,n,a,o,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,u=this.device,d=this.renderer,c=[];if(e){let e=this.getClearColor();n={r:e.r,g:e.g,b:e.b,a:e.a}}if(null===l){if(a=d.depth,o=d.stencil,t=t&&a,r=r&&o,e){let e=this.parameters.antialias,t={};!0===e?(t.view=this.colorBuffer.createView(),t.resolveTarget=this.context.getCurrentTexture().createView()):t.view=this.context.getCurrentTexture().createView(),t.clearValue=n,t.loadOp=s.Tw.Clear,t.storeOp=s.Zb.Store,c.push(t)}(t||r)&&(i={view:this.textureUtils.getDepthBuffer(d.depth,d.stencil).createView()})}else{if(a=l.depth,o=l.stencil,t=t&&a,r=r&&o,e)for(let e of l.textures){let t,r;let i=this.get(e),a=i.texture.createView();void 0!==i.msaaTexture?(t=i.msaaTexture.createView(),r=a):(t=a,r=void 0),c.push({view:t,resolveTarget:r,clearValue:n,loadOp:s.Tw.Clear,storeOp:s.Zb.Store})}(t||r)&&(i={view:this.get(l.depthTexture).texture.createView()})}void 0!==i&&(t?(i.depthLoadOp=s.Tw.Clear,i.depthClearValue=d.getClearDepth()):i.depthLoadOp=s.Tw.Load,i.depthStoreOp=s.Zb.Store,r?(i.stencilLoadOp=s.Tw.Clear,i.stencilClearValue=d.getClearStencil()):i.stencilLoadOp=s.Tw.Load,i.stencilStoreOp=s.Zb.Store);let h=u.createCommandEncoder({});h.beginRenderPass({colorAttachments:c,depthStencilAttachment:i}).end(),u.queue.submit([h.finish()])}beginCompute(e){let t=this.get(e);t.cmdEncoderGPU=this.device.createCommandEncoder({}),t.passEncoderGPU=t.cmdEncoderGPU.beginComputePass()}compute(e,t,r,i){let{passEncoderGPU:s}=this.get(e),n=this.get(i).pipeline;s.setPipeline(n);let a=this.get(r).group;s.setBindGroup(0,a),s.dispatchWorkgroups(t.dispatchCount)}finishCompute(e){let t=this.get(e);t.passEncoderGPU.end(),this.device.queue.submit([t.cmdEncoderGPU.finish()])}draw(e,t){let{object:r,geometry:i,context:n,pipeline:a}=e,o=this.get(e.getBindings()),l=this.get(n),u=this.get(a).pipeline,d=l.currentSets,c=l.currentPass;d.pipeline!==u&&(c.setPipeline(u),d.pipeline=u);let h=o.group;c.setBindGroup(0,h);let p=e.getIndex(),g=null!==p;if(!0===g&&d.index!==p){let e=this.get(p).buffer,t=p.array instanceof Uint16Array?s.fG.Uint16:s.fG.Uint32;c.setIndexBuffer(e,t),d.index=p}let m=e.getVertexBuffers();for(let e=0,t=m.length;e<t;e++){let t=m[e];if(d.attributes[e]!==t){let r=this.get(t).buffer;c.setVertexBuffer(e,r),d.attributes[e]=t}}if(void 0!==l.occlusionQuerySet){let e=l.lastOcclusionObject;e!==r&&(null!==e&&!0===e.occlusionTest&&(c.endOcclusionQuery(),l.occlusionQueryIndex++),!0===r.occlusionTest&&(c.beginOcclusionQuery(l.occlusionQueryIndex),l.occlusionQueryObjects[l.occlusionQueryIndex]=r),l.lastOcclusionObject=r)}let f=i.drawRange,T=f.start,y=this.getInstanceCount(e);if(0!==y){if(!0===g){let e=f.count!==1/0?f.count:p.count;c.drawIndexed(e,y,T,0,0),t.update(r,e,y)}else{let e=i.attributes.position,s=f.count!==1/0?f.count:e.count;c.draw(s,y,T,0),t.update(r,s,y)}}}needsRenderUpdate(e){let t=this.get(e),{object:r,material:i}=e,s=this.utils,n=s.getSampleCount(e.context),a=s.getCurrentColorSpace(e.context),o=s.getCurrentColorFormat(e.context),l=s.getCurrentDepthStencilFormat(e.context),u=s.getPrimitiveTopology(r,i),d=!1;return(t.material!==i||t.materialVersion!==i.version||t.transparent!==i.transparent||t.blending!==i.blending||t.premultipliedAlpha!==i.premultipliedAlpha||t.blendSrc!==i.blendSrc||t.blendDst!==i.blendDst||t.blendEquation!==i.blendEquation||t.blendSrcAlpha!==i.blendSrcAlpha||t.blendDstAlpha!==i.blendDstAlpha||t.blendEquationAlpha!==i.blendEquationAlpha||t.colorWrite!==i.colorWrite||t.depthWrite!==i.depthWrite||t.depthTest!==i.depthTest||t.depthFunc!==i.depthFunc||t.stencilWrite!==i.stencilWrite||t.stencilFunc!==i.stencilFunc||t.stencilFail!==i.stencilFail||t.stencilZFail!==i.stencilZFail||t.stencilZPass!==i.stencilZPass||t.stencilFuncMask!==i.stencilFuncMask||t.stencilWriteMask!==i.stencilWriteMask||t.side!==i.side||t.alphaToCoverage!==i.alphaToCoverage||t.sampleCount!==n||t.colorSpace!==a||t.colorFormat!==o||t.depthStencilFormat!==l||t.primitiveTopology!==u)&&(t.material=i,t.materialVersion=i.version,t.transparent=i.transparent,t.blending=i.blending,t.premultipliedAlpha=i.premultipliedAlpha,t.blendSrc=i.blendSrc,t.blendDst=i.blendDst,t.blendEquation=i.blendEquation,t.blendSrcAlpha=i.blendSrcAlpha,t.blendDstAlpha=i.blendDstAlpha,t.blendEquationAlpha=i.blendEquationAlpha,t.colorWrite=i.colorWrite,t.depthWrite=i.depthWrite,t.depthTest=i.depthTest,t.depthFunc=i.depthFunc,t.stencilWrite=i.stencilWrite,t.stencilFunc=i.stencilFunc,t.stencilFail=i.stencilFail,t.stencilZFail=i.stencilZFail,t.stencilZPass=i.stencilZPass,t.stencilFuncMask=i.stencilFuncMask,t.stencilWriteMask=i.stencilWriteMask,t.side=i.side,t.alphaToCoverage=i.alphaToCoverage,t.sampleCount=n,t.colorSpace=a,t.colorFormat=o,t.depthStencilFormat=l,t.primitiveTopology=u,d=!0),d}getRenderCacheKey(e){let{object:t,material:r}=e,i=this.utils,s=e.context;return[r.transparent,r.blending,r.premultipliedAlpha,r.blendSrc,r.blendDst,r.blendEquation,r.blendSrcAlpha,r.blendDstAlpha,r.blendEquationAlpha,r.colorWrite,r.depthWrite,r.depthTest,r.depthFunc,r.stencilWrite,r.stencilFunc,r.stencilFail,r.stencilZFail,r.stencilZPass,r.stencilFuncMask,r.stencilWriteMask,r.side,i.getSampleCount(s),i.getCurrentColorSpace(s),i.getCurrentColorFormat(s),i.getCurrentDepthStencilFormat(s),i.getPrimitiveTopology(t,r)].join()}createSampler(e){this.textureUtils.createSampler(e)}destroySampler(e){this.textureUtils.destroySampler(e)}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}copyTextureToBuffer(e,t,r,i,s){return this.textureUtils.copyTextureToBuffer(e,t,r,i,s)}createNodeBuilder(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new n.Z(e,t,r)}createProgram(e){this.get(e).module={module:this.device.createShaderModule({code:e.code,label:e.stage}),entryPoint:"main"}}destroyProgram(e){this.delete(e)}createRenderPipeline(e){this.pipelineUtils.createRenderPipeline(e)}createComputePipeline(e,t){this.pipelineUtils.createComputePipeline(e,t)}createBindings(e){this.bindingUtils.createBindings(e)}updateBindings(e){this.bindingUtils.createBindings(e)}updateBinding(e){this.bindingUtils.updateBinding(e)}createIndexAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.INDEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}updateSize(){this.colorBuffer=this.textureUtils.getColorBuffer()}getMaxAnisotropy(){return 16}hasFeature(t){let r=this.adapter||e,i=Object.values(s.qO);if(!1===i.includes(t))throw Error("THREE.WebGPURenderer: Unknown WebGPU GPU feature: "+t);return r.features.has(t)}copyFramebufferToTexture(e,t){let r=this.get(t),{encoder:i,descriptor:n}=r,a=null;e.isFramebufferTexture?a=this.context.getCurrentTexture():e.isDepthTexture&&(a=this.textureUtils.getDepthBuffer(t.depth,t.stencil));let o=this.get(e).texture;r.currentPass.end(),i.copyTextureToTexture({texture:a,origin:{x:0,y:0,z:0}},{texture:o},[e.image.width,e.image.height]),e.generateMipmaps&&this.textureUtils.generateMipmaps(e),n.colorAttachments[0].loadOp=s.Tw.Load,t.depth&&(n.depthStencilAttachment.depthLoadOp=s.Tw.Load),t.stencil&&(n.depthStencilAttachment.stencilLoadOp=s.Tw.Load),r.currentPass=i.beginRenderPass(n),r.currentSets={attributes:{}}}constructor(e={}){super(e),this.isWebGPUBackend=!0,this.parameters.antialias=!0===e.antialias,!0===this.parameters.antialias?this.parameters.sampleCount=void 0===e.sampleCount?4:e.sampleCount:this.parameters.sampleCount=1,this.parameters.requiredLimits=void 0===e.requiredLimits?{}:e.requiredLimits,this.adapter=null,this.device=null,this.context=null,this.colorBuffer=null,this.utils=new l.Z(this),this.attributeUtils=new u.Z(this),this.bindingUtils=new d.Z(this),this.pipelineUtils=new c.Z(this),this.textureUtils=new h.Z(this),this.occludedResolveCache=new Map}}t.Z=p,i()}catch(e){i(e)}},1)},418:function(e,t,r){r.a(e,async function(e,i){try{r.r(t);var s=r(4010),n=r(4358),a=r(6505),o=r(8328),l=e([o,a]);[o,a]=l.then?(await l)():l;class u extends s.Z{constructor(e={}){let t;o.Z.isAvailable()?t=a.Z:(t=n.Z,console.warn("THREE.WebGPURenderer: WebGPU is not available, running under WebGL2 backend.")),super(new t(e),e),this.isWebGPURenderer=!0}}t.default=u,i()}catch(e){i(e)}})},8898:function(e,t,r){r.d(t,{Z:function(){return M}});var i=r(1901),s=r(9567),n=r(2578);class a extends n.Z{constructor(e,t){super(e),this.texture=t,this.version=t?t.version:0,this.isSampler=!0}}var o=a;class l extends o{constructor(e,t){super(e,t?t.value:null),this.textureNode=t}}var u=r(178),d=r(6183),c=r(4324);class h extends c.Z{constructor(e,t){super(e,t?t.array:null),this.attribute=t,this.isStorageBuffer=!0}}var p=r(5584),g=r(3200),m=r(6241),f=r(3858),T=r(1812),y=r(134);let x=/^[fn]*\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)\s*[\-\>]*\s*([a-z_0-9]+)?/i,b=/[a-z_0-9]+|<(.*?)>+/ig,S={f32:"float"},N=e=>{let t=(e=e.trim()).match(x);if(null!==t&&4===t.length){let r=t[2],i=[],s=null;for(;null!==(s=b.exec(r));)i.push(s);let n=[],a=0;for(;a<i.length;){let e=i[a++][0],t=i[a++][0];t=S[t]||t,a<i.length&&!0===i[a][0].startsWith("<")&&a++,n.push(new y.Z(t,e))}let o=e.substring(t[0].length),l=void 0!==t[1]?t[1]:"";return{type:t[3]||"void",inputs:n,name:l,inputsCode:r,blockCode:o}}throw Error("FunctionNode: Function is not a WGSL code.")};class _ extends T.Z{getCode(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.name,t="void"!==this.type?"-> "+this.type:"";return"fn ".concat(e," ( ").concat(this.inputsCode.trim()," ) ").concat(t)+this.blockCode}constructor(e){let{type:t,inputs:r,name:i,inputsCode:s,blockCode:n}=N(e);super(t,r,i),this.inputsCode=s,this.blockCode=n}}class v extends f.Z{parseFunction(e){return new _(e)}}let A={vertex:GPUShaderStage.VERTEX,fragment:GPUShaderStage.FRAGMENT,compute:GPUShaderStage.COMPUTE},R={instance:!0},C={"^^":"threejs_xor"},E={float:"f32",int:"i32",uint:"u32",bool:"bool",color:"vec3<f32>",vec2:"vec2<f32>",ivec2:"vec2<i32>",uvec2:"vec2<u32>",bvec2:"vec2<bool>",vec3:"vec3<f32>",ivec3:"vec3<i32>",uvec3:"vec3<u32>",bvec3:"vec3<bool>",vec4:"vec4<f32>",ivec4:"vec4<i32>",uvec4:"vec4<u32>",bvec4:"vec4<bool>",mat3:"mat3x3<f32>",imat3:"mat3x3<i32>",umat3:"mat3x3<u32>",bmat3:"mat3x3<bool>",mat4:"mat4x4<f32>",imat4:"mat4x4<i32>",umat4:"mat4x4<u32>",bmat4:"mat4x4<bool>"},B={dFdx:"dpdx",dFdy:"- dpdy",mod:"threejs_mod",lessThanEqual:"threejs_lessThanEqual",greaterThan:"threejs_greaterThan",inversesqrt:"inverseSqrt",bitcast:"bitcast<f32>"},F={threejs_xor:new g.wg("\nfn threejs_xor( a : bool, b : bool ) -> bool {\n\n	return ( a || b ) && !( a && b );\n\n}\n"),lessThanEqual:new g.wg("\nfn threejs_lessThanEqual( a : vec3<f32>, b : vec3<f32> ) -> vec3<bool> {\n\n	return vec3<bool>( a.x <= b.x, a.y <= b.y, a.z <= b.z );\n\n}\n"),greaterThan:new g.wg("\nfn threejs_greaterThan( a : vec3<f32>, b : vec3<f32> ) -> vec3<bool> {\n\n	return vec3<bool>( a.x > b.x, a.y > b.y, a.z > b.z );\n\n}\n"),mod:new g.wg("\nfn threejs_mod( x : f32, y : f32 ) -> f32 {\n\n	return x - y * floor( x / y );\n\n}\n"),repeatWrapping:new g.wg("\nfn threejs_repeatWrapping( uv : vec2<f32>, dimension : vec2<u32> ) -> vec2<u32> {\n\n	let uvScaled = vec2<u32>( uv * vec2<f32>( dimension ) );\n\n	return ( ( uvScaled % dimension ) + dimension ) % dimension;\n\n}\n")};class w extends g._XU{build(){let{object:e,material:t}=this;return null!==t?g.Oie.fromMaterial(t).build(this):this.addFlow("compute",e),super.build()}needsColorSpaceToLinear(e){return!0===e.isVideoTexture&&e.colorSpace!==i.NoColorSpace}_generateTextureSample(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.shaderStage;return"fragment"!==s?this.generateTextureLod(e,t,r):i?"textureSample( ".concat(t,", ").concat(t,"_sampler, ").concat(r,", ").concat(i," )"):"textureSample( ".concat(t,", ").concat(t,"_sampler, ").concat(r," )")}_generateVideoSample(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.shaderStage;if("fragment"===r)return"textureSampleBaseClampToEdge( ".concat(e,", ").concat(e,"_sampler, vec2<f32>( ").concat(t,".x, 1.0 - ").concat(t,".y ) )");console.error("WebGPURenderer: THREE.VideoTexture does not support ".concat(r," shader."))}_generateTextureSampleLevel(e,t,r,i,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.shaderStage;return"fragment"===n&&!1===this.isUnfilterable(e)?"textureSampleLevel( ".concat(t,", ").concat(t,"_sampler, ").concat(r,", ").concat(i," )"):this.generateTextureLod(e,t,r,i)}generateTextureLod(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"0";return this._include("repeatWrapping"),"textureLoad( ".concat(t,", threejs_repeatWrapping( ").concat(r,", ").concat("textureDimensions( ".concat(t,", 0 )")," ), i32( ").concat(i," ) )")}generateTextureLoad(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"0u";return i?"textureLoad( ".concat(t,", ").concat(r,", ").concat(i,", ").concat(s," )"):"textureLoad( ".concat(t,", ").concat(r,", ").concat(s," )")}isUnfilterable(e){return!0===e.isDataTexture&&e.type===i.FloatType}generateTexture(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:this.shaderStage;return!0===e.isVideoTexture?this._generateVideoSample(t,r,s):this.isUnfilterable(e)?this.generateTextureLod(e,t,r,"0",i,s):this._generateTextureSample(e,t,r,i,s)}generateTextureCompare(e,t,r,i,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.shaderStage;if("fragment"===n)return"textureSampleCompare( ".concat(t,", ").concat(t,"_sampler, ").concat(r,", ").concat(i," )");console.error("WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ".concat(n," shader."))}generateTextureLevel(e,t,r,i,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.shaderStage;return!0===e.isVideoTexture?this._generateVideoSample(t,r,n):this._generateTextureSampleLevel(e,t,r,i,s,n)}getPropertyName(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.shaderStage;if(!0===e.isNodeVarying&&!0===e.needsInterpolation){if("vertex"===t)return"varyings.".concat(e.name)}else if(!0===e.isNodeUniform){let t=e.name,r=e.type;return"texture"===r||"cubeTexture"===r?t:"buffer"===r||"storageBuffer"===r?"NodeBuffer_".concat(e.id,".").concat(t):e.groupNode.name+"."+t}return super.getPropertyName(e)}_getUniformGroupCount(e){return Object.keys(this.uniforms[e]).length}getFunctionOperator(e){let t=C[e];return void 0!==t?(this._include(t),t):null}getUniformFromNode(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=super.getUniformFromNode(e,t,r,i),a=this.getDataFromNode(e,r,this.globalCache);if(void 0===a.uniformGPU){let i;let o=this.bindings[r];if("texture"===t||"cubeTexture"===t){let s=null;if("texture"===t?s=new u.m(n.name,n.node):"cubeTexture"===t&&(s=new u.j(n.name,n.node)),s.store=!0===e.isStoreTextureNode,s.setVisibility(A[r]),"fragment"===r&&!1===this.isUnfilterable(e.value)&&!1===s.store){let e=new l("".concat(n.name,"_sampler"),n.node);e.setVisibility(A[r]),o.push(e,s),i=[e,s]}else o.push(s),i=[s]}else if("buffer"===t||"storageBuffer"===t){let s=new("storageBuffer"===t?h:d.Z)("NodeBuffer_"+e.id,e.value);s.setVisibility(A[r]),o.push(s),i=s}else{let a=e.groupNode,l=a.name,u=this.uniformGroups[r]||(this.uniformGroups[r]={}),d=u[l];if(void 0===d&&((d=new s.Z(l,a)).setVisibility(A[r]),u[l]=d,o.push(d)),!0===e.isArrayUniformNode)for(let r of(i=[],e.nodes)){let e=this.getNodeUniform(r,t);e.boundary=(0,p.VL)(e.itemSize),e.itemSize=(0,p.bW)(e.itemSize),d.addUniform(e),i.push(e)}else i=this.getNodeUniform(n,t),d.addUniform(i)}a.uniformGPU=i,"vertex"===r&&(this.bindingsOffset.fragment=o.length)}return n}isReference(e){return super.isReference(e)||"texture_2d"===e||"texture_cube"===e||"texture_depth_2d"===e||"texture_storage_2d"===e}getBuiltin(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this.shaderStage,s=this.builtins[i]||(this.builtins[i]=new Map);return!1===s.has(e)&&s.set(e,{name:e,property:t,type:r}),t}getVertexIndex(){return"vertex"===this.shaderStage?this.getBuiltin("vertex_index","vertexIndex","u32","attribute"):"vertexIndex"}buildFunctionCode(e){let t=e.layout,r=this.flowShaderNode(e),i=[];for(let e of t.inputs)i.push(e.name+" : "+this.getType(e.type));return"fn ".concat(t.name,"( ").concat(i.join(", ")," ) -> ").concat(this.getType(t.type)," {\n").concat(r.vars,"\n").concat(r.code,"\n	return ").concat(r.result,";\n\n}")}getInstanceIndex(){return"vertex"===this.shaderStage?this.getBuiltin("instance_index","instanceIndex","u32","attribute"):"instanceIndex"}getFrontFacing(){return this.getBuiltin("front_facing","isFront","bool")}getFragCoord(){return this.getBuiltin("position","fragCoord","vec4<f32>")+".xy"}getFragDepth(){return"output."+this.getBuiltin("frag_depth","depth","f32","output")}isFlipY(){return!1}getBuiltins(e){let t=[],r=this.builtins[e];if(void 0!==r)for(let{name:e,property:i,type:s}of r.values())t.push("@builtin( ".concat(e," ) ").concat(i," : ").concat(s));return t.join(",\n	")}getAttributes(e){let t=[];if("compute"===e&&this.getBuiltin("global_invocation_id","id","vec3<u32>","attribute"),"vertex"===e||"compute"===e){let e=this.getBuiltins("attribute");e&&t.push(e);let r=this.getAttributesArray();for(let e=0,i=r.length;e<i;e++){let i=r[e],s=i.name,n=this.getType(i.type);t.push("@location( ".concat(e," ) ").concat(s," : ").concat(n))}}return t.join(",\n	")}getStructMembers(e){let t=[],r=e.getMemberTypes();for(let e=0;e<r.length;e++){let i=r[e];t.push("	@location( ".concat(e," ) m").concat(e," : ").concat(i,"<f32>"))}return t.join(",\n")}getStructs(e){let t=[],r=this.structs[e];for(let e=0,i=r.length;e<i;e++){let i=r[e],s=i.name,n="struct ".concat(s," {\n");n+=this.getStructMembers(i)+"\n}",t.push(n)}return t.join("\n\n")}getVar(e,t){return"var ".concat(t," : ").concat(this.getType(e))}getVars(e){let t=[],r=this.vars[e];if(void 0!==r)for(let e of r)t.push("	".concat(this.getVar(e.type,e.name),";"));return"\n".concat(t.join("\n"),"\n")}getVaryings(e){let t=[];if("vertex"===e&&this.getBuiltin("position","Vertex","vec4<f32>","vertex"),"vertex"===e||"fragment"===e){let r=this.varyings,i=this.vars[e];for(let s=0;s<r.length;s++){let n=r[s];if(n.needsInterpolation){let e="@location( ".concat(s," )");/^(int|uint|ivec|uvec)/.test(n.type)&&(e+=" @interpolate( flat )"),t.push("".concat(e," ").concat(n.name," : ").concat(this.getType(n.type)))}else"vertex"===e&&!1===i.includes(n)&&i.push(n)}}let r=this.getBuiltins(e);r&&t.push(r);let i=t.join(",\n	");return"vertex"===e?this._getWGSLStruct("VaryingsStruct","	"+i):i}getUniforms(e){let t=this.uniforms[e],r=[],i=[],s=[],n={},a=this.bindingsOffset[e];for(let s of t)if("texture"===s.type||"cubeTexture"===s.type){let t;let i=s.node.value;"fragment"===e&&!1===this.isUnfilterable(i)&&!0!==s.node.isStoreTextureNode&&(!0===i.isDepthTexture&&null!==i.compareFunction?r.push("@binding( ".concat(a++," ) @group( 0 ) var ").concat(s.name,"_sampler : sampler_comparison;")):r.push("@binding( ".concat(a++," ) @group( 0 ) var ").concat(s.name,"_sampler : sampler;"))),t=!0===i.isCubeTexture?"texture_cube<f32>":!0===i.isDataArrayTexture?"texture_2d_array<f32>":!0===i.isDepthTexture?"texture_depth_2d":!0===i.isVideoTexture?"texture_external":!0===s.node.isStoreTextureNode?"texture_storage_2d<"+(0,m.y)(i)+", write>":"texture_2d<f32>",r.push("@binding( ".concat(a++," ) @group( 0 ) var ").concat(s.name," : ").concat(t,";"))}else if("buffer"===s.type||"storageBuffer"===s.type){let e=s.node,t=this.getType(e.bufferType),r=e.bufferCount,n=r>0?", "+r:"",o="	".concat(s.name," : array< ").concat(t).concat(n," >\n"),l=e.isStorageBufferNode?"storage,read_write":"uniform";i.push(this._getWGSLStructBinding("NodeBuffer_"+e.id,o,l,a++))}else{let e=this.getType(this.getVectorType(s.type)),t=s.groupNode.name,r=n[t]||(n[t]={index:a++,snippets:[]});if(!0===Array.isArray(s.value)){let t=s.value.length;r.snippets.push("uniform ".concat(e,"[ ").concat(t," ] ").concat(s.name))}else r.snippets.push("	".concat(s.name," : ").concat(e))}for(let e in n){let t=n[e];s.push(this._getWGSLStructBinding(e,t.snippets.join(",\n"),"uniform",t.index))}return r.join("\n")+(i.join("\n")+s.join("\n"))}buildCode(){let e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};for(let t in e){let r=e[t];r.uniforms=this.getUniforms(t),r.attributes=this.getAttributes(t),r.varyings=this.getVaryings(t),r.structs=this.getStructs(t),r.vars=this.getVars(t),r.codes=this.getCodes(t);let i="// code\n\n";i+=this.flowCode[t];let s=this.flowNodes[t],n=s[s.length-1],a=n.outputNode,o=void 0!==a&&!0===a.isOutputStructNode;for(let e of s){let s=this.getFlowData(e),l=e.name;if(l&&(i.length>0&&(i+="\n"),i+="	// flow -> ".concat(l,"\n	")),i+="".concat(s.code,"\n	"),e===n&&"compute"!==t){if(i+="// result\n\n	","vertex"===t)i+="varyings.Vertex = ".concat(s.result,";");else if("fragment"===t){if(o)r.returnType=a.nodeType,i+="return ".concat(s.result,";");else{let e="	@location(0) color: vec4<f32>",t=this.getBuiltins("output");t&&(e+=",\n	"+t),r.returnType="OutputStruct",r.structs+=this._getWGSLStruct("OutputStruct",e),r.structs+="\nvar<private> output : OutputStruct;\n\n",i+="output.color = ".concat(s.result,";\n\n	return output;")}}}}r.flow=i}null!==this.material?(this.vertexShader=this._getWGSLVertexCode(e.vertex),this.fragmentShader=this._getWGSLFragmentCode(e.fragment)):this.computeShader=this._getWGSLComputeCode(e.compute,(this.object.workgroupSize||[64]).join(", "))}getMethod(e){return void 0!==F[e]&&this._include(e),B[e]||e}getType(e){return E[e]||e}isAvailable(e){return!0===R[e]}_include(e){let t=F[e];return t.build(this),null!==this.currentFunctionNode&&this.currentFunctionNode.includes.push(t),t}_getWGSLVertexCode(e){return"".concat(this.getSignature(),"\n\n// uniforms\n").concat(e.uniforms,"\n\n// varyings\n").concat(e.varyings,"\nvar<private> varyings : VaryingsStruct;\n\n// codes\n").concat(e.codes,"\n\n@vertex\nfn main( ").concat(e.attributes," ) -> VaryingsStruct {\n\n	// vars\n	").concat(e.vars,"\n\n	// flow\n	").concat(e.flow,"\n\n	return varyings;\n\n}\n")}_getWGSLFragmentCode(e){return"".concat(this.getSignature(),"\n\n// uniforms\n").concat(e.uniforms,"\n\n// structs\n").concat(e.structs,"\n\n// codes\n").concat(e.codes,"\n\n@fragment\nfn main( ").concat(e.varyings," ) -> ").concat(e.returnType," {\n\n	// vars\n	").concat(e.vars,"\n\n	// flow\n	").concat(e.flow,"\n\n}\n")}_getWGSLComputeCode(e,t){return"".concat(this.getSignature(),"\n// system\nvar<private> instanceIndex : u32;\n\n// uniforms\n").concat(e.uniforms,"\n\n// codes\n").concat(e.codes,"\n\n@compute @workgroup_size( ").concat(t," )\nfn main( ").concat(e.attributes," ) {\n\n	// system\n	instanceIndex = id.x;\n\n	// vars\n	").concat(e.vars,"\n\n	// flow\n	").concat(e.flow,"\n\n}\n")}_getWGSLStruct(e,t){return"\nstruct ".concat(e," {\n").concat(t,"\n};")}_getWGSLStructBinding(e,t,r){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,n=e+"Struct",a=this._getWGSLStruct(n,t);return"".concat(a,"\n@binding( ").concat(i," ) @group( ").concat(s," )\nvar<").concat(r,"> ").concat(e," : ").concat(n,";")}constructor(e,t,r=null){super(e,t,new v,r),this.uniformGroups={},this.builtins={}}}var M=w},3784:function(e,t,r){var i=r(1901),s=r(8667);let n=new Map([[Int8Array,["sint8","snorm8"]],[Uint8Array,["uint8","unorm8"]],[Int16Array,["sint16","snorm16"]],[Uint16Array,["uint16","unorm16"]],[Int32Array,["sint32","snorm32"]],[Uint32Array,["uint32","unorm32"]],[Float32Array,["float32"]]]),a=new Map([[i.Float16BufferAttribute,["float16"]]]),o=new Map([[Int32Array,"sint32"],[Uint32Array,"uint32"],[Float32Array,"float32"]]);class l{createAttribute(e,t){let r=this._getBufferAttribute(e),i=this.backend,s=i.get(r),n=s.buffer;if(void 0===n){let e=i.device,a=r.array,o=a.byteLength+(4-a.byteLength%4)%4;n=e.createBuffer({label:r.name,size:o,usage:t,mappedAtCreation:!0}),new a.constructor(n.getMappedRange()).set(a),n.unmap(),s.buffer=n}}updateAttribute(e){let t=this._getBufferAttribute(e),r=this.backend,i=r.device,s=r.get(t).buffer,n=t.array,a=t.updateRanges;if(0===a.length)i.queue.writeBuffer(s,0,n,0);else{for(let e=0,t=a.length;e<t;e++){let t=a[e];i.queue.writeBuffer(s,0,n,t.start*n.BYTES_PER_ELEMENT,t.count*n.BYTES_PER_ELEMENT)}t.clearUpdateRanges()}}createShaderVertexBuffers(e){let t=e.getAttributes(),r=new Map;for(let e=0;e<t.length;e++){let i=t[e],n=i.array.BYTES_PER_ELEMENT,a=this._getBufferAttribute(i),o=r.get(a);if(void 0===o){let e,t;!0===i.isInterleavedBufferAttribute?(e=i.data.stride*n,t=i.data.isInstancedInterleavedBuffer?s.yn.Instance:s.yn.Vertex):(e=i.itemSize*n,t=i.isInstancedBufferAttribute?s.yn.Instance:s.yn.Vertex),o={arrayStride:e,attributes:[],stepMode:t},r.set(a,o)}let l=this._getVertexFormat(i),u=!0===i.isInterleavedBufferAttribute?i.offset*n:0;o.attributes.push({shaderLocation:e,offset:u,format:l})}return Array.from(r.values())}destroyAttribute(e){let t=this.backend;t.get(this._getBufferAttribute(e)).buffer.destroy(),t.delete(e)}async getArrayBufferAsync(e){let t=this.backend,r=t.device,i=t.get(this._getBufferAttribute(e)),s=i.buffer,n=s.size,a=i.readBuffer,o=!0;void 0===a&&(a=r.createBuffer({label:e.name,size:n,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),o=!1,i.readBuffer=a);let l=r.createCommandEncoder({});l.copyBufferToBuffer(s,0,a,0,n),o&&a.unmap();let u=l.finish();return r.queue.submit([u]),await a.mapAsync(GPUMapMode.READ),a.getMappedRange()}_getVertexFormat(e){let t;let{itemSize:r,normalized:i}=e,s=e.array.constructor,l=e.constructor;if(1==r)t=o.get(s);else{let e=(a.get(l)||n.get(s))[i?1:0];if(e){let i=4*Math.floor((s.BYTES_PER_ELEMENT*r+3)/4)/s.BYTES_PER_ELEMENT;if(i%1)throw Error("THREE.WebGPUAttributeUtils: Bad vertex format item size.");t="".concat(e,"x").concat(i)}}return t||console.error("THREE.WebGPUAttributeUtils: Vertex format not supported yet."),t}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}constructor(e){this.backend=e}}t.Z=l},7540:function(e,t,r){var i=r(8667),s=r(1901);class n{createBindingsLayout(e){let t=this.backend.device,r=[],n=0;for(let t of e){let e={binding:n++,visibility:t.visibility};if(t.isUniformBuffer||t.isStorageBuffer){let r={};t.isStorageBuffer&&(r.type=i.Lp.Storage),e.buffer=r}else if(t.isSampler){let r={};t.texture.isDepthTexture&&null!==t.texture.compareFunction&&(r.type="comparison"),e.sampler=r}else if(t.isSampledTexture&&t.texture.isVideoTexture)e.externalTexture={};else if(t.isSampledTexture&&t.store){let r=this.backend.get(t.texture).texture.format;e.storageTexture={format:r}}else if(t.isSampledTexture){let r={};t.texture.isDepthTexture?r.sampleType=i.Bb.Depth:t.texture.isDataTexture&&t.texture.type===s.FloatType&&(r.sampleType=i.Bb.UnfilterableFloat),t.isSampledCubeTexture?r.viewDimension=i.ID.Cube:t.texture.isDataArrayTexture&&(r.viewDimension=i.ID.TwoDArray),e.texture=r}else console.error('WebGPUBindingUtils: Unsupported binding "'.concat(t,'".'));r.push(e)}return t.createBindGroupLayout({entries:r})}createBindings(e){let t=this.backend.get(e),r=this.createBindingsLayout(e),i=this.createBindGroup(e,r);t.layout=r,t.group=i,t.bindings=e}updateBinding(e){let t=this.backend,r=t.device,i=e.buffer,s=t.get(e).buffer;r.queue.writeBuffer(s,0,i,0)}createBindGroup(e,t){let r=this.backend,s=r.device,n=0,a=[];for(let t of e){if(t.isUniformBuffer){let e=r.get(t);if(void 0===e.buffer){let r=t.byteLength,i=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,n=s.createBuffer({label:"bindingBuffer_"+t.name,size:r,usage:i});e.buffer=n}a.push({binding:n,resource:{buffer:e.buffer}})}else if(t.isStorageBuffer){let e=r.get(t);if(void 0===e.buffer){let i=t.attribute;e.buffer=r.get(i).buffer}a.push({binding:n,resource:{buffer:e.buffer}})}else if(t.isSampler){let e=r.get(t.texture);a.push({binding:n,resource:e.sampler})}else if(t.isSampledTexture){let e,o;let l=r.get(t.texture);if(e=t.isSampledCubeTexture?i.ID.Cube:t.texture.isDataArrayTexture?i.ID.TwoDArray:i.ID.TwoD,void 0!==l.externalTexture)o=s.importExternalTexture({source:l.externalTexture});else{let r=i.XK.All;o=l.texture.createView({aspect:r,dimension:e,mipLevelCount:t.store?1:l.mipLevelCount})}a.push({binding:n,resource:o})}n++}return s.createBindGroup({layout:t,entries:a})}constructor(e){this.backend=e}}t.Z=n},8667:function(e,t,r){r.d(t,{Bb:function(){return y},DI:function(){return d},Do:function(){return h},EE:function(){return i},ID:function(){return b},Lp:function(){return T},NS:function(){return o},Ot:function(){return l},Sq:function(){return p},T3:function(){return m},Tw:function(){return a},XK:function(){return S},Zb:function(){return n},aK:function(){return f},fG:function(){return u},fT:function(){return c},kW:function(){return g},kq:function(){return s},oW:function(){return x},qO:function(){return _},yn:function(){return N}});let i={PointList:"point-list",LineList:"line-list",LineStrip:"line-strip",TriangleList:"triangle-list",TriangleStrip:"triangle-strip"},s={Never:"never",Less:"less",Equal:"equal",LessEqual:"less-equal",Greater:"greater",NotEqual:"not-equal",GreaterEqual:"greater-equal",Always:"always"},n={Store:"store",Discard:"discard"},a={Load:"load",Clear:"clear"},o={CCW:"ccw",CW:"cw"},l={None:"none",Front:"front",Back:"back"},u={Uint16:"uint16",Uint32:"uint32"},d={R8Unorm:"r8unorm",R8Snorm:"r8snorm",R8Uint:"r8uint",R8Sint:"r8sint",R16Uint:"r16uint",R16Sint:"r16sint",R16Float:"r16float",RG8Unorm:"rg8unorm",RG8Snorm:"rg8snorm",RG8Uint:"rg8uint",RG8Sint:"rg8sint",R32Uint:"r32uint",R32Sint:"r32sint",R32Float:"r32float",RG16Uint:"rg16uint",RG16Sint:"rg16sint",RG16Float:"rg16float",RGBA8Unorm:"rgba8unorm",RGBA8UnormSRGB:"rgba8unorm-srgb",RGBA8Snorm:"rgba8snorm",RGBA8Uint:"rgba8uint",RGBA8Sint:"rgba8sint",BGRA8Unorm:"bgra8unorm",BGRA8UnormSRGB:"bgra8unorm-srgb",RGB9E5UFloat:"rgb9e5ufloat",RGB10A2Unorm:"rgb10a2unorm",RG11B10uFloat:"rgb10a2unorm",RG32Uint:"rg32uint",RG32Sint:"rg32sint",RG32Float:"rg32float",RGBA16Uint:"rgba16uint",RGBA16Sint:"rgba16sint",RGBA16Float:"rgba16float",RGBA32Uint:"rgba32uint",RGBA32Sint:"rgba32sint",RGBA32Float:"rgba32float",Stencil8:"stencil8",Depth16Unorm:"depth16unorm",Depth24Plus:"depth24plus",Depth24PlusStencil8:"depth24plus-stencil8",Depth32Float:"depth32float",Depth32FloatStencil8:"depth32float-stencil8",BC1RGBAUnorm:"bc1-rgba-unorm",BC1RGBAUnormSRGB:"bc1-rgba-unorm-srgb",BC2RGBAUnorm:"bc2-rgba-unorm",BC2RGBAUnormSRGB:"bc2-rgba-unorm-srgb",BC3RGBAUnorm:"bc3-rgba-unorm",BC3RGBAUnormSRGB:"bc3-rgba-unorm-srgb",BC4RUnorm:"bc4-r-unorm",BC4RSnorm:"bc4-r-snorm",BC5RGUnorm:"bc5-rg-unorm",BC5RGSnorm:"bc5-rg-snorm",BC6HRGBUFloat:"bc6h-rgb-ufloat",BC6HRGBFloat:"bc6h-rgb-float",BC7RGBAUnorm:"bc7-rgba-unorm",BC7RGBAUnormSRGB:"bc7-rgba-srgb",ETC2RGB8Unorm:"etc2-rgb8unorm",ETC2RGB8UnormSRGB:"etc2-rgb8unorm-srgb",ETC2RGB8A1Unorm:"etc2-rgb8a1unorm",ETC2RGB8A1UnormSRGB:"etc2-rgb8a1unorm-srgb",ETC2RGBA8Unorm:"etc2-rgba8unorm",ETC2RGBA8UnormSRGB:"etc2-rgba8unorm-srgb",EACR11Unorm:"eac-r11unorm",EACR11Snorm:"eac-r11snorm",EACRG11Unorm:"eac-rg11unorm",EACRG11Snorm:"eac-rg11snorm",ASTC4x4Unorm:"astc-4x4-unorm",ASTC4x4UnormSRGB:"astc-4x4-unorm-srgb",ASTC5x4Unorm:"astc-5x4-unorm",ASTC5x4UnormSRGB:"astc-5x4-unorm-srgb",ASTC5x5Unorm:"astc-5x5-unorm",ASTC5x5UnormSRGB:"astc-5x5-unorm-srgb",ASTC6x5Unorm:"astc-6x5-unorm",ASTC6x5UnormSRGB:"astc-6x5-unorm-srgb",ASTC6x6Unorm:"astc-6x6-unorm",ASTC6x6UnormSRGB:"astc-6x6-unorm-srgb",ASTC8x5Unorm:"astc-8x5-unorm",ASTC8x5UnormSRGB:"astc-8x5-unorm-srgb",ASTC8x6Unorm:"astc-8x6-unorm",ASTC8x6UnormSRGB:"astc-8x6-unorm-srgb",ASTC8x8Unorm:"astc-8x8-unorm",ASTC8x8UnormSRGB:"astc-8x8-unorm-srgb",ASTC10x5Unorm:"astc-10x5-unorm",ASTC10x5UnormSRGB:"astc-10x5-unorm-srgb",ASTC10x6Unorm:"astc-10x6-unorm",ASTC10x6UnormSRGB:"astc-10x6-unorm-srgb",ASTC10x8Unorm:"astc-10x8-unorm",ASTC10x8UnormSRGB:"astc-10x8-unorm-srgb",ASTC10x10Unorm:"astc-10x10-unorm",ASTC10x10UnormSRGB:"astc-10x10-unorm-srgb",ASTC12x10Unorm:"astc-12x10-unorm",ASTC12x10UnormSRGB:"astc-12x10-unorm-srgb",ASTC12x12Unorm:"astc-12x12-unorm",ASTC12x12UnormSRGB:"astc-12x12-unorm-srgb"},c={ClampToEdge:"clamp-to-edge",Repeat:"repeat",MirrorRepeat:"mirror-repeat"},h={Linear:"linear",Nearest:"nearest"},p={Zero:"zero",One:"one",Src:"src",OneMinusSrc:"one-minus-src",SrcAlpha:"src-alpha",OneMinusSrcAlpha:"one-minus-src-alpha",Dst:"dst",OneMinusDstColor:"one-minus-dst",DstAlpha:"dst-alpha",OneMinusDstAlpha:"one-minus-dst-alpha",SrcAlphaSaturated:"src-alpha-saturated",Constant:"constant",OneMinusConstant:"one-minus-constant"},g={Add:"add",Subtract:"subtract",ReverseSubtract:"reverse-subtract",Min:"min",Max:"max"},m={None:0,Red:1,Green:2,Blue:4,Alpha:8,All:15},f={Keep:"keep",Zero:"zero",Replace:"replace",Invert:"invert",IncrementClamp:"increment-clamp",DecrementClamp:"decrement-clamp",IncrementWrap:"increment-wrap",DecrementWrap:"decrement-wrap"},T={Uniform:"uniform",Storage:"storage",ReadOnlyStorage:"read-only-storage"},y={Float:"float",UnfilterableFloat:"unfilterable-float",Depth:"depth",SInt:"sint",UInt:"uint"},x={OneD:"1d",TwoD:"2d",ThreeD:"3d"},b={OneD:"1d",TwoD:"2d",TwoDArray:"2d-array",Cube:"cube",CubeArray:"cube-array",ThreeD:"3d"},S={All:"all",StencilOnly:"stencil-only",DepthOnly:"depth-only"},N={Vertex:"vertex",Instance:"instance"},_={DepthClipControl:"depth-clip-control",Depth32FloatStencil8:"depth32float-stencil8",TextureCompressionBC:"texture-compression-bc",TextureCompressionETC2:"texture-compression-etc2",TextureCompressionASTC:"texture-compression-astc",TimestampQuery:"timestamp-query",IndirectFirstInstance:"indirect-first-instance",ShaderF16:"shader-f16",RG11B10UFloat:"rg11b10ufloat-renderable",BGRA8UNormStorage:"bgra8unorm-storage",Float32Filterable:"float32-filterable"}},1172:function(e,t,r){var i=r(3245),s=r(8667),n=r(1901);class a{createRenderPipeline(e){let t;let{object:r,material:i,geometry:s,pipeline:a}=e,{vertexProgram:o,fragmentProgram:l}=a,u=this.backend,d=u.device,c=u.utils,h=u.get(a),p=u.get(e.getBindings()),g=u.attributeUtils.createShaderVertexBuffers(e);!0===i.transparent&&i.blending!==n.NoBlending&&(t=this._getBlending(i));let m={};!0===i.stencilWrite&&(m={compare:this._getStencilCompare(i),failOp:this._getStencilOperation(i.stencilFail),depthFailOp:this._getStencilOperation(i.stencilZFail),passOp:this._getStencilOperation(i.stencilZPass)});let f=this._getColorWriteMask(i),T=[];if(null!==e.context.textures){let r=e.context.textures;for(let e=0;e<r.length;e++){let i=c.getTextureFormatGPU(r[e]);T.push({format:i,blend:t,writeMask:f})}}else{let r=c.getCurrentColorFormat(e.context);T.push({format:r,blend:t,writeMask:f})}let y=u.get(o).module,x=u.get(l).module,b=this._getPrimitiveState(r,s,i),S=this._getDepthCompare(i),N=c.getCurrentDepthStencilFormat(e.context),_=c.getSampleCount(e.context);h.pipeline=d.createRenderPipeline({vertex:Object.assign({},y,{buffers:g}),fragment:Object.assign({},x,{targets:T}),primitive:b,depthStencil:{format:N,depthWriteEnabled:i.depthWrite,depthCompare:S,stencilFront:m,stencilBack:{},stencilReadMask:i.stencilFuncMask,stencilWriteMask:i.stencilWriteMask},multisample:{count:_,alphaToCoverageEnabled:i.alphaToCoverage},layout:d.createPipelineLayout({bindGroupLayouts:[p.layout]})})}createComputePipeline(e,t){let r=this.backend,i=r.device,s=r.get(e.computeProgram).module,n=r.get(e),a=r.get(t);n.pipeline=i.createComputePipeline({compute:s,layout:i.createPipelineLayout({bindGroupLayouts:[a.layout]})})}_getBlending(e){let t,r;let i=e.blending;if(i===n.CustomBlending){let i=null!==e.blendSrcAlpha?e.blendSrcAlpha:s.Sq.One,n=null!==e.blendDstAlpha?e.blendDstAlpha:s.Sq.Zero,a=null!==e.blendEquationAlpha?e.blendEquationAlpha:s.Sq.Add;t={srcFactor:this._getBlendFactor(e.blendSrc),dstFactor:this._getBlendFactor(e.blendDst),operation:this._getBlendOperation(e.blendEquation)},r={srcFactor:this._getBlendFactor(i),dstFactor:this._getBlendFactor(n),operation:this._getBlendOperation(a)}}else{let a=e.premultipliedAlpha,o=(e,i,n,a)=>{t={srcFactor:e,dstFactor:i,operation:s.kW.Add},r={srcFactor:n,dstFactor:a,operation:s.kW.Add}};if(a)switch(i){case n.NormalBlending:o(s.Sq.SrcAlpha,s.Sq.OneMinusSrcAlpha,s.Sq.One,s.Sq.OneMinusSrcAlpha);break;case n.AdditiveBlending:o(s.Sq.SrcAlpha,s.Sq.One,s.Sq.One,s.Sq.One);break;case n.SubtractiveBlending:o(s.Sq.Zero,s.Sq.OneMinusSrc,s.Sq.Zero,s.Sq.One);break;case n.MultiplyBlending:o(s.Sq.Zero,s.Sq.Src,s.Sq.Zero,s.Sq.SrcAlpha)}else switch(i){case n.NormalBlending:o(s.Sq.SrcAlpha,s.Sq.OneMinusSrcAlpha,s.Sq.One,s.Sq.OneMinusSrcAlpha);break;case n.AdditiveBlending:o(s.Sq.SrcAlpha,s.Sq.One,s.Sq.SrcAlpha,s.Sq.One);break;case n.SubtractiveBlending:o(s.Sq.Zero,s.Sq.OneMinusSrc,s.Sq.Zero,s.Sq.One);break;case n.MultiplyBlending:o(s.Sq.Zero,s.Sq.Src,s.Sq.Zero,s.Sq.Src)}}if(void 0!==t&&void 0!==r)return{color:t,alpha:r};console.error("THREE.WebGPURenderer: Invalid blending: ",i)}_getBlendFactor(e){let t;switch(e){case n.ZeroFactor:t=s.Sq.Zero;break;case n.OneFactor:t=s.Sq.One;break;case n.SrcColorFactor:t=s.Sq.Src;break;case n.OneMinusSrcColorFactor:t=s.Sq.OneMinusSrc;break;case n.SrcAlphaFactor:t=s.Sq.SrcAlpha;break;case n.OneMinusSrcAlphaFactor:t=s.Sq.OneMinusSrcAlpha;break;case n.DstColorFactor:t=s.Sq.Dst;break;case n.OneMinusDstColorFactor:t=s.Sq.OneMinusDstColor;break;case n.DstAlphaFactor:t=s.Sq.DstAlpha;break;case n.OneMinusDstAlphaFactor:t=s.Sq.OneMinusDstAlpha;break;case n.SrcAlphaSaturateFactor:t=s.Sq.SrcAlphaSaturated;break;case i.$i:t=s.Sq.Constant;break;case i.Xh:t=s.Sq.OneMinusConstant;break;default:console.error("THREE.WebGPURenderer: Blend factor not supported.",e)}return t}_getStencilCompare(e){let t;let r=e.stencilFunc;switch(r){case n.NeverStencilFunc:t=s.kq.Never;break;case n.AlwaysStencilFunc:t=s.kq.Always;break;case n.LessStencilFunc:t=s.kq.Less;break;case n.LessEqualStencilFunc:t=s.kq.LessEqual;break;case n.EqualStencilFunc:t=s.kq.Equal;break;case n.GreaterEqualStencilFunc:t=s.kq.GreaterEqual;break;case n.GreaterStencilFunc:t=s.kq.Greater;break;case n.NotEqualStencilFunc:t=s.kq.NotEqual;break;default:console.error("THREE.WebGPURenderer: Invalid stencil function.",r)}return t}_getStencilOperation(e){let t;switch(e){case n.KeepStencilOp:t=s.aK.Keep;break;case n.ZeroStencilOp:t=s.aK.Zero;break;case n.ReplaceStencilOp:t=s.aK.Replace;break;case n.InvertStencilOp:t=s.aK.Invert;break;case n.IncrementStencilOp:t=s.aK.IncrementClamp;break;case n.DecrementStencilOp:t=s.aK.DecrementClamp;break;case n.IncrementWrapStencilOp:t=s.aK.IncrementWrap;break;case n.DecrementWrapStencilOp:t=s.aK.DecrementWrap;break;default:console.error("THREE.WebGPURenderer: Invalid stencil operation.",t)}return t}_getBlendOperation(e){let t;switch(e){case n.AddEquation:t=s.kW.Add;break;case n.SubtractEquation:t=s.kW.Subtract;break;case n.ReverseSubtractEquation:t=s.kW.ReverseSubtract;break;case n.MinEquation:t=s.kW.Min;break;case n.MaxEquation:t=s.kW.Max;break;default:console.error("THREE.WebGPUPipelineUtils: Blend equation not supported.",e)}return t}_getPrimitiveState(e,t,r){let i={},a=this.backend.utils;switch(i.topology=a.getPrimitiveTopology(e,r),null!==t.index&&!0===e.isLine&&!0!==e.isLineSegments&&(i.stripIndexFormat=t.index.array instanceof Uint16Array?s.fG.Uint16:s.fG.Uint32),r.side){case n.FrontSide:i.frontFace=s.NS.CCW,i.cullMode=s.Ot.Back;break;case n.BackSide:i.frontFace=s.NS.CCW,i.cullMode=s.Ot.Front;break;case n.DoubleSide:i.frontFace=s.NS.CCW,i.cullMode=s.Ot.None;break;default:console.error("THREE.WebGPUPipelineUtils: Unknown material.side value.",r.side)}return i}_getColorWriteMask(e){return!0===e.colorWrite?s.T3.All:s.T3.None}_getDepthCompare(e){let t;if(!1===e.depthTest)t=s.kq.Always;else{let r=e.depthFunc;switch(r){case n.NeverDepth:t=s.kq.Never;break;case n.AlwaysDepth:t=s.kq.Always;break;case n.LessDepth:t=s.kq.Less;break;case n.LessEqualDepth:t=s.kq.LessEqual;break;case n.EqualDepth:t=s.kq.Equal;break;case n.GreaterEqualDepth:t=s.kq.GreaterEqual;break;case n.GreaterDepth:t=s.kq.Greater;break;case n.NotEqualDepth:t=s.kq.NotEqual;break;default:console.error("THREE.WebGPUPipelineUtils: Invalid depth function.",r)}}return t}constructor(e){this.backend=e}}t.Z=a},6241:function(e,t,r){r.d(t,{Z:function(){return d},y:function(){return u}});var i=r(8667),s=r(1901);class n{getTransferPipeline(e){let t=this.transferPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.mipmapFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:i.EE.TriangleStrip,stripIndexFormat:i.fG.Uint32},layout:"auto"}),this.transferPipelines[e]=t),t}getFlipYPipeline(e){let t=this.flipYPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.flipYFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:i.EE.TriangleStrip,stripIndexFormat:i.fG.Uint32},layout:"auto"}),this.flipYPipelines[e]=t),t}flipY(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=t.format,{width:n,height:a}=t.size,o=this.getTransferPipeline(s),l=this.getFlipYPipeline(s),u=this.device.createTexture({size:{width:n,height:a,depthOrArrayLayers:1},format:s,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),d=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:i.ID.TwoD,baseArrayLayer:r}),c=u.createView({baseMipLevel:0,mipLevelCount:1,dimension:i.ID.TwoD,baseArrayLayer:0}),h=this.device.createCommandEncoder({}),p=(e,t,r)=>{let s=e.getBindGroupLayout(0),n=this.device.createBindGroup({layout:s,entries:[{binding:0,resource:this.flipYSampler},{binding:1,resource:t}]}),a=h.beginRenderPass({colorAttachments:[{view:r,loadOp:i.Tw.Clear,storeOp:i.Zb.Store,clearValue:[0,0,0,0]}]});a.setPipeline(e),a.setBindGroup(0,n),a.draw(4,1,0,0),a.end()};p(o,d,c),p(l,c,d),this.device.queue.submit([h.finish()]),u.destroy()}generateMipmaps(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=this.getTransferPipeline(t.format),n=this.device.createCommandEncoder({}),a=s.getBindGroupLayout(0),o=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:i.ID.TwoD,baseArrayLayer:r});for(let l=1;l<t.mipLevelCount;l++){let t=this.device.createBindGroup({layout:a,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:o}]}),u=e.createView({baseMipLevel:l,mipLevelCount:1,dimension:i.ID.TwoD,baseArrayLayer:r}),d=n.beginRenderPass({colorAttachments:[{view:u,loadOp:i.Tw.Clear,storeOp:i.Zb.Store,clearValue:[0,0,0,0]}]});d.setPipeline(s),d.setBindGroup(0,t),d.draw(4,1,0,0),d.end(),o=u}this.device.queue.submit([n.finish()])}constructor(e){this.device=e,this.mipmapSampler=e.createSampler({minFilter:i.Do.Linear}),this.flipYSampler=e.createSampler({minFilter:i.Do.Nearest}),this.transferPipelines={},this.flipYPipelines={},this.mipmapVertexShaderModule=e.createShaderModule({label:"mipmapVertex",code:"\nstruct VarysStruct {\n	@builtin( position ) Position: vec4<f32>,\n	@location( 0 ) vTex : vec2<f32>\n};\n\n@vertex\nfn main( @builtin( vertex_index ) vertexIndex : u32 ) -> VarysStruct {\n\n	var Varys : VarysStruct;\n\n	var pos = array< vec2<f32>, 4 >(\n		vec2<f32>( -1.0,  1.0 ),\n		vec2<f32>(  1.0,  1.0 ),\n		vec2<f32>( -1.0, -1.0 ),\n		vec2<f32>(  1.0, -1.0 )\n	);\n\n	var tex = array< vec2<f32>, 4 >(\n		vec2<f32>( 0.0, 0.0 ),\n		vec2<f32>( 1.0, 0.0 ),\n		vec2<f32>( 0.0, 1.0 ),\n		vec2<f32>( 1.0, 1.0 )\n	);\n\n	Varys.vTex = tex[ vertexIndex ];\n	Varys.Position = vec4<f32>( pos[ vertexIndex ], 0.0, 1.0 );\n\n	return Varys;\n\n}\n"}),this.mipmapFragmentShaderModule=e.createShaderModule({label:"mipmapFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n	return textureSample( img, imgSampler, vTex );\n\n}\n"}),this.flipYFragmentShaderModule=e.createShaderModule({label:"flipYFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n	return textureSample( img, imgSampler, vec2( vTex.x, 1.0 - vTex.y ) );\n\n}\n"})}}let a={[s.NeverCompare]:"never",[s.LessCompare]:"less",[s.EqualCompare]:"equal",[s.LessEqualCompare]:"less-equal",[s.GreaterCompare]:"greater",[s.GreaterEqualCompare]:"greater-equal",[s.AlwaysCompare]:"always",[s.NotEqualCompare]:"not-equal"},o=[0,1,3,2,4,5];class l{createSampler(e){let t=this.backend,r=t.device,i=t.get(e),s={addressModeU:this._convertAddressMode(e.wrapS),addressModeV:this._convertAddressMode(e.wrapT),addressModeW:this._convertAddressMode(e.wrapR),magFilter:this._convertFilterMode(e.magFilter),minFilter:this._convertFilterMode(e.minFilter),mipmapFilter:this._convertFilterMode(e.minFilter),maxAnisotropy:e.anisotropy};e.isDepthTexture&&null!==e.compareFunction&&(s.compare=a[e.compareFunction]),i.sampler=r.createSampler(s)}createDefaultTexture(e){let t;t=e.isCubeTexture?this._getDefaultCubeTextureGPU():this._getDefaultTextureGPU(),this.backend.get(e).texture=t}createTexture(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.backend,i=r.get(e);if(i.initialized)throw Error("WebGPUTextureUtils: Texture already initialized.");void 0===t.needsMipmaps&&(t.needsMipmaps=!1),void 0===t.levels&&(t.levels=1),void 0===t.depth&&(t.depth=1);let{width:s,height:n,depth:a,levels:o}=t,l=this._getDimension(e),d=e.internalFormat||u(e,r.device),c=void 0!==t.sampleCount?t.sampleCount:1,h=e.isRenderTargetTexture?1:c,p=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC;!0===e.isStorageTexture&&(p|=GPUTextureUsage.STORAGE_BINDING),!0!==e.isCompressedTexture&&(p|=GPUTextureUsage.RENDER_ATTACHMENT);let g={label:e.name,size:{width:s,height:n,depthOrArrayLayers:a},mipLevelCount:o,sampleCount:h,dimension:l,format:d,usage:p};if(e.isVideoTexture){let t=e.source.data,r=new VideoFrame(t);g.size.width=r.displayWidth,g.size.height=r.displayHeight,r.close(),i.externalTexture=t}else{if(void 0===d)return console.warn("WebGPURenderer: Texture format not supported."),this.createDefaultTexture(e);i.texture=r.device.createTexture(g)}if(e.isRenderTargetTexture&&c>1){let e=Object.assign({},g);e.label=e.label+"-msaa",e.sampleCount=c,i.msaaTexture=r.device.createTexture(e)}i.initialized=!0,i.textureDescriptorGPU=g}destroyTexture(e){let t=this.backend,r=t.get(e);r.texture.destroy(),void 0!==r.msaaTexture&&r.msaaTexture.destroy(),t.delete(e)}destroySampler(e){let t=this.backend.get(e);delete t.sampler}generateMipmaps(e){let t=this.backend.get(e);if(e.isCubeTexture)for(let e=0;e<6;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e);else this._generateMipmaps(t.texture,t.textureDescriptorGPU)}getColorBuffer(){this.colorBuffer&&this.colorBuffer.destroy();let e=this.backend,{width:t,height:r}=e.getDrawingBufferSize();return this.colorBuffer=e.device.createTexture({label:"colorBuffer",size:{width:t,height:r,depthOrArrayLayers:1},sampleCount:e.parameters.sampleCount,format:i.DI.BGRA8Unorm,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.colorBuffer}getDepthBuffer(){let e,t,r=!(arguments.length>0)||void 0===arguments[0]||arguments[0],i=!(arguments.length>1)||void 0===arguments[1]||arguments[1],n=this.backend,{width:a,height:o}=n.getDrawingBufferSize(),l=this.depthTexture,u=n.get(l).texture;if(i?(e=s.DepthStencilFormat,t=s.UnsignedInt248Type):r&&(e=s.DepthFormat,t=s.UnsignedIntType),void 0!==u){if(l.image.width===a&&l.image.height===o&&l.format===e&&l.type===t)return u;this.destroyTexture(l)}return l.name="depthBuffer",l.format=e,l.type=t,l.image.width=a,l.image.height=o,this.createTexture(l,{sampleCount:n.parameters.sampleCount,width:a,height:o}),n.get(l).texture}updateTexture(e,t){let r=this.backend.get(e),{textureDescriptorGPU:i}=r;if(!e.isRenderTargetTexture&&void 0!==i){if(e.isDataTexture||e.isData3DTexture)this._copyBufferToTexture(t.image,r.texture,i,0,!1);else if(e.isDataArrayTexture)for(let e=0;e<t.image.depth;e++)this._copyBufferToTexture(t.image,r.texture,i,e,!1,e);else if(e.isCompressedTexture)this._copyCompressedBufferToTexture(e.mipmaps,r.texture,i);else if(e.isCubeTexture)this._copyCubeMapToTexture(t.images,r.texture,i,e.flipY);else if(e.isVideoTexture){let t=e.source.data;r.externalTexture=t}else this._copyImageToTexture(t.image,r.texture,i,0,e.flipY);r.version=e.version,e.onUpdate&&e.onUpdate(e)}}async copyTextureToBuffer(e,t,r,i,s){let n=this.backend.device,a=this.backend.get(e),o=a.texture,l=a.textureDescriptorGPU.format,u=this._getBytesPerTexel(l),d=n.createBuffer({size:i*s*u,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),c=n.createCommandEncoder();c.copyTextureToBuffer({texture:o,origin:{x:t,y:r}},{buffer:d,bytesPerRow:i*u},{width:i,height:s});let h=this._getTypedArrayType(l);return n.queue.submit([c.finish()]),await d.mapAsync(GPUMapMode.READ),new h(d.getMappedRange())}_isEnvironmentTexture(e){let t=e.mapping;return t===s.EquirectangularReflectionMapping||t===s.EquirectangularRefractionMapping||t===s.CubeReflectionMapping||t===s.CubeRefractionMapping}_getDefaultTextureGPU(){let e=this.defaultTexture;if(null===e){let t=new s.Texture;t.minFilter=s.NearestFilter,t.magFilter=s.NearestFilter,this.createTexture(t,{width:1,height:1}),this.defaultTexture=e=t}return this.backend.get(e).texture}_getDefaultCubeTextureGPU(){let e=this.defaultTexture;if(null===e){let t=new s.CubeTexture;t.minFilter=s.NearestFilter,t.magFilter=s.NearestFilter,this.createTexture(t,{width:1,height:1,depth:6}),this.defaultCubeTexture=e=t}return this.backend.get(e).texture}_copyCubeMapToTexture(e,t,r,i){for(let s=0;s<6;s++){let n=e[s],a=!0===i?o[s]:s;n.isDataTexture?this._copyBufferToTexture(n.image,t,r,a,i):this._copyImageToTexture(n,t,r,a,i)}}_copyImageToTexture(e,t,r,i,s){this.backend.device.queue.copyExternalImageToTexture({source:e},{texture:t,mipLevel:0,origin:{x:0,y:0,z:i}},{width:e.width,height:e.height,depthOrArrayLayers:1}),!0===s&&this._flipY(t,r,i)}_getPassUtils(){let e=this._passUtils;return null===e&&(this._passUtils=e=new n(this.backend.device)),e}_generateMipmaps(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._getPassUtils().generateMipmaps(e,t,r)}_flipY(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this._getPassUtils().flipY(e,t,r)}_copyBufferToTexture(e,t,r,i,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,a=this.backend.device,o=e.data,l=this._getBytesPerTexel(r.format),u=e.width*l;a.queue.writeTexture({texture:t,mipLevel:0,origin:{x:0,y:0,z:i}},o,{offset:e.width*e.height*l*n,bytesPerRow:u},{width:e.width,height:e.height,depthOrArrayLayers:1}),!0===s&&this._flipY(t,r,i)}_copyCompressedBufferToTexture(e,t,r){let i=this.backend.device,s=this._getBlockData(r.format);for(let r=0;r<e.length;r++){let n=e[r],a=n.width,o=n.height,l=Math.ceil(a/s.width)*s.byteLength;i.queue.writeTexture({texture:t,mipLevel:r},n.data,{offset:0,bytesPerRow:l},{width:Math.ceil(a/s.width)*s.width,height:Math.ceil(o/s.width)*s.width,depthOrArrayLayers:1})}}_getBlockData(e){return e===i.DI.BC1RGBAUnorm||e===i.DI.BC1RGBAUnormSRGB?{byteLength:8,width:4,height:4}:e===i.DI.BC2RGBAUnorm||e===i.DI.BC2RGBAUnormSRGB||e===i.DI.BC3RGBAUnorm||e===i.DI.BC3RGBAUnormSRGB?{byteLength:16,width:4,height:4}:e===i.DI.BC4RUnorm||e===i.DI.BC4RSNorm?{byteLength:8,width:4,height:4}:e===i.DI.BC5RGUnorm||e===i.DI.BC5RGSnorm||e===i.DI.BC6HRGBUFloat||e===i.DI.BC6HRGBFloat||e===i.DI.BC7RGBAUnorm||e===i.DI.BC7RGBAUnormSRGB?{byteLength:16,width:4,height:4}:e===i.DI.ETC2RGB8Unorm||e===i.DI.ETC2RGB8UnormSRGB||e===i.DI.ETC2RGB8A1Unorm||e===i.DI.ETC2RGB8A1UnormSRGB?{byteLength:8,width:4,height:4}:e===i.DI.ETC2RGBA8Unorm||e===i.DI.ETC2RGBA8UnormSRGB?{byteLength:16,width:4,height:4}:e===i.DI.EACR11Unorm||e===i.DI.EACR11Snorm?{byteLength:8,width:4,height:4}:e===i.DI.EACRG11Unorm||e===i.DI.EACRG11Snorm||e===i.DI.ASTC4x4Unorm||e===i.DI.ASTC4x4UnormSRGB?{byteLength:16,width:4,height:4}:e===i.DI.ASTC5x4Unorm||e===i.DI.ASTC5x4UnormSRGB?{byteLength:16,width:5,height:4}:e===i.DI.ASTC5x5Unorm||e===i.DI.ASTC5x5UnormSRGB?{byteLength:16,width:5,height:5}:e===i.DI.ASTC6x5Unorm||e===i.DI.ASTC6x5UnormSRGB?{byteLength:16,width:6,height:5}:e===i.DI.ASTC6x6Unorm||e===i.DI.ASTC6x6UnormSRGB?{byteLength:16,width:6,height:6}:e===i.DI.ASTC8x5Unorm||e===i.DI.ASTC8x5UnormSRGB?{byteLength:16,width:8,height:5}:e===i.DI.ASTC8x6Unorm||e===i.DI.ASTC8x6UnormSRGB?{byteLength:16,width:8,height:6}:e===i.DI.ASTC8x8Unorm||e===i.DI.ASTC8x8UnormSRGB?{byteLength:16,width:8,height:8}:e===i.DI.ASTC10x5Unorm||e===i.DI.ASTC10x5UnormSRGB?{byteLength:16,width:10,height:5}:e===i.DI.ASTC10x6Unorm||e===i.DI.ASTC10x6UnormSRGB?{byteLength:16,width:10,height:6}:e===i.DI.ASTC10x8Unorm||e===i.DI.ASTC10x8UnormSRGB?{byteLength:16,width:10,height:8}:e===i.DI.ASTC10x10Unorm||e===i.DI.ASTC10x10UnormSRGB?{byteLength:16,width:10,height:10}:e===i.DI.ASTC12x10Unorm||e===i.DI.ASTC12x10UnormSRGB?{byteLength:16,width:12,height:10}:e===i.DI.ASTC12x12Unorm||e===i.DI.ASTC12x12UnormSRGB?{byteLength:16,width:12,height:12}:void 0}_convertAddressMode(e){let t=i.fT.ClampToEdge;return e===s.RepeatWrapping?t=i.fT.Repeat:e===s.MirroredRepeatWrapping&&(t=i.fT.MirrorRepeat),t}_convertFilterMode(e){let t=i.Do.Linear;return(e===s.NearestFilter||e===s.NearestMipmapNearestFilter||e===s.NearestMipmapLinearFilter)&&(t=i.Do.Nearest),t}_getBytesPerTexel(e){return e===i.DI.R8Unorm?1:e===i.DI.R16Float||e===i.DI.RG8Unorm?2:e===i.DI.RG16Float||e===i.DI.R32Float||e===i.DI.RGBA8Unorm||e===i.DI.RGBA8UnormSRGB?4:e===i.DI.RG32Float||e===i.DI.RGBA16Float?8:e===i.DI.RGBA32Float?16:void 0}_getTypedArrayType(e){return e===i.DI.R8Uint?Uint8Array:e===i.DI.R8Sint?Int8Array:e===i.DI.R8Unorm?Uint8Array:e===i.DI.R8Snorm?Int8Array:e===i.DI.RG8Uint?Uint8Array:e===i.DI.RG8Sint?Int8Array:e===i.DI.RG8Unorm?Uint8Array:e===i.DI.RG8Snorm?Int8Array:e===i.DI.RGBA8Uint?Uint8Array:e===i.DI.RGBA8Sint?Int8Array:e===i.DI.RGBA8Unorm?Uint8Array:e===i.DI.RGBA8Snorm?Int8Array:e===i.DI.R16Uint?Uint16Array:e===i.DI.R16Sint?Int16Array:e===i.DI.RG16Uint?Uint16Array:e===i.DI.RG16Sint?Int16Array:e===i.DI.RGBA16Uint?Uint16Array:e===i.DI.RGBA16Sint?Int16Array:e===i.DI.R32Uint?Uint32Array:e===i.DI.R32Sint?Int32Array:e===i.DI.R32Float?Float32Array:e===i.DI.RG32Uint?Uint32Array:e===i.DI.RG32Sint?Int32Array:e===i.DI.RG32Float?Float32Array:e===i.DI.RGBA32Uint?Uint32Array:e===i.DI.RGBA32Sint?Int32Array:e===i.DI.RGBA32Float?Float32Array:void 0}_getDimension(e){return e.isData3DTexture?i.oW.ThreeD:i.oW.TwoD}constructor(e){this.backend=e,this._passUtils=null,this.defaultTexture=null,this.defaultCubeTexture=null,this.colorBuffer=null,this.depthTexture=new s.DepthTexture,this.depthTexture.name="depthBuffer"}}function u(e){let t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=e.format,a=e.type,o=e.colorSpace;if(!0===e.isFramebufferTexture)t=i.DI.BGRA8Unorm;else if(!0===e.isCompressedTexture)switch(n){case s.RGBA_S3TC_DXT1_Format:t=o===s.SRGBColorSpace?i.DI.BC1RGBAUnormSRGB:i.DI.BC1RGBAUnorm;break;case s.RGBA_S3TC_DXT3_Format:t=o===s.SRGBColorSpace?i.DI.BC2RGBAUnormSRGB:i.DI.BC2RGBAUnorm;break;case s.RGBA_S3TC_DXT5_Format:t=o===s.SRGBColorSpace?i.DI.BC3RGBAUnormSRGB:i.DI.BC3RGBAUnorm;break;case s.RGB_ETC2_Format:t=o===s.SRGBColorSpace?i.DI.ETC2RGB8UnormSRGB:i.DI.ETC2RGB8Unorm;break;case s.RGBA_ETC2_EAC_Format:t=o===s.SRGBColorSpace?i.DI.ETC2RGBA8UnormSRGB:i.DI.ETC2RGBA8Unorm;break;case s.RGBA_ASTC_4x4_Format:t=o===s.SRGBColorSpace?i.DI.ASTC4x4UnormSRGB:i.DI.ASTC4x4Unorm;break;case s.RGBA_ASTC_5x4_Format:t=o===s.SRGBColorSpace?i.DI.ASTC5x4UnormSRGB:i.DI.ASTC5x4Unorm;break;case s.RGBA_ASTC_5x5_Format:t=o===s.SRGBColorSpace?i.DI.ASTC5x5UnormSRGB:i.DI.ASTC5x5Unorm;break;case s.RGBA_ASTC_6x5_Format:t=o===s.SRGBColorSpace?i.DI.ASTC6x5UnormSRGB:i.DI.ASTC6x5Unorm;break;case s.RGBA_ASTC_6x6_Format:t=o===s.SRGBColorSpace?i.DI.ASTC6x6UnormSRGB:i.DI.ASTC6x6Unorm;break;case s.RGBA_ASTC_8x5_Format:t=o===s.SRGBColorSpace?i.DI.ASTC8x5UnormSRGB:i.DI.ASTC8x5Unorm;break;case s.RGBA_ASTC_8x6_Format:t=o===s.SRGBColorSpace?i.DI.ASTC8x6UnormSRGB:i.DI.ASTC8x6Unorm;break;case s.RGBA_ASTC_8x8_Format:t=o===s.SRGBColorSpace?i.DI.ASTC8x8UnormSRGB:i.DI.ASTC8x8Unorm;break;case s.RGBA_ASTC_10x5_Format:t=o===s.SRGBColorSpace?i.DI.ASTC10x5UnormSRGB:i.DI.ASTC10x5Unorm;break;case s.RGBA_ASTC_10x6_Format:t=o===s.SRGBColorSpace?i.DI.ASTC10x6UnormSRGB:i.DI.ASTC10x6Unorm;break;case s.RGBA_ASTC_10x8_Format:t=o===s.SRGBColorSpace?i.DI.ASTC10x8UnormSRGB:i.DI.ASTC10x8Unorm;break;case s.RGBA_ASTC_10x10_Format:t=o===s.SRGBColorSpace?i.DI.ASTC10x10UnormSRGB:i.DI.ASTC10x10Unorm;break;case s.RGBA_ASTC_12x10_Format:t=o===s.SRGBColorSpace?i.DI.ASTC12x10UnormSRGB:i.DI.ASTC12x10Unorm;break;case s.RGBA_ASTC_12x12_Format:t=o===s.SRGBColorSpace?i.DI.ASTC12x12UnormSRGB:i.DI.ASTC12x12Unorm;break;default:console.error("WebGPURenderer: Unsupported texture format.",n)}else switch(n){case s.RGBAFormat:switch(a){case s.UnsignedByteType:t=o===s.SRGBColorSpace?i.DI.RGBA8UnormSRGB:i.DI.RGBA8Unorm;break;case s.HalfFloatType:t=i.DI.RGBA16Float;break;case s.FloatType:t=i.DI.RGBA32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with RGBAFormat.",a)}break;case s.RedFormat:switch(a){case s.UnsignedByteType:t=i.DI.R8Unorm;break;case s.HalfFloatType:t=i.DI.R16Float;break;case s.FloatType:t=i.DI.R32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with RedFormat.",a)}break;case s.RGFormat:switch(a){case s.UnsignedByteType:t=i.DI.RG8Unorm;break;case s.HalfFloatType:t=i.DI.RG16Float;break;case s.FloatType:t=i.DI.RG32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with RGFormat.",a)}break;case s.DepthFormat:switch(a){case s.UnsignedShortType:t=i.DI.Depth16Unorm;break;case s.UnsignedIntType:t=i.DI.Depth24Plus;break;case s.FloatType:t=i.DI.Depth32Float;break;default:console.error("WebGPURenderer: Unsupported texture type with DepthFormat.",a)}break;case s.DepthStencilFormat:switch(a){case s.UnsignedInt248Type:t=i.DI.Depth24PlusStencil8;break;case s.FloatType:r&&!1===r.features.has(i.qO.Depth32FloatStencil8)&&console.error('WebGPURenderer: Depth textures with DepthStencilFormat + FloatType can only be used with the "depth32float-stencil8" GPU feature.'),t=i.DI.Depth32FloatStencil8;break;default:console.error("WebGPURenderer: Unsupported texture type with DepthStencilFormat.",a)}break;default:console.error("WebGPURenderer: Unsupported texture format.",n)}return t}var d=l},9456:function(e,t,r){var i=r(8667);class s{getCurrentDepthStencilFormat(e){let t;return null!==e.depthTexture?t=this.getTextureFormatGPU(e.depthTexture):e.depth&&e.stencil?t=i.DI.Depth24PlusStencil8:e.depth&&(t=i.DI.Depth24Plus),t}getTextureFormatGPU(e){return this.backend.get(e).texture.format}getCurrentColorFormat(e){return null!==e.textures?this.getTextureFormatGPU(e.textures[0]):i.DI.BGRA8Unorm}getCurrentColorSpace(e){return null!==e.textures?e.textures[0].colorSpace:this.backend.renderer.outputColorSpace}getPrimitiveTopology(e,t){return e.isPoints?i.EE.PointList:e.isLineSegments||e.isMesh&&!0===t.wireframe?i.EE.LineList:e.isLine?i.EE.LineStrip:e.isMesh?i.EE.TriangleList:void 0}getSampleCount(e){return null!==e.textures?e.sampleCount:this.backend.parameters.sampleCount}constructor(e){this.backend=e}}t.Z=s}}]);