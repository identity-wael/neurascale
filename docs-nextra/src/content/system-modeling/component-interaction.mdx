import { Tabs } from 'nextra/components'

# Component Interaction Diagram

This diagram shows the complete system architecture and how all services interact with each other, including synchronous and asynchronous communication patterns.

```mermaid
graph TB
    subgraph "Client Layer"
        WEB[Web Console]
        SDK[Python/JS SDK]
        CLI[Neural CLI]
        MCP[MCP Clients]
    end

    subgraph "API Gateway Layer"
        GW[API Gateway<br/>Load Balancer]
        AUTH[Auth Service<br/>JWT/OAuth2]
        RATE[Rate Limiter<br/>Token Bucket]
    end

    subgraph "Core Services"
        DEVICE[Device Service<br/>:8001]
        SESSION[Session Service<br/>:8002]
        PROCESS[Processing Service<br/>:8003]
        CLINICAL[Clinical Service<br/>:8004]
        ANALYSIS[Analysis Service<br/>:8005]
        ML[ML Service<br/>:8006]
    end

    subgraph "Real-time Layer"
        STREAM[Streaming Service<br/>WebSocket]
        PUBSUB[Pub/Sub Broker]
        QUEUE[Task Queue<br/>Celery]
    end

    subgraph "Data Layer"
        CACHE[Redis Cache<br/>Session/Results]
        PG[PostgreSQL<br/>Metadata]
        BT[Bigtable<br/>Time-series]
        BQ[BigQuery<br/>Analytics]
        GCS[Cloud Storage<br/>Raw Files]
    end

    subgraph "Infrastructure"
        MONITOR[Monitoring<br/>Prometheus]
        LOG[Logging<br/>Cloud Logging]
        TRACE[Tracing<br/>OpenTelemetry]
        SECRET[Secret Manager<br/>KMS]
    end

    %% Client connections
    WEB --> GW
    SDK --> GW
    CLI --> GW
    MCP --> CLINICAL
    MCP --> DEVICE
    MCP --> ANALYSIS

    %% Gateway routing
    GW --> AUTH
    AUTH --> RATE
    RATE --> DEVICE
    RATE --> SESSION
    RATE --> PROCESS
    RATE --> CLINICAL
    RATE --> ANALYSIS
    RATE --> ML

    %% Service interactions
    DEVICE -.->|Events| PUBSUB
    SESSION --> DEVICE
    SESSION --> PG
    PROCESS --> STREAM
    PROCESS -.->|Jobs| QUEUE
    CLINICAL --> SESSION
    ANALYSIS --> ML
    ML -.->|Inference| QUEUE

    %% Real-time connections
    STREAM --> CACHE
    PUBSUB --> STREAM
    PUBSUB --> BT
    QUEUE --> PROCESS
    QUEUE --> ML

    %% Data access patterns
    DEVICE --> CACHE
    SESSION --> PG
    PROCESS --> BT
    CLINICAL --> PG
    ANALYSIS --> BQ
    ML --> GCS

    %% Infrastructure connections
    DEVICE --> MONITOR
    SESSION --> MONITOR
    PROCESS --> MONITOR
    CLINICAL --> LOG
    ANALYSIS --> TRACE
    ML --> TRACE
    AUTH --> SECRET

    %% Legend
    classDef client fill:#4285F4,stroke:#1a73e8,color:#fff
    classDef gateway fill:#34A853,stroke:#188038,color:#fff
    classDef service fill:#FBBC04,stroke:#F9AB00,color:#000
    classDef realtime fill:#EA4335,stroke:#C5221F,color:#fff
    classDef data fill:#9E9E9E,stroke:#616161,color:#fff
    classDef infra fill:#673AB7,stroke:#512DA8,color:#fff

    class WEB,SDK,CLI,MCP client
    class GW,AUTH,RATE gateway
    class DEVICE,SESSION,PROCESS,CLINICAL,ANALYSIS,ML service
    class STREAM,PUBSUB,QUEUE realtime
    class CACHE,PG,BT,BQ,GCS data
    class MONITOR,LOG,TRACE,SECRET infra
```

<Tabs items={['Communication Patterns', 'Service Details', 'Integration Points']}>
  <Tabs.Tab>
    **Communication Types:**

    | Pattern | Use Case | Technology | Latency |
    |---------|----------|------------|---------|
    | **Synchronous REST** | CRUD operations | HTTP/2 + JSON | 10-100ms |
    | **GraphQL** | Complex queries | Apollo Federation | 20-200ms |
    | **WebSocket** | Real-time streaming | WS + MessagePack | Less than 5ms |
    | **Pub/Sub** | Event broadcasting | Cloud Pub/Sub | 10-50ms |
    | **gRPC** | Service-to-service | Protocol Buffers | 5-20ms |
    | **Task Queue** | Async processing | Celery + Redis | 100ms-5s |
    | **MCP** | AI assistant integration | JSON-RPC | 50-200ms |

    **Service Discovery:**
    - Kubernetes DNS for internal services
    - Cloud Endpoints for external APIs
    - Consul for dynamic service registry
    - Health checks via `/health` endpoints
  </Tabs.Tab>

  <Tabs.Tab>
    **Service Responsibilities:**

    ```yaml
    Device Service:
      - Device registration and management
      - Connection handling (USB, BLE, Network)
      - Impedance monitoring
      - Real-time data acquisition
      - Event publishing

    Session Service:
      - Session lifecycle management
      - Recording coordination
      - Metadata management
      - Access control
      - Audit logging

    Processing Service:
      - Signal filtering and preprocessing
      - Feature extraction
      - Window management
      - Stream processing
      - Quality metrics

    Clinical Service:
      - Patient management
      - Treatment protocols
      - Clinical workflows
      - HIPAA compliance
      - Report generation

    Analysis Service:
      - Batch analysis jobs
      - Statistical computations
      - Visualization generation
      - Export functionality
      - Result caching

    ML Service:
      - Model serving
      - Real-time inference
      - Model versioning
      - A/B testing
      - Performance monitoring
    ```
  </Tabs.Tab>

  <Tabs.Tab>
    **Integration Points:**

    | Component | Inbound | Outbound | Protocol |
    |-----------|---------|----------|----------|
    | **API Gateway** | Clients | All services | HTTP/2 |
    | **Device Service** | Gateway, MCP | Pub/Sub, Cache | REST, gRPC |
    | **Session Service** | Gateway, Clinical | PostgreSQL, Device | REST, SQL |
    | **Processing Service** | Queue, Device | Bigtable, Stream | gRPC, WS |
    | **Clinical Service** | Gateway, MCP | PostgreSQL, Session | REST, SQL |
    | **Analysis Service** | Gateway, MCP | BigQuery, ML | REST, gRPC |
    | **ML Service** | Analysis, Queue | GCS, Cache | gRPC, REST |
    | **Streaming Service** | Processing | WebSocket clients | WS |
    | **Pub/Sub** | All services | Subscribers | Cloud Pub/Sub |
    | **Task Queue** | Services | Workers | AMQP |
  </Tabs.Tab>
</Tabs>
